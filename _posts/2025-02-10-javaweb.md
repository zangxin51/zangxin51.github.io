---
layout:     post
title:      "javaweb"
subtitle:   ""
date:       2024-02-10 15:44:00
author:     "zangxin"
header-img: "img/post-bg-2015.jpg"
catalog: true
tags:
---

# javaweb

## XML

### å®šä¹‰

- æ‰©å±•æ ‡è®°è¯­è¨€

### åŠŸèƒ½

- èƒ½å­˜å‚¨å¤æ‚çš„æ•°æ®ç»“æ„

- å¯ä»¥ä½œä¸ºåœ¨ç¨‹åºä¹‹é—´ä¼ è¾“æ•°æ®æ ¼å¼(è¢«JSONå–ä»£)

- ä½œä¸ºé…ç½®æ–‡ä»¶(ä¸»è¦: spring,mavenç­‰ç­‰)

- å……å½“å°å‹æ•°æ®åº“

### è¯­æ³•

- 1.xmlå£°æ˜æ”¾åœ¨xmlæ–‡æ¡£ç¬¬ä¸€è¡Œ

- 2.xmlå£°æ˜åŒ…å«version(åŸºæœ¬ä¸å˜ä¸º1.0), å’Œå­—ç¬¦ç¼–ç ä¸€èˆ¬ç”¨utf-8

  ```xml
  <?xml version="1.0" encoding="UTF-8"?>
  ```

- 3.å…ƒç´ è¯­æ³•è¦æ±‚

  - æ¯ä¸ªxmlæ–‡æ¡£æœ‰ä¸”åªæœ‰ä¸€ä¸ªæ ¹å…ƒç´ 

  - æ ¹å…ƒç´ åŒ…æ‹¬å…¶ä»–æ‰€æœ‰å…ƒç´ 

  - æ ‡ç­¾åˆ†ä¸ºæœ‰æ ‡ç­¾ä½“å’Œæ²¡æœ‰æ ‡ç­¾ä½“çš„

    - æœ‰æ ‡ç­¾ä½“

      ```xml
      <a>www.google.com</a>
      ```

    - æ— æ ‡ç­¾ä½“

      ```xml
      <a></a>ç®€å†™ä¸º<a/>
      ```

      

  - å…ƒç´ ,æ ‡ç­¾(tag),èŠ‚ç‚¹æœ¯è¯­æŒ‡å®šæ˜¯åŒä¸€ä¸ªä¸œè¥¿

- 4.å±æ€§

	- å±æ€§å€¼ç”¨åŒå¼•å·æˆ–è€…å•å¼•å·åˆ†éš”

	- ä¸€ä¸ªå…ƒç´ å¯ä»¥æœ‰å¤šä¸ªå±æ€§, åŸºæœ¬æ ¼å¼ä¸º<å…ƒç´ å å±æ€§å="å±æ€§å€¼">

	- å±æ€§ååœ¨ä¸€ä¸ªæ ‡ç­¾ä¸­ä¸èƒ½é‡å¤

	- å±æ€§å€¼ä¸èƒ½åŒ…æ‹¬&ç¬¦å·

- CDATAèŠ‚

  - CDATAèŠ‚ä¸­æ‰€æœ‰å­—ç¬¦éƒ½ä¼šè¢«å½“åšç®€å•æ–‡æœ¬,è€Œä¸æ˜¯xmlæ ‡è®°

    ```xml
    <![CDATA[éœ€è¦çš„å†…å®¹]]>
    ```

- è½¬ä¹‰å­—ç¬¦

  ```xml
  &lt; &gt; &amp;(&) &quot;(") &apos;(')
  ```

### xmlè§£æ

- åŸç†,xmlå’Œhtmlè¿™ç±»æ ‡è®°æ–‡æ¡£,å¯ä»¥é€šè¿‡w3cç»„ç»‡åˆ¶å®šçš„domæŠ€æœ¯è§£æxmlè·å–domå¯¹è±¡

- dom4jè§£æ

  - è·å–domå¯¹è±¡çš„3ç§æ–¹å¼

    ```java
    // ä»æ–‡ä»¶ä¸­è§£æ
    SAXReader reader = new SAXReader();
    Document document = reader.read(new File("src/xml/students.xml"));
    // ä»æ–‡æœ¬ä¸­è§£æ
    String text = "<name>mary</name>";
    document = DocumentHelper.parseText(text);
    // åˆ›å»ºdomå¯¹è±¡
    document = DocumentHelper.createDocument();
    document.addElement("name");
    ```

    - QNameæ˜¯æ ‡ç­¾åå­—

  - éå†

    ```java
    // ============éå†====================
    Element rootElement = document.getRootElement();
    // è·å–rootçš„ä¸¤ä¸ªç›´æ¥å­å…ƒç´ 
    List<Element> elements = rootElement.elements();
    for (Element student : elements) {
    // è·å–studentçš„å±æ€§id
    String id = student.attributeValue("id");
    // è·å–studentå­èŠ‚ç‚¹
    Element name = student.element("name");
    Element age = student.element("age");
    Element gender = student.element("gender");
    System.out.printf("%s,%s,%s,%s\n",
          id, name.getText(), age.getText(), gender.getText());
    }
    ```

  - æŸ¥æ‰¾

    ```java
    //=========== è·å–ç¬¬äºŒä¸ªå­¦ç”Ÿ===========
    Element stu = (Element) rootElement.elements("student").get(1);
    ```

  - å¢åˆ æ”¹

    - å¢

      ```java
      //=========== æ·»åŠ ä¸€ä¸ªæ–°å­¦ç”Ÿ=============
      Element newStu = DocumentHelper.createElement("student");
      Element newStuName = DocumentHelper.createElement("name");
      // å¦‚ä½•ç»™å…ƒç´ æ·»åŠ å±æ€§
      newStu.addAttribute("id", "300");
      // ç»™å…ƒç´ æ·»åŠ Text
      newStuName.addText("tom");
      // æŠŠå­èŠ‚ç‚¹æ·»åŠ åˆ°çˆ¶èŠ‚ç‚¹ä¸­
      newStu.add(newStuName);
      // æŠŠå­¦ç”ŸèŠ‚ç‚¹åŠ åˆ°æ ¹èŠ‚ç‚¹ä¸­
      rootElement.add(newStu);
      ```

    - åˆ 

      ```java
      // ============åˆ é™¤ç¬¬ä¸‰ä¸ªå­¦ç”Ÿ=========================
      Element student = (Element) rootElement.elements("student").get(2);
      student.getParent().remove(student);
      ```

      

    - æ”¹

      ```java
      //==========æ›´æ–°ç¬¬ä¸€ä¸ªå­¦ç”Ÿ, æŠŠå­¦ç”Ÿçš„å¹´é¾„+3============
      Element newAge = (Element) ((Element) (rootElement.elements("student").get(0))).elements("age").get(0);
      newAge.setText(Integer.parseInt(newAge.getText()) + 3 + "");
      ```

      

  - ä¿å­˜ä¿®æ”¹åˆ°æ–‡ä»¶ä¸­

    ```java
    // ========ä¿å­˜xmlæ–‡ä»¶=========
    OutputFormat out = OutputFormat.createPrettyPrint();
    out.setEncoding("utf-8");
    XMLWriter xmlWriter = new XMLWriter(new FileOutputStream("src/main/java/xml/students.xml"), out);
    xmlWriter.write(document);
    xmlWriter.close();
    ```

    

- å†å²

	- æ—©æœŸJDKæä¾›ä¸¤ç§xmlè§£ææŠ€æœ¯DOMå’ŒSax(Simple API for XML),ç°åœ¨äºŒè€…å·²ç»è¿‡æ—¶

	- ç¬¬ä¸‰æ–¹è§£ææŠ€æœ¯, jdomå¯¹domå°è£…, dom4jå¯¹jdomè¿›è¡Œäº†å°è£…

## HTTPåè®®

å‘½ä»¤

```shell
curl -i 'www.baidu.com'
```



### è¯·æ±‚

```text
GET /hi HTTP/1.1
Accept: text/html,application/xhtml+xml,application/xml;q=0.9,image/avif,image/webp,image/apng,
Accept-Encoding: gzip, deflate, br, zstd
Accept-Language: zh-CN,zh;q=0.9,en-US;q=0.8,en;q=0.7
Cache-Control: no-cache
Connection: keep-alive
Cookie: Idea-3873738e=839fe1ca-6bc2-4055-bb09-70a4cd05d6f5
Host: localhost:43999
Pragma: no-cache
Sec-Fetch-Dest: document
Sec-Fetch-Mode: navigate
Sec-Fetch-Site: none
Sec-Fetch-User: ?1
Upgrade-Insecure-Requests: 1
User-Agent: Mozilla/5.0 (Macintosh; Intel Mac OS X 10_15_7) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/133.0.0.0 Safari/537.36
sec-ch-ua: "Not(A:Brand";v="99", "Google Chrome";v="133", "Chromium";v="133"
sec-ch-ua-mobile: ?0
sec-ch-ua-platform: "macOS"
ç©ºè¡Œ\r\n
è¯·æ±‚ä½“
```



- è¯·æ±‚å¤´

  - Hostè¯·æ±‚çš„ä¸»æœºç«¯å£

  - User-Agent: æµè§ˆå™¨ä¿¡æ¯

  - Accept: æµè§ˆå™¨å¯ä»¥æ¥å—çš„æ•°æ®æ ¼å¼

  - Accept-Language:æµè§ˆå™¨å¯ä»¥æ¥å—çš„è¯­è¨€,zh-CN,en-Us

  - Accept-Encoding:æµè§ˆå™¨å¯ä»¥æ¥å—æ•°æ®å‹ç¼©æ–¹å¼

  - Connection: å‘Šè¯‰æœåŠ¡å™¨å¤„ç†è¿æ¥çš„æ–¹å¼, keep-aliveé•¿è¿æ¥, closed,ç«‹å³å…³é—­è¿æ¥

  - Referer: è¡¨ç¤ºè¿™ä¸ªè¯·æ±‚æ˜¯ä»å“ªé‡Œæ¥çš„(é˜²æ­¢ç›—é“¾)

  - Cookie, æµè§ˆå™¨æ¯æ¬¡è¯·æ±‚æ—¶éƒ½ä¼šå¸¦ä¸Šcookie

  - Content-Type:è¡¨ç¤ºæäº¤æ•°æ®çš„æ ¼å¼
    application/x-www-form-urlencoded è¡¨ç¤ºè¡¨å•æ•°æ®

  - content-lengthè¡¨ç¤ºæ•°æ®é•¿åº¦

  - Origin:è¡¨ç¤ºè¯·æ±‚æ˜¯ä»é‚£ä¸ªä¸»æœºå‘å‡ºçš„

### å“åº”

```text
HTTP/1.1 200 
Content-Length: 321
Accept-Ranges: bytes
Connection: keep-alive
Content-Type: text/html
Date: Fri, 21 Feb 2025 06:19:23 GMT
Etag: W/"321-1740107657325"
Keep-Alive: timeout=4
Last-Modified: Fri, 21 Feb 2025 03:14:17 GMT
Proxy-Connection: keep-alive

<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="UTF-8">
        <title>Title</title>
    </head>
    <body>
        <h1>Wel come hello</h1>
        <a href="ganyu-game.html">ç©æ¸¸æˆå§</a>
        <br>
        <a href="hi">hi</a> <br>
        <a href="register.html">å»æ³¨å†Œ</a>
    </body>
</html>
```


- å“åº”å¤´

  - Server: æœåŠ¡å™¨
    Accept-Range: byteå­—èŠ‚-->æ”¯æŒæ–­ç‚¹ç»­ä¼ 
    ETag: å¯¹èµ„æºçš„æ ‡è¯†(ç±»ä¼¼ä¸€ä¸ªtoken)
    Last-Modified: è¿”å›èµ„æºçš„ä¸Šæ¬¡ä¿®æ”¹æ—¶é—´,å¯ä»¥ç”¨æ¥åˆ¤æ–­æ˜¯å¦ä½¿ç”¨ç¼“å­˜
    Content-Type:è¡¨ç¤ºè¿”å›èµ„æºç±»å‹
    Content-Length:è¿”å›èµ„æºçš„å­—èŠ‚é•¿åº¦,æµè§ˆå™¨æ ¹æ®è¿™ä¸ªæ¥åˆ¤æ–­æ–‡ä»¶æ˜¯å¦ç»“æŸäº†,ä¸è®¾ç½®çš„è¯, æµè§ˆå™¨ä¼šä¸€ç›´è½¬åœˆ
    Date: æœåŠ¡å™¨å“åº”æ—¶é—´

- çŠ¶æ€ç 

  - 200OK
    302 é‡å®šå‘
    304  Not Modified
    404 
  - 302, æœ‰ä¸ªlocationå“åº”å¤´, è¡¨ç¤ºé‡å®šå‘çš„èµ„æºurl



é‡å®šå‘ä¼šå‘é€è‡³å°‘ä¸¤æ¬¡è¯·æ±‚

 304, å½“æ²¡æœ‰ç¦ç”¨æµè§ˆå™¨ç¼“å­˜æ—¶, å“åº”å¤´ä¼šæ·»åŠ if-modified-since:æ—¶é—´, è¡¨ç¤ºèµ„æºçš„æœ€è¿‘ä¿®æ”¹æ—¶é—´,æœåŠ¡å™¨ä¼šæ¯”è¾ƒæ—¶é—´, å¦‚æœæœåŠ¡å™¨çš„èµ„æºæ›´æ–°, å°±ä¼šè¿”å›è¯¥èµ„æº, å¦‚æœæ²¡æœ‰ä¿®æ”¹, å°±è¿”å›304çŠ¶æ€ç , ä½†æ˜¯ä¸ä¼šè¿”å›è¯¥èµ„æº



å‘é€è¯·æ±‚æ•°é‡æ¡ˆä¾‹

è¯·æ±‚äº†ä¸‰æ¬¡

```html
index.html
<img src="a.jpg">
<img src="b.jpg">
```

### getå’Œpostè¯·æ±‚åˆ†åˆ«æœ‰å“ªäº›

- get

  - è¡¨å•æ–¹æ³•æŒ‡å®šget, form, method=get
    aæ ‡ç­¾
    linkæ ‡ç­¾,å¼•å…¥css
    scriptæ ‡ç­¾,å¼•å…¥jsè„šæœ¬
    imgæ ‡ç­¾
    iframeå¼•å…¥htmlé¡µé¢
    æµè§ˆå™¨åœ°å€æ•²å›è½¦

- post

  - è¡¨å•ä¸­æ–¹æ³•æŒ‡å®špost

- ä»€ä¹ˆæƒ…å†µä¸‹ä½¿ç”¨post

  - getä¼ è¾“æ•°æ®é‡å°
    getçš„å¯†ç ä¼šæ˜¾ç¤ºåœ¨urlä¸Š

  - æŸ¥è¯¢ä½¿ç”¨get OK
    ä¿®æ”¹/æ›´æ–°/åˆ é™¤å¯ä»¥ä½¿ç”¨postè¯·æ±‚

### MIMEç±»å‹

- MIMEç±»å‹æ˜¯HTTPåè®®ä¸­æ•°æ®ç±»å‹,åœ¨å“åº”å¤´ä¸­çš„Content-Typeä¸­æŒ‡å®š

- å¸¸ç”¨çš„MIMIEç±»å‹

  - text/html
    text/plain
    image/gif
    application/json
    ...

## Tomcat+Servlet

### Tomcat

- ä»‹ç»

  tomcatä¹Ÿæ˜¯javaç½‘ç»œç¨‹åºçš„ä¸€éƒ¨åˆ†, ä»–è´Ÿè´£å¤„ç†sokcetå’Œæµè§ˆå™¨é€šä¿¡çš„è¿‡ç¨‹, æˆ‘ä»¬è´Ÿè´£ä¸šåŠ¡é—®é¢˜, æŠŠç”¨æˆ·çš„è¯·æ±‚å…¥åº“å†™å…¥æ•°æ®åº“æˆ–è€…æŠŠæ•°æ®åº“ä¸­çš„æ•°æ®è¿”å›ç»™tomcat,tomcatå†è¿”å›ç»™æµè§ˆå™¨.

- é…ç½®

  - Tomcatçš„ç›®å½•

    - bin: å­˜æ”¾å¯åŠ¨å’Œå…³é—­æœåŠ¡çš„å‘½ä»¤

    - conf å­˜æ”¾TomcatæœåŠ¡çš„å„ç§é…ç½®æ–‡ä»¶

      - server.xml é…ç½®tomcatçš„åŸºæœ¬è®¾ç½®,å¯åŠ¨ç«¯å£,å…³é—­ç«¯å£,ä¸»æœºå

      - web.xml ç”¨æ¥æŒ‡å®štomcatè¿è¡Œé…ç½®(æ¯”å¦‚servlet)

    - lib tomcatè‡ªå·±è¦ç”¨åˆ°çš„jaråŒ…

    - logs tomcatè¿è¡Œæ—¥å¿—

    - webapps

    	- webåº”ç”¨æ‰€åœ¨ç›®å½•, é»˜è®¤è®¿é—®ROOTåº”ç”¨é¡¹ç›®

    	- webåº”ç”¨

    		- webåº”ç”¨ç»„æˆ: html,å›¾ç‰‡,æ–‡æœ¬,å£°éŸ³,è§†é¢‘ç­‰,css,js,åŠ¨æ€webé¡µé¢, javaç¨‹åº(servlet), jaråŒ…,é…ç½®æ–‡ä»¶ç­‰

    		- webåº”ç”¨ç›®å½•è§„èŒƒ

    			- webappç›®å½•

    				- é™æ€æ–‡ä»¶,html/css/jsç­‰

    				- WEB-INFç›®å½•

    					- web.xml

    					- lib

    		- éƒ¨ç½²æ–¹å¼

    			- æ–¹å¼1,å°†webå·¥ç¨‹ç›®å½•copyåˆ°webappsç›®å½•ä¸‹

    			- æ–¹å¼2,é€šè¿‡é…ç½®æ–‡ä»¶æ¥éƒ¨ç½²(ideaå°±æ˜¯è¿™æ ·ç”¨è¿™ç§æ–¹å¼çš„), åœ¨tomcat/conf/Catalina/localhost/ä¸‹,é…ç½®æ–‡ä»¶

    		- è®¿é—®æ–¹å¼

    			- http://ip:port/webåº”ç”¨ç›®å½•å/è¯·æ±‚çš„æ–‡ä»¶è·¯å¾„

    - work: tomcatçš„å·¥ä½œç›®å½•,å­˜æ”¾è§£æåçš„jspæ–‡ä»¶

- ä½¿ç”¨

	- é…ç½®JAVA_HOMEç¯å¢ƒå˜é‡

	- åœ¨ideaä¸­é…ç½®tomcat

		- 1.åˆ›å»ºwebé¡¹ç›®

		- 2.edit configuration, é€‰æ‹©tomcat server

		- 3.mavenæ‰“åŒ…æ–¹å¼é€‰æ‹©waråŒ…

		- 4.rebuildé¡¹ç›®åç”Ÿæˆartifacts

		- 5,åœ¨ç¬¬2æ­¥ä¸­é€‰æ‹©deploymentä¸­é€‰æ‹©artifacts

		- 6.ç›´æ¥æ‰§è¡Œæˆ–è€…æ‹·è´artifactsåˆ°tomcatçš„webappsç›®å½•ä¸‹

		- æ³¨æ„, ç¼–è¾‘åŒºçš„æºç , å’Œè¿è¡Œæ—¶æºç ä¸æ˜¯ä¸€ä¸ªä¸œè¥¿
ç¼–è¾‘åŒºçš„æºç ç»è¿‡rebuild/buildåæ‰èƒ½ç”Ÿæˆå¯ä»¥è¿è¡Œçš„artifacts

- tomcatåº•å±‚åŸç†

  - httpè¯·æ±‚è¿‡ç¨‹

    - å¯åŠ¨tomcat, å®Œæˆweb.xmlé…ç½®Servlet,å¯åŠ¨socketServerç›‘å¬

      - http Request å¼€å¯ä¸€ä¸ªçº¿ç¨‹å»å¤„ç†è¯·æ±‚

        - é™æ€èµ„æº ç›´æ¥è¿”å›é™æ€èµ„æº

        - è¯·æ±‚Servlet ->è°ƒç”¨Servletçš„serviceæ–¹æ³•

  - å¯åŠ¨tomcat, socketç›‘å¬, è¯·æ±‚è¿‡æ¥å¼€å¯å¤šçº¿ç¨‹
  dom4j, è§£æweb.xml,  åˆ©ç”¨åå°„åˆ›å»ºServlet, 

  - æ‹¼æ¥httpè¯·æ±‚çš„å­—ç¬¦ä¸²

    ```text
    String content = """
    HTTP/1.1 200
    Content-Type: text/html;charset=utf-8
    Content-Length: %d
              
    %s
    """;
    String s = "<h1>ä½ å¥½, Hello, Tomcat</h1>";
    content = String.format(content, s.getBytes().length, s);
    ```

### å®ç°ç®€æ˜“ç‰ˆtomcat

æ ¸å¿ƒç±»-åŠ è½½é…ç½®-åˆ›å»º/è°ƒç”¨Servlet

```java
package com.xxx.tomcat_;

import com.xxx.tomcat_.myservlet.MyHttpRequest;
import com.xxx.tomcat_.myservlet.MyHttpResponse;
import com.xxx.tomcat_.myservlet.MyHttpServlet;
import com.xxx.tomcat_.myservlet.MyServlet;
import org.dom4j.Document;
import org.dom4j.DocumentException;
import org.dom4j.Element;
import org.dom4j.io.SAXReader;

import java.lang.reflect.Method;
import java.util.HashMap;
import java.util.List;
import java.util.Map;
import java.util.concurrent.ConcurrentHashMap;

/**
 * @author zangxin
 * @version 1.0
 * @date 2025/2/22
 *
 *åˆ›å»º,è°ƒç”¨,ä»xmlè¯»å–Servleté…ç½®ä¿¡æ¯
 */
public class ManageServlet {
    // url --- obj
    private static final Map<String, MyServlet> URL_SERVLET_MAP = new ConcurrentHashMap<>();
    public static final MyServlet NULLOBJ = new MyHttpServlet();
    // url --- class
    private static final Map<String, String> URL_CLASS_MAP = new HashMap<>();

    private static void doServlet() {

    }

    public static void loadServlet() {
        System.out.println("load servlet start ....");
        // ä»web.xmlæ–‡ä»¶ä¸­è¯»å–
        SAXReader saxReader = new SAXReader();
        try {
            Document document = saxReader.read(ManageServlet.class.getResourceAsStream("myservlet/web.xml"));
            Element rootElement = document.getRootElement();
            List<Element> elements = rootElement.elements("servlet-mapping");
            for (Element servletMapping : elements) {
                Element element = servletMapping.element("url-pattern");
                String urlPattern = element.getText();
                Element servletName = servletMapping.element("servlet-name");
                URL_CLASS_MAP.put(servletName.getText(), urlPattern);
            }
            List<Element> servlets = rootElement.elements("servlet");
            for (Element servlet : servlets) {
                String servletName = servlet.element("servlet-name").getText();
                String servletClass = servlet.element("servlet-class").getText();
                String urlPattern = URL_CLASS_MAP.get(servletName);
                URL_CLASS_MAP.put(urlPattern, servletClass);
                URL_CLASS_MAP.remove(servletName);
                URL_SERVLET_MAP.put(urlPattern, NULLOBJ);
            }
        } catch (DocumentException e) {
            throw new RuntimeException(e);
        }
        System.out.println("load servlet end, " + "load " + URL_SERVLET_MAP.size() + " servlets.");
    }

    public static void createServlet(String url) {
        String className = URL_CLASS_MAP.get(url);
        try {
            Class<?> clazz = Class.forName(className);
            Object o = clazz.newInstance();
            URL_SERVLET_MAP.put(url, (MyServlet) o);
        } catch (Exception e) {
            e.printStackTrace();
        }
    }

    public static MyServlet getServlet(String url) {
        return URL_SERVLET_MAP.get(url);
    }

    public static boolean containsUrl(String url) {
        return URL_SERVLET_MAP.containsKey(url);
    }

    public static void doService(String url, MyHttpRequest request, MyHttpResponse response) {
        String className = URL_CLASS_MAP.get(url);
        try {
            Class<?> clazz = Class.forName(className);
            Method service = clazz.getMethod("service", MyHttpRequest.class, MyHttpResponse.class);
            service.invoke(URL_SERVLET_MAP.get(url), request, response);
        } catch (Exception e) {
            e.printStackTrace();
        }
    }
}

```



æ ¸å¿ƒç±»-httpé€šä¿¡

```java
package com.xxx.tomcat_;

import com.xxx.tomcat_.myservlet.CalTwoSumServlet;
import com.xxx.tomcat_.myservlet.MyHttpRequest;
import com.xxx.tomcat_.myservlet.MyHttpResponse;
import com.xxx.tomcat_.myservlet.MyServlet;
import com.xxx.util.StreamUtils;

import java.net.ServerSocket;
import java.net.Socket;
import java.util.regex.Matcher;
import java.util.regex.Pattern;

import static com.xxx.tomcat_.ManageServlet.NULLOBJ;

/**
 * @author zangxin
 * @version 1.0
 * @date 2025/2/22
 * å’Œ2ä¸€æ ·, è¿™é‡Œè¦æ”¯æŒMyServletç³»åˆ—æ¥å£
 */
public class MyTomcat3 {
    public static void main(String[] args) throws Exception {
        System.out.println("tomcat åœ¨43999ç›‘å¬");
        ServerSocket serverSocket = new ServerSocket(43999);
        // åŠ è½½Servletä»xmlæ–‡ä»¶æˆ–è€…æ³¨è§£ä¸­
        ManageServlet.loadServlet();
        while (true) {
            Socket socket = serverSocket.accept();
            new HttpRequestThread3(socket).start();
        }
    }
}

class HttpRequestThread3 extends Thread {
    private Socket socket;

    public HttpRequestThread3(Socket socket) {
        this.socket = socket;
    }

    @Override
    public void run() {
        try {
            MyHttpRequest request = new MyHttpRequest(socket.getInputStream());
            MyHttpResponse response = new MyHttpResponse(socket.getOutputStream());

            // indexé¡µé¢
            String url = request.getUrl();
            if (url.equals("/")) {
                response.write(StreamUtils.streamToString(CalTwoSumServlet.class.getResourceAsStream("index.html")));
            }
            // æŸ¥æ‰¾é™æ€èµ„æº html
            // åŒ¹é…æ–‡ä»¶æ‰©å±•å
            Matcher matcher = Pattern.compile("(/)(\\w+.\\w+$)").matcher(url);
            if (matcher.find()) {
                String resource = matcher.group(2);
                System.out.println(resource);
                if (resource.substring(resource.lastIndexOf(".") + 1, resource.length()).equals("html")) {
                    response.write(StreamUtils.streamToString(CalTwoSumServlet.class.getResourceAsStream(resource)));
                }
            }
            // æ ¹æ®urlæŸ¥æ‰¾Servlet
            if (ManageServlet.containsUrl(url)) {
                MyServlet servlet = ManageServlet.getServlet(url);
                if (servlet == NULLOBJ) {
                    ManageServlet.createServlet(url);
                }
                ManageServlet.doService(url, request, response);
            }
            response.write("404 NOT FOUND");

            socket.close();
        } catch (Exception e) {
            e.printStackTrace();
        }
    }
}

```

request

```java
package com.xxx.tomcat_.myservlet;

import java.io.BufferedReader;
import java.io.IOException;
import java.io.InputStream;
import java.io.InputStreamReader;
import java.util.HashMap;

/**
 * @author zangxin
 * @version 1.0
 * @date 2025/2/22
 */
public class MyHttpRequest {
    private String url;
    private String method;
    private InputStream in;
    private HashMap<String, String> paramMap = new HashMap<>();

    public MyHttpRequest(InputStream inputStream) {
        // å°è£…è¯·æ±‚
        this.in = inputStream;
        BufferedReader br = new BufferedReader(new InputStreamReader(inputStream));
        try {
            // è§£æè¯·æ±‚è¡Œ
            String requestLine = br.readLine();
            // è¯·æ±‚è¡Œ
            // GET /?name=ggstar HTTP/1.1
            String[] lines = requestLine.split(" ");
            method = lines[0];
            url = lines[1];
            if (url.contains("?")) {
                url = url.substring(0, url.indexOf("?"));
                // è·å–å‚æ•°
                String pls = lines[1].substring(lines[1].indexOf("?")+1);
                String[] parameters = pls.split("&");
                for (String parameter : parameters) {
                    String[] kv = parameter.split("=");
                    if (kv.length == 2)
                        paramMap.put(kv[0], kv[1]);
                }
            }
        } catch (IOException e) {
            throw new RuntimeException(e);
        }

    }


    public String getMethod() {
        return method;
    }


    public String getParameter(String name) {
        return paramMap.get(name);
    }

    public String getUrl() {
        return url;
    }
}

```

response

```java
package com.xxx.tomcat_.myservlet;

import java.io.BufferedWriter;
import java.io.IOException;
import java.io.OutputStream;
import java.io.OutputStreamWriter;

/**
 * @author zangxin
 * @version 1.0
 * @date 2025/2/22
 */
public class MyHttpResponse {

    private OutputStream out;

    public MyHttpResponse(OutputStream out) {
        this.out = out;
    }

    public OutputStream getOut() {
        return out;
    }

    String httpFormat = """
            HTTP/1.1 200
            Content-Type: text/html;charset=utf-8
            Content-Length: %d
            KeepAlive: 3600
                      
            %s
            """;

    public String write(String content) {
        String format = String.format(httpFormat, content.getBytes().length, content);
        BufferedWriter writer = new BufferedWriter(new OutputStreamWriter(out));
        try {
            writer.write(format);
            writer.flush();
        } catch (IOException e) {
            e.printStackTrace();
        }
        return format;
    }
}
```

servletæ¥å£

```java
public interface MyServlet {
    void init();
    void service(MyHttpRequest request, MyHttpResponse response);
    void destroy();
}
```

servletå®ç°ç±»

```java
public class MyHttpServlet implements MyServlet {
    @Override
    public void init() {

    }

    @Override
    public void service(MyHttpRequest request, MyHttpResponse response) {
        if (request.getMethod().equals("GET")) {
            doGet(request, response);
        } else if (request.getMethod().equals("POST")) {
            doPost(request, response);
        }
    }

    public void doPost(MyHttpRequest request, MyHttpResponse response) {

    }

    public void doGet(MyHttpRequest request, MyHttpResponse response) {

    }

    @Override
    public void destroy() {

    }
}
```

web.xml

```java
<?xml version="1.0" encoding="UTF-8"?>
<web-app>
    <servlet>
        <servlet-name>CalTwoSumServlet</servlet-name>
        <servlet-class>com.xxx.tomcat_.myservlet.CalTwoSumServlet</servlet-class>
        <load-on-startup>99</load-on-startup>
    </servlet>
    <servlet-mapping>
        <servlet-name>CalTwoSumServlet</servlet-name>
        <url-pattern>/cal</url-pattern>
    </servlet-mapping>
    <servlet>
        <servlet-name>test</servlet-name>
        <servlet-class>com.xxx.tomcat_.myservlet.CalTwoSumServlet</servlet-class>
        <load-on-startup>99</load-on-startup>
    </servlet>
    <servlet-mapping>
        <servlet-name>test</servlet-name>
        <url-pattern>/ff</url-pattern>
    </servlet-mapping>
</web-app>
```



### servlet

- å®šä¹‰:Servletæ˜¯javaEEè§„èŒƒ, æ˜¯ä¸€å¥—æ¥å£
ç”±æœåŠ¡å™¨å‚å•†å®ç°è¯¥æ¥å£

	- servletå’Œtomcatçš„å…³ç³»: tomcatå®ç°äº†Servletæ¥å£

	- ä½¿ç”¨æ—¶,åœ¨Servletå®ç°ä¸šåŠ¡åŠŸèƒ½

- Servletæ¥å£

  - ç”Ÿå‘½å‘¨æœŸæ–¹æ³•

    - init

      è¯·æ±‚urlæ—¶,Servletå¦‚æœå­˜åœ¨, Tomcatå°±åˆ›å»ºå®ä¾‹,å†ä¼šè°ƒç”¨è¯¥æ–¹æ³•, åªè°ƒç”¨ä¸€æ¬¡(Servletæ˜¯æ‡’åŠ è½½çš„,åªæœ‰åœ¨æœ‰è¯·æ±‚æ—¶, æ‰åˆ›å»ºServletå¯¹è±¡)

    - service

      ä»åˆ›å»ºå¼€å§‹,æœåŠ¡ç›´åˆ°é”€æ¯, å¯è¢«å¤šæ¬¡è°ƒç”¨
      å¯ä»¥å¤„ç†getå’Œpostè¯·æ±‚

      1.æ¯æ”¶åˆ°ä¸€ä¸ªè¯·æ±‚, æœåŠ¡å™¨å°±ä¼šäº§ç”Ÿä¸€ä¸ªæ–°çš„çº¿ç¨‹å»å¤„ç†
      2.åˆ›å»ºä¸€ä¸ªç”¨äºå°è£…HTTPè¯·æ±‚æ¶ˆæ¯çš„ServletRquestå’ŒHTTPå“åº”å¯¹è±¡ServletResponse
      3.ç„¶åè°ƒç”¨serviceæ–¹æ³•,å¹¶å°†è¯·æ±‚å’Œå“åº”å¯¹è±¡ä½œä¸ºå‚æ•°ä¼ é€’

    - destroy

    	- é”€æ¯æ—¶è°ƒç”¨,åªè°ƒç”¨ä¸€æ¬¡

    	- ä½¿ç”¨kill -9 æ—¶ä¸ä¼šè°ƒç”¨

- ä½¿ç”¨æ–¹æ³•

  - å¼€å‘æ–¹å¼

    - é…ç½®æ–‡ä»¶web.xml

      ```xml
      <servlet>
       <servlet-name>
       <servlet-class>
        è®¾ç½®tomcatå¯åŠ¨æ—¶åŠ è½½Servlet, å¯¹æŠ—æ‡’åŠ è½½
        <load-on-startup>99</load-on-startup>
      
      <servlet-mapping>
      	<servlet-name>
        <url-pattern>
      ```

      åœ¨ç¬¬äºŒæ¬¡è¯·æ±‚æ—¶: 
      1.æŸ¥è¯¢web.xml, url-->ä»mapä¸­æŸ¥è¯¢è·å–Servletå¯¹è±¡-->æ‹¿åˆ°å¯¹è±¡,è°ƒç”¨serviceæ–¹æ³•,ä¸ºç”¨æˆ·æœåŠ¡

      - è¯·æ±‚è¿‡ç¨‹, å¦‚æœæ˜¯ç¬¬ä¸€æ¬¡è¯·æ±‚
      1.æŸ¥è¯¢web.xml
      2.æŸ¥çœ‹è¯·æ±‚çš„èµ„æº/helloServlet, åœ¨web.xmlé…ç½®url-pattern
      3.å¦‚æœæ‰¾åˆ°ç±»url-pattern, å°±å¾—åˆ°äº†HelloServletå¯¹è±¡
      4.Tomcatç»´æŠ¤äº†ä¸€ä¸ªå¤§çš„HashMap<id, Servlet> æŸ¥è¯¢è¯¥Map,çœ‹çœ‹æ˜¯å¦æœ‰Servletå®ä¾‹
      5.å¦‚æœæ²¡æœ‰æŸ¥è¯¢åˆ°Servletå¯¹åº”id, å³Servletè¿˜ä¸å­˜åœ¨
      6.å°±æ ¹æ®servlet-nameå»å¾—åˆ°servlet-classçš„ç±»è·¯å¾„
      7.åå°„å®ä¾‹åŒ–servlet,è°ƒç”¨init()æ–¹æ³•, åœ¨æ”¾å…¥åˆ°mapä¸­, ä¾¿äºä»¥åæŸ¥è¯¢

      - servleté»˜è®¤æ˜¯å•ä¾‹çš„, ä»åˆšæ‰çš„hashmapç»´æŠ¤url |---> Servletå¯¹è±¡å¯ä»¥çœ‹å‡ºæ¥

    - æ³¨è§£å¼€å‘

      - åœ¨æˆ‘ä»¬å®šä¹‰Servletç±»ä¸Šé¢å†™ä¸Šä¸‹é¢çš„æ³¨è§£

        ```java
        @WebServlet(urlPatterns = {"/as", "/as1","/as2"})
        // æˆ–è€…
        // nameå’Œvalueä¸èƒ½é‡å¤(å’Œå…¶ä»–Servletä¸€æ ·)
        @WebServlet(name = "helloServlet", value = "/hello-servlet") 
        ```

        

      - åŸç†

        åŒ…æ‰«æ, æŸä¸ªç±»ä¸Šé¢æœ‰WebServletæ³¨è§£æ—¶å°±è®¤ä¸ºå®ƒæ˜¯ä¸€ä¸ªServlet--->æ”¾å…¥hashmapä¸­

        æ³¨è§£å¼€å‘æ–¹å¼å’Œweb.xmlä¸€æ ·, ç›¸å½“äºweb.xmlçš„è¯­æ³•ç³–

  - å…±é€šçº¿

    1.å¼•å…¥servlet-apiå’Œjsp-apiä¾èµ–

    2.å†™Servlet

    å†™ä¸€ä¸ªç±»ç»§æ‰¿HttpServletç±»

    æˆ–è€…é€šè¿‡ideaè‡ªåŠ¨ç”Ÿæˆ

    3.å®ç°doGetæ–¹æ³•å’ŒdoPostæ–¹æ³•

    - çˆ¶ç±»çš„HttpServlet.serviceè¢«æˆ‘ä»¬çš„Servletæ–¹æ³•ç»§æ‰¿äº†, åœ¨è°ƒç”¨æ—¶å¹¶ä¸ç›´æ¥è°ƒç”¨serviceæ–¹æ³•, è€Œæ˜¯è°ƒç”¨serviceæ–¹æ³•, åˆ¤æ–­æ˜¯getè¿˜æ˜¯postç­‰è¯·æ±‚, ç„¶åifåˆ¤æ–­åå†å»è°ƒç”¨å¯¹åº”doGetæ–¹æ³•å’ŒdoPostæ–¹æ³•(åŠ¨æ€ç»‘å®šæœºåˆ¶)

    - è·¯å¾„åŒ¹é…

      - ç²¾å‡†åŒ¹é…

        - /ok åªåŒ¹é…/okè¿™ä¸€ä¸ªurl

      - ç›®å½•åŒ¹é…

        - /ok/* åŒ¹é…å‰ç¼€æ˜¯/ok/çš„

      - æ‰©å±•ååŒ¹é…

        - *.action åç¼€æ˜¯.action, æ¯”å¦‚/ab/c/e/gg.action

      - ä»»æ„åŒ¹é…

      	- /å’Œ/*

      		- åŒ¹é…æ‰€æœ‰è¯·æ±‚

      		- è¿é™æ€èµ„æºhtml,css,js,å›¾ç‰‡ç­‰é™æ€èµ„æºéƒ½ä¼šåŒ¹é…ğŸ˜…

      		- ä¼šè¦†ç›–äº†tomcatçš„web.xmlä¸­é…ç½®çš„DefaultServlet, å¯¼è‡´å¤„ç†ä¸äº†é™æ€èµ„æº, å»ºè®®ä¸è¦ä½¿ç”¨

      - ä¼˜å…ˆçº§: ç²¾å‡†è·¯å¾„>å‰ç¼€>åç¼€>ä»»æ„åŒ¹é…

      - ğŸ˜…ä¸è¦å‘æ˜æ–°åŒ¹é…, /**/a.html, /*/b.html, /**/ab_*.html, éƒ½ä¸ç”Ÿæ•ˆ, åªè¦ä¸Šé¢å››ç§æœ‰æ•ˆ

- Repsonse

	- å“åº”ä¸­æ–‡ä¹±ç æ—¶,åŠ ä¸Šé…ç½®

		- response.setContentType("text/html;utf-8");
response.setCharacterEncoding("utf8");

	- å¸¸ç”¨æ–¹æ³•

		- // æ·»åŠ content-Typeè¯·æ±‚å¤´,å‘Šè¯‰æµè§ˆå™¨ç”¨htmlæ–¹å¼æ¥è§£æ
response.setContentType("text/html;utf-8");

		- // è®¾ç½®çŠ¶æ€ç 
setStatus

		- // è®¾ç½®å“åº”å¤´
setHeader

		- // è·å–å­—ç¬¦æµå¯¹è±¡ç”¨æ¥ç»™clientè¿”å›æ•°æ®
getWriter
- ä¸¤ä¸ªæµåœ¨åŒä¸€æ—¶é—´åªèƒ½ä½¿ç”¨ä¸€ä¸ª
			
- // è·å–å­—èŠ‚æµå¯¹ç”¨æ¥ç»™clientè¿”å›äºŒè¿›åˆ¶æ–‡ä»¶
		getOutputStream

- Request

  - è¯·æ±‚å‚æ•°å€¼ä¹±ç æ—¶,åŠ ä¸Šé…ç½®

  	- request.setCharacterEncoding("utf8");

  - HttpServletRequestè¡¨ç¤ºå®¢æˆ·ç«¯çš„è¯·æ±‚, httpè¯·æ±‚å¤´ä¸­çš„ä¿¡æ¯éƒ½å°è£…åœ¨è¿™ä¸ªå¯¹è±¡,é€šè¿‡å¯¹è±¡çš„æ–¹æ³•å¯ä»¥è·å–å®¢æˆ·ç«¯çš„ä¿¡æ¯

  - å¸¸ç”¨æ–¹æ³•

    - getRequestURI : /req

    - getRequestURL: http://localhost:43999/req

    - getRemoteAddr

    	- å®¢æˆ·ç«¯åœ°å€

    - getHeader("referer")

    	- è·å–è¯·æ±‚å¤´

    - getParameter("username")

    	- è·å–è¯·æ±‚å‚æ•°(è¡¨å•ä¸­çš„,å’Œurlåé¢éƒ½å¯ä»¥)

    - getCookies

    	- è·å–cookie

    - getParameterValues("çˆ±å¥½")

    	- è·å–checkboxå¤é€‰æ¡†ä¸­å¤šå€¼æ•°æ®

    - getMethod

    	- è·å–è¯·æ±‚æ–¹æ³•

    - setAttribute/getAttribute

    	- è®¾ç½®/è·å–åŸŸæ•°æ®

    -  request.getRequestDispatcher("/").forward(request, response)

    	- è½¬å‘

- ServletConfig

  - ä¸ºServletæä¾›é…ç½®ä¿¡æ¯çš„ç±»
    é…ç½®ä¿¡æ¯ä¸å¯æ›´æ”¹(æ²¡æœ‰setæ–¹æ³•)

    - å®šä¹‰é…ç½®ä¿¡æ¯: åœ¨web.xmlä¸­é…ç½®

      ```xml
      <Servlet>é…ç½®ä¿¡æ¯<init-param>
      ```

      

    - è·å–é…ç½®ä¿¡æ¯: 

      ```java
      ServletConfig servletConfig = this.getServletConfig();
      servletConfig.getInitParameter("username")
      ```

      

  - ç”±tomcatåˆ›å»º

  - ServletConfigåœ¨Servletç¨‹åºåˆ›å»ºæ—¶,å°±åˆ›å»ºäº†ä¸€ä¸ªå¯¹åº”çš„ServletConfigå¯¹è±¡

  - é‡å†™initæ–¹æ³•æ—¶(æœ‰å‚çš„é‚£ä¸ª)éœ€è¦è°ƒç”¨super.init(æœ‰å‚)çš„é‚£ä¸ªæ–¹æ³•, å®Œæˆçˆ¶ç±»çš„åˆå§‹åŒ–

- ServletContext

  - Servletä¸Šä¸‹æ–‡å¯¹è±¡,ä¸ºæ‰€æœ‰Servletæä¾›é…ç½®ä¿¡æ¯
    é…ç½®ä¿¡æ¯ä¸å¯æ›´æ”¹,ç”±setæ–¹æ³•,ä½†æ”¹äº†å°±æŠ¥å¼‚å¸¸

    - å®šä¹‰é…ç½®ä¿¡æ¯: åœ¨web.xmlä¸­é…ç½®

      ```xml
      <context-param>
      ```

    - è·å–é…ç½®ä¿¡æ¯: 

      ```java
      ServletContext context = getServletContext()
      String appName = context.getInitParameter("appName");
      ```

      ```java
      // è·å–å·¥ç¨‹è·¯å¾„: /j2025/javaweb åœ¨ideaçš„edit configurationçš„deploymentçš„application Contextä¸­é…ç½®çš„è·¯å¾„
      System.out.println(context.getContextPath());
      // è·å–é¡¹ç›®å‘å¸ƒåçš„ç»å¯¹è·¯å¾„: ~/IdeaProjects/j2025/out/artifacts/fishWeb_Web_exploded/  --> ROOT
      System.out.println(context.getRealPath("/"));
      ```

      

  - ä¸€ä¸ªwebå·¥ç¨‹åªæœ‰ä¸€ä¸ªServletContextå®ä¾‹

  - ç”±tomcatåˆ›å»º,åœ¨webå·¥ç¨‹å¯åŠ¨æ—¶åˆ›å»º, åœ¨webå·¥ç¨‹åœæ­¢æ—¶é”€æ¯

  - è·å–Context, this.getServletContext

  - åŸŸå¯¹è±¡:webåº”ç”¨ä¸­æ‰€æœ‰Servletå…±äº«åŒä¸€ä¸ªContextå¯¹è±¡, Servletå¯ä»¥å€ŸåŠ©Contextå¯¹è±¡æ¥é€šä¿¡

  	- ä¼ é€’æ•°æ®æ–¹æ³•æ˜¯:
  setAttribute(String name, Object object);
  public Object getAttribute(String name);
  è€Œä¸æ˜¯getInitParameter

- è½¬å‘å’Œé‡å®šå‘

  - è¯·æ±‚è½¬å‘

    - å®šä¹‰

      è¯·æ±‚è½¬å‘æŒ‡çš„æ˜¯ä¸€ä¸ªwebèµ„æºæ”¶åˆ°å®¢æˆ·ç«¯çš„è¯·æ±‚å, é€šçŸ¥æœåŠ¡ç«¯å»è°ƒç”¨å¦å¤–ä¸€ä¸ªwebèµ„æºè¿›è¡Œå¤„ç†

    - ä½¿ç”¨

    	- request.getRequestDispatcher("èµ„æºuri").forward(request, response);

    	- requestå¯¹è±¡åŒæ—¶ä¹Ÿæ˜¯ä¸€ä¸ªåŸŸå¯¹è±¡,é€šè¿‡requestå¯¹è±¡åœ¨å®ç°è½¬å‘æ—¶, å¯ä»¥é€šè¿‡requestå¯¹è±¡æŠŠè‡ªå·±çš„æ•°æ®å¸¦ç»™å…¶ä»–webèµ„æº

    		- setAttribute
    getAttribute
    removeAttirbute
    getAttributeNames

    - æ³¨æ„äº‹é¡¹

    	- è¯·æ±‚è½¬å‘çš„åœ°å€æ ä¸ä¼šå‘ç”Ÿæ”¹å˜, çŠ¶æ€ç æ˜¯302

    	- åœ¨åŒä¸€æ¬¡httpè¯·æ±‚ä¸­,è¿›è¡Œå¤šæ¬¡è½¬å‘, ä»ç„¶æ˜¯ä¸€æ¬¡HTTPè¯·æ±‚

    	- è½¬å‘é“¾ä¸Šçš„servletå¯ä»¥å…±äº«requeståŸŸä¸­çš„æ•°æ®, å› ä¸ºæ˜¯åŒä¸€ä¸ªrequestå¯¹è±¡

    	- å¯ä»¥è½¬å‘åˆ°WEB-INFç›®å½•ä¸‹

    	- ä¸èƒ½è®¿é—®åˆ°WEBå·¥ç¨‹å¤–çš„èµ„æº

    	- å› ä¸ºæµè§ˆå™¨åœ°å€æ ä¼šåœæ­¢åœ¨ç¬¬ä¸€ä¸ªservlet, å¦‚æœåˆ·æ–°é¡µé¢,ä¼šå†æ¬¡å‘ç”Ÿè¯·æ±‚å¹¶æºå¸¦æ•°æ®, æ‰€ä»¥åœ¨æ”¯ä»˜é¡µé¢ä¸Š, ä¸è¦ä½¿ç”¨è¯·æ±‚è½¬å‘, å¦åˆ™ä¼šé€ æˆé‡å¤æ”¯ä»˜

  - é‡å®šå‘

    - å®šä¹‰

      ä¸€ä¸ªwebèµ„æºæ”¶åˆ°å®¢æˆ·ç«¯è¯·æ±‚å, é€šçŸ¥å®¢æˆ·ç«¯å»è®¿é—®å¦å¤–ä¸€ä¸ªwebèµ„æº (2æ¬¡è¯·æ±‚, å¤šè·‘ä¸€è¶Ÿ)

    - ç”¨æ³•

    	- ç¬¬ä¸€ç§æ–¹æ³•: reponse.sendRedirect("èµ„æºä½ç½®") (æ¨è)

    	- ç¬¬äºŒç§æ–¹æ³•
    response.setStatus(302)
    response.setHeader("Location","/downloadNew)

    - æ³¨æ„äº‹é¡¹

      - æµè§ˆå™¨urlåœ°å€æ˜¯é‡å®šå‘çš„åœ°å€, æ˜¯2æ¬¡httpè¯·æ±‚

      - ç¬¬ä¸€æ¬¡è¯·æ±‚å“åº”ç ä¸º302,å“åº”å¤´Locationä¸ºé‡å®šå‘çš„åœ°å€

      - é‡å®šå‘æ˜¯æµè§ˆå™¨æ¥è§£æ, ä¸æ˜¯æœåŠ¡ç«¯è§£æ,æ‰€ä»¥urlæœ€å¥½å†™å·¥ç¨‹çš„å…¨è·¯å¾„, /xxxServlet/xxx/bbServlet

        - åŠ¨æ€è·å–èµ„æºç»å¯¹è·¯å¾„:

          ```java
          sendRedirect(getServletContext.getContextPath + "/resoucrepath")
          ```

      - ä¸èƒ½å…±äº«RequeståŸŸä¸­çš„æ•°æ®, æœ¬è´¨ä¸Šæ˜¯ä¸¤æ¬¡httpè¯·æ±‚, ä¼šç”Ÿæˆä¸¤ä¸ªRequestå¯¹è±¡

      - ä¸èƒ½é‡å®šå‘åˆ°/WEB-INFç›®å½•ä¸‹çš„èµ„æº

      - å¯ä»¥é‡å®šå‘webå·¥ç¨‹ä»¥å¤–çš„èµ„æº,æ¯”å¦‚www.google.com

    - å…¸å‹åº”ç”¨åœºæ™¯

    	- ç½‘ç«™åŸŸåè¿ç§»



## ä¼šè¯æŠ€æœ¯Cookieå’ŒSession

### Cookie

- cookieåŸç†

  - Cookieåˆ›å»ºè¿‡ç¨‹

    - æµè§ˆå™¨è¯·æ±‚æœåŠ¡å™¨æ—¶,,æœåŠ¡å™¨åˆ›å»ºCookieå¯¹è±¡, æ·»åŠ åˆ°å“åº”ä¸­,å¹¶è¿”å›ç»™æµè§ˆå™¨

      ```java
      Cookie cookie = new Cookie("userId","123")
      response.addCookie(cookie)
      ```

    æµè§ˆå™¨æ”¶åˆ°httpè¯·æ±‚æ—¶, è§£æå“åº”å¤´
    Set-Cookie: userId=123
    æŠŠuserId=123ä¿å­˜åœ¨æœ¬åœ°cookieä¸­

  - Cookieæ˜¯æœåŠ¡å™¨åœ¨å®¢æˆ·ç«¯ä¿å­˜ç”¨æˆ·çš„ä¿¡æ¯, æ¯”å¦‚ç™»å½•å, æµè§ˆå†å²ç­‰, å°±å¯ä»¥ä½¿ç”¨Cookieæ–¹å¼ä¿å­˜

  - Cookieçš„æ•°æ®é‡ä¸å¤§, æœåŠ¡å™¨åœ¨éœ€è¦æ—¶å¯ä»¥ä»å®¢æˆ·ç«¯/æµè§ˆå™¨è¯»å–Cookie

    - æµè§ˆå™¨æ¯æ¬¡è¯·æ±‚æ—¶,éƒ½ä¼šæºå¸¦Cookieè¯·æ±‚å¤´

      - Cookie: JSESSIONID=E72676B5952D59BD7A5BA5BE3FE88568; userId=123

  - Cookieæ˜¯ä¿å­˜åœ¨æµè§ˆå™¨ä¸Šçš„(å…¶å®æ˜¯æµè§ˆå™¨ä¿å­˜åˆ°æœ¬åœ°æ–‡ä»¶ä¸­çš„, å¾ˆå¤šç½‘ç«™åœ¨è®¿é—®æ—¶éƒ½è¦æ±‚ä½ åŒæ—¶ä½¿ç”¨Cookie,å¦åˆ™ç½‘ç«™ä¸èƒ½æ­£å¸¸ä½¿ç”¨

- Cookieå¸¸ç”¨æ–¹æ³•

  - Cookieæœ‰ç‚¹åƒä¸€å¼ è¡¨, åˆ†ä¸ºä¸¤åˆ—, ä¸€ä¸ªæ˜¯é‚£ä¹ˆ, ä¸€ä¸ªæ˜¯value, æ•°æ®ç±»å‹éƒ½æ˜¯String

  - åˆ›å»ºCookie, cookieçš„åå­—æ˜¯å”¯ä¸€çš„

    ```java
    Cookie c = new Cookie(String name, String val);
    c.setMaxAge();// ä¿å­˜æ—¶é—´
    ```

  - æŠŠåˆ›å»ºçš„Cookieæ·»åŠ åˆ°å®¢æˆ·ç«¯

    ```java
    response.addCookie(c)
    ```

  - 4.è¯»å–Cookie

    ```java
    request.getCookies();
    ```

    è·å–Cookieå’Œåˆ›å»ºCookieå’Œæ›´æ–°Cookie(æ›´æ”¹Cookieå’Œåˆ›å»ºCookieæ–¹æ³•æ˜¯ä¸€æ ·çš„)

    ```java
    Cookie[] cookies = request.getCookies();
    boolean isCookieExist = false;
    for (Cookie cookie : cookies) {
      if (cookie.getName().equals("userId")) {
        Cookie userId = new Cookie("userId", WebUtil.parseInt(cookie.getValue()) + 1 + "");
        response.addCookie(userId);
        isCookieExist = true;
      }
    	System.out.printf("%s = %s\n", cookie.getName(), cookie.getValue());
    }
    if (!isCookieExist) {
      Cookie userId = new Cookie("userId", "123");
      response.addCookie(userId);
    }
    ```

    

- JSESSIONID

  - æœåŠ¡å™¨ç”¨æ¥åŒºåˆ†å’Œå“ªä¸ªæµè§ˆå™¨ä¼šè¯, å³ç”¨æ¥åŒºåˆ«ä¸åŒçš„ä¼šè¯

- Cookieçš„ç”Ÿå‘½å‘¨æœŸ

  - cookieçš„å£°æ˜å‘¨æœŸæ˜¯æŒ‡Cookieä»€ä¹ˆæ—¶å€™è¢«é”€æ¯

  - é€šè¿‡setMaxAgeæ–¹æ³•è®¾ç½®å¤šä¹…è¿‡æœŸ

    - æ­£æ•°: å¤šå°‘ç§’åè¿‡æœŸ

    - è´Ÿæ•°, è¡¨ç¤ºæµè§ˆå™¨å…³é—­, Cookieå°±ä¼šè¢«åˆ é™¤(é»˜è®¤å€¼æ˜¯-1, ä¼šè¯çº§åˆ«)

    - 0, è¡¨ç¤ºé©¬ä¸Šåˆ é™¤

    - å“åº”å¤´ä¼šåŠ ä¸Šä¸€ä¸ªmax-Ageå’Œè¿‡æœŸäº‹ä»¶
      Set-Cookie: userId=130; Max-Age=7200; Expires=Sat, 22 Feb 2025 17:25:30 GMT

- Cookieçš„pathå±æ€§

  - Cookieçš„pathå±æ€§å¯ä»¥æœ‰æ•ˆçš„è¿‡æ»¤å“ªäº›Cookieå¯ä»¥åˆ†çˆ±é€ç»™æœåŠ¡å™¨, å“ªäº›ä¸å‘ç»™æœåŠ¡å™¨, pathå±æ€§æ˜¯é€šè¿‡è¯·æ±‚çš„åœ°å€æ¥è¿›è¡Œæœ‰æ•ˆçš„è¿‡æ»¤

    - Set-Cookie: password=123root; Path=/webpath/CookiePathServlet

  - è§„åˆ™

    - cookie1.setPath=/webpath
      cookie2.setPath=/webpath/aaa
      è¯·æ±‚åœ°å€http://ip:port/webpath/resource
      cookie1ä¼šå‘é€ç»™æœåŠ¡å™¨
      cookie2ä¸ä¼šå‘é€ç»™æœåŠ¡å™¨
      è¯·æ±‚åœ°å€ http://ip:port/webpath/aaa/èµ„æº
      cookie1ä¼šå‘é€
      cookie2ä¼šå‘é€
      pathæ˜¯å‰ç¼€åŒ¹é…çš„

- ç»†èŠ‚

  - ä¸€ä¸ªCookieåªèƒ½æ ‡è¯†ä¸€ç§ä¿¡æ¯, ä»–æœ‰ä¸€ä¸ªnameå’Œvalueå¯¹

  - ä¸€ä¸ªwebç«™ç‚¹å¯ä»¥ç»™ä¸€ä¸ªæµè§ˆå™¨å‘é€å¤šä¸ªCookie, ä¸€ä¸ªæµè§ˆå™¨ä¹Ÿå¯ä»¥å­˜å‚¨å¤šä¸ªwebç«™ç‚¹æä¾›çš„cookie

  - cookieçš„æ€»æ•°æ²¡æœ‰é™åˆ¶, ä½†æ˜¯æ¯ä¸ªåŸŸåçš„cookieæ•°é‡å’Œcookieå¤§å°æ˜¯æœ‰é™åˆ¶çš„, cookieä¸é€‚åˆå­˜å‚¨æ•°é‡å¤§çš„ä¿¡æ¯

  - åˆ é™¤cookieæ—¶, å¿…é¡»ä¿æŒpathä¸€è‡´, å¦åˆ™ä¸èƒ½åˆ é™¤

  - ä¸­æ–‡cookieä¸€èˆ¬æ¥è¯´ä¸æ”¯æŒ(è®¾ç½®å­—ç¬¦é›†ä¸ºutf8æ—¶å¯ä»¥æ”¯æŒ),ä¹Ÿå¯ä»¥ä½¿ç”¨URLç¼–ç æ¥è§£å†³, URLEncoder,URLDecoder

### Session

- å®šä¹‰

  - Sessionæ˜¯æœåŠ¡ç«¯æŠ€æœ¯, æœåŠ¡å™¨åœ¨è¿è¡Œæ—¶ä¸ºæ¯ä¸€ä¸ªç”¨æˆ·çš„æµè§ˆå™¨åˆ›å»ºä¸€ä¸ªå…¶ç‹¬äº«çš„Sessionå¯¹è±¡/é›†åˆ

  - ç”±äºsessionä¸ºå„ä¸ªç”¨æˆ·æµè§ˆå™¨ç‹¬äº«, æ‰€ä»¥åœ¨ç”¨æˆ·è®¿é—®æœåŠ¡å™¨çš„ä¸åŒé¡µé¢æ—¶, å¯ä»¥ä»å„è‡ªçš„Sessionä¸­è¯»å–/æ·»åŠ æ•°æ®,ä»è€Œå®Œæˆå“åº”ä»»åŠ¡

- åŸç†

  - åˆ›å»ºè¿‡ç¨‹

    - å½“ç”¨æˆ·è¯·æ±‚æœåŠ¡å™¨æ—¶, æ“ä½œSessionæ—¶(è°ƒç”¨request.getSession(æ–¹æ³•)), æœåŠ¡å™¨å°±ä¼šåœ¨å†…å­˜ä¸­ä¸ºè¯¥æµè§ˆå™¨åˆ†é…ä¸€ä¸ªSessionå¯¹è±¡, è¯¥Sessionå¯¹è±¡è¢«è¿™ä¸ªæµè§ˆå™¨(ä¼šè¯)ç‹¬å 

    - è¯·æ±‚æ˜¯å¦æœ‰jsessionidçš„cookie

      - æ— 

        - è¯·æ±‚æ—¶,å¦‚æœæ²¡æœ‰æºå¸¦jsessionid, æ–°å»ºsessionå¯¹è±¡, åˆ†é…jessionId: å“åº”æ—¶æ·»åŠ set-cookie: jsessionid=xxxxxxx,å“åº”å¤´, æ·»åŠ jsessionidçš„cookie

      - æœ‰

        - æ˜¯å¦æœ‰id=jsessionidçš„Sessionå¯¹è±¡

          -  æœ‰

             - è·å–Session,æ“ä½œsession

          -  æ— 

             - è¿™æ˜¯æƒ…å†µ, æ˜¯æœåŠ¡ç«¯é‡å¯, æµè§ˆå™¨æ²¡æœ‰å…³é—­
               åˆ›å»ºsessionå¯¹è±¡åˆ†é…jsessionid, æ³¨æ„è¿™ä¸ªsessionidå’ŒåŸæ¥çš„ä¸ä¸€æ ·

  - å•ä¸ªSessionçš„ç»“æ„

    - ç±»ä¼¼ä¸€ä¸ªhashmapå¯¹è±¡, æœ‰é”®å€¼å¯¹<String,Object>

  - æœåŠ¡ç«¯å¤šä¸ªSessionç»“æ„

    - Map<jsessionid, Session> ---> Map<jsessionid, Map<String, Object>(å®é™…ä¸Šæ˜¯concurrentHashMap)

- ä½¿ç”¨

  - å¸¸ç”¨æ–¹æ³•

    - åˆ›å»ºSession

      - è·å–å’Œå½“å‰Requestå…³è”çš„session, å¦‚æœæœ‰å°±è¿”å›, å¦‚æœæ²¡æœ‰å°±åˆ›å»ºä¸€ä¸ªsession
        request.getSession()

    - å‘sessionæ·»åŠ å±æ€§

      - addAttribute(String name, Object val)

    - è·å–sessionçš„æŸä¸ªå±æ€§

      - getAttribute(String name)

    - åˆ é™¤

      - removeAttribute

    - åˆ¤æ–­æ˜¯å¦ä¸ºæ–°å»ºçš„session

      - isNew()

    - è·å–sessionçš„æ ‡è¯†Id

      - æ¯ä¸ªsessionéƒ½æœ‰ä¸€ä¸ªå”¯ä¸€çš„æ ‡è¯†id
        getId()æ–¹æ³•å¯ä»¥è·å–

- ç”Ÿå‘½å‘¨æœŸ

  - é»˜è®¤ç”Ÿå‘½å‘¨æœŸ

    - åœ¨Tomcatçš„web.xmlä¸­å¯ä»¥é…ç½®, é»˜è®¤æ˜¯30min

      ```xml
      <session-config>
      ```

  - é€šè¿‡æ–¹æ³•è®¾ç½®è¿‡æœŸæ—¶é—´

    - session.setMaxInactiveInterval(30)

      - æ­£æ•°, å¤šå°‘ç§’è¿‡æœŸ

      - è´Ÿæ•°, æ°¸ä¸è¿‡æœŸ

        - æœåŠ¡ç«¯é‡å¯å°±æ²¡äº†

    - é”€æ¯sessionå¯¹è±¡

      - session.invalidate()

  - Sessionçš„ç”Ÿå‘½å‘¨æœŸæŒ‡çš„æ˜¯, å®¢æˆ·ç«¯/ä¸¤æ¬¡è¯·æ±‚æœ€å¤§é—´éš”æ—¶é•¿, è€Œä¸æ˜¯ç´¯è®¡æ—¶é•¿. å½“å®¢æˆ·ç«¯è®¿é—®äº†è‡ªå·±çš„session, Sessionçš„ç”Ÿå‘½å‘¨æœŸå°†ä¼šä»0å¼€å§‹è®¡ç®—(åŒä¸€ä¸ªä¼šè¯ä¸¤æ¬¡è¯·æ±‚ä¹‹é—´çš„é—´éš”)

  - tomcatä½¿ç”¨ä¸€ä¸ªçº¿ç¨‹æ¥è½®è¯¢ä¼šè¯çŠ¶æ€, å¦‚æœæŸä¸ªä¼šè¯çš„ç©ºé—²äº‹ä»¶è¶…è¿‡æ—¶é—´è®¾å®šçš„æœ€å¤§å€¼, åˆ™ä¼šé”€æ¯è¯¥Session

- sessionèƒ½åšä»€ä¹ˆ

  - ç½‘ä¸Šå•†åŸçš„è´­ç‰©è½¦

  - ä¿å­˜ç”¨æˆ·çš„ä¿¡æ¯

  - å°†æ•°æ®æ”¾å…¥Sessionä¸­,ä¾›ç”¨æˆ·åœ¨è®¿é—®ä¸åŒçš„é¡µé¢æ—¶, å®ç°è·¨é¡µé¢è®¿é—®æ•°æ®

  - é˜²æ­¢ç”¨æˆ·æ²¡æœ‰ç™»å½•, å°±è¿›å…¥åˆ°ç™»å½•æ‰èƒ½è®¿é—®çš„é¡µé¢



## ç›‘å¬å™¨å’Œè¿‡æ»¤å™¨

### ç›‘å¬å™¨

- å®šä¹‰

  - javawebçš„ä¸‰å¤§ç»„ä»¶, ç›‘å¬å™¨ç›‘å¬æŸç§å˜åŒ–(å¯¹è±¡åˆ›å»º/é”€æ¯,å±æ€§å˜åŒ–),è§¦å‘å¯¹åº”æ–¹æ³•å®Œæˆä»»åŠ¡

- å¸¸ç”¨ç›‘å¬å™¨

  - ServletContextListeneræ¥å£

    - ä½œç”¨:ç›‘å¬ServletContextåˆ›å»ºæˆ–è€…é”€æ¯(webåº”ç”¨å¯åŠ¨æ—¶, å°±ä¼šåˆ›å»ºServletContext),å³ç”Ÿå‘½å‘¨æœŸç›‘å¬, åº”ç”¨: åŠ è½½springçš„é…ç½®æ–‡ä»¶, ä»»åŠ¡è°ƒåº¦(é…åˆå®šæ—¶å™¨Timer/TimerTask)

    - å¸¸ç”¨æ–¹æ³•

      - åˆ›å»ºæ—¶è§¦å‘
        public void contextInitialized(ServletContextEvent sce)

      - é”€æ¯æ—¶è§¦å‘
        public void contextDestroyed(ServletContextEvent sce)

    - ä½¿ç”¨

      - å®šä¹‰ä¸€ä¸ªç±»å®ç°ServletContextListeneræ¥å£,åœ¨web.xmlä¸­å†™æ ‡ç­¾

        ```xml
         <listener>
        ```

  - ServletContextAttributeListener

    - ä½œç”¨ç›‘å¬ServletContextå±æ€§å˜åŒ–

    - æ–¹æ³•

      - attributeAdded

        - æ·»åŠ å±æ€§æ—¶è°ƒç”¨

      - attributeRemoved

        - åˆ é™¤å±æ€§æ—¶è°ƒç”¨

      - attributeReplaced

        - æ›¿æ¢å±æ€§å€¼æ—¶è°ƒç”¨

  - HttpSessionListener

    - ä½œç”¨:ç›‘å¬Sessionçš„åˆ›å»ºæˆ–é”€æ¯(ç”Ÿå‘½å‘¨æœŸ)

    - æ–¹æ³•

      - sessionCreated

        - sessionåˆ›å»ºæ—¶è°ƒç”¨

      - sessionDestroyed

        - sessioné”€æ¯æ—¶è°ƒç”¨

    - ä½¿ç”¨æ¡ˆä¾‹, ç›‘æ§ç”¨æˆ·ä¸Šä¸‹çº¿

  - HttpSessionAttributeListener

    - ä½œç”¨:ç›‘å¬Sessionå±æ€§çš„å˜åŒ–

    - æ–¹æ³•

      - attributeAdded

        - æ·»åŠ å±æ€§æ—¶è°ƒç”¨

      - attributeRemoved

        - åˆ é™¤å±æ€§æ—¶è°ƒç”¨

      - attributeReplaced

        - æ›¿æ¢å±æ€§å€¼æ—¶è°ƒç”¨

  - ServletRequestListener

    - ç›‘å¬requestçš„åˆ›å»ºå’Œé”€æ¯

    - æ–¹æ³•

      - requestInitialized

      - requestDestroyed

    - ä½¿ç”¨æ¡ˆä¾‹,å¯ä»¥ç”¨æ¥ç›‘æ§æŸä¸ªIPè®¿é—®ç½‘ç«™çš„é¢‘ç‡, æ—¥å¿—è®°å½•,è®¿é—®èµ„æº

  - å…¶ä»–ç›‘å¬å™¨

    - ServletRequestAttributeListener

    - HttpSessionBindingListener

    - HttpSessionActivationListener

### è¿‡æ»¤å™¨

- è¿‡æ»¤å™¨çš„å¿…è¦æ€§

  - ç™»å½•æ ¡éªŒ, æƒé™æ ¡éªŒ,è®°å½•æ—¥å¿—,äº‹åŠ¡å¤„ç†ç­‰ç­‰,å¦‚æœåœ¨æ¯ä¸ªServletå‰é¢åŠ ä¸Šæ ¡éªŒå°±å¾ˆç¹ç,ä»£ç å†—ä½™

- å®šä¹‰

  - javawebçš„ä¸‰å¤§ç»„ä»¶ä¹‹ä¸€,è¿‡æ»¤å™¨Filteræ˜¯javaEEçš„æ¥å£, æœ‰ä¸‰ä¸ªæ–¹æ³•init, doFilter,destroy, éœ€è¦åœ¨web.xmlä¸­é…ç½®æ ‡ç­¾å’Œè¿‡æ»¤è·¯å¾„

    ```xml
    <filter>
    ```

- ä½œç”¨

  - æ‹¦æˆªè¯·æ±‚

  - è¿‡æ»¤å“åº”

- åŸç†

  - 1.åœ¨web.xmlä¸­é…ç½®è¿‡æ»¤å™¨, æŒ‡å®šè¿‡æ»¤è§„åˆ™url-pattern
    2.å¦‚æœåŒ¹é…url-pattern,å°±èµ°è¿‡æ»¤å™¨
    3.å¦‚æœä¸åŒ¹é…å°±ç›´æ¥è®¿é—®

  - ç”Ÿå‘½å‘¨æœŸ

    - Filteré»˜è®¤ä¸æ˜¯æ‡’åŠ è½½

    - Filteræ¥å£æœ‰ä¸‰ä¸ªæ–¹æ³•init, doFilter, destroyåˆ†åˆ«å¯¹åº”Servletçš„init,service, destroyåŸºæœ¬ä¸€è‡´

  - tomcatåœ¨åå°„è°ƒç”¨æ—¶Servlet.serviceæ–¹æ³•ä¹‹å‰ä¼šåˆ¤æ–­filterMapçš„urlè·¯å¾„å’ŒServletè·¯å¾„æ˜¯å¦åŒ¹é…, åŒ¹é…å°±ä¼šåœ¨è°ƒç”¨serviceä¹‹å‰è°ƒç”¨doFilteræ–¹æ³•, å¦‚æœæ”¾è¡Œ, å°±ç»§ç»­è°ƒç”¨service, å¦‚æœä¸æ”¾è¡Œå°±ä¸ç”¨è°ƒç”¨service

  - filteråœ¨webé¡¹ç›®å¯åŠ¨æ—¶, æœ‰tomcatåˆ›å»º, åªä¼šåˆ›å»ºä¸€æ¬¡, åˆ›å»ºæˆåŠŸæ—¶ä¼šè°ƒç”¨initæ–¹æ³•, åªè°ƒç”¨ä¸€æ¬¡, åœ¨åˆ›å»ºfilteræ—¶ä¼šåˆ›å»ºä¸€ä¸ªfilterConfigå¯¹è±¡,é€šè¿‡initæ–¹æ³•ä¼ å…¥, é€šè¿‡filterConfigå¯¹è±¡,å¯ä»¥è·å–éƒ½åœ¨web.xmlä¸­filterçš„<init-param>é…ç½®ä¿¡æ¯, å½“ä¸€ä¸ªhttpè¯·æ±‚çš„uriè·¯å¾„å’Œfilterçš„url-patternåŒ¹é…æ—¶, å°±ä¼šè°ƒç”¨doFilteræ–¹æ³•, åœ¨è°ƒç”¨doFilteræ–¹æ³•æ—¶, tomcatä¼šä¼ å…¥requestå’ŒResponseå’ŒFilterChainä¸‰ä¸ªå‚æ•°, å¹¶é€šè¿‡Filterä¼ å…¥, å¦‚æœåé¢è¯·æ±‚çš„æ•°æ®åº“è¯·æ±‚ç›®æ ‡èµ„æº,jsp,Servlet,ä¼šä½¿ç”¨åˆ°request, æ¯”å¦‚ç™»å½•æ ¡éªŒ, è¿‡æ»¤è„è¯

  - æ”¾è¡Œ

    - è°ƒç”¨filterChain.doFilteræ–¹æ³•,å¦‚æœæ²¡æœ‰å†™è¿™ä¸ªæ–¹æ³•ä¼šè¿”å›ç©ºç™½é¡µé¢,ä¸€èˆ¬å†™ä¸ªè½¬å‘æˆ–è€…é‡å®šå‘åˆ°ç™»å½•é¡µé¢å»

    - æ”¾è¡Œå, ä¼šç»§ç»­è®¿é—®ç›®æ ‡èµ„æº, ServletRequest, ServletResponseä¼šç»§ç»­ä¼ é€’ç»™ç›®æ ‡èµ„æº

  - FilterConfigçš„æ–¹æ³•

    - getServletContext  è·å–åº”ç”¨åŸŸ
      getInitParameter è·å–é…ç½®å‚æ•°Byå‚æ•°å
      getInitParameterNames è·å–æ‰€æœ‰é…ç½®å‚æ•°å
      getFilterName è·å–è¿‡æ»¤å™¨çš„åå­—

      - ä½¿ç”¨æ¡ˆä¾‹,å°æ€ip

        ```java
        public void doFilter(ServletRequest request, ServletResponse response, FilterChain chain){
          // å°æ€ip, åœ¨initæ–¹æ³•ä¸­ç»™banIpèµ‹å€¼, ä»initParamä¸­è·å–
          if (request.getRemoteAddr().startsWith(banIp)) {
          System.out.println("~~~~å°æ€è¯¥ç½‘æ®µip~~~ " + request.getRemoteAddr());
          ((HttpServletResponse) response)
                .sendRedirect(request.getServletContext().getContextPath() + "/login.jsp");
          } else {
          System.out.println("éç›®æ ‡ipæ®µæ”¾è¡Œ~~~~~~~ " + request.getRemoteAddr());
          chain.doFilter(request, response);
        	}
        }
        ```

        

- ç»†èŠ‚è¯´æ˜

  - æ³¨æ„tomcatçš„ç‰ˆæœ¬å·å’ŒServlet-apiä¾èµ–çš„ç‰ˆæœ¬å·ä¹‹é—´çš„å¯¹åº”å…³ç³»

  - url-pattern

    - å’ŒServletåŒ¹é…æ¨¡å¼ä¸€æ ·, æ³¨æ„æ˜¯æœåŠ¡ç«¯, æ‰€ä»¥ / è¡¨ç¤ºå·¥ç¨‹è·¯å¾„å/åé¢çš„ä¸œè¥¿, 
    - æ³¨æ„/*è¡¨ç¤ºæ‹¦æˆªæ‰€æœ‰è¯·æ±‚, / ä»€ä¹ˆéƒ½æ‹¦æˆªä¸äº†, 
    - åç¼€åŒ¹é…, *.do, *.action, *
    - *å‰ç¼€åŒ¹é…/xxx/*, ä¸èƒ½åœ¨åŒ¹é…æ–‡ä»¶å,filteråªå…³å¿ƒè·¯å¾„æ˜¯å¦åŒ¹é…, è‡³äºè·¯å¾„åçš„èµ„æºæ˜¯å¦å­˜åœ¨, å®ƒä¸ç®¡

- è¿‡æ»¤å™¨é“¾

  - FilterChain:åœ¨å¤„ç†å¤æ‚ä¸šåŠ¡æ—¶, ä¸€ä¸ªè¿‡æ»¤å™¨ä¸å¤Ÿ, å¯ä»¥è®¾è®¡å¤šä¸ªè¿‡æ»¤å™¨å…±åŒå®Œæˆä»»åŠ¡,å½¢æˆè¿‡æ»¤å™¨é“¾

  - åŸç†

    - FilterChainæ‰§è¡Œé¡ºåº: 
      Httpè¯·æ±‚-->AFilter-->AFilterçš„å‰ç½®ä»£ç -->AdoFilter-->BFilter-->BFilterå‰ç½®ä»£ç -->BdoFilter-->ç›®æ ‡èµ„æº-->Båç½®ä»£ç -->Aåç½®ä»£ç -->è¿”å›ç»™æµè§ˆå™¨é¡µé¢/æ•°æ®

    - å¤šä¸ªFilterå’Œç›®æ ‡èµ„æºåœ¨ä¸€æ¬¡è¯·æ±‚, åœ¨åŒä¸€ä¸ªçº¿ç¨‹ä¸­

    - å½“ä¸€ä¸ªè¯·æ±‚çš„urlå’ŒFilterçš„url-patternPåŒ¹é…æ—¶,æ‰ä¼šæ‰§è¡Œ, å¦‚æœæœ‰å¤šä¸ªåŒ¹é…, å°±ä¼šå½¢æˆä¸€ä¸ªfilterè°ƒç”¨é“¾(æ ˆæ•°æ®ç»“æ„)

    - å¤šä¸ªfilterå…±åŒæ‰§è¡Œæ—¶, å› ä¸ºæ˜¯åŒä¸€ä¸ªhttpè¯·æ±‚, æ‰€ä»¥å…±åŒä½¿ç”¨ä¸€ä¸ªreqeustå¯¹è±¡

    - å¤šä¸ªFilteræ‰§è¡Œé¡ºåºå’Œå’Œweb.xmlçš„é…ç½®é¡ºåºä¿æŒä¸€è‡´

    - chain.doFilter(req,resp)æ–¹æ³•, å°†æ‰§è¡Œä¸‹ä¸€ä¸ªè¿‡æ»¤å™¨çš„doFilteræ–¹æ³•, å¦‚æœåé¢æ²¡æœ‰è¿‡æ»¤å™¨, åˆ™æ‰§è¡Œç›®æ ‡èµ„æº

- è½¬å‘ä¸èµ°è¿‡æ»¤å™¨

  - è½¬å‘é»˜è®¤ä¸èµ°è¿‡æ»¤å™¨,è¿‡æ»¤å™¨é»˜è®¤ä¸æ‹¦æˆªå†…éƒ¨çš„è¯·æ±‚

  - è¦æƒ³èµ°è¿‡è¿‡æ»¤å™¨éœ€è¦é…ç½®

    ```java
    <filter>
      <filter-name>TestFilter</filtername>
      <filter-class>anni.TestFilter</filter-class>
    </filter>
    <filter-mapping>
      <filter-name>TestFilter</filtername>
      <url-pattern>/*</url-pattern>
    <!-- è®©è½¬å‘èµ°è¿‡æ»¤å™¨çš„é…ç½® -->  
      <dispatcher>REQUEST</dispatcher>
      <dispatcher>FORWARD</dispatcher>
      <dispatcher>INCLUDE</dispatcher>
      <dispatcher>EXCEPTION</dispatcher>
    </filter-mapping>
    ```

    

## æ–‡ä»¶ä¸Šä¼ /ä¸‹è½½

### ä¸Šä¼ 

- å‡†å¤‡jaråŒ…
commons-fileupload
commos-io

- è¡¨å•å±æ€§è®¾ç½®

  - inputçš„typeæŒ‡å®šä¸ºfile

  - æ–¹æ³•ä¸ºpostæ–¹æ³•(æ–‡ä»¶æ¯”è¾ƒå¤§)

  - formçš„enctype(encodetype)ç¼–ç ç±»å‹,é»˜è®¤æ˜¯application/x-www-form-urlencodedå³urlç¼–ç , è¿™ç§ç¼–ç ä¸é€‚åˆäºŒè¿›åˆ¶æ•°æ®æäº¤, ä¸€èˆ¬é€‚ç”¨äºæ–‡æœ¬

  - å¦‚æœè¦è¿›è¡ŒäºŒè¿›åˆ¶æ–‡ä»¶æäº¤, enctypeè¦è®¾ç½®ä¸ºmultipart/form-data, è¡¨ç¤ºè¡¨å•æäº¤çš„æ•°æ®æœ‰å¤šä¸ªéƒ¨åˆ†ç»„æˆ, ä¹Ÿå°±æ˜¯å¯ä»¥æäº¤äºŒè¿›åˆ¶æ•°æ®å’Œæ–‡æœ¬æ•°æ®, ä½¿ç”¨äº†è¯¥ç±»å‹,
    åç«¯ä½¿ç”¨request.getParameterå°±å¤±æ•ˆäº†

- æœåŠ¡ç«¯æ¥æ”¶

	- åˆ¤æ–­æ˜¯å¦ä¸ºä¸€ä¸ªæ–‡ä»¶è¡¨å•

	- åˆ¤æ–­è¡¨å•æäº¤çš„å„ä¸ªè¡¨å•é¡¹æ˜¯ä»€ä¹ˆç±»å‹

	- å¦‚æœæ˜¯ä¸€ä¸ªæ™®é€šçš„è¡¨å•é¡¹, å°±æŒ‰ç…§æ–‡æœ¬çš„æ–¹å¼æ¥å¤„ç†

	- å¦‚æœæ˜¯ä¸€ä¸ªæ–‡ä»¶è¡¨å•é¡¹(äºŒè¿›åˆ¶æ•°æ®)ä½¿ç”¨IOæŠ€æœ¯è¿›è¡Œå¤„ç†

	- æŠŠè¡¨å•æäº¤çš„æ–‡ä»¶ä¿å­˜åˆ°æŒ‡å®šçš„ç›®å½•ä¸‹

	- æ–‡ä»¶è¦†ç›–é—®é¢˜

		- å¯¹ä¸Šä¼ çš„æ–‡ä»¶åè¿›è¡Œå¤„ç†, å‰é¢åŠ ä¸Šä¸€ä¸ªå‰ç¼€(UUID)æˆ–æ—¶é—´æˆ³,ä¿è¯æ˜¯å”¯ä¸€çš„

- å®ä¾‹

  - å‰ç«¯

    ```html
    <%@ page contentType="text/html;charset=UTF-8" language="java" %>
    <html>
        <head>
            <title>ä¸Šä¼ æ–‡ä»¶</title>
            <base href="${pageContext.request.getContextPath()}">
            <script src="js/jquery-3.7.1.min.js" type="text/javascript"></script>
            <script type="text/javascript">
                function prev(event) {
                    // è·å–æ–‡ä»¶å¯¹è±¡
                    let file = event.files[0];
                    // è·å–æ–‡ä»¶é˜…è¯»å™¨
                    let reader = new FileReader();
                    reader.readAsDataURL(file);
                   // base64çš„å½¢å¼çš„å›¾ç‰‡
                    reader.onload = function () {
                        $("#preView").attr('src', this.result)
                    };
                }
            </script>
        </head>
        <body>
            <form action="UploadServlet" method="post" enctype="multipart/form-data">
                å›¾ç‰‡:<img src="img/a.jpeg" width="200px" id="preView"> <br>
                <input type="file" name="pic" value="2xxx.jpg" onchange="prev(this)"><br>
                å›¾ç‰‡äººç‰©:<input type="text" name="username"><br>
                <input type="submit" value="ä¸Šä¼ ">
            </form>
        </body>
    </html>
    ```

    

  - åç«¯

    ```java
    // åˆ¤æ–­æ˜¯å¦ä¸ºæ–‡ä»¶è¡¨å•(enctype=multipart/form-data)
    if (ServletFileUpload.isMultipartContent(request)) {
      System.out.println("æ˜¯æ–‡ä»¶è¡¨å•");
      // åˆ›å»ºä¸€ä¸ª
      DiskFileItemFactory diskFileItemFactory = new DiskFileItemFactory();
      ServletFileUpload servletFileUpload = new ServletFileUpload(diskFileItemFactory);
      try {
        // servletFileUploadå¯¹è±¡å¯ä»¥è¡¨å•æäº¤çš„æ•°æ®text/æ–‡ä»¶,å°†å…¶å°è£…åˆ°FileItemæ–‡ä»¶é¡¹ä¸­
        // name=a.jpeg, StoreLocation=~/tomcat/temp/upload_45fb0d4e_b017_47d2_a35c_7e1f3cc4f6c6_00000000.tmp,
        // size=295675 bytes, isFormField=false, FieldName=pic
        // name=null, StoreLocation=null, size=5 bytes, isFormField=true, FieldName=name
        List<FileItem> fileItems = servletFileUpload.parseRequest(request);
        for (FileItem fileItem : fileItems) {
          System.out.println(fileItem);
          // éæ–‡ä»¶è¡¨å•é¡¹,å³type!=file
          if (fileItem.isFormField()) {
            // usernameçš„value = ganyu
            // System.out.println(fileItem.getFieldName() + "çš„value = " + fileItem.getString());
          } else {
            // a.jpeg
            String filename = fileItem.getName();
            // åŠ ä¸Šéšæœºå‰ç¼€,é¿å…æ–‡ä»¶è¦†ç›–
            filename = UUID.randomUUID() + "_" + System.currentTimeMillis() + "_" + filename;
            // é…ç½®ä¸Šä¼ çš„æ–‡ä»¶å¤¹,ä¼˜åŒ–æ–‡ä»¶å¤¹åŒ…å«æ–‡ä»¶æ–‡ä»¶å¤§å°,æ¯å¤©çš„æ–‡ä»¶æ”¾å…¥ä¸åŒçš„æ–‡ä»¶å¤¹/20010101
            String filepath = getDirNameByDate();
            // è·å–å·¥ç¨‹ä¸‹çš„è·¯å¾„ä½œä¸ºä¸Šä¼ ç›®å½•
            String fileRealPath = request.getServletContext().getRealPath(filepath);
            File uploadDir = new File(fileRealPath);
            // å¦‚æœæ–‡ä»¶å¤¹ä¸å­˜,åˆ™åˆ›å»ºæ–‡ä»¶å¤¹
            if (!uploadDir.exists()) {
              uploadDir.mkdirs();
              System.out.println("åˆ›å»ºæ–‡ä»¶ä¸Šä¼ ä¿å­˜ç›®å½•: " + uploadDir);
            }
            // å‰ªåˆ‡æ–‡ä»¶åˆ°æŒ‡å®šçš„æ–‡ä»¶å¤¹ä¸­,å› ä¸ºé»˜è®¤ä½StoreLocationåœ¨tomcatçš„tempç›®å½•ä¸‹
            File file = new File(uploadDir, filename);
            fileItem.write(file);
            System.out.println("ä¸Šä¼ æ–‡ä»¶æˆåŠŸ: " + file);
          }
          // æ—¥æœŸæ–‡ä»¶å
          private static String getDirNameByDate() {
            // /20020101
            return "/" + DateTimeFormatter.ofPattern("yyyyMMdd").format(LocalDate.now());
          }
    
    ```

    

### ä¸‹è½½

- è¯·æ±‚æ–¹æ³•get

- è®¾ç½®ä¸¤ä¸ªå“åº”å¤´

	- content-disposition

		- è¡¨ç¤ºä¸‹è½½çš„æ•°æ®çš„å±•ç¤ºæ–¹å¼,å¦‚:inlineå†…è”å½¢å¼(ç½‘é¡µå½¢å¼æˆ–è€…æ–‡ä»¶ä¸‹è½½æ–¹å¼ attachment

			- ä¸‹è½½å®Œæ‰“å¼€æ–‡ä»¶, æˆ–è€…ä¸‹è½½åˆ°æœ¬åœ°ç›®å½•ä¸­

	- ContentType,æŒ‡å®šè¿”å›æ•°æ®è¿™ç±»å‹MIME

- å“åº”ä½“

	- åœ¨ç½‘ç»œä¼ è¾“æ—¶æ˜¯å›¾ç‰‡çš„åŸç”Ÿæ•°æ®(äºŒè¿›åˆ¶), å›¾ç‰‡åœ¨ä¸‹è½½å®Œçœ‹åˆ°,æ˜¯å› ä¸ºæµè§ˆå™¨åšäº†è§£æ

- ä¸‹è½½çš„æ–‡ä»¶åä¸è¦åŒ…å«ç©ºæ ¼, base64å¯èƒ½è½¬æˆ+å·, é•­é›•äº‹æ•…

- å…³äºurlç¼–ç çš„é—®é¢˜
(æä¸æ‡‚, ä»¥åå†çœ‹

	- å‰ç«¯å‘é€æ•°æ®å…ˆæŠŠæ•°æ®è¿›è¡ŒBase64ç¼–ç , ç„¶åå‘é€æ—¶,æµè§ˆå™¨è¿›è¡Œurlç¼–ç ,

	- æœåŠ¡ç«¯æ”¶åˆ°æ•°æ®æ—¶, ä¼šå…ˆè¿›è¡Œurlè§£ç (æœåŠ¡å™¨åšçš„),å½“è¡¨å•æ•°æ®ç±»å‹ä¸ºurl-encodedæ—¶, è¿™æ—¶å€™ä¼šå¯¼è‡´base64çš„urlä¸­+è¢«urldecodeä¸ºç©ºæ ¼

		- åœ¨urlç¼–ç ä¸­:ç©ºæ ¼-->+

- ç¤ºä¾‹

  - å‰ç«¯

    ```html
    <%@ page contentType="text/html;charset=UTF-8" language="java" %>
    <html>
        <head>
            <title>ä¸‹è½½æ–‡ä»¶</title>
            <base href="${pageContext.request.getContextPath()}">
        </head>
        <body>
            <h1>æ–‡ä»¶ä¸‹è½½</h1>
            <a href="DownloadServlet?filename=a.jpeg">ä¸‹è½½a.jpeg</a><br>
            <a href="DownloadServlet?filename=b.jpeg">ä¸‹è½½b.jpeg</a> <br>
            <a href="DownloadServlet?filename=å¤œã®å‘æ—¥è‘µ.mp3">ä¸‹è½½å¤œã®å‘æ—¥è‘µ.mp3</a>
        </body>
    </html>
    ```

    

  - åç«¯

    ```java
    request.setCharacterEncoding("utf8");
    response.setCharacterEncoding("utf8");
    String filename = request.getParameter("filename");
    ServletContext servletContext = request.getServletContext();
    String downloadPath = "/download";
    String downloadFile = downloadPath + "/" + filename;
    String mimeType = servletContext.getMimeType(downloadFile);
    response.setContentType(mimeType);
    response.setHeader("content-disposition", "attachment; filename=" +
      URLEncoder.encode(filename, "utf8"));
    // è¯»å–ä¸‹è½½çš„æ–‡ä»¶æ•°æ®,è¿”å›ç»™æµè§ˆå™¨
    InputStream is = servletContext.getResourceAsStream(downloadFile);
    ServletOutputStream os = response.getOutputStream();
    // ä½¿ç”¨commons-ioå·¥å…·copyæ–‡ä»¶
    IOUtils.copy(is, os);
    System.out.println("ä¸‹è½½æˆåŠŸ: " + downloadFile);
    ```



## webåº”ç”¨è·¯å¾„é—®é¢˜(å°½é‡ç”¨ç»å¯¹è·¯å¾„)

### ç›¸å¯¹è·¯å¾„

- å‡è®¾æˆ‘ä»¬çš„å·¥ç¨‹è·¯å¾„ä¸ºhttp://localhost/webpath/

  ```html
  <a href="hello-servlet">Hello Servlet</a>
  <a href="http://localhost/webpath/hello-servlet">
  ```

  

- é¡µé¢æ‰€æœ‰çš„ç›¸å¯¹è·¯å¾„æ˜¯,æµè§ˆå™¨åœ°å€æ è·¯å¾„http://host:port/å·¥ç¨‹å/+èµ„æºæ¥è·³è½¬

- æ‰€ä»¥href="hello-servlet"ä¸
http://localhost/webpath/hello-servletæ˜¯ç­‰ä»·çš„

- ç›¸å¯¹è·¯å¾„çš„ç¼ºç‚¹:ä¼šè®©é¡¹ç›®çš„äº’ç›¸è°ƒç”¨å…³é—­å˜å¾—å¤æ‚

### ç”¨baseæ ‡ç­¾(åœ¨headæ ‡ç­¾å†…)æŒ‡å®šé¡µé¢çš„å‚è€ƒè·¯å¾„

- å¦‚æœç”¨baseæŒ‡å®šå, æµè§ˆå™¨å°±ä¼šåœ¨è§£ææ—¶,å–base+èµ„æºè·¯å¾„,å³ç»å¯¹è·¯å¾„

  ```html
  <base href="http://localhost/webpath/">
  æ–œæ /ä¸èƒ½å°‘
  å¯ä»¥ç®€å†™ä¸º: <base href="/webpath/">
  <h1>å½“å‰ä½ç½®: /d1/d2/b.html</h1>
  ```

  ```html
  <a href="../../a.html">åˆ°a.htmlé¡µé¢å»1</a>
  ```

  ```html
  <a href="a.html">åˆ°a.htmlé¡µé¢å»2</a>
  ```

  åŠ äº†baseæ ‡ç­¾å, å°±ä¼šä»¥baseçš„urlä¸ºç›¸å¯¹è·¯å¾„çš„åŸºå‡†ç‚¹
   å’Œ../../a.htmlç­‰ä»·

- ä¼šè·³è½¬åˆ°è¿™é‡Œ

  ```html
  <a href="/a.html">
  ```

- http://localhost/a.html
/ å¼€å¤´çš„å«ä¹‰å°±æ˜¯, ä¸»æœº:ç«¯å£/

- baseæ ‡ç­¾çš„é—®é¢˜, baseæ ‡ç­¾åŸºå‡†urlæ˜¯å†™æ­»äº†çš„ç¡¬ç¼–ç , æ”¹åŠ¨æ—¶ä¸æ–¹ä¾¿

  - åŠ¨æ€è·å–(jsp)

    ```java
    åŠ¨æ€è·å–çš„å·¥ç¨‹è·¯å¾„: <%=request.getContextPath()%>
    ```

    

### è½¬å‘è·¯å¾„

- åœ¨æœåŠ¡ç«¯è§£æç¬¬ä¸€ä¸ª/ä¼šè¢«è§£ææˆhttp://ip:port/Application Context

  ```java
  request.getRequestDispatcher("/d1/d2/b.html").forward(request,response); // æ¨è
  // è¿™ä¸ªå’Œä¸Šé¢çš„æ˜¯ç­‰ä»·çš„,æ¨èç¬¬ä¸€ä¸ª
  request.getRequestDispatcher("d1/d2/b.html").forward(request,response);
  ```

  

### æ€»ç»“

- åœ¨webä¸­ /æ–œæ å¦‚æœè¢«æœåŠ¡ç«¯è§£æ, å¾—åˆ°çš„åœ°å€æ˜¯http://ip:port/ApplicationContext/

  ```xml
  <url-pattern>/servletUrl</url-pattern>
  ```

  servletContext.getRealPath("/") ==> å¾—åˆ°é¡¹ç›®è·¯å¾„(ç£ç›˜ç»å¯¹è·¯å¾„)
  request.getDispatcher("/")

- æ–œæ åœ¨æµè§ˆå™¨è§£ææˆhttp://ip:port/

  ```html
  <a href="/">
  ```

  

- é‡å®šå‘

	- response.sendRedirect("/")ç­‰ä»·äº
http://ip:port/

	-  response.sendRedirect("b.html");ç­‰ä»·äº
http://localhost/webpath/b.html
æ¨èçš„é‡å®šå‘å†™æ³•
response.sendRedirect(getServletContext().getContextPath() + b.html")

	- é‡å®šå‘ç­‰ä»·äºæµè§ˆå™¨è§£æ

- æµè§ˆå™¨urlåé¢å¸¦æ–œæ /è¯´æ˜æ˜¯è·¯å¾„, ä¸å¸¦æ–œæ è¯´æ˜æ˜¯èµ„æº



## æœåŠ¡ç«¯æ¸²æŸ“æŠ€æœ¯(JSP)

ä¸ºä»€ä¹ˆéœ€è¦æœåŠ¡ç«¯æ¸²æŸ“æŠ€æœ¯, htmlé¡µé¢æ— æ³•è·å–åŠ¨æ€çš„æ•°æ®,åœ¨Servletä¸­å†™HTMLå­—ç¬¦ä¸²æ‹¼æ¥, ä¸‘é™‹åˆéš¾ä»¥ç»´æŠ¤

### JSP

- å®šä¹‰

	- JSP, Java Server Pages, javaæœåŠ¡å™¨é¡µé¢, å°±æ˜¯æœåŠ¡ç«¯æ¸²æŸ“æŠ€æœ¯

- ç‰¹ç‚¹

	- å†™JSPå°±åƒåœ¨å†™HTML

	- JSPä¸èƒ½ç›´æ¥ç”¨æµè§ˆå™¨ç›´æ¥è®¿é—®, éœ€è¦å»è¯·æ±‚Tomcat, æ¥è§£ææˆhtmlæ–‡ä»¶

	- æ¯”html, å¯ä»¥å†™åŠ¨æ€æ•°æ®å,
æ¯”Servlet,æ’ç‰ˆæ›´å‹å¥½,æ›´ä¼˜ç¾

	- JSPåŸºäºServlet, JSPå°±æ˜¯å¯¹Servletçš„åŒ…è£…, å¯ä»¥ç†è§£JSPå°±æ˜¯Servlet

	- ç†è§£JSP, å­¦thymeleaf(å¦ä¸€ç§æœåŠ¡ç«¯æ¸²æŸ“æŠ€æœ¯)ä¼šæ›´å®¹æ˜“

- JSPåŸç†

	- jspæœ¬è´¨æ˜¯ä¸€ä¸ªServletç¨‹åº,å…¶æ€§èƒ½å’Œjavaå…³è”

	- ç¬¬ä¸€æ¬¡è®¿é—®jspé¡µé¢çš„æ—¶å€™, Tomcatä¼šæŠŠjspé¡µé¢è§£ææˆä¸€ä¸ªjavaæºæ–‡ä»¶, å¹¶ä¸”å¯¹å®ƒç¼–è¯‘æˆclasså­—èŠ‚ç æ–‡ä»¶, ç›®å½•åœ¨: Catalinna_BASE/workç›®å½•ä¸‹

	- jspç»§æ‰¿äº†HttpJspBase, è€ŒHttpJspBaseç»§æ‰¿äº†HttpServlet

	- è§£æåçš„jsp.javaä¸­ä½¿ç”¨åŸç”Ÿçš„out.println()æ‹¼æ¥æ‰“å°htmlå­—ç¬¦ä¸²

- ä½¿ç”¨

  - å¼•å…¥ä¾èµ–

  	- servlet-apiå’Œjsp-api

  - å¸¸ç”¨æŒ‡ä»¤

    - page

      ```jsp
      <%@ page contentType="text/html;charset=UTF-8" language="java" %>
      ```

      - languageè¡¨ç¤ºjspç¿»è¯‘åçš„è¯­è¨€, åªæ”¯æŒjava

      - contentType, ç­‰ä»·äºresponse.setContentType

      - pageEncoding, è¡¨ç¤ºå½“å‰jspé¡µé¢çš„å­—ç¬¦é›†

      - import, javaä¸­çš„å¯¼åŒ…

    - å£°æ˜è„šæœ¬

      - <%! å£°æ˜javaä»£ç  %>

        - å®šä¹‰jspéœ€è¦çš„å±æ€§, æ–¹æ³•,é™æ€ä»£ç å—å’Œå†…éƒ¨ç±»

          ```jsp
          <%!
          private Integer id;
          private String name;
          private static String job;
          static {
              job = "DE";
          }
          public void setId(Integer id) {
              this.id = id;
          }
          %>
          ```

          

    - è¡¨è¾¾å¼è„šæœ¬

      - <%=è¡¨è¾¾å¼%>

        - ä½œç”¨: åœ¨jspé¡µé¢ä¸Šè¾“å‡ºæ•°æ®

          ```jsp
          å·¥ä½œæ˜¯: <%=job%> <br>
          å§“åæ˜¯: <%=name%> <br>
          IDæ˜¯: <%=id%> <br>
          ```

          - è¡¨è¾¾å¼è„šæœ¬ä¸­çš„è¡¨è¾¾å¼ä¸èƒ½ä»¥åˆ†å·ç»“æŸ

    - ä»£ç è„šæœ¬

      - <% javaä»£ç  %>

  æ¡ˆä¾‹

```jsp
<%!
    private List<Hero> heroes = new ArrayList<>();
    {
        heroes.add(new Hero(1, "çŸ®äººç›´å‡æœº", "è½°ç‚¸"));
        heroes.add(new Hero(2, "æ–¯æ©", "æŠ¢äººå¤´"));
    }
    %>

<%
    for (Hero hero : heroes) {
%>
<tr>
    <td><%=hero.getId()%>
    </td>
    <td><%=hero.getName()%>
    </td>
    <td><%=hero.getSkill()%>
    </td>
</tr>
<%
    }
%>
```

æ³¨é‡Š

<%-- comment %>

 æ ‡ç­¾

è¯·æ±‚è½¬å‘æ ‡ç­¾

```jsp
<jsp:forward page="/a.jsp"></jsp:forward>
<%--ä¸request.getRequestDispatcher("/a.jsp").forward(request,response)ç­‰ä»· %>
```

ELè¡¨è¾¾å¼

 Expression Languageè¯­è¨€

è¯­æ³•${key1}

ä¸»è¦ä½œç”¨æ˜¯ä¸ºäº†æ›¿ä»£è¡¨è¾¾å¼è„šæœ¬<%=%>, æœ¬è´¨ä¸Šæ˜¯è¯­æ³•ç³–

elè¡¨è¾¾å¼è¾“å‡ºnullä¸º""ç©ºä¸², jspè¡¨è¾¾å¼æ ‡æœ¬è¾“å‡ºnullä¸ºnullå­—ç¬¦ä¸²

å–å¾—æ˜¯è¯·æ±‚åŸŸä¸­æ•°æ®, å–çš„å¯¹è±¡è¦æœ‰getæ–¹æ³•

```jsp
 <%
        Book book = new Book();
        book.setName("å­˜åœ¨ä¸æ—¶é—´");
        book.setAuthor(new String[]{"é©¬ä¸", "æµ·å¾·æ ¼å°”"});
        ArrayList<String> readers = new ArrayList<>();
        Collections.addAll(readers, "ç»´ç‰¹æ ¹æ–¯å¦", "zangxin");
        book.setReader(readers);
        HashMap<String, Object> map = new HashMap<>();
        map.put("Inder welt Sein", "åœ¨ä¸–ç•Œä¸­å­˜åœ¨");
        map.put("to be or not to be", "å‘æ­»è€Œåœ¨");
        book.setTopics(map);
        request.setAttribute("book",book);
    %>
    bookå¯¹è±¡: ${book} <br>
    book.name: ${book.name} <br>
    book.author: ${book.author} <br>
    book.author[0]: ${book.author[0]} <br>
    book.readers: ${book.reader}  <br>
    book.readers[0]: ${book.reader.get(0)} <br>
    book.topics: ${book.topics} <br>
    book.topics[0]: ${book.topics.get("to be or not to be")} <br>
    book.topics[0]: ${book.topics["to be or not to be"]}<br>
```

${}å–æ•°æ®æŒ‰ç…§ä»å°å¤§çš„çš„åŸŸå–pageContext -->request -->session-->applicationContext



è¿ç®—ç¬¦

```jsp
== eq
!= ne
< lt <= le
gt >= ge
&& and
|| or
! not
/ div 
% mod
```

- empty

	- åˆ¤æ–­ä¸€ä¸ªæ•°æ®æ˜¯å¦ä¸ºç©º, ç©º-true, éç©ºfalse 

	- ä¸ºç©ºçš„æƒ…å†µ

		- null, ç©ºä¸²""
Objectç±»å‹æ•°ç»„é•¿åº¦ä¸º0
listé›†åˆå…ƒç´ ä¸ªæ•°ä¸º0
mapé›†åˆå…ƒç´ ä¸ªæ•°ä¸º0

- ä¸‰å…ƒè¿ç®—ç¬¦

  ?:å’Œjavaä¸€æ ·

- ELçš„éšå«å¯¹è±¡

  - å››ä¸ªç‰¹å®šåŸŸå˜é‡,ç±»å‹ä¸ºMap<String,Object>

    - pageScope

    - requestScope

    - sessionScope

  ```jsp
  <%
  pageContext.setAttribute("k1", "pageContext-k1");
  request.setAttribute("k1", "request-k1");
  session.setAttribute("k1", "session-k1");
  application.setAttribute("k1", "application-k1");
  %>
  pageContextæ•°æ®: ${pageScope.k1} <br>
  requestæ•°æ®: ${requestScope.k1} <br>
  sessionæ•°æ®: ${sessionScope.k1} <br>
  applicationæ•°æ®: ${applicationScope.k1} <br>
  </body>
  ```

  - applicationScope

  - pageContextå¯¹è±¡

    ```jsp
    åè®®:${pageContext.request.scheme}
    ç«¯å£:${pageContext.request.remotePort}
    ```

    

- jstlæ ‡å‡†æ ‡ç­¾åº“

  - JSP Standard Library

    - JSTLæ˜¯ä¸ºäº†æ›¿æ¢ä»£ç è„šæœ¬,jspé¡µé¢æ›´ç®€æ´

    - ä¾èµ–

      ```xml
      <dependency>
      <groupId>javax.servlet</groupId>
      <artifactId>jstl</artifactId>
      <version>1.2</version>
      </dependency>
      <dependency>
      <groupId>taglibs</groupId>
      <artifactId>standard</artifactId>
      <version>1.1.2</version>
      </dependency>
      ```

      

  - jstlæœ‰5ä¸ªæ ‡ç­¾åº“

    - å…ˆçœ‹æ ¸å¿ƒæ ‡ç­¾åº“core, ä»¥cå¼€å¤´

      - <c:set scope="request" var="username" value="root" />
      ç­‰ä»·äºrequest.setAttribute("username","root")

      - å•åˆ†æ”¯

        ```jsp
        <c:if test="${10 < 2}">ä¸ºçœŸæ‰æ˜¾ç¤ºæˆ‘</c:if>
        ```

        

      - å¤šåˆ†æ”¯é€‰æ‹©
        
        ```jsp
        <c:choose>
            <c:when test="${requestScope.score >= 80}">
                <h1>${score}-æˆç»©ä¼˜ç§€</h1>
            </c:when>
            <c:when test="${requestScope.score >= 60}">
                <h1>${score}-åŠæ ¼äº†, è¿˜ä¸é”™</h1>
            </c:when>
            <c:otherwise>
                <h1>${score}-ä¸åŠæ ¼</h1>
          </c:otherwise>
        </c:choose>
        ```
        
        
        
      - éå†æ•°ç»„,åˆ—è¡¨,map,å¿…é¡»æä¾›getæ–¹æ³•

        ```jsp
        <%--   ç­‰ä»·äºfor(int i=1; <=5;i++)  output 1 2 3 4 5  --%>
        <c:forEach begin="1" end="5" step="1" var="i">
        ${i}
        </c:forEach>
        <%-- æ•°ç»„ request.setAttribute("sports",new String[]{"lq","zq","ymq","tc"}) --%>
        <c:forEach items="${requestScope.sports}" var="sport">
        ${sport}
        </c:forEach>
        <%-- Map<String, String> cities = new HashMap<>(); --%>
        <c:forEach items="${requestScope.cities}" var="city">
        ${city.key}===${city.value}
        </c:forEach>
        <%-- List<String> list = new ArrayList<>(); --%>
        <c:forEach items="${list}" var="item">
        ${item}
        </c:forEach>
        ```

        

- JSPå†…ç½®å¯¹è±¡(build-in)

	- out

		- JspWriterç»§æ‰¿äº†Writer

	- request å®¢æˆ·ç«¯è¯·æ±‚

		- HtttpServletRequest

	- responseå“åº”å¯¹è±¡

		- HttpServletResponse

	- Sessionä¼šè¯å¯¹è±¡

		- HttpSession

	- application

		- ServletContext

	- pageContext

		-  jspé¡µé¢çš„ä¸Šä¸‹æ–‡, æ˜¯ä¸€ä¸ªåŸŸå¯¹è±¡,å¯ä»¥setAttribute, ä½œç”¨èŒƒå›´æ˜¯æœ¬é¡µé¢

	- exception

	- page

		- ç±»ä¼¼äºthis

	- config

		- ServletConfig

- JSPå››å¤§åŸŸå¯¹è±¡

	- pageContext(jspç‰¹æœ‰)

		- å­˜æ”¾çš„æ•°æ®åªèƒ½åœ¨å½“å‰jspé¡µé¢ä½¿ç”¨

	- request

		- å­˜æ”¾çš„æ•°æ®åœ¨ä¸€æ¬¡è¯·æ±‚æœ‰æ•ˆ, è½¬å‘å¯ä»¥(é‡å®šå‘ä¸è¡Œå“¦ğŸ˜¯)

	- session

		- å¤šæ¬¡è¯·æ±‚éƒ½å¯ä»¥, åªè¦ä¼šè¯æ²¡æœ‰å˜åŒ–

	- application

		- ServletContextå­˜æ”¾çš„æ•°æ®åœ¨æ•´ä¸ªwebåº”ç”¨è¿è¡ŒæœŸé—´æœ‰æ•ˆ, èŒƒå›´æœ€å¤§,å¤šä¸ªä¼šè¯å…±äº«

	- æµ‹è¯•

		- åœ¨ä¸€ä¸ªjspé¡µé¢

			- å››ä¸ªåŸŸå¯¹è±¡éƒ½æœ‰æ•°æ®

		- è·¨jspé¡µé¢(è½¬å‘)

			- pageContextæ²¡æœ‰æ•°æ®

		- é‡å®šå‘è·¨jspé¡µé¢

			- pageContextå’Œrequestæ²¡æœ‰æ•°æ®

		- æ¸…é™¤cookie(jsessionid)

			- pageContext, request, sessionéƒ½æ²¡æœ‰æ•°æ®

		- é‡å¯Tomcat

			- æ•°æ®å…¨éƒ½ä¸ºnull äº†

	- æ€»ç»“

		- åŸŸå¯¹è±¡æ˜¯å¯ä»¥åƒmapä¸€æ ·å­˜å–æ•°æ®çš„å¯¹è±¡. å››ä¸ªåŸŸå¯¹è±¡åŠŸèƒ½ä¸€æ ·, ä¸åŒçš„æ˜¯ä»–ä»¬å¯¹æ•°æ®å­˜å‚¨çš„èŒƒå›´

		- å­˜å‚¨èŒƒå›´å¤§å°: pageContext < request < Session < ServletContext(applicantion)



## JSONè½¬æ¢

### jackson

æ–‡æ¡£

- https://www.baeldung.com/jackson-object-mapper-tutorial

ä¾èµ–

- jackson-databind

åºåˆ—åŒ–

```java
ObjectMapper om = new ObjectMapper();
String jsonString = om.writeValueAsString(books);
```



ååºåˆ—åŒ–json string ---> java

- å•ä¸ªå¯¹è±¡

  ```java
  om.readValue(jsonString, Book.class);
  ```

- æ•°ç»„

  ```java
  List<Book> books1 = om.readValue(jsonString, new TypeReference<List<Book>>() {});
  ```

  

- map

  ```java
  HashMap<String, Book> map = om.readValue(mapJson, new TypeReference<HashMap<String, Book>>() {});
  ```

- æ³¨æ„äº‹é¡¹
  - JSONè½¬æ¢æ—¶,å®ä½“ç±»å¿…é¡»æä¾›getter/setter



## é¡¹ç›®ç»ƒä¹ 

### å®¶å±…ç½‘è´­

- æ¶æ„

  - MVCä¸‰å±‚æ¶æ„,åŒ…ç®¡ç†æŠ€æœ¯ğŸ˜

    - æµè§ˆå™¨

      - å®¢æˆ·ç«¯,è§£æç½‘é¡µæ•°æ®

    - view

      - html,css.js

        - ç½‘é¡µ,å’Œç”¨æˆ·ç›´æ¥äº¤äº’çš„ç•Œé¢

        - å‘èµ·httpè¯·æ±‚,æ¥æ”¶å“åº”æ•°æ®/é¡µé¢

      - å¯ç”¨æŠ€æœ¯,vue

    - controller/servlet

      - è§†å›¾å±‚:
        æ¥æ”¶ç”¨æˆ·è¯·æ±‚,è°ƒç”¨Serviceå®Œæˆä¸šåŠ¡å¤„ç†
        è¿”å›å“åº”æ•°æ®æˆ–è€…é‡å®šå‘,è½¬å‘é¡µé¢
        å¯ç”¨æŠ€æœ¯:servlet, springmvc

    - service

      - ä¸šåŠ¡å±‚:
        æä¾›äº†å¾ˆå¤šä¸šåŠ¡API
        ä¸šåŠ¡é€»è¾‘ä¸»è¦åœ¨è¿™é‡Œå®ç°
        é’ˆå¯¹ä¸åŒä¸šåŠ¡é€»è¾‘, è°ƒç”¨daoå±‚

    - dao

      - æ•°æ®è®¿é—®å±‚:
        å®Œæˆå¯¹æ•°æ®åº“å¯çš„æ“ä½œ
        æ•°æ®åº“çš„å¢åˆ æ”¹æŸ¥,Create, Read, Update, Delete
        å¯ç”¨æŠ€æœ¯: JDBC,DButils, JdbcTemplate,Mybatis,Mybatis-plus,Hibernate

    - bean

      - æ”¾å®ä½“ç±», vo,domain/bean/pojo,dto

    - util

      - å·¥å…·ç±»

    - test

      - æµ‹è¯•ç±»

  - MVCæ­£ç»è§£è¯´

    - MVCå…¨ç§°æ˜¯ Modelæ¨¡å‹,Viewè§†å›¾,Controlleræ§åˆ¶å™¨,MVCå¯ä»¥æœ‰æ•ˆçš„æŒ‡å¯¼WEBå±‚ä»£ç æœ‰æ•ˆåˆ†ç¦»

    - Viewè§†å›¾

      - åªè´Ÿè´£ç•Œé¢çš„æ˜¾ç¤º, ä¸æ¥æ”¶ä»»ä½•ä¸ç°å®æ— å…³çš„ä»£ç ,ä¾¿äºç¨‹åºå‘˜å’ŒUIçš„åˆ†å·¥åˆä½œ(Vue/JSP/Thymeleaf/HTML)

    - Controlleræ§åˆ¶å™¨

      - åªè´Ÿè´£æ¥æ”¶è¯·æ±‚, è°ƒç”¨ä¸šåŠ¡å±‚çš„ä»£ç å¤„ç†è¯·æ±‚, è¿”å›æ´¾å‘é¡µé¢, æ˜¯ä¸€ä¸ªè°ƒåº¦è€…çš„è§’è‰²(Servlet)

    - Modelå°†ä¸šåŠ¡é€»è¾‘ç›¸å…³çš„æ•°æ®å°è£…ä¸ºå…·ä½“çš„javaBean, å…¶ä¸­ä¸ä¸æºæ‚ä»»ä½•ä¸æ•°æ®å¤„ç†ç›¸å…³çš„ä»£ç (javabean/domain/pojo)

      - modelæœ€æ—©æœŸå°±æ˜¯javabean, é€šè¿‡service+daoè·å–çš„æ•°æ®å°è£…æˆbean, è€Œä¸å»ç®¡ç»†èŠ‚,åªè¦bean

      - éšç€ä¸šåŠ¡å¤æ‚, modelåˆ†åŒ–ä¸ºservice+dao

      - æŒä¹…å±‚æŠ€æœ¯çš„å‡ºç°å°±æ¼”å˜ä¸ºservice + dao + æŒä¹…å±‚æŠ€æœ¯(hibernate/mybatis/...)

    - MVCçš„ç†å¿µæ˜¯å°†è½¯ä»¶æ‹†åˆ†æˆä¸ºç»„ä»¶, å•ç‹¬å¼€å‘,ç»„åˆä½¿ç”¨(ç›®çš„æ˜¯è§£è€¦åˆ),(SpringMVC)

- Servletåˆå¹¶

  - ç—›ç‚¹: ä¸€ä¸ªurlå¯¹åº”ä¸€ä¸ªservlet, nä¸ªåŠŸèƒ½å¯¹åº”nä¸ªservlet....

  - è§£å†³æ–¹æ³•1

    - å‰ç«¯è¾“å…¥æ¡†ä¼ é€’éšè—åŸŸaction, æ ¹æ®actionçš„å€¼ä¸åŒæ¥è°ƒç”¨ä¸åŒçš„ä¸šåŠ¡æ–¹æ³•

    - æ„Ÿè§‰è€¦åˆæ€§å¤ªé«˜, æ¶‰åŠå‰åç«¯é«˜åº¦è€¦åˆ,ç›´æ¥æ·˜æ±°

  - æ¨¡æ¿æ–¹æ³•æ¨¡å¼

    - æŠ½è±¡å‡ºBaseService, åœ¨serviceæ–¹æ³•ä¸­å®šä¹‰å·è¦åšçš„æ­¥éª¤, æŠŠè¿™äº›æ­¥éª¤å®šä¹‰ä¸ºæŠ½è±¡çš„, ç„¶åå­ç±»å®ç°è¿™äº›æ­¥éª¤

    - uriæœ€åä¸€æˆªå’Œæ–¹æ³•åä¿æŒä¸€è‡´, åˆ©ç”¨uriä½œä¸ºæ–¹æ³•å,åå°„è°ƒç”¨æ–¹æ³•

      ```java
      public class BaseServlet extends HttpServlet {
        @Override
        protected void service(HttpServletRequest req, HttpServletResponse resp)
            throws ServletException, IOException {
          req.setCharacterEncoding("utf8");
          resp.setCharacterEncoding("utf8");
          String uri = req.getRequestURI();
          String methodName = uri.substring(uri.lastIndexOf("/") + 1);
          Class<? extends BaseServlet> clazz = this.getClass();
          try {
              Object o = clazz.newInstance();
              Method method = clazz.getMethod(methodName,
                      HttpServletRequest.class, HttpServletResponse.class);
              method.invoke(o, req, resp);
          } catch (Exception e) {
              resp.sendRedirect(req.getContextPath() + "/500.html");
              e.printStackTrace();
          }
        }
      }
      ```

    - æ‰©å±•åŠŸèƒ½, åœ¨æ¨¡æ¿æ–¹æ³•ä¸­å¦‚åŠ å…¥å­—ç¬¦é›†ç¼–ç è®¾ç½®, ç»Ÿä¸€é…ç½®

      

- insertSQLé¡µé¢ä½¿ç”¨è½¬å‘é€ æˆé‡å¤æäº¤æé—®

  - åœ¨ä¿å­˜é¡µé¢(insert)ä¸èƒ½ç”¨è½¬å‘,å› ä¸ºå†æ¬¡åˆ·æ–°é¡µé¢æ—¶ä¼šå‡ºç°é‡å¤æ’å…¥çš„æƒ…å†µ

  - åŸå› :å½“ç”¨æˆ·æäº¤å®Œè¯·æ±‚ï¼Œæµè§ˆå™¨ä¼šè®°å½•ä¸‹æœ€åä¸€æ¬¡è¯·æ±‚çš„å…¨éƒ¨ä¿¡æ¯ã€‚å½“ç”¨æˆ·åˆ·æ–°é¡µ
    é¢(f5)ï¼Œ å°±ä¼šå‘èµ·æµè§ˆå™¨è®°å½•çš„ä¸Šä¸€æ¬¡è¯·æ±‚

  - è§£å†³æ–¹æ¡ˆä½¿ç”¨é‡å®šå‘å³å¯ï¼Œå› ä¸ºé‡å®šå‘æœ¬è´¨æ˜¯ä¸¤æ¬¡è¯·æ±‚ï¼Œè€Œä¸”æœ€åä¸€æ¬¡å°±æ˜¯è¯·æ±‚æ˜¾ç¤ºå®¶
    å±…ï¼Œè€Œä¸æ˜¯æ·»åŠ å®¶å±…

- åç«¯æ•°æ®æ ¡éªŒ

  - æ ¡éªŒæ•°æ®æ ¼å¼æ˜¯å¦æ­£ç¡®

    - å‰ç«¯ä¼ å…¥çš„æ•°æ®éƒ½æ˜¯string,éœ€è¦æŸ¥çœ‹ä¸‹ä¸€ä¸‹æ˜¯å¦ä¸ºæ•°å­—,æˆ–è€…é•¿åº¦éªŒè¯,åˆ¤ç©ºéªŒè¯ç­‰ç­‰

  - ä¸èƒ½ä¾èµ–äºå‰ç«¯æ ¡éªŒ

    - åœ¨æ¥å£æµ‹è¯•æ—¶, å¯ä»¥éšä¾¿æ”¹æ•°æ®, ç»•è¿‡å‰ç«¯

  - springmvcæœ‰ä¸€ä¸ªæ•°æ®æ ¡éªŒå·¥å…·æ”¯æŒJSR303,Hibernate validator,æ³¨è§£æ ¡éªŒ, è¿™é‡Œä¸€ä¸ªä¸€ä¸ªæ ¡éªŒå¤ªç¹çäº†

- å·¥å…·ç±»çš„ä½¿ç”¨

  - commons-beanutils

    - å°è£…bean,æŠŠå‰ç«¯ä¼ è¿‡æ¥çš„æ•°æ®å°è£…æˆjavaå¯¹è±¡

    - Furn furn = new Furn();
      BeanUtils.populate(furn,request.getParameterMap());

    - éœ€è¦ä¿æŒnameå’Œjavabeançš„å±æ€§åä¸€æ ·

    - å¦‚æœä¼ æ¥abc, javabeanä¸ºInteger, ä¼šè®¾ç½®ä¸º0(é»˜è®¤å€¼), ä¸æŠ›å‡ºå¼‚å¸¸, æ‰€ä»¥æŒ‡æœ›æŠ›å‡ºå¼‚å¸¸æ¥æ ¡éªŒä¸å¤ªè¡Œ

- ä¸¤ä¸ªhtmlé¡µé¢ä¹‹é—´ä¼ é€’å‚æ•°é—®é¢˜ä¸é€šè¿‡æœåŠ¡æœåŠ¡å™¨è½¬å‘æˆ–è€…é‡å®šå‘

  ```javascript
  // ä»é¡µé¢Aè·³è½¬åˆ°é¡µé¢Bï¼Œå¹¶ä¼ é€’å‚æ•°
  window.location.href = 'pageB.html?param1=value1&param2=value2';
  // åœ¨é¡µé¢Bä¸­è·å–å‚æ•°
  var params = new URLSearchParams(window.location.search);
  var param1 = params.get('param1');
  var param2 = params.get('param2');
  ```

  

- åˆ†é¡µåŠŸèƒ½

  - åˆ†é¡µå‚æ•°

    - pageSize --æ¯é¡µå®¹é‡
      pageNum---ç¬¬å‡ é¡µ
      totalRows--æ€»è®°å½•æ•°
      totalPage--æ€»é¡µæ•°
      pageTotalRow--æ¯é¡µè¡Œæ•°
      list---åˆ†é¡µçš„æ•°æ®è®°å½•
    - å°è£…æˆå¯¹è±¡Page

  - åˆ†é¡µæ—¶,ä¸è¦ä½¿ç”¨å¼‚æ­¥ajax, è¦ä¹ˆä»£ç å…¨éƒ¨å†™åœ¨successä¸­, å¦åˆ™å¯¼è‡´è·å–çš„åˆ†é¡µå‚æ•°å¯èƒ½ä¸ºnullå€¼

- ç™»å½•åŠŸèƒ½+é‰´æƒ

  - ç™»å½•åŠŸèƒ½æ˜¾ç¤ºç™»å½•åå’Œç°å®è®¢å•èœå•å…¥å£(å‰ç«¯)

    - åœ¨ç™»å½•servletä¸­å®Œæˆç™»å½•å,ä¿å­˜ç”¨æˆ·å¯¹è±¡åˆ°sessionä¸­, cookieä¸­å†™å…¥ç”¨æˆ·åå’Œæƒé™çº§åˆ«, æ¥æ˜¾ç¤ºç”¨æˆ·å,æ ¹æ®roleçº§åˆ«æ˜¯å¦æ˜¾ç¤ºåå°ç®¡ç†å…¥å£

      - molizaçš„cookieå·¥å…·
        https://developer.mozilla.org/zh-CN/docs/Web/API/Document/cookie

  - æƒé™æ ¡éªŒ

    - å®šä¹‰: æ§åˆ¶ç”¨æˆ·èƒ½è®¿é—®çš„uri

    - å¯¹httpè¯·æ±‚è¿›è¡ŒFilter, åœ¨web.xmlä¸­é…ç½®æ‹¦æˆªçš„urlå’Œç™½åå•url, åœ¨doFilteræ–¹æ³•ä¸­å®Œæˆé…ç½®

    - AuthFilter

      ```java
      public class AuthFilter implements Filter {
        private List<String> excludeUrls;
        private String loginHtmlPath = "/views/member/login.html";
        @Override
        public void init(FilterConfig filterConfig) throws ServletException {
        excludeUrls = Arrays.stream(filterConfig.getInitParameter("excludeUrl").split(",")).toList();
        System.out.println("excludeUrls = " + excludeUrls);
      }
      @Override
      public void doFilter(ServletRequest req, ServletResponse response, FilterChain chain) throws IOException, ServletException {
        HttpServletRequest request = (HttpServletRequest) req;
        // é…ç½®æ—¶æ²¡æœ‰é…ç½®é¡¹ç›®è·¯å¾„,è¿™é‡Œè¦å»æ‰
        String url = request.getRequestURI().substring(request.getContextPath().length());
        User user = SessionUtils.getUser(request);
        // å¦‚æœæ˜¯ç™½åå•, å’Œ ç™»å½•è¿‡ç”¨æˆ·ç›´æ¥æ”¾è¡Œ
        if (excludeUrls.contains(url) || user != null) {
            System.out.println("æ”¾è¡Œ: " + url);
            chain.doFilter(request, response);
        } else {
            ((HttpServletResponse) response).sendRedirect(request.getContextPath() + loginHtmlPath);
        }
          System.out.printf("%sè¯·æ±‚è®¿é—®url: %s\n", (user == null ? "" : user.getUsername()), url);
        }
      }
      ```

      

    - web.xml

      ```xml
      <filter>
      <filter-name>AuthFilter</filter-name>
      <filter-class>com.xxx.jiajumall.filter.AuthFilter</filter-class>
      <init-param>
          <param-name>excludeUrl</param-name>
          <!--é€—å·ä½œä¸ºåˆ†å‰²ç¬¦-->
          <param-value>/views/manage/manage_login.html,
              ,/views/member/login.html,/manage/login,/furn/get,/furn/getPageByName,
          ,/furn/getPage,/cart/getItems,/cart/getCarInfo</param-value>
      </init-param>
      </filter>
      <filter-mapping>
      <filter-name>AuthFilter</filter-name>
      <url-pattern>/views/manage/*</url-pattern>
      <url-pattern>/views/order/*</url-pattern>
      <url-pattern>/furn/*</url-pattern>
      <url-pattern>/cart/*</url-pattern>
      </filter-mapping>
      ```

      

- éªŒè¯ç åŠŸèƒ½
  è§£å†³é‡å¤æäº¤çš„åˆ©å™¨

  - 1.ç™»å½•htmlé¡µé¢å‘æœåŠ¡ç«¯è¯·æ±‚ç”ŸæˆéªŒè¯ç å›¾ç‰‡, æœåŠ¡ç«¯è¿”å›éªŒè¯ç å›¾ç‰‡
    2.æ˜¾ç¤ºéªŒè¯ç å›¾ç‰‡

    - KaptchaServletè¢«è¯·æ±‚ç”ŸæˆéªŒè¯ç , getæ–¹æ³•
      googleæä¾›çš„å·¥å…·, è¿”å›éªŒè¯ç å›¾ç‰‡, å¹¶ä¸”æŠŠéªŒè¯å­˜åœ¨sessionä¸­, å°†å›¾ç‰‡ä»¥httpçš„æ–¹å¼è¿”å›

  - 3.ç”¨æˆ·è¾“å…¥ç”¨æˆ·å,å¯†ç ,éªŒè¯ç ç­‰

  - 4.å…ˆåœ¨æµè§ˆå™¨ç«¯éªŒè¯,éªŒè¯ç æ˜¯å¦æ­£ç¡®

  - 5.å¦‚æœéªŒè¯é€šè¿‡å‘é€ç»™æœåŠ¡ç«¯éªŒè¯ç å€¼å’Œç”¨æˆ·ä¿¡æ¯

    - è·å–æµè§ˆå™¨æäº¤çš„ä¿¡æ¯, ä»sessionä¸­å»é™¤éªŒè¯ç å€¼, ç«‹å³åˆ æ‰éªŒè¯ç (é˜²æ­¢é‡å¤æäº¤), æ¯”è¾ƒéªŒè¯å€¼æ˜¯å¦ç›¸ç­‰,ç›¸ç­‰æ—¶æ³¨å†ŒæˆåŠŸ

  - å®ç°

    - å‰ç«¯

      - åŠ ä¸Šæ—¶é—´æˆ³æ˜¯ä¸ºäº†t=xxxxxxæ˜¯ä¸ºåˆ·æ–°éªŒè¯ç , å¦åˆ™æœåŠ¡ä¼šè¿”å›åŸæ¥çš„éªŒè¯ç (302è®¤ä¸ºä½ çš„å†…å®¹æ²¡æœ‰å‘ç”Ÿæ”¹å˜)

        ```java
        function verifyCodeEvent() {
          $("#verifyCode").click(function () {
          $("#verifyCode").get(0).src = '/jiaju_mall/KaptchaServlet?t=' + (new Date().getTime())
          });
        }
        //
        <img id="verifyCode" alt="" src="/jiaju_mall/KaptchaServlet">
        ```

        

    - åç«¯

      - ç”ŸæˆéªŒè¯ç 

        - googleçš„kaptchaServlet

          - ä¸€ä¸ªServletæ”¶åˆ°getè¯·æ±‚æ—¶,è¿”å›ä¸€å¼ æ ¹æ®éªŒè¯ç”Ÿæˆçš„å›¾ç‰‡, éªŒè¯æ”¾åœ¨Sessionä¸­

      - æ ¡éªŒéªŒè¯ç 

        ```java
        private boolean checkCode(HttpServletRequest request) {
        // å‰ç«¯ä¼ æ¥çš„éªŒè¯ç 
          String code = request.getParameter("code");
          // session ç”Ÿæˆçš„éªŒè¯ç 
          String token = (String) 	        request.getSession().getAttribute(Constants.KAPTCHA_SESSION_KEY);
          // ç«‹å³åˆ é™¤Sessionä¸­éªŒè¯ç ,é¿å…é‡å¤ä½¿ç”¨
          request.getSession().removeAttribute(Constants.KAPTCHA_SESSION_KEY);
          // æ¯”å¯¹
          return token != null && token.equalsIgnoreCase(code);
        }
        ```

        

- è´­ç‰©è½¦è®¾è®¡

  - Sessionç‰ˆè´­ç‰©è½¦, å…ç™»å½•å¯ä»¥æ·»åŠ è´­ç‰©è½¦,å…³é—­ä¼šè¯å,å°±ä¼šæ¸…ç©ºä¿¡æ¯

  - éœ€æ±‚

    - å¯ä»¥æŠŠå•†å“æ·»åŠ åˆ°,æ·»åŠ è´­ç‰©è½¦,ç»“ç®—è´­ç‰©è½¦,
      æ¸…ç©ºè´­ç‰©è½¦, åˆ é™¤è´­ç‰©è½¦å•†å“, ä¿®æ”¹å•†å“æ•°é‡

  - æ¨¡å‹

    - Cartè´­ç‰©è½¦å¯¹è±¡

      - è´­ç‰©è½¦é¡¹cartItemList

        - cartItemå•é¡¹å±æ€§

          - id

          - img å•†å“å›¾ç‰‡

          - name å•†å“å

          - count å•†å“æ•°é‡

          - price å•†å“å•ä»·

          - totalPrice å•†å“æ€»ä»·

      - clear()æ¸…ç©ºè´­ç‰©è½¦

      - addItem()

      - removeItem()

      - updateCount

      - getTotalCount

      - getTotalPrice

      - getItem

- è®¢å•è®¾è®¡

  - ä¸€ä¸ªç”¨æˆ·å¯ä»¥æœ‰å¤šä¸ªè®¢å•, ä¸€ä¸ªè®¢å•å¯ä»¥æœ‰å¤šä¸ªè®¢å•é¡¹

  - å…·ä½“å­—æ®µæ ¹æ®ç”¨æˆ·ç•Œé¢æ¥è®¾è®¡

  - è®¢å•å¯¹è±¡OrderæŒæœ‰è®¢å•é¡¹å¯¹è±¡OrderItem

  - è®¢å•è¡¨è®¾è®¡(tbl_order)

    - id

    - è®¢å•ç¼–å·

      - orderCode

    - å…³è”ç”¨æˆ·

      - userId

    - è®¢å•æ—¶é—´

      - createTime

    - è®¢å•é‡‘é¢

      - amount

    - è®¢å•çŠ¶æ€,(æœªå‘è´§,æœªæ”¯ä»˜,..)

      - status

    ```mysql
    create table tbl_order
    (
    id         int primary key auto_increment,
    orderCode  varchar(14)    not null default '',
    userId     int            not null default 0,
    amount     decimal(12, 2) not null default 0 comment 'è®¢å•é‡‘é¢',
    status     tinyint        not null default 0 comment 'è®¢å•çŠ¶æ€ 0 æœªæ”¯ä»˜ 1 å·²æ”¯ä»˜å¾…å‘è´§ 2è®¢å•å–æ¶ˆ 3 è®¢å•å·²å®Œæˆ 4 å”®å',
    createTime timestamp      not null default current_timestamp on update current_timestamp
    ) charset utf8mb4
    collate utf8mb4_general_ci
    engine 'Innodb';
    ```

    

    - è®¢å•è¯¦æƒ…

      - è®¢å•é¡¹è¡¨(å•ä¸ªå•†å“)tbl_order_item

        - id

        - è®¢å•å·

          - orderCode

        - å•†å“id

          - furnId

        - å•†å“å

          - name

        - å•†å“æ•°é‡

          - count

        - å•†å“å•ä»·

          - price

        - å•†å“æ€»ä»·

          - totalPrice

    ```mysql
    create table tbl_order_item
    (
    id         int primary key auto_increment,
    orderCode  varchar(14)    not null default '',
    furnId     int            not null default 0 comment 'å•†å“id',
    name       varchar(64)    not null default '' comment 'å•†å“å',
    count      int            not null default 0 comment 'å•†å“æ•°é‡',
    price      decimal(12, 2) not null default 0,
    totalPrice decimal(12, 2) not null default 0
    ) charset utf8mb4
    collate utf8mb4_general_ci
    engine 'Innodb';
    ```

    

  - ä¸‹å•æµç¨‹

    - è´­ç‰©è½¦æäº¤è®¢å•

      - ç”¨æˆ·æ˜¯å¦ç™»å½•

        - æœªç™»å½•é‡å®šå‘ç™»å½•é¡µé¢,ç™»å½•åè¿”å›è´­ç‰©è½¦é¡µé¢

        - å·²ç»ç™»å½•

          - å¼€å¯äº‹åŠ¡
            è·å–è´­ç‰©è½¦å¯¹è±¡, éå†è´­ç‰©è½¦, 
            æ’å…¥è®¢å•è¡¨, 
            è®¢å•é¡¹è¡¨, 
            æŸ¥è¯¢å•†å“è¡¨çš„åº“å­˜
            æ‰£å‡å•†å“è¡¨çš„åº“å­˜
            æ›´æ–°é”€é‡, è°ƒç”¨æ”¯ä»˜æ–¹æ³•,
            æäº¤è®¢å•åè¦æ¸…ç©ºè´­ç‰©è½¦
            - å®Œæˆåè·³è½¬è®¢å•å®Œæˆé¡µé¢

- æ˜¯å¦è¦ä½¿ç”¨å¤–é”®

  - ä½¿ç”¨å¤–é”®å¯ä»¥ä»æ•°æ®åº“å±‚å¼ºåˆ¶ä¿è¯æ•°æ®çš„ä¸€è‡´æ€§

  - ä¸ä½¿ç”¨å¤–é”®, å¤–é”®å½±å“æ•ˆç‡, ä»ç¨‹åºä¸Šä¿æŒæ•°æ®ä¸€è‡´æ€§

- äº‹åŠ¡å¤„ç†, å¤„ç†æ•°æ®ä¸ä¸€è‡´

  - åœ¨è¿›è¡Œæäº¤è®¢å•æ—¶
    æ‰£å‡åº“å­˜--ä¿®æ”¹å•†å“è¡¨
    æ’å…¥è®¢å•è¡¨
    æ’å…¥è®¢å•é¡¹
    éƒ½ä½¿ç”¨åˆ°äº†BaseDaoä¸­updateæ–¹æ³•, è¿™ä¸ªæ–¹æ³•è¢«è°ƒç”¨äº†å¤šæ¬¡, æ¯æ¬¡éƒ½ä»è¿æ¥æ± æ‹¿å–,ç”¨å®Œæ”¾å›,ä¸èƒ½ä¿è¯æäº¤è®¢å•è¿‡ç¨‹ä¸­ä½¿ç”¨æ˜¯åŒä¸€ä¸ªè¿æ¥

    ```java
    // ä»æ•°æ®åº“è¿æ¥æ± è·å–connection,ä¸èƒ½ä¿è¯è·å–çš„æ˜¯åŒä¸€ä¸ªè¿æ¥
    connection = JdbcDruidUtil.getConnection();
    return queryRunner.update(connection, sql, parameters);
    JdbcDruidUtil.close(null, null, connection);
    ```

    

  - è§£å†³æ–¹æ¡ˆ

    - è¦ä¿è¯åœ¨ä¸€æ¬¡è¯·æ±‚ä¸­, æ˜¯åŒä¸€ä¸ªconnection

    - å°†è‡ªåŠ¨æäº¤äº‹åŠ¡, æ”¹ä¸ºæ‰‹åŠ¨æäº¤äº‹åŠ¡

  - è½åœ°

    - ä½¿ç”¨Filter + ThreadLocalè¿›è¡Œäº‹åŠ¡ç®¡ç†

    - åœ¨ä¸€æ¬¡httpè¯·æ±‚ä¸­, servlet-service-daoçš„è°ƒç”¨è¿‡ç¨‹å§‹ç»ˆæ˜¯ä¸€ä¸ªçº¿ç¨‹, è¿™æ˜¯ä½¿ç”¨ThreadLocalçš„å‰æ

    - ä½¿ç”¨ThreadLocalæ¥ç¡®ä¿æ‰€æœ‰daoæ“ä½œéƒ½åœ¨åŒä¸€ä¸ªConnectionè¿æ¥ä¸­å®Œæˆ

      - é‡å†™JDBCUtilsæ–¹æ³• getConnection(å…³é—­è‡ªåŠ¨æäº¤)

      ```java
       /**
       * ä¿è¯åœ¨åŒä¸€ä¸ªçº¿ç¨‹ä¸­,è·å–çš„æ˜¯åŒä¸€è¿æ¥
       */
      public static Connection getConnection() {
         try {
             Connection connection = connectionThreadLocal.get();
             // è¯´æ˜å½“å‰ThreadLocalä¸­æ²¡æœ‰è¿æ¥
             if (connection == null) {
                 // ä»è¿æ¥æ± ä¸­è·å–ä¸€ä¸ªè¿æ¥æ”¾å…¥åˆ°ThreadLocalä¸­
                 connection = ds.getConnection();
                 // è®¾ç½®äº‹åŠ¡ä¸ºæ‰‹åŠ¨æäº¤
                 connection.setAutoCommit(false);
                 connectionThreadLocal.set(connection);
             }
             return connection;
         } catch (SQLException e) {
             throw new RuntimeException(e);
         }
      }
      ```

      commit

       ```java
    /**
    * æäº¤äº‹åŠ¡
    */
    public static void commit() {
      Connection connection = connectionThreadLocal.get();
      if (connection != null) {
        try {
          connection.commit();
        } catch (SQLException e) {
          throw new RuntimeException(e);
        } finally {
          try {
            connection.close();
          } catch (SQLException e) {
            throw new RuntimeException(e);
          }
        }
      }
      // å½“æäº¤å,éœ€è¦æŠŠconnectionä»threadLocalä¸­æ¸…é™¤
      // ä¸ç„¶ä¼šé€ æˆThreadLocalé•¿æœŸæŒæœ‰è¯¥çº¿ç¨‹, ä¼šå½±å“æ•ˆç‡
      // ä¹Ÿå› ä¸ºTomcatåº•å±‚ä½¿ç”¨çš„ä½¿ç”¨çº¿ç¨‹æ± æŠ€æœ¯
      connectionThreadLocal.remove();
    }
       ```

    rollback

    ```java
    /**
    * å›æ»šäº‹åŠ¡
    */
      public static void rollback() {
      Connection connection = connectionThreadLocal.get();
      // ä¿è¯è¿æ¥æ˜¯æœ‰æ•ˆçš„
      if (connection != null) {
        try {
          connection.rollback();
        } catch (SQLException e) {
          throw new RuntimeException(e);
        } finally {
          try {
            connection.close();
          } catch (SQLException e) {
            throw new RuntimeException(e);
          }
        }
      }
      connectionThreadLocal.remove();
    }
    ```

TransactionFilteräº‹åŠ¡è¿‡æ»¤å™¨
doFilter()

// å‰ç½®ä»£ç ,æ‰‹åŠ¨æäº¤äº‹åŠ¡
autoCommit=false 
è·å–è¿æ¥,è·Ÿå½“å‰çº¿ç¨‹ç»‘å®š-->ThreadLocal
// åç½®ä»£ç 
commit

// å¯¹æ‰€æœ‰è¯·æ±‚å¼€å¯äº‹åŠ¡, ä¸€å®šè¦æŠŠæ‰€æœ‰å¼‚å¸¸æŠ›å‡ºæ¥,åœ¨filterä¸­åœ¨æ•è·

```java
@WebFilter(urlPatterns = {"/*"})
public class TransactionFilter implements Filter {
    @Override
    public void doFilter(ServletRequest request, ServletResponse response, FilterChain chain) throws IOException, ServletException {
        try {
            chain.doFilter(request, response);
            JdbcDruidUtil.commit(); // ç»Ÿä¸€æäº¤äº‹åŠ¡
            System.out.println("äº‹åŠ¡æäº¤æˆåŠŸ~~~~");
        } catch (Exception e) {
            System.out.println("å‘ç”Ÿå¼‚å¸¸,å›æ»šäº‹åŠ¡");
            JdbcDruidUtil.rollback();
            e.printStackTrace();
        }
	}
}
```



- ç»Ÿä¸€é”™è¯¯é¡µé¢å¤„ç†

  - åŸç†

    - æŠ›å‡ºçš„å¼‚å¸¸ä¼šç»™tomcat, tomcatä¼šæ ¹æ®errorPageæ¥æ˜¾ç¤ºå¯¹åº”çš„é¡µé¢(è¿™ä¸ªæ˜¯è½¬å‘åˆ°é¡¹ç›®æ ¹è·¯å¾„, æ‰€ä»¥404.htmlå›¾ç‰‡ç­‰èµ„æºä½¿ç”¨ç›¸å¯¹è·¯å¾„æ—¶è¦æ³¨æ„æ˜¯ç›¸å¯¹äºæ ¹è·¯å¾„çš„)
    - å¼‚å¸¸ä¸€å®šè¦æŠ›å‡ºæ¥, å¦åˆ™ä¸èƒ½è¾¾æˆé¢„æœŸæ•ˆæœ

  - é…ç½®,web.xmlä¸­

    ```xml
    <error-page>
      <error-code>404</error-code>
      <location>/views/error/404.html</location>
    </error-page>
    <error-page>
      <error-code>500</error-code>
      <location>/views/error/500.html</location>
    </error-page>
    ```

    

- ajaxå±€éƒ¨åˆ·æ–°é¡µé¢åŠŸèƒ½

  - æ·»åŠ è´­ç‰©è½¦å,è´­ç‰©è½¦æ•°é‡æ˜¾ç¤ºåŠ 1, ä½†æ˜¯åˆ·æ–°äº†æ•´ä¸ªé¡µé¢,å ç”¨èµ„æºå¤š

  - ä¿®æ”¹æˆä¸åˆ·æ–°æ•´ä¸ªé¡µé¢, ä¹Ÿèƒ½ä¿®æ”¹è´­ç‰©è½¦æ•°é‡

  ```javascript
  // æ·»åŠ è´­ç‰©è½¦
  function addToCart(furnId) {
  $.post({
   url: '/jiaju_mall/cart/addItem',
   data: {
       id: furnId
   },
   dataType: 'json',
   success: function (res, statusText, xhr) {
       if (res.code == 1) {
           // å¤„ç†è½¬å‘æˆ–å®šå‘åˆ°ajaxè¯·æ±‚ä¸Š
           if (res.url) {
            window.location.href = res.url
           } else {
               alert("æ·»åŠ æˆåŠŸ");
               showCartItemCount()
           }
       } else {
           alert("æ·»åŠ å¤±è´¥")
       }
   },
  })
  }
  //æ˜¾ç¤ºè´­ç‰©è½¦
  function showCartItemCount() {
  $.getJSON({
   url:'/jiaju_mall/cart/getCarInfo',
   success: function (res,statusText,xhr){
       let cart = res.cart
       if (res.code == 1) {
           $("#cart_items_count").text(cart.totalCount)
       }
   }
  })
  }
  ```

  

  - é’ˆå¯¹ajaxçš„è½¬å‘å’Œé‡å®šå‘å¤±æ•ˆé—®é¢˜ (è¿‡æ»¤å™¨äº§ç”Ÿçš„é—®é¢˜)

    - ä¸»è¦æ˜¯æœåŠ¡å™¨å¾—åˆ°çš„æ˜¯ajaxå‘é€è¿‡æ¥çš„request,ä¹Ÿå°±æ˜¯è¯´è¿™ä¸ªè¯·æ±‚ä¸æ˜¯æµè§ˆå™¨è¯·æ±‚çš„, è€Œæ˜¯ajaxè¯·æ±‚çš„, æ‰€ä»¥,Servletå¯¹requestè¿›è¡Œè½¬å‘å’Œé‡å®šå‘éƒ½ä¸èƒ½å½±å“æµè§ˆå™¨çš„è·³è½¬
    - è§£å†³:åœ¨è¿‡æ»¤å™¨ä¸­åˆ¤æ–­æ˜¯å¦ä¸ºAJAXè¯·æ±‚,å¦‚æœæ˜¯AJAXè¿”å›url, ä¸æ˜¯AJAXè¯·æ±‚æ—¶è¿›è¡Œè½¬å‘æˆ–è€…é‡å®šå‘
      ç„¶åajaxæ‹¿åˆ°è¯·æ±‚åæ‰§è¡Œwindow.location.href= url

```java
if (request.getHeader("x-requested-with").equals("XMLHttpRequest")) {
  response.setContentType("application/json;utf8");
  Result result = new Result(response);
  result.put("url", request.getContextPath() + loginHtmlPath);
}
```

- ä¸Šä¼ å¤´åƒå›¾ç‰‡åŠŸèƒ½

  - å¤„ç†multipart/form-data