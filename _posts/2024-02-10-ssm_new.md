---
layout:     post
title:      "SSM-latter"
subtitle:   ""
date:       2024-02-10 15:44:00
author:     "zangxin"
header-img: "img/post-bg-2015.jpg"
catalog: true
tags:
---

# Ssm-latter

## spring

æ–‡æ¡£,å®˜ç½‘spring.io

### IOC

- å®šä¹‰

	- ä¼ ç»Ÿåˆ›å»ºå¯¹è±¡,éœ€è¦newæˆ–è€…ä»é…ç½®æ–‡ä»¶ä¸­å–å‡ºå±æ€§ä¿¡æ¯,åå°„åˆ›å»ºå¯¹è±¡,è¿™äº›éƒ½éœ€è¦æ‰‹åŠ¨å»ç®¡ç†å¯¹è±¡

	- iocå°±æ˜¯ä¸€ä¸ªå®¹å™¨, æˆ‘ä»¬å†™å¤šä¸ªå¯¹è±¡é…ç½®æ–‡ä»¶,
ç„¶åiocè¯»å–é…ç½®æ–‡ä»¶, åå°„åˆ›å»º, ç„¶åæ”¾å…¥ä¸€ä¸ªå¹¶å‘mapä¸­,å½“éœ€è¦ä½¿ç”¨å¯¹è±¡å°±getå‡ºæ¥
- quickstart

  - åˆ›å»ºmavenå·¥ç¨‹,å¼•å…¥ä¾èµ–
  spring-version:5.3.8
  spring-context
  spring-beans
  spring-core
  spring-expression
  lombok:1.18.12
  - åˆ›å»ºspringé…ç½®æ–‡ä»¶.beans.xml

```xml
<bean id="user" class="bean.User">
  <property name="username" value="Alice"/>
  <property name="age" value="24"/>
</bean>
```

- å®šä¹‰Userå®ä½“ç±»

  ```java
  @Data
  public class User {
    private String username;
    private Integer age;
  }
  ```

- ä»å®¹å™¨è·å–bean, ä»xmlæ–‡ä»¶ä¸­è·å–çš„è¯è¿™ä¸ªå®¹å™¨

  ```java
  new ClassPathXmlApplicationContext("beans.xml").getBean("user");
  ```

- ç±»è·¯å¾„,SpringBeanTest.classè¿™ä¸ªç±»è¿è¡Œæ—¶çš„è·¯å¾„
  SpringBeanTest.class.getResource("").getPath()

- ç±»è·¯å¾„,SpringBeanTest.classè¿™ä¸ªç±»è¿è¡Œæ—¶çš„æ ¹è·¯å¾„
  SpringBeanTest.class.getClassLoader().getResource("").getPath()

- éå†æ‰€æœ‰å®šä¹‰çš„beançš„åå­—
  String[] definitionNames = ctx.getBeanDefinitionNames();

- beanFactory

1.bfçš„å±æ€§beanDefinitionMapç±»å‹æ˜¯å¹¶å‘Map
2.å­˜æ”¾çš„çš„æ˜¯beans.xmlä¸­beanèŠ‚ç‚¹é…ç½®çš„beanå¯¹è±¡çš„ä¿¡æ¯,
3.åœ¨beanDefinitionMapä¸­å±æ€§table
4.tableæ•°æ•°ç»„,ç±»å‹æ˜¯ConcurrentHashMap$Node
5.å› ä¸ºæ˜¯æ•°ç»„, æ‰€æœ‰å¯ä»¥å­˜æ”¾å¾ˆå¤šçš„beanå¯¹è±¡ä¿¡æ¯,å°±æ˜¯beans.xmlé…ç½®
6.åˆå§‹çš„å¤§å°æ˜¯512,å½“è¶…è¿‡æ—¶ä¼šè‡ªåŠ¨æ‰©å®¹
7.é€šè¿‡hashç®—æ³•,userå¯¹è±¡ä¿¡æ¯ä¿å­˜åœ¨index=502ä½ç½®ä¸Š,
8.ä¿å­˜çš„ç±»å‹æ˜¯Node
9.keyæ˜¯beans.xmlä¸­id

10.valueæ˜¯å¯¹è±¡çš„ä¿¡æ¯,å±æ€§å€¼/ç±»ä¿¡æ¯/æ˜¯ä¸æ˜¯æ‡’åŠ è½½
11.åœ¨beanFactoryä¸­,å±æ€§singletonObjects,ç±»å‹æ˜¯å¹¶å‘Map
è¿˜æœ‰ä¸€ä¸ªå±æ€§tableç±»å‹æ˜¯Nodeçš„æ•°ç»„
12,å¦‚æœbeans.xmlæ–‡ä»¶ä¸­é…ç½®çš„å¯¹è±¡æ˜¯å•ä¾‹çš„, å°±ä¼šåˆå§‹åŒ–æ”¾åˆ°è¿™ä¸ªtableé‡Œé¢
13.åœ¨beanfactoryä¸­,è¿˜æœ‰ä¸€ä¸ªå±æ€§beanDefinitionNames
14è®°å½•ç±»beans.xmlä¸­é…ç½®çš„beançš„åç§°,æ–¹ä¾¿æŸ¥æ‰¾

- å­—æ®µbeanDefinitionMap:å¹¶å‘Map
ä»beans.xmlä¸­è¯»å–çš„beané…ç½®ä¿¡æ¯

	- table:512é•¿åº¦
ç±»å‹ä¸ºNode
- key:beançš„id
	
- value:beanå®šä¹‰ä¿¡æ¯,å±æ€§/æ˜¯å¦å•ä¾‹/æ˜¯å¦æ‡’åŠ è½½
	
- å­—æ®µ:singletonObjects:å¹¶å‘Map
å•ä¾‹å¯¹è±¡å­˜æ”¾çš„åœ°æ–¹

	- table:512é•¿åº¦
ç±»å‹ä¸ºNode
- key:beançš„id
	
- value:å°±æ˜¯å®ä¾‹åŒ–çš„å¯¹è±¡
	
- next:æŒ‡å‘ä¸‹ä¸€ä¸ªèŠ‚ç‚¹
		hash:hashå€¼

- å¦‚æœåœ¨beans.xmlä¸­æ²¡æœ‰é…ç½®id,åˆ™idä¼šé»˜è®¤ä¸ºå…¨ç±»å#indexé…ç½®
bean.User#0
bean.User#1
ctx.getBean("bean.User#0")

- è‡ªå®šä¹‰beanFactory

  - éœ€æ±‚:
  ä½¿ç”¨dom4j+åå°„
  // è‡ªå®šä¹‰ä¸€ä¸ªbeanFactoryçš„singletonObjectsçš„å¹¶å‘map
  // 1.è§£æbeans.xml dom4j
  // 2.å¾—åˆ°å¯¹è±¡çš„id,class,å±æ€§å’Œå±æ€§å€¼
  // 3.ä½¿ç”¨åå°„ç”Ÿæˆå¯¹è±¡,å¹¶èµ‹å€¼
  // 4.å°†åˆ›å»ºå¥½çš„beanå¯¹è±¡æ”¾å…¥singletonObjects
  // 5.æä¾›getBean(id),å¯ä»¥è¿”å›å¯¹åº”çš„beanå¯¹è±¡

  - å®ç°:

    ```java
    class BeanFactory_ {
      private ConcurrentHashMap<String, Object> singletonObjects = new ConcurrentHashMap<>();
      public Object getBean(String id) {
        return singletonObjects.get(id);
      }
      public BeanFactory_(String config) {
        // è¯»å–beans.xmllæ–‡ä»¶
        SAXReader reader = new SAXReader();
        try {
          Document document = reader.read(this.getClass().getClassLoader().getResource(config));
          // ============éå†====================
          Element rootElement = document.getRootElement();
          // è·å–rootçš„ç›´æ¥å­å…ƒç´ 
          List<Element> elements = rootElement.elements();
          for (Element bean : elements) {
            // è·å–beançš„å±æ€§id
            String id = bean.attributeValue("id");
            // è·å–class,åå°„åˆ›å»ºå¯¹è±¡
            String clazz = bean.attributeValue("class");
            Class<?> c = Class.forName(clazz);
            Object obj = c.newInstance();
            // æ”¾å…¥å•ä¾‹æ± ä¸­
            singletonObjects.put(id, obj);
            // è·å–å­—æ®µçš„å±æ€§,å¹¶ä¸”è®¾ç½®å±æ€§
            List<Element> properties = bean.elements("property");
            for (Element property : properties) {
              String name = property.attributeValue("name");
              String value = property.attributeValue("value");
              Field field = c.getDeclaredField(name);
              field.setAccessible(true);
              // æ ¹æ®å­—æ®µç±»å‹æ¥è®¾ç½®å€¼
              if (field.getType() == Integer.class) {
                field.set(obj, Integer.parseInt(value));
              } else if (field.getType() == String.class) {
                field.set(obj, value);
              }
            }
          }
        } catch (Exception e) {
          throw new RuntimeException(e);
        }
      }
    }
    ```

    

- beané…ç½®æ–¹å¼

  - åŸºäºxml

    - è·å–beançš„æ–¹å¼

      - é€šè¿‡ç±»å‹æ¥è·å–,å‰æ:Classåªæœ‰ä¸€ä¸ªå®ä¾‹å¯¹è±¡
      ctx.getBean(Car.class)

      - é€šè¿‡é™æ€å·¥å‚è·å–bean

  ```xml
  <!--classæŒ‡å®šé™æ€å·¥å‚ç±»,æ–¹æ³•æ˜¯å·¥å‚æ–¹æ³•,å¯ä»¥è¿”å›beanå¯¹è±¡, <constructor-argè¡¨ç¤ºæ–¹æ³•å‚æ•°,
  æ ¹æ®è¯¥å‚æ•°ä»å·¥å‚æ–¹æ³•ä¸­è·å–bean-->
  <bean id="zangxin02" class="ioc.MyStaticFactory" factory-method="getUser">
  	<constructor-arg value="zangxin"/>
  </bean> 
  ```

  // å·¥å‚ç±» 

  ```java
  public class MyStaticFactory {
    private static Map<String, User> userMap;
    static {
      userMap = new HashMap<>();
      userMap.put("alice", new User("alice", 23, null));
      userMap.put("zangxin", new User("zangxin", 25, null));
    }
    public static User getUser(String key) {
      return userMap.get(key);
    }
  }
  ```

  

  - å®ä¾‹å·¥å‚è·å–bean


// å®ä¾‹å·¥å‚è¦å…ˆåˆ›å»ºå·¥å‚bean, å› ä¸ºä»–çš„æ–¹æ³•æ˜¯éé™æ€çš„

```xml
<bean class="ioc.MyInstanceFactory" id="myInstanceFactory"/>
<bean id="alice02" factory-bean="myInstanceFactory"
factory-method="getUser">
	<constructor-arg value="alice"/>
</bean>
```

```java
public class MyStaticFactory {
  private static Map<String, User> userMap;
  static {
    userMap = new HashMap<>();
    userMap.put("alice", new User("alice", 23, null));
    userMap.put("zangxin", new User("zangxin", 25, null));
  }
  public static User getUser(String key) {
    return userMap.get(key);
  }
}
```



- é€šè¿‡FactoryBeanè·å–bean(é‡ç‚¹)


```xml
<!--è¿™é‡Œçš„classæŒ‡å®šè¦ä½¿ç”¨çš„FactoryBean
keyè¡¨ç¤ºå°±æ˜¯MyFactoryBeançš„å±æ€§key-->
<bean id="alice03" class="ioc.MyFactoryBean">
	<property name="key" value="alice"/>
</bean>
```

```java
public class MyFactoryBean implements FactoryBean<User> {
  // è¿™ä¸ªkeyå°±æ˜¯åœ¨é…ç½®æ—¶,æŒ‡å®šçš„è¦è·å–çš„å¯¹è±¡å¯¹åº”çš„key
  private String key;
  private Map<String, User> userMap;

  public void setKey(String key) {
    this.key = key;
  }

  {
    userMap = new HashMap<>();
    userMap.put("alice", new User("alice", 23, null));
    userMap.put("zangxin", new User("zangxin", 25, null));
  }

  @Override
  public User getObject() throws Exception {
    return userMap.get(key);
  }

  @Override
  public Class<?> getObjectType() {
    return User.class;
  }

  @Override
  public boolean isSingleton() {
    return true;
  }
}
```

å¤ç”¨bean,ä½¿ç”¨parentå±æ€§

```xml
<bean id="alice04" class="bean.User" parent="alice"/>
```

 å¤ç”¨bean,ä½¿ç”¨abstract,åªèƒ½ä½œä¸ºparent,ä¸èƒ½è·å–

```xml
<bean id="alice05" class="bean.User" abstract="true" p:username="alice05" p:age="24" p:car-ref="audi">
```
 å±æ€§æ³¨å…¥æ–¹å¼

setteré…ç½®å±æ€§

\<property/\>æ˜¯é€šè¿‡setteræ¥è®¾ç½®å€¼çš„,å‰æ:å¯¹è±¡æœ‰setter


```xml
<bean class="bean.Car" id="car">
  <property name="id" value="1"/>
  <property name="name" value="bmw"/>
  <property name="price" value="1000000"/>
</bean>
```
constructoré…ç½®å±æ€§

é€šè¿‡ç´¢å¼•

```xml
<bean id="bmw" class="bean.Car">
    <constructor-arg value="2" index="0"/>
    <constructor-arg value="å®é©¬" index="1"/>
    <constructor-arg value="400000" index="2"/>
</bean>
```
é€šè¿‡å±æ€§å

```xml
<bean id="bench" class="bean.Car">
    <constructor-arg value="2" name="id"/>
    <constructor-arg value="å¥”é©°" name="name"/>
    <constructor-arg value="400000" name="price"/>
</bean>
```
 é€šè¿‡å±æ€§çš„ç±»å‹

```xml
<bean id="audi" class="bean.Car">
    <constructor-arg value="2" type="java.lang.Integer"/>
    <constructor-arg value="å¥¥è¿ª" type="java.lang.String"/>
    <constructor-arg value="400000" type="java.lang.Double"/>
</bean>
```
é€šè¿‡å‘½åç©ºé—´p

```xml
<bean id="fort" class="bean.Car" p:id="3" p:name="ç¦ç‰¹" p:price="500000"/>
```
refå¼•ç”¨å…¶ä»–å¯¹è±¡ä½œä¸ºå±æ€§

```xml
<bean class="bean.User" id="zangxin">
  <property name="username" value="zangxin"/>
  <property name="age" value="22"/>
  <property name="car" ref="fort"/>
</bean>
<bean id="fort" class="bean.Car" p:id="3" p:name="ç¦ç‰¹" p:price="500000"/>
```
ä¸ç”¨refç”¨å†…éƒ¨beanä¹Ÿå¯ä»¥

```xml
<bean class="bean.User" id="alice">
    <property name="username" value="Alice"/>
    <property name="age" value="24"/>
    <property name="car">
        <bean class="bean.Car" p:id="4" p:name="ä¿æ—¶æ·" p:price="50000000"/>
    </property>
</bean>
```
æ³¨å…¥é›†åˆ(map,propertis,list,set)/æ•°ç»„ç±»å‹

```xml
<bean id="manager" class="bean.Manager">
  <property name="name" value="chaos"/>
  <property name="userList">
    <!--Listèµ‹å€¼-->
    <list>
      <ref bean="alice"/>
      <ref bean="zangxin"/>
      <bean class="bean.User" p:username="hyy" p:age="25" p:car-ref="audi"/>
    </list>
  </property>
  <!--mapèµ‹å€¼-->
  <property name="userMap">
    <map>
      <entry key="alice" value-ref="alice"/>
    </map>
  </property>
  <!--ç»™æ•°ç»„èµ‹å€¼-->
  <property name="userName">
    <array value-type="java.lang.String">
      <value>alice</value>
      <value>znagxin</value>
    </array>
  </property>
  <!--ç»™setèµ‹å€¼-->
  <property name="userSet">
    <set value-type="bean.User">
      <ref bean="alice"/>
      <ref bean="zangxin"/>
    </set>
  </property>
  <!--ç»™propertiesèµ‹å€¼-->
  <property name="pros">
    <props>
      <prop key="username">root</prop>
      <prop key="password">root</prop>
      <prop key="url">jdbc:mysql://localhost:3306/</prop>
    </props>
  </property>
</bean>
```
é€šè¿‡ util åç§°ç©ºé—´åˆ›å»º list

å¯ä»¥è¾¾åˆ°å¤ç”¨æ•ˆæœ

```xml
<util:list id="bookList">
  <value>å­˜åœ¨ä¸æ—¶é—´</value>
  <value>è¥¿æ¸¸è®°</value>
  <value>ç‹¼é“</value>
  <value>é‡‘å­—å¡”æ¨¡å¼</value>
  <value>çº¢æ¥¼æ¢¦</value>
  <value>é‡‘ç“¶æ¢…å…¸è—ç‰ˆ</value>
</util:list>

<bean id="bookStore1" class="bean.BookStore">
  <property name="bookList" ref="bookList"/>
</bean>

<bean id="bookStore2" class="bean.BookStore">
  <property name="bookList" ref="bookList"/>
</bean>
```
çº§è”å±æ€§èµ‹å€¼

```xml
 <bean id="dept" class="bean.Dept"/>
<bean id="emp" class="bean.Emp">
    <property name="name" value="jack"/>
    <property name="dept" ref="dept"/>
    // æŠŠdeptçš„nameå±æ€§è®¾ç½®ä¸ºè½¯ä»¶å¼€å‘éƒ¨é—¨
    <property name="dept.name" value="è½¯ä»¶å¼€å‘éƒ¨é—¨"/>
</bean>
```
é€šè¿‡.propertiesæ–‡ä»¶ç»™beanæ³¨å…¥å€¼



```xml
<!--æŒ‡å®šé…ç½®æ–‡ä»¶çš„ä½ç½®,locationæŒ‡å®šå±æ€§æ–‡ä»¶çš„ä½ç½®,è¦å¸¦ä¸Šclasspath-->
<context:property-placeholder location="classpath:user.properties"/>
<!--ä½¿ç”¨é…ç½®æ–‡ä»¶,${}æ¥åº”ç”¨é…ç½®æ–‡ä»¶ä¸­çš„key-->
<bean id="zangxin03" class="bean.User" p:username="${username}" p:age="${age}"/>
```
user.propetiesæ–‡ä»¶è¦æ”¾åœ¨resourcesç›®å½•ä¸‹,æœ€ç»ˆæ‰“åŒ…åœ¨ç±»çš„æ ¹è·¯å¾„
username=zangxin
age=27

å±æ€§æ–‡ä»¶æœ‰ä¸­æ–‡, éœ€è¦è½¬æ¢æˆuicodeç¼–ç 

 beançš„åˆ›å»ºé¡ºåº

 åœ¨ spring çš„ ioc å®¹å™¨, é»˜è®¤æ˜¯æŒ‰ç…§é…ç½®çš„é¡ºåºåˆ›å»º bean å¯¹è±¡

depends-onæŒ‡å®šé¡ºåº



```xml
<bean id="student01" class="com.hspedu.bean.Student" depends-on="department01"/>
<bean id="department01" class="com.hspedu.bean.Department" />
```
ä¼šå…ˆåˆ›å»º department01 å¯¹è±¡ï¼Œå†åˆ›å»º student01 å¯¹è±¡

å¦‚æœAå¼•ç”¨B, Båœ¨Açš„å‰é¢

å…ˆåˆ›å»ºB

å†åˆ›å»ºAå¹¶setterB



å¦‚æœA,å¼•ç”¨äº†(ref)B, é…ç½®é¡ºåºAåœ¨Bå‰é¢ä¼šæ€ä¹ˆæ ·?

 Aå…ˆåˆ›å»º

Båœ¨åˆ›å»º
A setter B

beanå¯¹è±¡çš„å•ä¾‹å’Œå¤šä¾‹scopeå’Œ æ‡’åŠ è½½

é»˜è®¤scope=singleton

ä½¿ç”¨å¤šä¾‹ scope=prototype

ç»†èŠ‚

1.é»˜è®¤æ˜¯å•ä¾‹singleton, åœ¨å¯åŠ¨å®¹å™¨æ—¶, é»˜è®¤å°±ä¼šåˆ›å»º , å¹¶æ”¾å…¥åˆ°singletonObjectsé›†åˆ

2.å½“ \<bean scope="prototype"\> è®¾ç½®ä¸ºå¤šå®ä¾‹æœºåˆ¶å, è¯¥ bean æ˜¯åœ¨ getBean()æ—¶æ‰åˆ› å»º
3.å¦‚æœæ˜¯å•ä¾‹ singleton, åŒæ—¶å¸Œæœ›åœ¨ getBean æ—¶æ‰åˆ›å»º, å¯ä»¥ æŒ‡å®šæ‡’åŠ è½½ lazy-init="true" (æ³¨æ„é»˜è®¤æ˜¯ false)

4.é€šå¸¸æƒ…å†µä¸‹, lazy-init å°±ä½¿ç”¨é»˜è®¤å€¼ false , åœ¨å¼€å‘çœ‹æ¥, ç”¨ç©ºé—´æ¢æ—¶é—´æ˜¯å€¼å¾—çš„, é™¤éæœ‰ç‰¹æ®Šçš„è¦æ±‚.
5.å¦‚æœ scope="prototype" è¿™æ—¶ä½ çš„ lazy-init å±æ€§çš„å€¼ä¸ç®¡æ˜¯ ture, è¿˜æ˜¯ false éƒ½æ˜¯åœ¨getBean æ—¶å€™ï¼Œæ‰åˆ›å»ºå¯¹è±¡



beançš„ç”Ÿå‘½å‘¨æœŸ

1. åˆå§‹åŒ– init æ–¹æ³•å’Œ destory æ–¹æ³•, æ˜¯ç¨‹åºå‘˜æ¥æŒ‡å®š 
2.  é”€æ¯æ–¹æ³•å°±æ˜¯å½“å…³é—­å®¹å™¨æ—¶ï¼Œæ‰ä¼šè¢«è°ƒç”¨.
3. æ‰§è¡Œé¡ºåº

LifeCycle.LifeCycle æ— å‚æ„é€ å™¨
LifeCycle.setName setteræ–¹æ³•
LifeCycle.init åˆå§‹åŒ–æ–¹æ³•
ä½¿ç”¨ bean.LifeCycle@5884a914
LifeCycle.destroy é”€æ¯æ–¹æ³•

```xml
<!--beançš„ç”Ÿå‘½å‘¨æœŸ-->
<bean id="lifeCycle" class="bean.LifeCycle" init-method="init" destroy-method="destroy">
  <property name="name" value="ç”Ÿå‘½å‘¨æœŸ"/>
</bean>
```
```java
public class LifeCycle {
  private String name;
  public LifeCycle() {
    System.out.println("LifeCycle.LifeCycle æ— å‚æ„é€ å™¨");
  }
  public void setName(String name) {
    System.out.println("LifeCycle.setName setteræ–¹æ³•");
    this.name = name;
  }
  /**
  * initå’Œdestroyåç§°éšä¾¿è‡ªå®šä¹‰
  * è¦ä½¿ç”¨éœ€è¦åœ¨xmlä¸­æŒ‡å®šinit-method
    */
  public void init() {
    System.out.println("LifeCycle.init åˆå§‹åŒ–æ–¹æ³•");
  }
  public void destroy() {
    System.out.println("LifeCycle.destroy é”€æ¯æ–¹æ³•");
  }
}
```

æµ‹è¯•

```java
// beançš„ç”Ÿå‘½å‘¨æœŸ
ClassPathXmlApplicationContext ctx = new ClassPathXmlApplicationContext("/beans.xml");
Object lifeCycle = ctx.getBean("lifeCycle");
System.out.println("ä½¿ç”¨ " + lifeCycle);
// å…³é—­,é”€æ¯æ”¾åœ¨åªæœ‰è°ƒç”¨å…³é—­å®¹å™¨æ–¹æ³•æ—¶,æ‰è°ƒç”¨
ctx.close();
```



- beançš„åç½®å¤„ç†å™¨
- è¯¥å¤„ç†å™¨/å¯¹è±¡ä¼šåœ¨ bean åˆå§‹åŒ–æ–¹æ³•è°ƒç”¨å‰å’Œåˆå§‹åŒ–æ–¹æ³•è°ƒç”¨åè¢«è°ƒç”¨

```java
public class MyBeanPostProcessor implements BeanPostProcessor {
  /**

  * åœ¨beançš„initæ–¹æ³•å‰è¢«è°ƒç”¨, æ²¡æœ‰é…ç½®initæ–¹æ³•ä¹Ÿä¼šè¢«è°ƒç”¨
    *
  * @param bean     ä¼ å…¥åœ¨iocå®¹å™¨ä¸­åˆ›å»º/é…ç½®beanå¯¹è±¡
  * @param beanName ä¼ å…¥åœ¨iocå®¹å™¨åˆ›å»º/é…ç½®beançš„id
  * @return å¯¹ä¼ å…¥çš„beanè¿›è¡Œä¿®æ”¹/å¤„ç†(å¦‚æœæœ‰éœ€è¦çš„è¯), è¿”å›
    */
  @Override
  public Object postProcessBeforeInitialization(Object bean, String beanName) throws BeansException {
    System.out.println("postProcessBeforeInitialization : beanName=" + beanName + " " + bean);
    return bean;
  }
  /**
  * åœ¨bean initæ–¹æ³•åè¢«è°ƒç”¨, æ²¡æœ‰é…ç½®initæ–¹æ³•ä¹Ÿä¼šè¢«è°ƒç”¨
  *
  * @param bean     ä¼ å…¥åœ¨iocå®¹å™¨ä¸­åˆ›å»º/é…ç½®beanå¯¹è±¡
  * @param beanName ä¼ å…¥åœ¨iocå®¹å™¨åˆ›å»º/é…ç½®beançš„id
  * @return å¯¹ä¼ å…¥çš„beanè¿›è¡Œä¿®æ”¹/å¤„ç†(å¦‚æœæœ‰éœ€è¦çš„è¯), è¿”å›
  */
  @Override
  public Object postProcessAfterInitialization(Object bean, String beanName) throws BeansException {
    System.out.println("postProcessAfterInitialization : beanName=" + beanName + " " + bean);
    return bean;
  }
}
```

```xml
<bean id="myBeanPostProcessor" class="bean.MyBeanPostProcessor"/>
```



// è¾“å‡º

```text
LifeCycle.LifeCycle æ— å‚æ„é€ å™¨
LifeCycle.setName setteræ–¹æ³•
postProcessBeforeInitialization : beanName=lifeCycle LifeCycle(name=ç”Ÿå‘½å‘¨æœŸ)
LifeCycle.init åˆå§‹åŒ–æ–¹æ³•
postProcessAfterInitialization : beanName=lifeCycle LifeCycle(name=ç”Ÿå‘½å‘¨æœŸ)
ä½¿ç”¨ LifeCycle(name=ç”Ÿå‘½å‘¨æœŸ)
LifeCycle.destroy é”€æ¯æ–¹æ³•
```

beanåç½®å¤„ç†å™¨å¯¹beans.xmlæ–‡ä»¶ä¸­æ‰€æœ‰beanéƒ½æœ‰æ•ˆ

åŸç†: AOP(åå°„+åŠ¨æ€ä»£ç†)

 ç”¨å¤„:å¯ä»¥å¯¹ IOC å®¹å™¨ä¸­æ‰€æœ‰çš„å¯¹è±¡è¿›è¡Œç»Ÿä¸€å¤„ç† ,

æ¯”å¦‚æ—¥å¿—å¤„ç†/æƒé™çš„æ ¡éªŒ/å®‰å…¨çš„éªŒè¯/äº‹åŠ¡ç®¡ç†.



- xmlçš„è‡ªåŠ¨è£…é…autowire

  - byType

  ```xml
  <!--è‡ªåŠ¨è£…é… autowire byTypeæŒ‰å±æ€§çš„ç±»å‹è£…é…, åœ¨iocå®¹å™¨ä¸­æ‰¾,
  å¦‚æœæœ‰å°±ç”¨setteræ³¨å…¥,å¦‚æœæ²¡æœ‰æˆ–è€…æœ‰2ä¸ªä»¥ä¸Š,å°±ä¼šæŠ¥é”™,ä¸çŸ¥é“è£…é…å“ªä¸€ä¸ª-->
  <bean id="orderDao" class="bean.OrderDao"/>
  <bean id="orderService" class="bean.OrderService" autowire="byType"/>
  <bean id="orderController" class="bean.OrderController" autowire="byType"/>
  ```

  

  - byName(setterçš„name)

  ```xml
  <!--byNameæŒ‰idåç§°è‡ªåŠ¨è£…é… ä¼šè‡ªåŠ¨å»æ‰¾idä¸ºsetXxxçš„idåä¸ºä¸ºXxxçš„beanè‡ªåŠ¨è£…é…, æ‰¾ä¸åˆ°å°±æŠ¥é”™-->
  <bean id="orderDao" class="bean.OrderDao"/>
  <bean id="orderService" class="bean.OrderService" autowire="byName"/>
  <bean id="orderController" class="bean.OrderController" autowire="byName"/>
  ```

  

- spring elè¡¨è¾¾å¼

  - spring expression language, ç®€ç§°ä¸ºSpELæ”¯æŒè¿è¡Œæ—¶æŸ¥è¯¢å¹¶å¯ä»¥æ“ ä½œå¯¹è±¡ã€‚
  å’Œ EL è¡¨è¾¾å¼ä¸€æ ·ï¼ŒSpEL æ ¹æ® JavaBean é£æ ¼çš„ getXxx()ã€setXxx()æ–¹æ³•å®šä¹‰çš„å±æ€§è®¿é—®
  å¯¹è±¡,
   SpEL ä½¿ç”¨#{...}ä½œä¸ºå®šç•Œç¬¦ï¼Œæ‰€æœ‰åœ¨å¤§æ¡†å·ä¸­çš„å­—ç¬¦éƒ½å°†è¢«è®¤ä¸ºæ˜¯ SpEL è¡¨è¾¾å¼


  ```xml
  <!--spring elè¡¨è¾¾å¼-->
  <bean id="spELBean" class="bean.SpELBean">
    <!--ä½¿ç”¨å­—ç¬¦èµ‹å€¼-->
    <property name="name" value="#{'zangxin'}"/>
    <!--å¼•ç”¨å¯¹è±¡å±æ€§èµ‹å€¼-->
    <property name="username" value="#{zangxin03.username}"/>
    <!--å¼•ç”¨å¯¹è±¡èµ‹å€¼-->
    <property name="user" value="#{zangxin}"/>
    <!--æ™®é€šæ–¹æ³•è¿”å›å€¼èµ‹å€¼-->
    <property name="crySound" value="#{spELBean.cry('å–µå–µå–µ')}"/>
    <!--é™æ€æ–¹æ³•è¿”å›å€¼èµ‹å€¼-->
    <property name="bookName" value="#{T(bean.SpELBean).read('å­˜åœ¨ä¸æ—¶é—´')}"/>
    <!--è®¡ç®—-->
    <property name="result" value="#{3.14*2*2}"/>
  </bean>
  ```

  

- åŸºäºæ³¨è§£

  - å¼€å¯æ³¨è§£

  - æ³¨è§£éœ€è¦aopä¾èµ–spring-aop
    åœ¨xmlæ–‡ä»¶ä¸­åŠ å…¥æ³¨è§£æ‰«æ

    ```xml
    <!--å¼€å¯æ³¨è§£æ‰«æ-->
    <context:component-scan base-package="baseonannot.commponent"/>
    ```

    

  - ç»„ä»¶æ³¨è§£

  	- ä¸‹é¢ç»„ä»¶å¯ä»¥è¢«springæ‰«ææ”¾å…¥å®¹å™¨ä¸­
  1.@Component é€šç”¨ç»„ä»¶
  2.@Controller æ ‡è¯†ä¸€ä¸ªæ§åˆ¶å™¨å¯¹è±¡(åœ¨springmvcæ˜¯æœ‰ç‰¹å®šå«ä¹‰)
  3.@Service æ ‡è¯†ä¸šåŠ¡å±‚å¯¹è±¡
  4.@Repository æ ‡è¯†æŒä¹…å±‚å¯¹è±¡
  - Spring çš„ IOC å®¹å™¨ä¸èƒ½æ£€æµ‹ä¸€ä¸ªä½¿ç”¨äº†@Controller æ³¨è§£çš„ç±»åˆ°åº•æ˜¯ä¸æ˜¯ä¸€ä¸ªçœŸæ­£çš„æ§ åˆ¶å™¨ã€‚æ³¨è§£çš„åç§°æ˜¯ç”¨äºç¨‹åºå‘˜è‡ªå·±è¯†åˆ«å½“å‰æ ‡è¯†çš„æ˜¯ä»€ä¹ˆç»„ä»¶ã€‚å…¶å®ƒçš„@Service @Repository ä¹Ÿæ˜¯ä¸€æ ·çš„é“ç† [ä¹Ÿå°±æ˜¯è¯´springçš„IOCå®¹å™¨åªè¦æ£€æŸ¥åˆ°æ³¨è§£å°±ä¼šç”Ÿæˆå¯¹è±¡ï¼Œ ä½†æ˜¯è¿™ä¸ªæ³¨è§£çš„å«ä¹‰ spring ä¸ä¼šè¯†åˆ«ï¼Œæ³¨è§£æ˜¯ç»™ç¨‹åºå‘˜ç¼–ç¨‹æ–¹ä¾¿çœ‹çš„]
  	
  - å•ä¾‹å’Œå¤šä¾‹@Scopeæ³¨è§£

  	- prototypes å¤šä¾‹
  singleton å•ä¾‹(é»˜è®¤)

  - åŒ…æ‰«æç»†èŠ‚

    - åªæ‰«æç‰¹å®šç±»æ–‡ä»¶

    ```xml
    <context:component-scan base-package="com.hspedu.spring.component" resource-pattern="User*.class" />
    ```

    resource-pattern="User*.class": è¡¨ç¤ºåªæ‰«ææ»¡è¶³è¦æ±‚çš„ ç±».[ä½¿ç”¨çš„å°‘ï¼Œä¸æƒ³æ‰«æï¼Œä¸å†™æ³¨è§£å°±å¯ä»¥, 

    - ä¸æ‰«ææŸäº›æ³¨è§£

    ```xml
    <!-- æ’é™¤å“ªäº›ç±» , ä»¥ annotaion æ³¨è§£ä¸ºä¾‹,ä¸æ‰«ææ ‡æ³¨äº†Controllerçš„æ³¨è§£ --> 
    <context:component-scan base-package="baseonannot.commponent">
      <context:exclude-filter type="annotation" expression="org.springframework.stereotype.Controller"/>
    </context:component-scan>
    ```

    - æ‰«ææŸäº›æ³¨è§£

    ```xml
    <!--åªæ‰«æç‰¹å®šæ³¨è§£, serviceå’Œdao-->
    <context:component-scan base-package="baseonannot.commponent" use-default-filters="false">
     <context:include-filter type="annotation" expression="org.springframework.stereotype.Service"/>
     <context:include-filter type="annotation" expression="org.springframework.stereotype.Repository"/>
    </context:component-scan>
    ```

    

  - æ³¨è§£é»˜è®¤åå­—

  	- é»˜è®¤ç±»åé¦–å­—æ¯å°å†™ä½œä¸ºidçš„å€¼(concurrentHashpMapçš„key)

  	- ä¹Ÿå¯ä»¥ä½¿ç”¨æ³¨è§£çš„valueå±æ€§æ¥è®¾ç½®idå€¼
  @Repository("dao")
  public class UserDao {}

  - æ‰‹æ’•æ³¨è§£

    - 1.åœ¨beans.xmlä¸­é…ç½®äº†åŒ…æ‰«æçš„è·¯å¾„,æŒ‡å®šè¦æ‰«æçš„åŒ…
      2.ClassPathXmlApplicationnContextåŠ è½½beans.xmlæ–‡ä»¶,
      3.æ ¹æ®åŒ…æ‰«ææ¥æ‰¾åˆ°æ ‡æœ‰æœ‰æ³¨è§£çš„ç±»
      4.å®ä¾‹åŒ–å¯¹è±¡,æ”¾å…¥åˆ°å®¹å™¨ä¸­,singletonObjects
      5.æä¾›getBeanæ–¹æ³•

```java
/**
 * ç»„ä»¶,è¢«æ³¨è§£ä¿®é¥°çš„ç±»éƒ½ä¼šè¢«æ‰«æ
 */
@Target(ElementType.TYPE)
@Retention(RetentionPolicy.RUNTIME)
public @interface MyComponent {
  String value() default "";
}
```



```java
/**
* æ ¹æ®ä¼ å…¥çš„MySpringConfigå»æ‰«æåŒ…
*/
public class MyAnnotationFactory {
  private Class configClass;
  /**
   * å­˜æ”¾å¯¹è±¡, key=id, value=å¯¹è±¡
   */
  private final ConcurrentHashMap<String, Object> ioc = new ConcurrentHashMap<>();
  public MyAnnotationFactory(Class config) throws Exception {
    this.configClass = config;
    Annotation anno = configClass.getDeclaredAnnotation(MyComponentScan.class);
    if (anno instanceof MyComponentScan ms) {
      String path = ms.value();
      // åŒ…->è·¯å¾„: baseonannot/commponent
      path = path.replace(".", "/");
      ClassLoader classLoader = MyAnnotationFactory.class.getClassLoader();
      String dirPath = classLoader.getResource(path).getPath();
      File file = new File(dirPath);
      File[] files = file.listFiles();
      // éå†è·¯å¾„ä¸‹çš„.classæ–‡ä»¶,æœ‰æ³¨è§£æ‰åŠ å…¥åˆ°å®¹å™¨
      for (File f : files) {
        String ap = f.getAbsolutePath();
        // ä¸æ˜¯å­—èŠ‚ç æ–‡ä»¶,ä¸å¤„ç†
        if (!ap.endsWith(".class")) {
          continue;
        }
        // è·å–ç±»å: UserDao
        String className = ap.substring(ap.lastIndexOf("/") + 1, ap.lastIndexOf("."));
        // ç»“æœå…¨ç±»å: baseonannot.commponent.UserService
        String fullName = path.replace("/", ".") + "." + className;
        // åå°„åŠ è½½ç±», forNameå’ŒloadClassçš„åŒºåˆ«æ˜¯:forNameä¼šæ‰§è¡Œè°ƒç”¨è¯¥ç±»çš„é™æ€æ–¹æ³•,ä¸‹é¢çš„æ–¹å¼ä¸ä¼š
        Class<?> clazz = classLoader.loadClass(fullName);
        // å¦‚æœæ²¡æœ‰MyComponentæ³¨è§£å°±ä¸åŠ å…¥å®¹å™¨é‡Œå»
        MyComponent cptAnno = clazz.getDeclaredAnnotation(MyComponent.class);
        if (cptAnno == null) {
          continue;
        }
        // åå°„åˆ›å»ºå¯¹è±¡
        Class<?> targetClass = Class.forName(fullName);
        Object obj = targetClass.newInstance();
        // è®¾ç½®é»˜è®¤çš„id
        String id = cptAnno.value();
        if (id.equals("")) {
          id = className.substring(0, 1).toLowerCase(Locale.ROOT) + className.substring(1);
        }
        ioc.put(id, obj);
      }
    }
  }

  public Object getBean(String id) {
    return ioc.get(id);
  }

  public Map<String, Object> getIoc() {
    return ioc;
  }
}
```



```java
/**
* ç±»ä¼¼äºbeans.xml
* è¯¥ç±»æ ‡è¯†äº†ä¸€ä¸ªæ³¨è§£@componentScan
* å‘Šè¯‰è¦æ‰«æå“ªäº›åŒ…
*/
@MyComponentScan(value = "baseonannot.commponent")
class MySpringConfig {}
```



```java
/**
 * æŒ‡å®šæ‰«æçš„åŒ…è·¯å¾„
 */
@Target(ElementType.TYPE)
@Retention(RetentionPolicy.RUNTIME)
@interface MyComponentScan {
  String value() default "";
}
```



```
ç»†èŠ‚
åå°„åŠ è½½ç±», forNameå’ŒloadClassçš„åŒºåˆ«æ˜¯:
forNameä¼šæ‰§è¡Œè°ƒç”¨è¯¥ç±»çš„é™æ€æ–¹æ³•,
classLoader.loadClassä¸ä¼š
```
// é¦–å­—æ¯å°å†™-springçš„stringUtilså·¥å…·ç±»
id = StringUtils.uncapitalize(className)



 è‡ªåŠ¨è£…é…

 åœ¨ IOC å®¹å™¨ä¸­æŸ¥æ‰¾å¾…è£…é…çš„ç»„ä»¶çš„ç±»å‹ï¼Œå¦‚æœæœ‰å”¯ä¸€çš„ bean åŒ¹é…ï¼Œåˆ™ä½¿ç”¨è¯¥ bean è£…é…

å¦‚å¾…è£…é…çš„ç±»å‹å¯¹åº”çš„ bean åœ¨ IOC å®¹å™¨ä¸­æœ‰å¤šä¸ªï¼Œåˆ™ä½¿ç”¨å¾…è£…é…çš„å±æ€§çš„å±æ€§åä½œä¸º id å€¼å†è¿›è¡ŒæŸ¥æ‰¾, æ‰¾åˆ°å°±è£…é…ï¼Œæ‰¾ä¸åˆ°å°±æŠ›å¼‚å¸¸

å¯ä»¥å’Œ@Qualifier("userDao")é…åˆä½¿ç”¨,æŒ‡å®šid

 @Resource,è¿™ä¸ªæ˜¯jdkçš„æ³¨è§£,ç‰ˆæœ¬é«˜äº8çš„éœ€è¦é¢å¤–å¼•å…¥ä¾èµ–

nameå±æ€§ bean çš„åå­—

typeå±æ€§ bean çš„ç±»å‹

æ‰€ä»¥å¦‚æœä½¿ç”¨ name å± æ€§,åˆ™ä½¿ç”¨ byName çš„è‡ªåŠ¨æ³¨å…¥ç­–ç•¥,è€Œä½¿ç”¨ type å±æ€§æ—¶åˆ™ä½¿ç”¨ byType è‡ªåŠ¨æ³¨å…¥ç­–ç•¥

å¦‚æœ@Resource æ²¡æœ‰æŒ‡å®š name å’Œ type,åˆ™å…ˆä½¿ç”¨byNameæ³¨å…¥ç­–ç•¥, å¦‚æœåŒ¹é…ä¸ä¸Š, å†ä½¿ç”¨ byType ç­–ç•¥, å¦‚æœéƒ½ä¸æˆåŠŸï¼Œå°±ä¼šæŠ¥é”™

æ³›å‹ä¾èµ–æ³¨å…¥

åœ¨æ³›å‹çˆ¶ç±»ä¸­æ³¨å…¥, å­ç±»å°±ä¸ç”¨æ³¨å…¥äº†

```java
public abstract class BaseDao<T> {
  public abstract void save();
}
```


```java
public abstract class BaseService<T> {
  @Autowired
  private BaseDao<T> baseDao;
  public void save() {
    baseDao.save();
  }
}
```
åç½®å¤„ç†å™¨

initå’Œdestroyæ–¹æ³•å˜æˆä¸¤ä¸ªæ¥å£äº†

InitializingBean å¯¹åº”initæ–¹æ³•,åœ¨setteråé¢æ‰§è¡Œ

DisposableBean å¯¹åº”destroy, åœ¨closeå®¹å™¨å‰æ‰§è¡Œ

å¦‚æœbeançš„scopeæ˜¯prototype, é‚£ä¹ˆæ¯æ¬¡getBeanä¸€æ¬¡éƒ½ä¼šåˆ›å»ºä¸€æ¬¡bean, ä¹Ÿä¼šè°ƒç”¨æ— å‚,setter,init,åç½®å¤„ç†å™¨

prototypeæ—¶ä¸å†è°ƒç”¨destroyæ–¹æ³•äº†



### AOP

- ä¸€ä¸ªéœ€æ±‚,ç»Ÿè®¡æ–¹æ³•æ‰§è¡Œè€—æ—¶

  - ä¼ ç»Ÿæ–¹æ³•,ä½¿ç”¨æ¨¡æ¿æ–¹æ³•

  ```java
  public abstract class Vehicle {
    protected abstract void run0();
    public void run() {
      System.out.println("è®¡æ—¶å¼€å¯");
      run0();
      System.out.println("è®¡æ—¶ç»“æŸ");
    }
  }
  public class Car extends Vehicle{
    @Override
    public void run0() {
      System.out.println("å°æ±½è½¦è¡Œé©¶");
    }
  }
  public class RunVehicle {
    public static void main(String[] args) {
      run(new Car());
    }
  
    public static void run(Vehicle vehicle) {
      vehicle.run();
    }
  }
  ```

  

- åŠ¨æ€ä»£ç†(æ ¸å¿ƒ)

  - åŠ¨æ€ä»£ç†æ ¸å¿ƒ

    ```java
    public class VehicleProxyProvider {
    /**
    * è¢«ä»£ç†çš„å¯¹è±¡
    */
      private Vehicle targetVehicle;
    /**
    * è·å–ä»£ç†å¯¹è±¡çš„æ–¹æ³•
    */
      public Vehicle getProxy() {
        /**
        * è°ƒç”¨å¤„ç†å™¨: ä½œç”¨æ˜¯å¯¹æ–¹è¿›è¡Œå¢å¼ºåŠŸèƒ½:å‰ç½®æˆ–è€…åç½®è¿›è¡Œå¤„ç†
        * targetVehicle è¢«ä»£ç†çš„å¯¹è±¡
        * method è¢«ä»£ç†çš„æ–¹æ³•
        * args è¢«ä»£ç†æ–¹æ³•çš„å‚æ•°
        * proxy ä»£ç†å¯¹è±¡
        */
        InvocationHandler handler = (proxy, method, args) -> {
          System.out.println("å‰ç½®å¤„ç†");
          // è¿™é‡Œåå°„è°ƒç”¨è¢«ä»£ç†å¯¹è±¡çš„æ–¹æ³•,å¦‚æœæœ‰ç»“æœå°±è¿”å›
          Object result = method.invoke(targetVehicle, args);
          System.out.println("åç½®å¤„ç†");
          return result;
        };
        Class clazz = this.targetVehicle.getClass();
        /**
        * è¿™é‡Œåˆ›å»ºä¸€ä¸ªä»£ç†å¯¹è±¡
        * å‚æ•°åˆ†åˆ«æ˜¯è¢«ä»£ç†å¯¹è±¡çš„: ç±»åŠ è½½å™¨, è¢«ä»£ç†å¯¹è±¡çš„æ¥å£, ä»¥åŠè°ƒç”¨å¤„ç†å™¨
          */
        Vehicle obj = (Vehicle) Proxy.newProxyInstance(clazz.getClassLoader(),
                                                       clazz.getInterfaces(), handler);
        return obj;
      }
      public VehicleProxyProvider(Vehicle targetVehicle) {
        this.targetVehicle = targetVehicle;
      }
    }
    ```

    

    // æµ‹è¯•

     ```java
    VehicleProxyProvider provider = new VehicleProxyProvider(new Car());
    Vehicle proxy = provider.getProxy();
    proxy.run();
     ```

    

  - å¼•å…¥æ¨ªå‘åˆ‡å…¥ç‚¹

    ```java
    SmartAnimal proxyAnimal = (SmartAnimal) Proxy.newProxyInstance(dog.getClass().getClassLoader(),
    dog.getClass().getInterfaces(), (proxy, method, params) -> {
        try {
            System.out.printf("[å‰ç½®é€šçŸ¥]æ—¥å¿—-æ–¹æ³•å-%s-å‚æ•° %s %s\n", method.getName(), params[0], params[1]);
            Object result = method.invoke(dog, params);
            System.out.printf("[è¿”å›åé€šçŸ¥]æ—¥å¿—-æ–¹æ³•å-%s-ç»“æœ result= %s\n", method.getName(), result);
            return result;
        } catch (Exception e) {
            System.out.println("[å¼‚å¸¸é€šçŸ¥]å‘ç”Ÿå¼‚å¸¸");
        } finally {
            System.out.println("[åç½®é€šçŸ¥]ä¸€å®šä¼šæ‰§è¡Œçš„ä¸œè¥¿");
        }
        return null;
    });
    ```

    

  - è¿›ä¸€æ­¥çš„ç®€æ˜“çš„åˆ‡é¢ç±»

  ```java
  // è‡ªå®šä¹‰åˆ‡é¢ç±» 
  public class MyAspect {
    public static void afterReturn(Object proxy, Method method, Object result) {
      System.out.printf("[è¿”å›åé€šçŸ¥]æ—¥å¿—-æ–¹æ³•å-%s-ç»“æœ result= %s\n", method.getName(), result);
    }
    public static void before(Object proxy, Method method, Object[] params) {
      System.out.printf("[å‰ç½®é€šçŸ¥]æ—¥å¿—-æ–¹æ³•å-%s-å‚æ•° %s %s\n", method.getName(), params[0], params[1]);
    }
  }
  // ä»£ç†æ–¹æ³•
  MyAspect.before(proxy,method, params);
  Object result = method.invoke(dog, params);
  MyAspect.afterReturn(proxy,method, result);
  ```

  - ç¼ºç‚¹: åªæœ‰å®ç°å¯¹åº”æ¥å£çš„æ–¹æ³•æ‰èƒ½å¢å¼ºæ–¹æ³•
  çµæ´»æ€§å·®--é»˜è®¤å¯¹æ‰€æœ‰æ–¹æ³•è¿›è¡Œå¢å¼º
  ç¡¬ç¼–ç --->å®Œç¾çš„è§£å†³æ–¹æ¡ˆAOPçš„å¼•å‡º

- aop

	- aspect oriented programmingé¢ç›¸åˆ‡é¢ç¼–ç¨‹

	- å°±æ˜¯åœ¨åˆ‡é¢ç±»ä¸­å†™æ–¹æ³•, å¯ä»¥æŒ‡å®šè¿™äº›æ–¹æ³•åœ¨ç›®çš„ç±»çš„ä»»æ„ä½ç½®å»æ‰§è¡Œ

	- å®ç°æ–¹å¼

		- åŸºäºåŠ¨æ€ä»£ç†çš„æ–¹å¼[å†…ç½® aop å®ç°],å‰é¢å°±æ˜¯

		- aspectjæ¡†æ¶

- aspectj

  - 1.å¼•å…¥aspectjåŒ…
  aspectjweaver:1.9.5
  aspectjrt:1.9.5
  spring-aspects:5.3.8

  - 2.åœ¨beans.xmlä¸­é…ç½®å¼€å¯aspectjè‡ªåŠ¨ä»£ç†

    ```xml
    <aop:aspectj-autoproxy/>
    ```

  - äº”ç§é€šçŸ¥æ–¹æ³•

  	- å¯¹åº”try-catch-finallyä½ç½®
  @Before
  // ç›®æ ‡æ–¹æ³•çš„ä½ç½®
  @AfterReturning
  @AfterThrowing
  @After
  // ç»“åˆå››ä¸ªçš„ç¯ç»•é€šçŸ¥
  @Around

  - quickstart

```java
@Aspect // è¡¨ç¤ºæ˜¯ä¸€ä¸ªåˆ‡é¢ç±»
@Component // æ ‡è®°-åŠ å…¥spring iocå®¹å™¨
public class SmartAnimalAspect {
  @Before("execution(public int aop.aspectj.SmartDog.getSum(..))")
  private void before(JoinPoint joinPoint) {
    String methodName = joinPoint.getSignature().getName();
    Object[] args = joinPoint.getArgs();
    System.out.printf("[å‰ç½®é€šçŸ¥]æ—¥å¿—-æ–¹æ³•å-%s-å‚æ•° %s %s\n", methodName, args[0], args[1]);
  }
}
```

ç»†èŠ‚

 1.åˆ‡å…¥è¡¨è¾¾å¼çš„æ›´å¤šé…ç½®ï¼Œæ¯”å¦‚ä½¿ç”¨æ¨¡ç³Šé…ç½®

@Before(value="execution(* com.hspedu.aop.proxy.SmartDog.*(..))")

2.è¡¨ç¤ºæ‰€æœ‰è®¿é—®æƒé™ï¼Œæ‰€æœ‰åŒ…çš„ä¸‹æ‰€æœ‰æœ‰ç±»çš„æ‰€æ–¹æ³•ï¼Œéƒ½ä¼šè¢«æ‰§è¡Œè¯¥å‰ç½®é€šçŸ¥æ–¹æ³•

3.@Before(value="execution(* *.*(..))")

3.å½“ spring å®¹å™¨å¼€å¯äº† å¼€å¯åŸºäºæ³¨è§£çš„ AOP åŠŸèƒ½  \<aop:aspectj-autoproxy/\> , è·å–æ³¨å…¥çš„å¯¹è±¡, éœ€è¦ä»¥æ¥å£çš„ç±»å‹æ¥è·å–, å› ä¸ºä½ æ³¨å…¥çš„å¯¹è±¡.getClass() å·²ç»æ˜¯ä»£ç†ç±»å‹äº†!

4.å½“ spring å®¹å™¨å¼€å¯äº† å¼€å¯åŸºäºæ³¨è§£çš„ AOP åŠŸèƒ½  \<aop:aspectj-autoproxy/\>,  è·å–æ³¨å…¥çš„å¯¹è±¡, ä¹Ÿå¯ä»¥é€šè¿‡ id æ¥è·å–, ä½†æ˜¯ä¹Ÿè¦è½¬æˆæ¥å£ç±»å‹

5.å¦‚æœæŒ‰ç±»å‹è·å–, åˆ™ä¸èƒ½ä½¿ç”¨å­ç±»å‹,åªèƒ½ä½¿ç”¨æ¥å£ç±»å‹æ¥è·å–, ç„¶è€Œæ¥å£ç±»å‹çš„å­ç±»åªæœ‰ä¸€ä¸ª,æ‰èƒ½è·å–,å› ä¸ºä¼šæŠ¥found 2é”™è¯¯

6.å¯ä»¥ä½¿ç”¨idæ¥è·å–,ä½†æ˜¯è¦ç”¨æ¥å£æ¥æ¥æ”¶,å› ä¸ºä»£ç†å¯¹è±¡æ˜¯ä¸€ä¸ªæ¥å£çš„å­ç±», ä½†æ˜¯ç»å¯¹ä¸æ˜¯å­ç±»ç±»å‹,ä¼šæŠ¥ç±»å‹è½¬æ¢å¼‚å¸¸

 7.ä¸å¯ä»¥å»æ‰å­ç±»ä¸Šçš„@Componentæ³¨è§£,

å®¹å™¨ä¸­æ²¡æœ‰å­ç±»å‹çš„bean, å°±ç®—æœ‰ä¹Ÿè·å–ä¸åˆ°, åªæœ‰ä»£ç†bean

```java
UsbInterface camera = (UsbInterface) ctx.getBean("camera"); æ­£ç¡®âœ…
```
```java
Camera camera1 = ctx.getBean(Camera.class); âŒé”™è¯¯
```

8.æ€»ç»“

é€šè¿‡idæ¥è·å–,ä½¿ç”¨æ¥å£æ¥æ¥æ”¶

åˆ‡å…¥è¡¨è¾¾å¼

execution([æƒé™ä¿®é¥°ç¬¦] [è¿”å›ç±»å‹] [ç®€å•ç±»å/å…¨ç±»å] \[æ–¹æ³•å\]([å‚æ•°åˆ—è¡¨]) )

åˆ‡å…¥è¡¨è¾¾å¼ä¹Ÿå¯ä»¥æŒ‡å‘ç±»çš„æ–¹æ³•, è¿™æ—¶åˆ‡å…¥è¡¨è¾¾å¼ä¼šå¯¹è¯¥ç±»/å¯¹è±¡ç”Ÿæ•ˆ

åˆ‡å…¥è¡¨è¾¾å¼ä¹Ÿå¯ä»¥æŒ‡å‘æ¥å£çš„æ–¹æ³•, è¿™æ—¶åˆ‡å…¥è¡¨è¾¾å¼ä¼šå¯¹å®ç°äº†æ¥å£çš„ç±»/å¯¹è±¡ç”Ÿæ•ˆ

 åˆ‡å…¥è¡¨è¾¾å¼ä¹Ÿå¯ä»¥å¯¹æ²¡æœ‰å®ç°æ¥å£çš„ç±»

ä½¿ç”¨cglib

jdkä»£ç†å’Œcglibä»£ç†

jdk åŠ¨æ€ä»£ç† å¿…é¡»æœ‰æ¥å£, åªèƒ½å¢å¼ºæ¥å£ä¸­å®šä¹‰çš„æ–¹æ³•

åŠ¨æ€ä»£ç†å¯ä»¥ä¸æ”¹å˜åŸæ¥ä»£ç çš„æƒ…å†µä¸‹,å¢å¼ºæ–¹æ³•åŠŸèƒ½

jdkåŠ¨æ€ä»£ç†åŸç†: å®ç°çˆ¶æ¥å£

cglibåŠ¨æ€ä»£ç† æ²¡æœ‰æ¥å£ä¹Ÿè¡Œ, ä½†æ˜¯ç±»ä¸èƒ½å£°æ˜ä¸ºfinal

cglibåŠ¨æ€ä»£ç†åŸç†: ç»§æ‰¿åŸæ¥çš„ç±»,é‡å†™çˆ¶ç±»æ–¹æ³•

JoinPoint,åˆ‡å…¥ç‚¹

```java
public void beforeMethod(JoinPoint joinPoint){}
```



å¸¸ç”¨æ–¹æ³•

```java
joinPoint.getSignature().getName(); // è·å–ç›®æ ‡æ–¹æ³•å
joinPoint.getSignature().getDeclaringType().getSimpleName(); // è·å–ç›®æ ‡æ–¹æ³•æ‰€å± ç±»çš„ç®€å•ç±»å
joinPoint.getSignature().getDeclaringTypeName(); // è·å–ç›®æ ‡æ–¹æ³•æ‰€å±ç±»çš„ç±»å
joinPoint.getSignature().getModifiers(); // è·å–ç›®æ ‡æ–¹æ³•å£°æ˜ç±»å‹(publicã€privateã€protected)
Object[] args = joinPoint.getArgs(); // è·å–ä¼ å…¥ç›®æ ‡æ–¹æ³•çš„å‚æ•°ï¼Œè¿”å›ä¸€ä¸ªæ•°ç»„ 
joinPoint.getTarget(); // è·å–è¢«ä»£ç†çš„å¯¹è±¡
joinPoint.getThis(); // è·å–ä»£ç†å¯¹è±¡è‡ªå·±
```
è¿”å›é€šçŸ¥è·å–ç»“æœ

åœ¨è¿”å›é€šçŸ¥afterReturné‚£é‡Œè·å–,é‚£é‡Œå¯ä»¥æ‹¿åˆ°è¿”å›ç»“æœ

```java
/**
* è·å–è¿”å›å€¼
* returning = "res" å’Œ Object res å‚æ•°åå¿…é¡»ä¿æŒä¸€è‡´
*/
@AfterReturning(value = "execution(public * NoInterfaceCar.run())", returning = "res")
public void noInterfaceAfterReturn(JoinPoint joinPoint, Object res) {
  System.out.println("è¿”å›ç»“æœ res=" + res);
}
```



- åœ¨å¼‚å¸¸é€šçŸ¥ä¸­è·å–å¼‚å¸¸ä¿¡æ¯
AfterThrowing

	- 

```java
/** 
* è·å–å¼‚å¸¸ä¿¡æ¯
* throwing = "ex" å’Œå‚æ•°Throwable ex åå­—ä¿æŒä¸€è‡´
*/
@AfterThrowing(value = "execution(public * NoInterfaceCar.run())", throwing = "ex")
public void noInterfaceAfterThrowing(JoinPoint joinPoint, Throwable ex) {
  System.out.println("å‘ç”Ÿäº†å¼‚å¸¸: " + ex.getMessage());
}
```



- ç¯ç»•é€šçŸ¥,å¯ä»¥å®Œæˆä¸Šé¢4ä¸ªé€šçŸ¥
  Around

  ```java
  @Around("execution(*  TestAroundAdvice.run(..))")
  public Object testAround(ProceedingJoinPoint joinPoint) {
    Object result = null;
    try {
      Object[] args = joinPoint.getArgs();
      System.out.println("å‰ç½®é€šçŸ¥[æ–¹æ³•å‚æ•°] " + Arrays.toString(args));
      result = joinPoint.proceed(args);
      System.out.println("è¿”å›é€šçŸ¥[è¿”å›ç»“æœ] " + result);
    } catch (Throwable e) {
      System.out.println("å¼‚å¸¸é€šçŸ¥: " + e.getMessage());
      throw new RuntimeException(e);
    } finally {
      System.out.println("åç½®é€šçŸ¥:");
    }
    return result;
  }
  ```

  

- åˆ‡å…¥ç‚¹è¡¨è¾¾å¼å¤ç”¨

  - å®šä¹‰åˆ‡å…¥ç‚¹è¡¨è¾¾å¼
  ä½¿ç”¨æ—¶ç›´æ¥å¼•ç”¨,æé«˜äº†å¤ç”¨æ€§

  - å®šä¹‰

    ```java
    @Pointcut("execution(int aop.aspectj.NoInterfaceCar.*(..))")
    public void myPointCut() {}
    ```

    

  - //ä½¿ç”¨

    ```java
    @Before("myPointCut()")
    public void noInterfaceBefore() {
      System.out.println("åœ¨NoInterfaceCar.runä¹‹å‰");
    }
    @AfterReturning(value = "myPointCut()", returning = "res")
    public void noInterfaceAfterReturn(JoinPoint joinPoint, Object res) {
      System.out.println("è¿”å›ç»“æœ res=" + res);
    }
    ```

- å¤šä¸ªåˆ‡é¢çš„æ‰§è¡Œé¡ºåº

  - å¯ä»¥ç”¨@Orderæ¥æŒ‡å®šé¡ºåº, æ•°å­—è¶Šå°ä¼˜å…ˆçº§è¶Šé«˜

  - é¡ºåºæˆ–Filteré¡ºåºä¸€è‡´çš„, éƒ½æ˜¯å¾€è¿”è·‘æ¨¡å¼,æ ˆæ•°æ®ç»“æ„


  ```java
  @Aspect
  @Component
  @Order(1)
  public class Aspect1 {}
  ```

  ```java
  @Aspect
  @Component
  @Order(2)
  public class Aspect2 {}
  ```

  



```text
// æ‰§è¡Œç»“æœ
Aspect1[å‰ç½®é€šçŸ¥]
Aspect2[å‰ç½®é€šçŸ¥]
å°ç‹—æ±ªæ±ªæ±ªå«ğŸ˜Šâ¤ï¸~~~~
Aspect2[è¿”å›åé€šçŸ¥])
Aspect2[åç½®é€šçŸ¥]
Aspect1[è¿”å›åé€šçŸ¥])
Aspect1[åç½®é€šçŸ¥]
```


- åŸºäºxmlé…ç½®aop

  - xmlé…ç½®

```xml
<!--ä½¿ç”¨xmlé…ç½®aopåˆ‡é¢ç¼–ç¨‹-->
<!--é…ç½®ä¸€ä¸ªåˆ‡é¢ç±»å¯¹è±¡-->
<bean id="dogAspect" class="aop.xmlconfig.Aspect1Xml"/>
<!--é…ç½®ä¸€ä¸ªDogå¯¹è±¡-->
<bean id="dog" class="aop.xmlconfig.Dog"/>
<!--é…ç½®ä¸€ä¸ªåˆ‡é¢ç±», ç»†èŠ‚å¼•å…¥aopå‘½åç©ºé—´-->
<aop:config>
  <!--æŒ‡å®šåˆ‡å…¥ç‚¹,åˆ‡å…¥ç‚¹æ ‡ç­¾è¦æ”¾åœ¨åˆ‡é¢æ ‡ç­¾å‰é¢-->
  <aop:pointcut id="myPointCut" expression="execution(* aop.xmlconfig.Dog.*(..))"/>
  <!--æŒ‡å®šåˆ‡é¢ç±»å¯¹è±¡-->
  <aop:aspect ref="dogAspect" order="10">
    <aop:before method="before" pointcut-ref="myPointCut"/>
    <aop:after-returning method="afterReturn" pointcut-ref="myPointCut" returning="res"/>
    <aop:after-throwing method="afterThrowing" pointcut-ref="myPointCut" throwing="ex"/>
    <aop:after method="after" pointcut-ref="myPointCut"/>
  </aop:aspect>
</aop:config>
```



### åç½®å¤„ç†å™¨æ·±å…¥

- AOPå’Œåç½®å¤„ç†å™¨çš„å…³ç³»

  - ç°è±¡

  	- // åˆ‡é¢ç¼–ç¨‹, åœ¨initå‰æ˜¯åŸç”Ÿå¯¹è±¡, åœ¨initåå°±æ˜¯ä»£ç†å¯¹è±¡äº†
  postProcessBeforeInitializationåœ¨beançš„initæ–¹æ³•ä¹‹å‰è°ƒç”¨ class diy.aop.MyCal
  MyCal--init~~~
  postProcessAfterInitializationåœ¨beançš„initæ–¹æ³•ä¹‹åè°ƒç”¨ class jdk.proxy2.$Proxy19

  - AOPåº•å±‚æ˜¯åŸºäºBeanPostProcessorçš„

  - åŸç†

    - å¼•å…¥æ³¨è§£@EnableAspectJAutoProxy

      - è‡ªåŠ¨ä¸ºè¢« @Aspect æ ‡è®°çš„åˆ‡é¢ç±»åˆ›å»ºä»£ç†ï¼Œä½¿åˆ‡é¢ä¸­çš„é€šçŸ¥ï¼ˆAdviceï¼‰èƒ½å¤Ÿæ‹¦æˆªç›®æ ‡ Bean çš„æ–¹æ³•è°ƒç”¨ã€‚
      - å–ä»£\<aop:aspectj-autoproxy\> é…ç½®
      - å±æ€§proxyTargetClass

      	- æ§åˆ¶ä»£ç†ç±»å‹ã€‚è‹¥ä¸º trueï¼Œå¼ºåˆ¶ä½¿ç”¨ CGLIB åŸºäºç±»çš„ä»£ç†ï¼›è‹¥ä¸º falseï¼Œå¯¹æ¥å£ä½¿ç”¨ JDK åŠ¨æ€ä»£ç†ï¼Œå¦åˆ™å›é€€åˆ° CGLIB

      	- ç›®æ ‡ç±»æœªå®ç°æ¥å£æ—¶éœ€è®¾ä¸º true
      - ä½¿ç”¨æ¡ˆä¾‹

```java
@Configuration
@EnableAspectJAutoProxy(proxyTargetClass = true, exposeProxy = true)
@ComponentScan(basePackages = "com.example")
public class AppConfig {
  // å…¶ä»– Bean å®šä¹‰
}
```

```java
@Aspect
@Component
public class LoggingAspect {
  @Before("execution(* com.example.service.*.*(..))")
  public void logBefore(JoinPoint joinPoint) {
    System.out.println("æ–¹æ³•æ‰§è¡Œå‰: " + joinPoint.getSignature().getName());
  }
}
```

å·¥ä½œåŸç†

æ³¨å†Œåç½®å¤„ç†å™¨

é€šè¿‡ @Import(AspectJAutoProxyRegistrar.class) æ³¨å†Œ AnnotationAwareAspectJAutoProxyCreatorï¼Œè¯¥åç½®å¤„ç†å™¨åœ¨ Bean åˆå§‹åŒ–æ—¶ç”Ÿæˆä»£ç†ã€‚

åˆ‡é¢æ£€æµ‹ä¸ä»£ç†åˆ›å»º

Spring å®¹å™¨æ‰«ææ‰€æœ‰ @Aspect ç±»ï¼Œæ ¹æ®åˆ‡ç‚¹è¡¨è¾¾å¼åŒ¹é…ç›®æ ‡ Beanï¼Œå¹¶åœ¨å¿…è¦æ—¶åˆ›å»ºä»£ç†ä»¥ç»‡å…¥é€šçŸ¥ã€‚

æ‰‹æ’•SpringAOP

è¡¥å……çŸ¥è¯†

ç±»åŠ è½½å™¨

Bootstrap  å¯¹åº”è·¯å¾„jre/lib

Extç±»åŠ è½½å™¨ jre/lib/ext

Appç±»åŠ è½½å™¨ å¯¹åº”è·¯å¾„classpath

å®¹å™¨å¸¸ç”¨ä¸€ä¸ªæ–¹æ³•, æ ¹æ®ä¸€ä¸ªç±»æ˜¯å¦å®ç°æ¥æŸä¸ªæ¥å£, æ¥åˆ¤æ–­æ˜¯å¦è¦æ‰§è¡ŒæŸä¸ªä¸šåŠ¡é€»è¾‘,è¿™ä¸ªå°±æ˜¯æ¥å£ç¼–ç¨‹

å…¸å‹çš„å°±æ˜¯æ ‡è®°æ¥å£,ä¸€ä¸ªæ–¹æ³•éƒ½æ²¡æœ‰, å®ƒçš„ä»·å€¼å°±æ˜¯,ç”¨æ¥åˆ¤æ–­

isAssignableFrom åˆ¤æ–­çš„å·¦è¾¹æ˜¯ä¸æ˜¯å³è¾¹çš„çˆ¸çˆ¸ã€‚

æµç¨‹

1.è¯»å–beans.xmlæ–‡ä»¶ä¸­åŒ…æ‰«ææ ‡ç­¾
2.æ‰«ææŒ‡å®šåŒ…ä¸‹çš„.classæ–‡ä»¶
3.æ‰«æçš„classä¿¡æ¯æ”¾å…¥BeanDefinitionå¯¹è±¡ä¸­,å†æ”¾å…¥åˆ°mapä¸­
4.åˆå§‹åŒ–å•ä¾‹æ± ,å¦‚æœbeanæ˜¯å•ä¾‹çš„å°±å®ä¾‹åŒ–,æ”¾å…¥åˆ°å•ä¾‹æ± mapä¸­
5.getBean(id)æ–¹æ³•çš„å®ç°
6,å¦‚æœbeanä¸å­˜åœ¨(definitionMapä¸­ä¸å­˜åœ¨),æŠ›å‡ºå¼‚å¸¸
7.å¦‚æœbeanæ˜¯å•ä¾‹çš„,ä»singletonæ± ä¸­è·å–
8.å¦‚æœè¿™ä¸ªå¯¹è±¡æ˜¯prototypeåˆ™,åˆ›å»ºbeanå¯¹è±¡,å¹¶è¿”å›

9.ä¾èµ–æ³¨å…¥,åˆ›å»ºbeanæ—¶éå†å­—æ®µ,æ‰¾å‡ºæœ‰Autowireæ ‡è®°
10.åç½®å¤„ç†å™¨æœºåˆ¶-->åœ¨createBeanæ—¶åœ¨initæ–¹æ³•å‰åæ‰§è¡Œ
11.åœ¨åç½®å¤„ç†å™¨æœºåˆ¶ä¸Šå®ç°AOP--> åœ¨åç½®å¤„ç†å™¨çš„Afteræ–¹æ³•ä¸­æ‰§è¡Œ

```
ä»£ç å¤ªå¤šäº†: å‚è€ƒåŒ…diy.diyspring.ioc.SpringApplicationContext
```

### JdbcTemplate

- springè‡ªå·±çš„æ•°æ®è®¿é—®å·¥å…·ç±», å°†Jdbcçš„å¸¸ç”¨æ“ä½œå°è£…ä¸ºæ¨¡æ¿æ–¹æ³•

- ä½¿ç”¨

  - å¼•å…¥ä¾èµ–

    - mysql-connector-j:8.4.0
    c3p0:0.9.1.2
    spring-jdbc:5.3.8
    spring-orm:5.3.8
    spsring-tx:5.3.8

    - å¼•å…¥jdbc.propeties

    ```properties
    driverClassName=com.mysql.cj.jdbc.Driver
    url=jdbc:mysql://localhost:3306/spring?rewriteBatchedStatements=true
    username=root
    password=root
    ```

    

    - xmlå¼•å…¥æ•°æ®æº

    ```xml
    <context:property-placeholder location="classpath*:jdbc.properties"/>
    <bean id="dataSource" class="com.mchange.v2.c3p0.ComboPooledDataSource">
      <property name="user" value="${username}"/>
      <property name="password" value="${password}"/>
      <property name="jdbcUrl" value="${url}"/>
      <property name="driverClass" value="${driverClassName}"/>
    </bean>
    
    <bean id="jdbcTemplate" class="org.springframework.jdbc.core.JdbcTemplate">
      <property name="dataSource" ref="dataSource"/>
      <property name="lazyInit" value="false"/>
    </bean
    ```

```java
// æµ‹è¯•ç±»
ClassPathXmlApplicationContext ctx;
JdbcTemplate jdbcTemplate;

@BeforeEach
void before() throws Exception {
    ctx = new ClassPathXmlApplicationContext("jdbcTemplate.xml");
    jdbcTemplate = ctx.getBean(JdbcTemplate.class);
}
```


- æŸ¥è¯¢

  - BeanPropertyRowMapper

    æŠŠbeanå±æ€§æ˜ å°„åˆ°ç»“æœé›†çš„ä¸€è¡Œçš„æ˜ å°„å™¨,
    è¦æ³¨æ„ç»“æœé›†å­—æ®µè¦å’Œbeanå­—æ®µåå­—ä¸€æ ·,
    ä¸ä¸€æ ·æ—¶ä½¿ç”¨ user_name as usernameè¿™æ ·çš„æ–¹å¼èµ·åˆ«å

  - æŸ¥è¯¢Scalar

    ```java
    String sql = "select count(*) from monster";
    Integer count = jdbcTemplate.queryForObject(sql, Integer.class);
    ```

  - æŸ¥è¯¢ä¸€è¡Œ

    ```java
    String sql = "select * from monster where id = ?";
    Monster monster = jdbcTemplate.queryForObject(sql, new BeanPropertyRowMapper<>(Monster.class), 301);
    ```

  - æŸ¥è¯¢å¤šè¡Œ

    ```java
    String sql = "select * from monster";
    List<Monster> monsters = jdbcTemplate.query(sql, new BeanPropertyRowMapper<>(Monster.class));
    // æœ‰æ¡ä»¶çš„
    sql = "select * from monster where id >= ?";
    jdbcTemplate.query(sql, new BeanPropertyRowMapper<>(Monster.class), 300);
    ```

    

- DDL

  - æ’å…¥

  ```java
  String sql = "INSERT INTO monster VALUES(null, ?, ?)";
  int update = jdbcTemplate.update(sql, "å­™æ‚Ÿç©º", "çŒ´æ¯›åˆ†èº«");
  ```

  - ä¿®æ”¹

  ```java
  String sql = "update monster set skill = ? where id= ?";
  int rows = jdbcTemplate.update(sql, "å¤§é—¹å¤©å®«", 301);
  ```

  - åˆ é™¤

  ```java
  String sql = "delete from monster where id = ?";
  int rows = jdbcTemplate.update(sql, 307);
  ```

  

- æ‰¹é‡å¤„ç†

  - æ‰¹é‡æ’å…¥

  ```java
  String sql = "INSERT INTO monster VALUES(null, ?, ?)";
  List<Object[]> bachArgs = new ArrayList<>();
  bachArgs.add(new Object[]{"ç‰›é­”ç‹", "èŠ­è•‰æ‰‡"});
  bachArgs.add(new Object[]{"ç™½éª¨ç²¾", "å¹»åŒ–æ¬ºéª—"});
  bachArgs.add(new Object[]{"é‡‘è§’å¤§ç‹", "è‘«èŠ¦å¸äºº"});
  int[] rows = jdbcTemplate.batchUpdate(sql, bachArgs);
  Assertions.assertTrue(rows.length == 3);
  for (int row : rows) {
    // row=-2, ä¹Ÿæ˜¯æˆåŠŸçš„æ ‡è¯†,å½“ä½ jdbc.urlæœ‰rewriteBatchedStatementså‚æ•°ä¼šè¿”å›-2
    // row=1,æ²¡æœ‰ä¸Šé¢çš„å‚æ•°
    System.out.println(row);
  }
  ```

  

- NamedParameterJdbcTemplate

  - å¼•å…¥é…ç½®

    ```xml
    <bean id="nPJdbcTemplate" class="org.springframework.jdbc.core.namedparam.NamedParameterJdbcTemplate">
      <constructor-arg name="dataSource" ref="dataSource"/>
    </bean>
    ```

      nPJdbcTemplate = ctx.getBean(NamedParameterJdbcTemplate.class);

  - insert

  ```java
  /**
  * 1.ä½¿ç”¨api: int update(String sql, Map<String, ?> paramMap)
  * 2.å‡†å¤‡å‚æ•°[:id, :name, :skill]
  */
  String sql = "INSERT INTO monster VALUES(:id, :name, :skill)";
  Map<String, Object> paramMap = new HashMap<>();
  paramMap.put("id", null);
  paramMap.put("name", "è€é¼ ç²¾");
  paramMap.put("skill", "å¤œé—´è¡ŒåŠ¨");
  int rows = nPJdbcTemplate.update(sql, paramMap);
  System.out.println("rows = " + rows); // 1
  // insert2
  // api: int update(String sql, SqlParameterSource paramSource)
  // è¿™é‡Œçš„:idç­‰å‚æ•°åº”è¯¥å’Œå¯¹è±¡å±æ€§åä¿æŒä¸€è‡´
    String sql = "INSERT INTO monster VALUES(:id, :name, :skill)";
  Monster monster = new Monster(null, "é»‘ç†Šç²¾", "å·è¢ˆè£Ÿ");
  // æŠŠbeanå±æ€§æ˜ å°„ä¸ºå‚æ•°
  BeanPropertySqlParameterSource bp = new BeanPropertySqlParameterSource(monster);
  int update = nPJdbcTemplate.update(sql, bp); // 1
  ```

  
### å£°æ˜å¼äº‹åŠ¡

ç»¼åˆä½¿ç”¨ioc,aop,jdbc

- ä¼ ç»Ÿäº‹åŠ¡

```java
try {
  String sql1 = "update account set balance = balance-100 where id = 1";
  String sql2 = "update account set balance = balance+100 where id = 2";
  connection = JdbcUtil.getConnection();
  // å…³é—­è‡ªåŠ¨æäº¤äº‹åŠ¡
  connection.setAutoCommit(false);
  // æ‰§è¡Œå¤šä¸ªsql
  ps = connection.prepareStatement(sql1);
  ps = connection.prepareStatement(sql2);
  int x = 1/0; // å‘ç”Ÿå¼‚å¸¸
  // æäº¤äº‹åŠ¡
  connection.commit();
} catch (Exception e) {
  // å‘ç”Ÿå¼‚å¸¸æ—¶å›æ»šäº‹åŠ¡
  connection.rollback();
  e.printStackTrace();
} finally {
  // å…³é—­è¿æ¥,é‡Šæ”¾èµ„æº
  JdbcUtil.close(null, ps, connection);
}
```

- æ‰‹åŠ¨æäº¤ç®¡ç†äº‹åŠ¡, sqlä»£ç ä¸èƒ½å¤ç”¨

- ä»€ä¹ˆæ˜¯å£°æ˜å¼äº‹åŠ¡

  - ä½¿ç”¨

    1.é…ç½®æ•°æ®æºå’Œäº‹åŠ¡ç®¡ç†åŠå¼€å¯äº‹åŠ¡çš„æ³¨è§£é©±åŠ¨

  ```xml
  <context:property-placeholder location="classpath*:jdbc.properties"/>
  <context:component-scan base-package="tx"/>
  <!--é…ç½®æ•°æ®æº-->
  <bean id="ds" class="com.mchange.v2.c3p0.ComboPooledDataSource">
    <property name="user" value="${username}"/>
    <property name="password" value="${password}"/>
    <property name="jdbcUrl" value="${url}"/>
    <property name="driverClass" value="${driverClassName}"/>
  </bean>
  <!--é…ç½®jdbcTemplate-->
  <bean id="jdbcTemplate" class="org.springframework.jdbc.core.JdbcTemplate">
    <property name="dataSource" ref="ds"/>
    <property name="lazyInit" value="false"/>
  </bean>
  <!--é…ç½®äº‹åŠ¡ç®¡ç†å™¨-->
  <bean id="tx" class="org.springframework.jdbc.datasource.DataSourceTransactionManager">
    <!--é…ç½®æ•°æ®æº,å¯¹å“ªä¸ªæ•°æ®æºè¿›è¡Œäº‹åŠ¡ç®¡ç†-->
    <property name="dataSource" ref="ds"/>
  </bean>
  <!--å¼€å¯åŸºäºæ³¨è§£çš„äº‹åŠ¡ç®¡ç†-->
  <tx:annotation-driven transaction-manager="tx"/>
  ```

  2.åœ¨ä¸šåŠ¡æ–¹æ³•ä¸Šæ·»åŠ æ³¨è§£@Transactional

  - å£°æ˜å¼äº‹åŠ¡

    - æŠŠä¸€å¥sqlå¯¹åº”æˆä¸€ä¸ªdaoæ–¹æ³•
    æ¶‰åŠåˆ°å¤šå¼ è¡¨çš„ä¸šåŠ¡æŠŠå¤šä¸ªdaoçš„sqlå°è£…æˆä¸€ä¸ªä¸šåŠ¡æ–¹æ³•, åœ¨ä¸šåŠ¡æ–¹æ³•è¿™ä¸ªåˆ‡å…¥ç‚¹ä¸Šè¿›è¡Œäº‹åŠ¡å¤„ç†

  - åŸç†

    - DataSourceTransactionManager

    	- æœ‰ä¸‰ä¸ªæ–¹æ³•doBegine,doCommit,doRollback

    	- doBegine

    		- æ£€æµ‹æ˜¯å¦å¼€å¯è‡ªåŠ¨æäº¤äº‹åŠ¡, å¦‚æœå¼€å¯,å°±å…³é—­

    	- doCommitå’ŒdoRollback

    		- æäº¤äº‹åŠ¡å’Œå›æ»šäº‹åŠ¡

    	- åº•å±‚åŸç†ä½¿ç”¨cglibåŠ¨æ€ä»£ç†, ä»£ç†äº†åŠ äº†@Transactionalæ³¨è§£çš„çš„æ–¹æ³•, å¦‚æœå‘ç”Ÿå¼‚å¸¸å°±doRollback,å¦å°±doCommit

- äº‹åŠ¡çš„ä¼ æ’­æœºåˆ¶
  propagation

  - å®šä¹‰: åœ¨ä¸€ä¸ªäº‹åŠ¡æ–¹æ³•ä¸­åˆè°ƒç”¨å¦ä¸€ä¸ªäº‹åŠ¡æ–¹æ³•, æ€ä¹ˆå¤„ç†äº‹åŠ¡å‘¢?

  - REQUIRED(é»˜è®¤)

  	- å¦‚æœæœ‰äº‹åŠ¡åœ¨è¿è¡Œ, å½“å‰æ–¹æ³•å°±åœ¨è¿™ä¸ªäº‹åŠ¡å†…è¿è¡Œ, å¦‚æœæ²¡æœ‰äº‹åŠ¡è¿è¡Œ, å°±å¼€å¯ä¸€ä¸ªæ–°äº‹ç‰©

  		- è‡ªå§‹è‡³ç»ˆåªæœ‰ä¸€ä¸ªäº‹åŠ¡

  - REQUIRES_NEW

    - å½“å‰æ–¹æ³•å¿…é¡»å¼€å¯æ–°äº‹ç‰©, åœ¨ä»–è‡ªå·±çš„äº‹åŠ¡ä¸­è¿è¡Œ, å¦‚æœæœ‰äº‹åŠ¡æ­£åˆ™è¿è¡Œ,åˆ™å°†ä»–æŒ‚èµ·

    	- ç‹¬ç«‹çš„äº‹åŠ¡

    - f1{f2,f3}

      f2å¤±è´¥ä¸å½±å“f3,f3å¤±è´¥ä¹Ÿä¸å½±å“f2

    ```java
    /**
     * 1.multiplyBuyByTx()æœ‰ä¸¤æ¬¡è´­ä¹°æ“ä½œ
     * 2.buyGoodsByTxå’ŒbuyGoodsByTx2éƒ½æ˜¯å£°æ˜å¼äº‹åŠ¡
     * 3.buyGoodsByTxå’ŒbuyGoodsByTx2ä½¿ç”¨çš„å±æ€§æ˜¯é»˜è®¤çš„REQUESTED
     * å³: å½“åšä¸€ä¸ªäº‹åŠ¡è¿›è¡Œç®¡ç†, å¦‚æœbuyGoodsByTx2å¤±è´¥,buyGoodsByTxä¹Ÿä¼šå›æ»š
     * 4.å¦‚æœä½¿ç”¨REQUIRES_NEWå±æ€§, åˆ™buyGoodsByTx2å¤±è´¥, buyGoodsByTxä¸ä¼šå›æ»š
       */
      @Transactional
      public void multiplyBuyByTx() {
      //@Transactional public void buyGoodsByTx(..){}
      goodService.buyGoodsByTx(1, 1, 1);
      goodService.buyGoodsByTx2(1, 1, 1);
    }
    ```

    

 * - SUPPORTS

	- å¦‚æœæœ‰äº‹åŠ¡åœ¨è¿è¡Œ,å½“å‰æ–¹æ³•å°±åœ¨è¿™ä¸ªäº‹åŠ¡ä¸­è¿è¡Œ, å¦åˆ™ä»–å¯ä»¥ä¸è¿è¡Œåœ¨äº‹åŠ¡ä¸­

    		- æœ‰å°±ç”¨,æ²¡æœ‰å°±ä¸ç”¨
   
    - NO_SUPPORT

	- å½“å‰æ–¹æ³•ä¸åº”è¯¥è¿è¡Œåœ¨äº‹åŠ¡ä¸­, å¦‚æœäº‹åŠ¡,åˆ™å°†ä»–æŒ‚èµ·
	
- MANDATORY
	
	- å½“å‰æ–¹æ³•å¿…é¡»åœ¨äº‹åŠ¡ä¸­è¿è¡Œ, æ²¡æœ‰äº‹åŠ¡,å°±æŠ›å‡ºå¼‚å¸¸
	
- Nerver
	
	- æœ‰äº‹åŠ¡,æŠ›å‡ºå¼‚å¸¸
	
- NESTED
	
	- å¦‚æœæœ‰äº‹åŠ¡, å°±åœ¨äº‹åŠ¡ä¸­è¿è¡Œ, æ²¡æœ‰å°±å¯åŠ¨ä¸€ä¸ªæ–°çš„äº‹ç‰©,å¹¶åœ¨ä»–è‡ªå·±çš„äº‹ç‰©ä¸­è¿è¡Œ

- äº‹åŠ¡çš„éš”ç¦»çº§åˆ«isolation

  - mysqläº‹åŠ¡æ¦‚è¦

    - è„è¯»: ä¸€ä¸ªäº‹åŠ¡è¯»å–äº†å¦ä¸€ä¸ªæœªæäº¤äº‹åŠ¡ä¿®æ”¹çš„æ•°æ®ã€‚

      - åœºæ™¯ :

        äº‹åŠ¡ A ä¿®æ”¹äº†æŸè¡Œæ•°æ®ï¼ˆæœªæäº¤ï¼‰ã€‚

        äº‹åŠ¡ B è¯»å–äº†è¯¥è¡Œæ•°æ®ã€‚

        äº‹åŠ¡ A å›æ»šäº†ä¿®æ”¹ï¼Œå¯¼è‡´äº‹åŠ¡ B è¯»åˆ°äº†æ— æ•ˆçš„â€œè„æ•°æ®â€ã€‚

      - è§£å†³ READ COMMITTED åŠä»¥ä¸Š

    - ä¸å¯é‡å¤è¯»åŒä¸€äº‹åŠ¡å†…ï¼Œå¤šæ¬¡è¯»å–åŒä¸€è¡Œæ•°æ®ï¼Œç»“æœä¸ä¸€è‡´ï¼ˆå› å…¶ä»–äº‹åŠ¡ä¿®æ”¹å¹¶æäº¤äº†è¯¥è¡Œæ•°æ®)

      åœºæ™¯: äº‹åŠ¡ A ç¬¬ä¸€æ¬¡è¯»å–æŸè¡Œæ•°æ®ã€‚äº‹åŠ¡ B ä¿®æ”¹è¯¥è¡Œæ•°æ®å¹¶æäº¤ã€‚äº‹åŠ¡ A å†æ¬¡è¯»å–è¯¥è¡Œæ•°æ®ï¼Œç»“æœä¸åŒã€‚

       è§£å†³: REPEATABLE READ åŠä»¥ä¸Š

    å¹»è¯»ï¼ˆPhantom Readï¼‰:åŒä¸€äº‹åŠ¡å†…ï¼Œå¤šæ¬¡æŸ¥è¯¢åŒä¸€èŒƒå›´çš„æ•°æ®ï¼Œç»“æœé›†çš„è¡Œæ•°ä¸åŒï¼ˆå› å…¶ä»–äº‹åŠ¡æ’å…¥æˆ–åˆ é™¤äº†ç¬¦åˆè¯¥èŒƒå›´çš„æ•°æ®å¹¶æäº¤ï¼‰

    åœºæ™¯: äº‹åŠ¡ A ç¬¬ä¸€æ¬¡æŸ¥è¯¢æŸä¸ªèŒƒå›´çš„æ•°æ®ã€‚

    äº‹åŠ¡ B æ’å…¥æˆ–åˆ é™¤äº†ç¬¦åˆè¯¥èŒƒå›´çš„æ•°æ®å¹¶æäº¤ã€‚

    äº‹åŠ¡ A å†æ¬¡æŸ¥è¯¢ï¼Œå‘ç°ç»“æœé›†ä¸­å¤šäº†æˆ–å°‘äº†è¡Œï¼ˆâ€œå¹»å½±è¡Œâ€ï¼‰ã€‚

    è§£å†³: SERIALIZABLE éš”ç¦»çº§åˆ«æˆ–è€…MySQL çš„ REPEATABLE READ ç»“åˆé—´éš™é”ï¼ˆGap Locksï¼‰é¿å…å¹»è¯»ã€‚

    é”

    è¡Œé”

    1.SELECT ... FOR UPDATE æ˜¯æ˜¾å¼åŠ é”æœºåˆ¶ï¼Œç”¨äºä¿æŠ¤ç°æœ‰è¡Œçš„ä¿®æ”¹æƒ

    2.å…¶ä»–äº‹åŠ¡æ— æ³•å¯¹è¢«é”å®šçš„è¡Œæ‰§è¡Œä¿®æ”¹ï¼ˆå¦‚ UPDATEã€DELETEï¼‰æˆ–åŠ å…¶ä»–æ’ä»–é”ã€‚
    3.å¿…é¡»é…åˆäº‹åŠ¡ä½¿ç”¨
    4.è‹¥æŸ¥è¯¢æœªä½¿ç”¨ç´¢å¼•ï¼Œå¯èƒ½å‡çº§ä¸º è¡¨é”ï¼ˆInnoDB ä¼šé€€åŒ–ä¸ºé”å…¨è¡¨



```mysql
BEGIN;
SELECT * FROM orders WHERE user_id = 100 FOR UPDATE; -- é”å®š user_id=100 çš„è®¢å•è¡Œ
UPDATE orders SET status = 'paid' WHERE user_id = 100;
COMMIT;
```
é—´éš™é”: é—´éš™é” æ˜¯ InnoDB åœ¨ REPEATABLE READ ä¸‹è‡ªåŠ¨åŠ çš„é”ï¼Œç”¨äºé˜²æ­¢å¹»è¯»

springäº‹åŠ¡éš”ç¦»çº§åˆ«

DEFAULT åœ¨é»˜è®¤æƒ…å†µä¸‹, å£°æ˜å¼äº‹åŠ¡éš”ç¦»ä½¿ç”¨æ•°æ®åº“çš„é»˜è®¤éš”ç¦»çº§åˆ«, mysqlæ˜¯REPEATABLE_READ

READ_UNCOMMITTED

READ_COMMITTED

REPEATABLE_READ

SERIALIZABLE

äº‹åŠ¡æ‰¾è¶…æ—¶å›æ»štimeout
ä»¥ç§’ä¸ºå•ä½

- æ­¤äº‹åŠ¡çš„è¶…æ—¶æ—¶é—´ï¼ˆä»¥ç§’ä¸ºå•ä½ï¼‰ã€‚
é»˜è®¤ä¸ºåº•å±‚äº‹åŠ¡ç³»ç»Ÿçš„é»˜è®¤è¶…æ—¶æ—¶é—´ã€‚
ä¸“ä¸ºä¸ Propagation.REQUIRED æˆ– Propagation.REQUIRES_NEW é…åˆä½¿ç”¨è€Œè®¾è®¡ï¼Œå› ä¸ºå®ƒä»…é€‚ç”¨äºæ–°å¯åŠ¨çš„äº‹åŠ¡ã€‚

- é»˜è®¤å€¼æ˜¯-1, è¡¨ç¤ºä½¿ç”¨mysqlé»˜è®¤äº‹åŠ¡è¶…æ—¶æ—¶é—´

## springMVC

### å®šä¹‰

- springmvcæ˜¯webå±‚æ¡†æ¶

	- æ¥ç®¡äº†webå±‚ç»„ä»¶
æ§åˆ¶å™¨,è§†å›¾,è§†å›¾è§£æ,è¿”å›ç»™ç”¨æˆ·æ•°æ®æ ¼å¼,æ”¯æŒmvcçš„å¼€å‘æ¨¡å¼

	- springMVCé€šè¿‡æ³¨è§£,è®©pojoæˆä¸ºæ§åˆ¶å™¨, ä¸éœ€è¦ç»§æ‰¿HttpServletç±»æˆ–è€…æ¥å£, è€¦åˆåº¦æ›´ä½

	- æ”¯æŒRESTé£æ ¼çš„URLè¯·æ±‚

	- springmvcåŸºäºspring

	- springmvcåº•å±‚æ˜¯Servlet(javaEEæ ‡å‡†)

- å’Œspringbootçš„å…³ç³»

	- booté›†æˆäº†springmvc,springæ˜¯ä¸€ä¸ªæ•´åˆæ¡†æ¶, æ›´å®¹æ˜“ä½¿ç”¨

	- è€Œä¸”booté…ç½®æ›´ç®€å•, ä¸ç”¨é€‰ä¾èµ–ç‰ˆæœ¬å·, å› ä¸ºbootéƒ½ç»™ä½ å®šå¥½äº†

### ä½¿ç”¨+quickstart

- å¼•å…¥ä¾èµ–

	- spring-web
spring-webmvc
5.3.8
javax.servlet-api:3.1.0
jsp-api:2.2
å‚è€ƒspringmvc_çš„pom.xmlæ–‡ä»¶

- åˆ›å»ºjavawebå·¥ç¨‹

  ```java
  @Controller
  public class UserController {
    /**
  
   * å“åº”ç”¨æˆ·çš„ç™»å½•è¯·æ±‚
   * æŒ‡å®šè·¯å¾„ @RequestMapping(value = "/login")
   * ç±»ä¼¼äº  @WebServlet(urlPatterns = "/login"),
   * å°±æ˜¯è®©urlæ˜ å°„åˆ°è¿™ä¸ªloginæ–¹æ³•ä¸Š
   * å½“è®¿é—®http://localhost/springmvc/loginæ—¶å°±ä¼šè°ƒç”¨è¯¥æ–¹æ³•
   * return "login_ok"; è¡¨ç¤ºè¿”å›ç»“æœç»™è§†å›¾è§£æå™¨
   * è§†å›¾è§£æå™¨æ ¹æ®é…ç½®, æ¥å†³å®šè·³è½¬é¡µé¢
     */
    @RequestMapping(value = "/login")
    public String login() {
      return "login_ok";
    }
  }
  ```

  

- åœ¨web.xmlé…ç½®å‰ç«¯æ§åˆ¶æ¥ç®¡æ‰€æœ‰è¯·æ±‚
  é¡ºä¾¿å¯åŠ¨springmvcå®¹å™¨

  ```xml
  <servlet>
    <!--é…ç½®å‰ç«¯æ§åˆ¶å™¨, æ¥ç®¡ç”¨æˆ·çš„æ‰€æœ‰è¯·æ±‚-->
    <servlet-name>DispatcherServlet</servlet-name>
    <servlet-class>org.springframework.web.servlet.DispatcherServlet</servlet-class>
    <init-param>
      <param-name>contextConfigLocation</param-name>
      <param-value>classpath*:ApplicationContext-mvc.xml</param-value>
    </init-param>
  </servlet>
  <servlet-mapping>
    <!--åŒ¹é…æ‰€æœ‰è¯·æ±‚,åŒ…æ‹¬é™æ€èµ„æº-->
    <servlet-name>DispatcherServlet</servlet-name>
    <url-pattern>/</url-pattern>
  </servlet-mapping>
  ```

  

- é…ç½®SpringMVC
  ApplicationContext-mvc.xml

  ```xml
  <!--é…ç½®è¦æ‰«æçš„åŒ…-->
  <context:component-scan base-package="com.xxx.web.controller"/>
  <!--é…ç½®è§†å›¾è§£æå™¨-->
  <bean class="org.springframework.web.servlet.view.InternalResourceViewResolver">
    <!--æŒ‡å®šprefixå‰ç¼€ä¸ºæ–‡ä»¶çš„ç›®å½•-->
    <property name="prefix"  value="/WEB-INF/pages/"/>
    <!--æŒ‡å®šåç¼€suffixä¸º.jspæ–‡ä»¶-->
    <property name="suffix" value=".jsp"/>
  </bean>
  ```

- è®¿é—®æµç¨‹(ç®€è¦ç‰ˆ)

  - 1.æµè§ˆå™¨å‘å‡ºè¯·æ±‚url
    2.å‰ç«¯æ§åˆ¶å™¨æ¥ç®¡æ‰€æœ‰è¯·æ±‚,è°ƒç”¨å¤„ç†å™¨æ˜ å°„å™¨handlerMapping
    3.handleMappingè¿”å›HandlerExecutionChainå¤„ç†å™¨æ‰§è¡Œé“¾å’Œæ‹¦æˆªå™¨(å¤šä¸ª)å’Œç›®æ ‡handler
    4.å‰ç«¯æ§åˆ¶å™¨è°ƒç”¨handlerAdapter
    5.handlerAdapterè°ƒç”¨handler(Controller-->service-->dao--DB)
    6.handlerè¿”å›ModelAndViewç»™handlerAdapter
    7.handlerAdapterè¿”å›ModelAndViewç»™å‰ç«¯æ§åˆ¶å™¨
    8.å‰ç«¯æ§åˆ¶å™¨è°ƒç”¨è§†å›¾è§£æå™¨æ¥è§£æmodelAndView
    9.è¿”å›Viewç»™å‰ç«¯æ§åˆ¶å™¨
    10.å¯¹è§†å›¾æ¸²æŸ“-->html,jsp,freemarker,thymeleaf: å³å°†modelä¸­æ•°æ®å¡«å……åˆ°view
    11.è¿”å›å“åº”

![springmvcè¯·æ±‚æµç¨‹](../IdeaProjects/zangxin51.github.io/img/md-img/2025-03-26-project-01/springmvcè¯·æ±‚æµç¨‹-5199223.png)

### RequestMapping

- @RequestMapping æ³¨è§£å¯ä»¥æŒ‡å®šæ§åˆ¶å™¨/å¤„ç†å™¨çš„æŸä¸ªæ–¹æ³•çš„è¯·æ±‚çš„ url

- @RequestMappingå¯ä»¥ä¿®é¥°æ–¹æ³•å’Œç±»

	- å½“åŒæ—¶ä¿®é¥°ç±»å’Œæ–¹æ³•æ—¶ï¼Œ è¯·æ±‚çš„ url å°±æ˜¯ç»„åˆ /ç±»è¯·æ±‚å€¼/æ–¹æ³•è¯·æ±‚å€¼

- valueå±æ€§æŒ‡å®šurl

	- è·¯å¾„å’ŒWebServletä¸€æ ·,/ä»£è¡¨å·¥ç¨‹è·¯å¾„

- methodå±æ€§

	- æŒ‡å®šè¯·æ±‚æ–¹æ³•,å€¼æ˜¯æšä¸¾ç±»RequestMethod

		- å¸¸ç”¨çš„GET/POST/PUT/DELETE

	- SpringMVC æ§åˆ¶å™¨é»˜è®¤æ”¯æŒGETå’ŒPOSTä¸¤ç§æ–¹å¼, ä¹Ÿå°±æ˜¯ä¸æŒ‡å®š method, è¿˜å¯ä»¥æ¥æ”¶ GET å’Œ POST è¯·æ±‚

	- ä¸æ”¯æŒçš„æ–¹æ³•ä¼šæŠ¥405

- æŒ‡å®š params å’Œ headers æ”¯æŒç®€å•è¡¨è¾¾å¼

  -  param1: è¡¨ç¤ºè¯·æ±‚å¿…é¡»åŒ…å«åä¸º param1 çš„è¯·æ±‚å‚æ•°

    @RequestMapping(value = "/login",params = "param1") //å¿…é¡»åŒ…å«å‚æ•°param1

  - !param1: è¡¨ç¤ºè¯·æ±‚ä¸èƒ½åŒ…å«åä¸º param1 çš„è¯·æ±‚å‚æ•°

    @RequestMapping(value = "/login",params ="!username")

  - param1 != value1: è¡¨ç¤ºå¦‚æœè¯·æ±‚åŒ…å«åä¸º param1 çš„è¯·æ±‚å‚æ•°ï¼Œåˆ™å…¶å€¼ä¸èƒ½ä¸º value1

    @RequestMapping(value = "/login", params = "username!=1") // username!=1,å¯ä»¥æ²¡æœ‰è¯¥å‚æ•°

  - {"param1=value1", "param2"}: è¯·æ±‚å¿…é¡»åŒ…å«åä¸º param1 å’Œ param2 çš„ä¸¤ä¸ªè¯·æ±‚å‚æ•°ï¼Œ ä¸” param1 å‚æ•°çš„å€¼å¿…é¡»ä¸º value1

    @RequestMapping(value = "/login",params ={"username=root","password"})

- urlæ”¯æŒAnté£æ ¼èµ„æºè·¯å¾„
1. ?:åŒ¹é…æ–‡ä»¶åä¸­çš„ä¸€ä¸ªå­—ç¬¦

2. *:åŒ¹é…æ–‡ä»¶åä¸­çš„ä»»æ„å­—ç¬¦
3. **:åŒ¹é…å¤šå±‚è·¯å¾„
- Ant é£æ ¼çš„ url åœ°å€ä¸¾
	
	- /user/*/createUser: åŒ¹é… /user/aaa/createUserã€/user/bbb/createUser ç­‰
	
	- /user/**/createUser: åŒ¹é… /user/createUserã€/user/aaa/bbb/createUser
	
	- /user/createUser??: åŒ¹é… /user/createUseraaã€/user/createUserbb

- @PathVariableè·¯å¾„å˜é‡

  -  @RequestMapping è¿˜å¯ä»¥é…åˆ @PathVariable æ˜ å°„ URL ç»‘å®šçš„å ä½ç¬¦

  - è¿™æ ·å°±ä¸éœ€è¦åœ¨ url åœ°å€ä¸Šå¸¦å‚æ•°åäº†ï¼Œæ›´åŠ çš„ç®€æ´æ˜äº†


  ```java
  http://localhost/springmvc/user/ok/11/alice
  @RequestMapping("/user/ok/{id}/{username}")
  public String m1(@PathVariable Integer id, @PathVariable("username") String name) {}
  ```

  

- ç®€å†™å½¢å¼

  - @GetMapping ç­‰ä»·äº @RequestMapping(value = "/user/**",method = RequestMethod.GET)

  - è¿˜æœ‰PostMapping, PutMapping, DeleteMapping

- æ³¨æ„äº‹é¡¹

  - æ˜ å°„çš„ URL, ä¸èƒ½é‡å¤

  - å¦‚æœæˆ‘ä»¬ç¡®å®šè¡¨å•æˆ–è€…è¶…é“¾æ¥ä¼šæäº¤æŸä¸ªå­—æ®µæ•°æ®æ¯”å¦‚(email), è¦æ±‚æäº¤çš„å‚æ•°åå’Œç›®æ–¹æ³•çš„å‚æ•°åä¿æŒä¸€è‡´, å¦åˆ™åç«¯æ¥æ”¶ä¸åˆ°å‚æ•°

    ```java
    // http://localhost/springmvc/login?username=root&password=root
    @GetMapping(value = "/login")
    public String login(String username, String password) {
      System.out.println("æ”¶åˆ°è¯·æ±‚~~" + username + " " + password);
      return "login_ok";
    }
    ```

    

### postmanä½¿ç”¨/curl,httpClientéƒ½å¯ä»¥ç”¨

### REST

- Representational State Transfer

	- èµ„æºè¡¨ç°å±‚çŠ¶æ€è½¬åŒ–

		- æµè¡Œçš„è¯·æ±‚æ–¹å¼

- åœ¨HTTPåè®®ä¸­å››ä¸ªè¡¨ç¤ºæ“ä½œæ–¹å¼çš„åŠ¨è¯

  - GET

    - æŸ¥è¯¢  @GetMapping

  - POST

  	- æ–°å¢

  - PUT

  	- æ›´æ–°

  - DELET

  	- åˆ é™¤

- ä¼ ç»Ÿä¸­urlä½¿ç”¨å‚æ•°æ¥è¯´æ˜crudçš„ç±»å‹, restä½¿ç”¨ä¸åŒè¯·æ±‚æ–¹æ³•æ¥è¯´æ˜crudçš„ç±»å‹

- REST çš„æ ¸å¿ƒè¿‡æ»¤å™¨

  - å½“å‰çš„æµè§ˆå™¨åªæ”¯æŒpost/get è¯·æ±‚ï¼Œå› æ­¤ä¸ºäº†å¾—åˆ°put/deleteçš„è¯·æ±‚æ–¹å¼éœ€è¦ä½¿ç”¨Spring æä¾›çš„ HiddenHttpMethodFilter è¿‡æ»¤å™¨è¿›è¡Œè½¬æ¢.

  -  HiddenHttpMethodFilter:æµè§ˆå™¨ form è¡¨å•åªæ”¯æŒ GET ä¸ POST è¯·æ±‚ï¼Œè€Œ DELETEã€PUT ç­‰ method å¹¶ä¸æ”¯æŒï¼ŒSpring æ·»åŠ äº†ä¸€ä¸ªè¿‡æ»¤å™¨ï¼Œå¯ä»¥å°†è¿™äº›è¯·æ±‚è½¬æ¢ä¸ºæ ‡å‡†çš„ http æ–¹ æ³•ï¼Œä½¿å¾—æ”¯æŒ GETã€POSTã€PUT ä¸ DELETE è¯·æ±‚

  - HiddenHttpMethodFilter èƒ½å¯¹ post è¯·æ±‚æ–¹å¼è¿›è¡Œè½¬æ¢

  - è¿™ä¸ªè¿‡æ»¤å™¨éœ€è¦åœ¨ web.xml ä¸­é…ç½®

  - HiddenHttpMethodFilterçš„**æºç **æ˜¯æŠŠè¡¨å•ä¸­_methodå‚æ•°çš„å€¼è½¬æ¢putæˆ–è€…delete
    POST /springmvc/book HTTP/1.1
    _method=DELETE

    ```java
    // åªå¯¹postæ–¹æ³•è¿›è¡Œè½¬æ¢
    if ("POST".equals(request.getMethod())) {
      String paramValue = request.getParameter("_method");
      if (StringUtils.hasLength(paramValue)) {
        // æ–¹æ³•åè½¬æ¢æˆå¤§å†™
        String method = paramValue.toUpperCase(Locale.ENGLISH);
        // å…è®¸çš„æ–¹æ³•æœ‰put | delete
        if (ALLOWED_METHODS.contains(method)) {
          // è¿™é‡Œä¿®æ”¹æ–¹æ³•ä¸º_methodä¼ è¿‡æ¥çš„å€¼
          requestToUse = new HttpMethodRequestWrapper(request, method);
        }
      }
    }
    ```

    

- é…ç½®è¿‡æ»¤å™¨, ä½œç”¨æ˜¯æŠŠpostè¯·æ±‚è½¬æ¢æˆputå’Œdelete

- åœ¨web.xmlä¸­

  ```xml
  <filter>
    <filter-name>hiddenHttpMethodFilter</filter-name>
    <filter-class>org.springframework.web.filter.HiddenHttpMethodFilter</filter-class>
  </filter>
  <filter-mapping>
    <!--åŒ¹é…æ‰€æœ‰è¯·æ±‚-->
    <filter-name>hiddenHttpMethodFilter</filter-name>
    <url-pattern>/*</url-pattern>
  </filter-mapping>
  ```

  

- é…ç½®ApplicationContext-mvc.xml

  ```xml
  <!--åŠ å…¥ä¸¤ä¸ªå¸¸è§„é…ç½®-->
  <!--æ”¯æŒSpringMvcçš„é«˜çº§åŠŸèƒ½JSR303æ ¡éªŒ,æ˜ å°„åŠ¨æ€è¯·æ±‚-->
  <mvc:annotation-driven/>
  <!--å°†SpringMvcä¸èƒ½å¤„ç†çš„è¯·æ±‚äº¤ç»™tomcat,æ¯”å¦‚css/jsç­‰é™æ€æ–‡ä»¶-->
  <mvc:default-servlet-handler/>
  ```

  

- 405é—®é¢˜

  - è¿™ç§æ–¹å¼å­˜åœ¨é—®é¢˜

    ```java
    @PutMapping("/book")
    public String editBook() {
      System.out.println("ä¿®æ”¹ä¹¦ç±");
      // è¿™ç§æ–¹å¼ä½¿ç”¨çš„æ˜¯è½¬å‘
        return "success";
    }
    ```

    

  - 405 - æ–¹æ³•ä¸å…è®¸
  JSP åªå…è®¸ GETã€POST æˆ– HEADã€‚Jasper è¿˜å…è®¸ OPTIONS

  	- å¦‚æœ web é¡¹ç›®æ˜¯è¿è¡Œåœ¨ Tomcat 8 åŠä»¥ä¸Šï¼Œä¼šå‘ç°è¢«è¿‡æ»¤æˆ DELETE å’Œ PUT è¯·æ±‚ï¼Œåˆ°è¾¾ æ§åˆ¶å™¨æ—¶èƒ½é¡ºåˆ©æ‰§è¡Œï¼Œä½†æ˜¯è¿”å›æ—¶(forward)ä¼šæŠ¥ HTTP 405 çš„é”™è¯¯æç¤º:æ¶ˆæ¯ JSP åªå…è®¸ GETã€POST æˆ– HEAD

  - : å°†è¯·æ±‚è½¬å‘(forward)æ”¹ä¸ºè¯·æ±‚é‡å®šå‘(redirect):é‡å®šå‘åˆ°ä¸€ä¸ª Handlerï¼Œ ç”± Handler è½¬å‘åˆ°é¡µé¢

    ```java
    @DeleteMapping("/book")
    public String deleteBook() {
      System.out.println("åˆ é™¤ä¹¦ç±");
      // é‡å®šå‘ä¼šè¢«è§£æä¸º: /springmvc/success
      return "redirect:/success";
    }
    ```

    ```java
    @GetMapping("/success")
    public String success() {
      return "success";
    }
    ```

    

### SpringMVCæ˜ å°„è¯·æ±‚æ•°æ®

- å¦‚ä½•è·å–åˆ° http://xxx/url?å‚æ•°å=å‚æ•°å€¼&å‚æ•°å=å‚æ•°å€¼

	- @RequestParam(value="name", required=false) 
1.@RequestParam : è¡¨ç¤ºè¯´æ˜ä¸€ä¸ªæ¥å—åˆ°çš„å‚æ•°
 2.value="name" : æ¥æ”¶çš„å‚æ•°åæ˜¯ name å‚æ•°.     
3.required=false : è¡¨ç¤ºè¯¥å‚æ•°å¯ä»¥æœ‰ï¼Œä¹Ÿå¯ä»¥æ²¡æœ‰ ,
å¦‚æœ required=true,è¡¨ç¤ºå¿…é¡»ä¼ é€’, é»˜è®¤æ˜¯ required=true

	
	```java
	/**
	* http://localhost/springmvc/vote/vote01?name=abc
	*/
	@RequestMapping("/vote01")
	public String test01(@RequestParam(value = "name",required = true) String username) {
	  System.out.println("å¾—åˆ°username=" + username);
	  return "success";
	}
	```
	
	
 * - ä¸å†™@RequestParamæ—¶, å¦‚æœå‰ç«¯å‚æ•°åå’Œåç«¯æ–¹æ³•å‚æ•°åä¸ä¸€æ ·å°±æ‹¿ä¸åˆ°å‚æ•°

- è·å–HTTPè¯·æ±‚å¤´

```java
@RequestMapping("/vote02")
public String test02(@RequestHeader("Accept-Encoding") String ae,
                     @RequestHeader("Host") String host) {
  System.out.printf("%s,%s\n", ae, host);
  return "success";
}
```



- ç”¨javabean/pojoæ¥æ¥æ”¶æ•°æ®

  -  è‡ªåŠ¨å°è£…, è¦æ±‚æäº¤çš„æ•°æ®åå­—å’Œå¯¹è±¡çš„å±æ€§åä¸€æ ·,æä¾›getter/setter
 * çº§è”æ“ä½œ: å¦‚æœå±æ€§æ˜¯å¯¹è±¡, é€šè¿‡å­—æ®µå.å­—æ®µåæ¥åŒ¹é…
 * æ¯”å¦‚: pet.id pet.name, å…¶ä¸­petæ˜¯Masterçš„ä¸€ä¸ªå­—æ®µ
 * å¦‚æœæ²¡æœ‰åŒ¹é…æˆåŠŸ, åˆ™å¯¹è±¡å±æ€§å€¼ä¸ºnullå€¼æˆ–é»˜è®¤å€¼

```shell
curl 'http://localhost/springmvc/vote/vote03' \
--data-raw 'id=1001&name=kiyana&pet.id=10001&pet.name=heyy'
```

```java
@Data
public class Master {
  private Integer id;
  String name;
  // çº§è”å±æ€§
  Pet pet;
}
@Data
class Pet {
  Integer id;
  String name;
}
```

```java
@RequestMapping(value = "/vote03")
public String test03(Master master) {
  System.out.println(master);
  return "success";
}
```



- ä½¿ç”¨servletAPI

  - è·å–request, response

```java
@RequestMapping("/vote04")
public String test04(HttpServletRequest request,
                     HttpServletResponse response,
                     HttpSession hs) {
  String username = request.getParameter("username");
  String password = request.getParameter("password");
  System.out.printf("%s,%s\n", username, password);
  // ä»requestè·å–çš„sessionå’Œä»å½¢å‚æ‹¿åˆ°Sessionæ˜¯åŒä¸€ä¸ª
  System.out.println(hs.getId().equals(request.getSession().getId()));
  return "success";
}
```



### æ¨¡å‹æ•°æ®model

- æ¨¡å‹æ•°æ®å¤„ç†-æ•°æ®æ”¾å…¥ request

  - å¼€å‘ä¸­, æ§åˆ¶å™¨/å¤„ç†å™¨ä¸­è·å–çš„æ•°æ®å¦‚ä½•æ”¾å…¥ request åŸŸï¼Œç„¶ååœ¨å‰ç«¯(VUE/JSP/...)å–å‡ºæ˜¾ç¤º

  - æŠŠè¯·æ±‚å‚æ•°æ”¾åˆ°requeståŸŸä¸­

```java
// 1. springmvc ä¼šè‡ªåŠ¨æŠŠè·å–çš„ model æ¨¡å‹(å½¢å‚)ï¼Œæ”¾å…¥åˆ° request åŸŸä¸­ï¼Œåå­—å°±æ˜¯ master 
// 2. ä¹Ÿå¯ä»¥æ‰‹åŠ¨å°† master æ”¾å…¥åˆ° request
// å±æ€§åé»˜è®¤æ˜¯ç±»åå°å†™
//request.setAttribute("master", master);
@RequestMapping("/vote05")
public String test05(Master master) {
  return "vote_ok";
}
```



- <h1>è·å–æ•°æ®çš„æ˜¾ç¤ºé¡µé¢</h1>
  ```jsp
  ä¸»äººçš„id:${requestScope.master.id} <br>
  ä¸»äººçš„åå­—:${requestScope.master.name} <br>
  å® ç‰©çš„id:${requestScope.master.pet.id} <br>
  å® ç‰©çš„åå­—:${requestScope.master.pet.name}
  ```

  

- é€šè¿‡mapæ·»åŠ æ•°æ®åˆ°requeståŸŸä¸­

  ```java
  @RequestMapping("/vote06")
  public String test06(Master master, Map<String,Object> map) {
    map.put("address", "shanghai");
    // è¿™ä¼šä½¿å¾—masterå¯¹è±¡ä¸ºnull,åœ¨è§†å›¾è·å–ä¸åˆ°master
    // map.put("master", null);
    return "vote_ok";
  }
  ```

  

- è¿”å›ModelAndViewå¯¹è±¡,å°†æ•°æ®æ”¾åˆ°requeståŸŸä¸­

  ```java
  @RequestMapping("/vote07")
  public ModelAndView test07(Master master) {
    ModelAndView mv = new ModelAndView();
    // æ·»åŠ requeståŸŸå±æ€§
    mv.addObject("address", "shenzhen");
    // è¿™ä¼šä½¿å¾—masterå¯¹è±¡ä¸ºnull,åœ¨è§†å›¾è·å–ä¸åˆ°master
    // mv.addObject("master", null);
    // è½¬å‘çš„è§†å›¾åç§°
    mv.setViewName("vote_ok");
    return mv;
  }
  
  ```

  1) ä»æœ¬è´¨çœ‹ï¼Œè¯·æ±‚å“åº”çš„æ–¹æ³• return "xx", æ˜¯è¿”å›äº†ä¸€ä¸ªå­—ç¬¦ä¸²ï¼Œå…¶å®æœ¬è´¨æ˜¯è¿”å›äº†ä¸€ä¸ªModelAndView å¯¹è±¡ï¼Œåªæ˜¯é»˜è®¤è¢«å°è£…èµ·æ¥çš„.
    2) ModelAndView å³å¯ä»¥åŒ…å« model æ•°æ®ï¼Œä¹Ÿå¯ä»¥åŒ…å«è§†å›¾ä¿¡æ¯
    3) ModelAndView å¯¹è±¡çš„ addObject æ–¹æ³•å¯ä»¥æ·»åŠ  key-val æ•°æ®ï¼Œé»˜è®¤åœ¨ request åŸŸä¸­ 
    4) ModelAndView å¯¹è±¡ setView æ–¹æ³•å¯ä»¥æŒ‡å®šè§†å›¾åç§°

- æ•°æ®æ”¾å…¥ session

```java
@RequestMapping("/vote08")
public String test08(Master master,HttpSession session) {
  // masterå¯¹è±¡é»˜è®¤æ”¾åœ¨requestä¸­
  // æˆ‘ä»¬å°†masteræ”¾å…¥åˆ°Sessionä¸­
  session.setAttribute("master", master);
  session.setAttribute("address","america");
  return "vote_ok";
}
```

- @ModelAttributeçš„prepareæ–¹æ³•--controllerçš„å‰ç½®é€šçŸ¥æ–¹æ³•

  - åœ¨æŸä¸ªæ–¹æ³•ä¸Šï¼Œå¢åŠ äº†@ModelAttribute æ³¨è§£å
  é‚£ä¹ˆåœ¨è°ƒç”¨è¯¥ Handler çš„ä»»ä½•ä¸€ä¸ªæ–¹æ³•æ—¶ï¼Œéƒ½ä¼šå…ˆè°ƒç”¨è¿™ä¸ªæ–¹æ³•, æœ‰ç‚¹ç±»ä¼¼äºAOPçš„å‰ç½®é€šçŸ¥,åº•å±‚è¿˜æ˜¯aopçš„å‰ç½®é€šçŸ¥

  - æœ€ä½³å®è·µ

### è§†å›¾å’Œè§†å›¾è§£æå™¨

- å®šä¹‰

1.åœ¨ springMVC ä¸­çš„ç›®æ ‡æ–¹æ³•æœ€ç»ˆè¿”å›éƒ½æ˜¯ä¸€ä¸ªè§†å›¾(æœ‰å„ç§è§†å›¾).
2.è¿”å›çš„è§†å›¾éƒ½ä¼šç”±ä¸€ä¸ªè§†å›¾è§£æå™¨æ¥å¤„ç† (è§†å›¾è§£æå™¨æœ‰å¾ˆå¤šç§)
3.è§†å›¾è§£æå™¨è¿”å›çš„æ˜¯æ•°æ®å’Œè·³è½¬çš„url, å³model and view

- è‡ªå®šä¹‰è§†å›¾

ä¸ºä»€ä¹ˆè‡ªå®šä¹‰è§†å›¾

åœ¨é»˜è®¤æƒ…å†µä¸‹ï¼Œæˆ‘ä»¬éƒ½æ˜¯è¿”å›é»˜è®¤çš„è§†å›¾, ç„¶åè¿™ä¸ªè¿”å›çš„è§†å›¾äº¤ç”± SpringMVC çš„ InternalResourceViewResolver è§†å›¾å¤„ç†å™¨æ¥å¤„ç†çš„

åœ¨å®é™…å¼€å‘ä¸­ï¼Œæˆ‘ä»¬æœ‰æ—¶éœ€è¦è‡ªå®šä¹‰è§†å›¾,è¿™æ ·å¯ä»¥æ»¡è¶³æ›´å¤šæ›´å¤æ‚çš„éœ€æ±‚.

- è‡ªå®šä¹‰è§†å›¾æ­¥éª¤ 

  1.é…ç½®è‡ªå®šä¹‰è§†å›¾è§£æå™¨BeanNameViewResolver

  ```xml
  <!--
  BeanNameViewResolverå¯ä»¥è§£ææˆ‘ä»¬è‡ªå®šä¹‰çš„è§†å›¾
   é…ç½®å±æ€§order,è¡¨ç¤ºè§£æå™¨æ‰§è¡Œçš„é¡ºåº,å€¼è¶Šå°,ä¼˜å…ˆçº§è¶Šé«˜
   å±æ€§orderé»˜è®¤å€¼æ˜¯Integer.MAX, å°±æ˜¯æœ€å°ä¼˜å…ˆçº§
  -->
  <bean class="org.springframework.web.servlet.view.BeanNameViewResolver">
    <property name="order" value="99"/>
  </bean>
  ```

  å®šä¹‰è§†å›¾

```java
/**
* 1.MyViewç»§æ‰¿äº†AbstractView,å¯ä»¥ä½œä¸ºä¸€ä¸ªè§†å›¾ä½¿ç”¨
* 2.@Component("myView")äº¤ç»™å®¹å™¨ç®¡ç†
*/
@Component("myView")
public class MyView extends AbstractView {
  @Override
  protected void renderMergedOutputModel(Map<String, Object> model,
                                         HttpServletRequest request, HttpServletResponse response) throws Exception {
    // è¿™ä¸ªæ–¹æ³•å®Œæˆè§†å›¾æ¸²æŸ“
    // å¹¶ä¸”å†³å®šè·³è½¬çš„é¡µé¢ /WEB-INF/pages/my_view.jsp
    System.out.println("è¿›å…¥åˆ°è‡ªå®šä¹‰çš„è§†å›¾è§£æå™¨");
    request.getRequestDispatcher("/WEB-INF/pages/my_view.jsp")
      .forward(request, response);
  }
}
```

è¿”å›è‡ªå®šä¹‰è§†å›¾

```java
@RequestMapping("/goods")
@Controller
public class GoodsController {
  @RequestMapping("/buy")
  public String buy() {
    System.out.println("buy()æ–¹æ³•è¢«è°ƒç”¨");
    // è¿”å›è‡ªå®šä¹‰è§†å›¾
    return "myView";
  }
}
```

æ€»ç»“

1. è‡ªå®šä¹‰è§†å›¾: åˆ›å»ºä¸€ä¸ª View çš„ bean, è¯¥ bean éœ€è¦ç»§æ‰¿è‡ª AbstractView, å¹¶å®ç°
renderMergedOutputModel æ–¹æ³•.        

2. å¹¶æŠŠè‡ªå®šä¹‰ View åŠ å…¥åˆ° IOC å®¹å™¨ä¸­
3. è‡ªå®šä¹‰è§†å›¾çš„è§†å›¾å¤„ç†å™¨ï¼Œä½¿ç”¨ BeanNameViewResolverï¼Œè¿™ä¸ªè§†å›¾å¤„ç†å™¨ä¹Ÿéœ€è¦é…ç½® åˆ° ioc å®¹å™¨
4. BeanNameViewResolver çš„è°ƒç”¨ä¼˜å…ˆçº§éœ€è¦è®¾ç½®ä¸€ä¸‹ï¼Œè®¾ç½® order æ¯” Integer.MAX_VAL å°çš„å€¼. ä»¥ç¡®ä¿å…¶åœ¨ InternalResourceViewResolver ä¹‹å‰è¢«è°ƒç”¨

5. å·¥ä½œæµç¨‹ SpringMVC è°ƒç”¨ç›®æ ‡æ–¹æ³•, è¿”å›è‡ªå®šä¹‰ View åœ¨ IOC å®¹å™¨ä¸­çš„ id

6. SpringMVC è°ƒç”¨ BeanNameViewResolver è§£æè§†å›¾: ä» IOC å®¹å™¨ä¸­è·å– è¿”å› id å€¼å¯¹ åº”çš„ bean, å³è‡ªå®šä¹‰çš„ View çš„å¯¹è±¡
7. SpringMVC è°ƒç”¨è‡ªå®šä¹‰è§†å›¾çš„ renderMergedOutputModel æ–¹æ³•æ¸²æŸ“è§†å›¾
8. å¦‚æœåœ¨ SpringMVC è°ƒç”¨ç›®æ ‡æ–¹æ³•, è¿”å›è‡ªå®šä¹‰ View åœ¨ IOC å®¹å™¨ä¸­çš„ id, ä¸å­˜åœ¨ï¼Œ åˆ™ä»ç„¶æŒ‰ç…§é»˜è®¤çš„è§†å›¾å¤„ç†å™¨æœºåˆ¶å¤„ç†.

9. å¤šä¸ªè§†å›¾æ‰§è¡Œé¡ºåº, ç”±orderæ¥æŒ‡å®š, å¦‚æœæ²¡æœ‰è‡ªå®šä¹‰è§†å›¾,Springmvcæä¾›äº†ä¸€ä¸ªé»˜è®¤çš„InternalResourceViewResolverè§†å›¾è§£æå™¨

- æºç åˆ†æ

  - DispatcherServletå¯åŠ¨æ—¶ä¼šinitStrategiesæ–¹æ³•è°ƒç”¨initViewResolvers(context)æ–¹æ³•

  - initViewResolversæ–¹æ³•ä¼šæŠŠæ‰€æœ‰ViewResolver.classç±»æ”¾åœ¨viewResolversè¿™ä¸ªé›†åˆé‡Œ,ç„¶åæŒ‰ç…§orderæ’åº,å¦‚æœæ²¡æœ‰çš„è¯å°±è¿”å›åªæœ‰é»˜è®¤è§£æå™¨çš„å•ä¾‹é›†åˆ

  - åœ¨doDispatchçš„æ–¹æ³•ä¸­è°ƒç”¨processDispatchResultå¤„ç†è¿”å›ç»“æœ, processDispatchResultè°ƒç”¨renderæ–¹æ³•

  - renderæ–¹æ³•è°ƒç”¨resolveViewName, é€šè¿‡forå¾ªç¯å»éå†viewResolvers, ,éå†ä¸­è°ƒç”¨
  viewResolver.resolveViewName(viewName, locale)æ–¹æ³•,å¦‚æœè¿”å›å€¼ä¸ä¸ºnull,å°±æŠŠç»“æœè¿”å›ä¸Šä¸€å±‚,è¿™é‡Œæ³¨æ„åˆ°orderè¶Šå°çš„æœ€å…ˆè¢«å–å‡º,returnä¼šbreakå¾ªç¯

  - BeanNameViewResolver#resolveViewNameä¼šå…ˆå»åˆ¤æ–­å®¹å™¨æœ‰æ²¡æœ‰æœ‰viewNameå¯¹åº”çš„bean, å¦‚æœæœ‰å°±è¿”å›è¿™ä¸ªbeanç»™render

  - rederè°ƒç”¨beançš„renderæ–¹æ³•(beanæ˜¯ä¸€ä¸ªViewæ¥å£çš„å®ä¾‹å¯¹è±¡,å°±æ˜¯æˆ‘ä»¬çš„è‡ªå®šä¹‰è§†å›¾)

  - è¿™ä¸ªview.renderåœ¨Absrtractä¸­é‡å†™, é‡å†™æ–¹æ³•ä¸­è°ƒç”¨äº†ä¸€ä¸ªrenderMergedOutputModelæ–¹æ³•

    è¿™é‡Œç”¨äº†æ¨¡æ¿æ–¹æ³•çš„æ¨¡å¼

  - è¿™ä¸ªrenderMergedOutputModelæ–¹æ³•å°±æ˜¯æˆ‘ä»¬è‡ªå®šä¹‰çš„è§†å›¾é‡å†™çš„æ–¹æ³•.å®Œæ¯•

- åœ¨controlleræ–¹æ³•ä¸­æŒ‡å®šè½¬å‘æˆ–è€…é‡å®šå‘

  - controlleræ–¹æ³•çš„é»˜è®¤è¿”å›æ–¹å¼æ˜¯è½¬å‘,ç„¶åç”¨é»˜è®¤è§†å›¾è§£æå™¨å¤„ç†,æ¯”å¦‚:

    ```java
    @RequestMapping("/buy")
    public String buy() {
      System.out.println("buy()æ–¹æ³•è¢«è°ƒç”¨");
      // è¿”å›è‡ªå®šä¹‰è§†å›¾
      return "myView";
    }
    ```

  - ä¹Ÿå¯ä»¥åœ¨controlleræ–¹æ³•ä¸­æŒ‡å®šé‡å®šå‘æˆ–è€…è½¬å‘çš„url, ä½†æ˜¯é‡å®šå‘ä¸èƒ½å®šå‘åˆ°/WEB-INFç›®å½•ä¸‹

    ```java
    @RequestMapping(value = "order")
    public String order() {
      System.out.println("===========order======");
      // è½¬å‘åˆ°:http://localhost/springmvc/WEB-INF/pages/my_view.jsp
      // /å¼€å¤´è‡ªåŠ¨è§£æä¸ºå·¥ç¨‹è·¯å¾„
      return "forward:/WEB-INF/pages/my_view.jsp";
      // é‡å®šå‘ä¸èƒ½åˆ°/WEB-INFç›®å½•ä¸‹å»
      return "redirect:/WEB-INF/pages/my_view.jsp";
    }
    ```

    

  - debug

  	- forwardè½¬å‘ä½¿ç”¨çš„æ˜¯é»˜è®¤è§†å›¾è§£æå™¨
  redirecté‡å®šå‘ä½¿ç”¨çš„æ˜¯RedirectViewè§†å›¾è§£æå™¨

### å®ç°SpringMVC(ç®€æ˜“ç‰ˆ)

- 1.åˆ›å»ºwebå·¥ç¨‹,åˆ›å»ºä¸€ä¸ªDispatcherServletçš„servlet,ç»§æ‰¿HttpServlet
2.web.xmlæ–‡ä»¶ä¸­å®šä¹‰DispatcherServletçš„urlä¸º/ æ¥ç®¡æ‰€æœ‰è¯·æ±‚
3.DispatcherServletå¯åŠ¨è®¾ç½®éšç€tomcatå¯åŠ¨æ—¶å¯åŠ¨
4.é…ç½®DispatcherServletçš„init-param,æŒ‡å®šmvc.xmlçš„è·¯å¾„
5.mvc.xmlä¸­é…ç½®component-scanæ ‡ç­¾,æŒ‡å®šåŒ…æ‰«æè·¯å¾„
6.é‡å†™DispatcherServletçš„initæ–¹æ³•, è¯»å–initå‚æ•°,è·å–mvc.xmlæ–‡ä»¶ä½ç½®
7.è§£æmvc.xmlæ–‡ä»¶è·å–åŒ…æ‰«æè·¯å¾„
8.é€šè¿‡ç±»åŠ è½½å™¨è·å–æŒ‡å®šåŒ…ä¸‹é¢çš„çœŸå®è·¯å¾„ä¸‹çš„classæ–‡ä»¶,éå†è·å–
9.æŠŠclassæ–‡ä»¶æ”¾å…¥é›†åˆclassFullPathListä¸­
10.éå†classFullPathList,åˆ›å»ºåˆ›å»ºè¢«æ³¨è§£Controlleræ ‡æ³¨çš„ç±»çš„å®ä¾‹å¯¹è±¡,æ”¾å…¥é›†åˆiocä¸­
11.éå†iocä¸­è¢«Controlleræ ‡è®°çš„å¯¹è±¡,éå†å¯¹è±¡çš„æ‰€æœ‰æ–¹æ³•,è¿‡æ»¤å‡ºæœ‰@RequestMappingæ³¨è§£çš„æ–¹æ³•, å¾—åˆ°urlè·¯å¾„,å°è£…åˆ°Handlerå¯¹è±¡ä¸­(url,controller,method), æ”¾å…¥åˆ°handlerListä¸­
12.DispatcherServletæ”¶åˆ°è¯·æ±‚å,è·å–uri,ç„¶åéå†handlerList,æ‰¾åˆ°åŒ¹é…çš„handlerå¯¹è±¡,ç”¨åå°„è°ƒç”¨æ–¹æ³•,å®Œæˆè¯·æ±‚,å¦‚æœæ²¡æœ‰åŒ¹é…url, è¿”å›404
=========è‡ªåŠ¨è£…é…åŠŸèƒ½============
13.è‡ªå®šä¹‰Serviceæ³¨è§£,åŠ å…¥åˆ°iocå®¹å™¨ä¸­
14.æŠŠServiceè‡ªåŠ¨è£…é…åˆ°Controllerçš„å­—æ®µä¸­: éå†æ‰€æœ‰beançš„æ‰€æœ‰å­—æ®µ, è·å–æœ‰Autowiredæ³¨è§£çš„å­—æ®µçš„ç±»å‹, ç„¶åéå†æ‰€æœ‰iocå®¹å™¨,æ ¹æ®ç±»å‹è·å–bean,ç”¨field.set(bean, obj)å®Œæˆæ³¨å…¥
=========å°è£…è¯·æ±‚å‚æ•°================
15.@RequestParamè§£æè¯·æ±‚å‚æ•°åˆ°handleræ–¹æ³•å½¢å‚: éå†handlerçš„æ–¹æ³•çš„å½¢å‚åˆ—è¡¨, åŒæ—¶éå†request.getParameterMapè¿›è¡Œå‚æ•°åå’Œå½¢å‚ååŒ¹é…:
15.1.RequestParamæ³¨è§£,åŒ¹é…æ³¨è§£valueä¸å‚æ•°å,
15.2æ— æ³¨è§£,åŒ¹é…å‚æ•°åå’Œå½¢å‚å, éš¾ç‚¹åœ¨äºå½¢å‚çš„ä½ç½®å¤„ç†:å°è£…æˆå‚æ•°æ•°ç»„,ç„¶åæ”¾åˆ°invokeä¸­
===========è§†å›¾è§£æ=======================
16.è§†å›¾è§£æ,å¯¹handleræ–¹æ³•çš„è¿”å›ç»“æœ,åˆ¤æ–­æ˜¯è½¬å‘/é‡å®šå‘/é»˜è®¤å¤„ç†(å¤„ç†)
17.@ResponseBodyæ³¨è§£,è¿”å›jsonæ•°æ®å½¢å¼: åˆ¤æ–­handleræ–¹æ³•ä¸Šæ˜¯å¦æœ‰ ResponseBodyæ³¨è§£,
æœ‰æ³¨è§£ä½¿ç”¨jsonå·¥å…·è½¬æ¢æˆjson,è®¾ç½®content-typeä¸ºjson
- æºç åœ¨myspringmvc
	
- æ–°çŸ¥è¯†

	- æ³¨è§£çš„ä½¿ç”¨
isAnnotationPresent,åˆ¤æ–­æ˜¯æœ‰æ³¨è§£
A.class.isAssignableFrom(B.class),åˆ¤æ–­Aæ˜¯ä¸æ˜¯Bçš„çˆ¶ç±»å‹
éå†æ–‡ä»¶
Files.walk(path)æµæ–¹æ³•

### è¯·æ±‚æ•°æ®æ ¼å¼åŒ–

- å®šä¹‰

	- åœ¨æˆ‘ä»¬æäº¤æ•°æ®(æ¯”å¦‚è¡¨å•æ—¶)SpringMVC æ€æ ·å¯¹æäº¤çš„æ•°æ®è¿›è¡Œè½¬æ¢å’Œå¤„ç†çš„

- åŸºæœ¬æ•°æ®ç±»å‹å¯ä»¥å’Œå­—ç¬¦ä¸²ä¹‹é—´è‡ªåŠ¨å®Œæˆè½¬æ¢

	- java.lang.Character -> java.lang.Number : CharacterToNumberFactory
java.lang.String -> java.lang.Enum : StringToEnumConverterFactory
.....ç­‰

	- æŸ¥çœ‹æ¥å£org.springframework.core.convert.ConversionService

- ç‰¹æ®Šæ•°æ®ç±»å‹å’Œå­—ç¬¦ä¸²é—´çš„è½¬æ¢

  - ç‰¹æ®Šæ•°æ®ç±»å‹å’Œå­—ç¬¦ä¸²ä¹‹é—´çš„è½¬æ¢ä½¿ç”¨æ³¨è§£(æ¯”å¦‚æ—¥æœŸï¼Œè§„å®šæ ¼å¼çš„å°æ•°æ¯”å¦‚è´§å¸å½¢å¼ ç­‰)

  - å¯¹äºæ—¥æœŸå’Œè´§å¸å¯ä»¥ä½¿ç”¨ @DateTimeFormat å’Œ @NumberFormat æ³¨è§£. æŠŠè¿™ä¸¤ä¸ªæ³¨ è§£æ ‡è®°åœ¨å­—æ®µä¸Šå³å¯.

  ```java
  @DateTimeFormat(pattern = "yyyy-MM-dd")
  private Date birthday;
  @NumberFormat(pattern = "###,###.##")
  private Double salary;
  ```

  

### æ•°æ®éªŒè¯

- å®šä¹‰

	- å¯¹è¾“å…¥çš„æ•°æ®(æ¯”å¦‚è¡¨å•æ•°æ®)ï¼Œè¿›è¡Œå¿…è¦çš„éªŒè¯ï¼Œå¹¶ç»™å‡ºç›¸åº”çš„æç¤ºä¿¡æ¯ã€‚

	- å¯¹äºéªŒè¯è¡¨å•æ•°æ®ï¼ŒspringMVC æä¾›äº†å¾ˆå¤šå®ç”¨çš„æ³¨è§£, è¿™äº›æ³¨è§£ç”± JSR 303 éªŒè¯æ¡†æ¶æä¾›.

- JSR 303 éªŒè¯æ¡†æ¶

  - JSR 303 æ˜¯ Java ä¸º Bean æ•°æ®åˆæ³•æ€§æ ¡éªŒæä¾›çš„æ ‡å‡†æ¡†æ¶ï¼Œå®ƒå·²ç»åŒ…å«åœ¨ JavaEE ä¸­

  - JSR 303 é€šè¿‡åœ¨ Bean å±æ€§ä¸Šæ ‡æ³¨ç±»ä¼¼äº @NotNullã€@Max ç­‰æ ‡å‡†çš„æ³¨è§£æŒ‡å®šæ ¡éªŒè§„åˆ™ï¼Œ å¹¶é€šè¿‡æ ‡å‡†çš„éªŒè¯æ¥å£å¯¹ Bean è¿›è¡ŒéªŒè¯

- Hibernate Validator

	-  Hibernate æ²¡æœ‰å…³ç³»ï¼Œåªæ˜¯ JSR 303 å®ç°çš„ä¸€ä¸ªæ‰©å±•.

	- Hibernate Validator æ˜¯ JSR 303 çš„ä¸€ä¸ªå‚è€ƒå®ç°ï¼Œé™¤æ”¯æŒæ‰€æœ‰æ ‡å‡†çš„æ ¡éªŒæ³¨è§£å¤–ï¼Œå®ƒè¿˜æ”¯ æŒä»¥ä¸‹çš„æ‰©å±•æ³¨è§£:
@Email  è¢«æ³¨è§£çš„å…ƒç´ å¿…é¡»æ˜¯email
@Length è¢«æ³¨é‡Šçš„å­—ç¬¦ä¸²é•¿åº¦å¿…é¡»åœ¨æŒ‡å®šèŒƒå›´
@NotEmpty è¢«æ³¨é‡Šçš„å­—ç¬¦ä¸²å¿…é¡»éç©º
@Range è¢«æ³¨é‡Šçš„å…ƒç´ å¿…é¡»åœ¨åˆé€‚çš„èŒƒå›´å†…

- å¼•å…¥éªŒè¯å’Œå›½é™…åŒ–ç›¸å…³ä¾èµ–

	- hibernate-validator:5.0.0.CR2
hibernate-validator-annotation-processor:5.0.0.CR2
validation-api:1.1.0.Final
classmate:0.8.0
jaxb-api:2.3.1

- ä½¿ç”¨

  - ä½¿ç”¨springmvcçš„è¡¨å•æ ‡ç­¾ä¾¿äºå›æ˜¾æ•°æ®

```html
<%@ taglib prefix="form" uri="http://www.springframework.org/tags/form" %>
  <%@ page contentType="text/html;charset=UTF-8" language="java" %>
    <html>

      <head>
        <title>Title</title>
      </head>

      <body>

        <h3>æ·»åŠ å¦–æ€ª~~</h3>

        <!--ä½¿ç”¨ springMVC çš„æ ‡ç­¾æ¥å®Œæˆ

1. SpringMVC è¡¨å•æ ‡ç­¾åœ¨æ˜¾ç¤ºä¹‹å‰å¿…é¡»åœ¨ request ä¸­æœ‰ä¸€ä¸ª bean, è¯¥ bean çš„å±æ€§ å’Œè¡¨å•æ ‡ç­¾çš„å­—æ®µè¦å¯¹åº”!
request ä¸­çš„ key ä¸º: form æ ‡ç­¾çš„ modelAttrite å±æ€§å€¼ï¼Œ æ¯”å¦‚è¿™é‡Œçš„ monster
2. SpringMVC çš„ form:form æ ‡ç­¾çš„ action å±æ€§å€¼ä¸­çš„ / ä¸ä»£è¡¨ WEB åº”ç”¨çš„æ ¹ç›®å½•.
ç›´æ¥å†™saveå°±è¡Œ, è¿™ä¸ªæ˜¯springmvcçš„æ ‡ç­¾
-->
        <form:form action="save" method="POST" modelAttribute="monster">
          å¦–æ€ªåå­—:<form:input path="name"/><form:errors path="name"/> <br><br>
          å¦–æ€ªå¹´é¾„~:<form:input path="age"/><form:errors path="age"/><br><br>
          ç”µå­é‚®ä»¶:<form:input path="email"/><form:errors path="email"/><br><br>
          ç”Ÿæ—¥:<form:input path="birthday"/><form:errors path="birthday"/>è¦æ±‚ä»¥"9999-11-11"çš„å½¢å¼<br><br>
          è–ªæ°´:<form:input path="salary"/><form:errors path="salary"/>è¦æ±‚ä»¥"123,890.12"çš„å½¢å¼<br><br>
          <input type="submit" value="æ·»åŠ å¦–æ€ª"/>
          <input type="reset">
        </form:form>
      </body>
    </html>
```



- åœ¨beanä¸Šé…ç½®æ³¨è§£

```java
public class Monster {
  @Range(min = 1)
  private Integer id;
  @Email
  private String email;
  @Range(min = 1, max = 100)
  private Integer age;
  // ä¸èƒ½ä¸ºç©º,Asserts that the annotated string,
  // collection, map or array is not {@code null} or empty
  @NotEmpty
  private String name;
  @DateTimeFormat(pattern = "yyyy-MM-dd")
  private Date birthday;
  @NumberFormat(pattern = "###,###.##")
  private Double salary;
}
```



- åœ¨handleræ–¹æ³•ä¸­æ·»åŠ éªŒè¯

```java
/**
 * @Valid Monster monster è¡¨ç¤ºå¯¹monsteræ¥æ”¶çš„æ•°æ®è¿›è¡Œæ ¡éªŒ
 * Errors errorsè¡¨ç¤ºå¦‚æœæ ¡éªŒå‡ºç°é”™è¯¯,å°†æ£€éªŒçš„é”™è¯¯ä¿¡æ¯ä¿å­˜åˆ°errorsä¸­
 * æ ¡éªŒå‘ç”Ÿæ—¶é—´: åœ¨springmvcåº•å±‚,åå°„è°ƒç”¨ç›®æ ‡æ–¹æ³•æ—¶,ä¼šæ¥æ”¶httpè¯·æ±‚æ•°æ®
 * ç„¶åæ ¹æ®æ³¨è§£æ¥è¿›è¡Œæ ¡éªŒ, åœ¨éªŒè¯è¿‡ç¨‹ä¸­,å¦‚æœæœ‰error,å°±æŠŠerrorå¡«å……åˆ°Errorå’Œmapä¸­
 */
  @RequestMapping("/save")
  public String save(@Valid Monster monster, Errors errors, Map<String, Object> map) {
  System.out.println("=========monster==========");
  System.out.println("monster = " + monster);
  System.out.println("=========errors==========");
  System.out.println("errors = " + errors);
  System.out.println("=========map==========");
  System.out.println("map = " + map);
  if (errors.hasErrors()) {
    System.out.println("éªŒè¯å‡ºé”™");
    // è¿”å›åˆ°æ·»åŠ ç•Œé¢,æ˜¾ç¤ºé”™è¯¯
    return "/datavalid/monster_add";
  }
  return "/datavalid/success";
}
```



- é…ç½®å›½é™…åŒ–

  - mvc.xmlæ–‡ä»¶ä¸­é…ç½®

  ```xml
  <!-- é…ç½®å›½é™…åŒ–é”™è¯¯ä¿¡æ¯çš„èµ„æºå¤„ç† -->
  <bean id="messageSource" class="org.springframework.context.support.ResourceBundleMessageSource">
    <!-- é…ç½®å›½é™…åŒ–æ–‡ä»¶åå­—
      è¡¨ç¤º messageSource ä¼šåˆ° src/i18nXXX.properties å»è¯»å–é”™è¯¯ä¿¡æ¯-->
    <property name="basename" value="i18n"></property>
  </bean>
  ```

  

  - i18n.properties

```properties
NotEmpty.monster.name=åå­—ä¸èƒ½ä¸ºç©ºâ¤ï¸
typeMismatch.monster.age=å¹´é¾„åœ¨1-100ä¹‹é—´
typeMismatch.monster.birthday=ç”Ÿæ—¥æ ¼å¼ä¸æ­£ç¡®ğŸ˜¡
typeMismatch.monster.salary=è–ªæ°´å¤ªä½äº†ä¸å¤ªè¡ŒğŸ˜›
```



- ä½¿ç”¨ç»†èŠ‚

1. åœ¨éœ€è¦éªŒè¯çš„ Javabean/POJO çš„å­—æ®µä¸ŠåŠ ä¸Šç›¸åº”çš„éªŒè¯æ³¨è§£.

2. ç›®æ ‡æ–¹æ³•ä¸Š,åœ¨ JavaBean/POJO ç±»å‹çš„å‚æ•°å‰, æ·»åŠ  @Valid æ³¨è§£. å‘ŠçŸ¥ SpringMVC è¯¥ bean æ˜¯éœ€è¦éªŒè¯çš„

3. åœ¨ @Valid æ³¨è§£ä¹‹å, æ·»åŠ ä¸€ä¸ª Errors æˆ– BindingResult ç±»å‹çš„å‚æ•°, å¯ä»¥è·å–åˆ°éªŒè¯ çš„é”™è¯¯ä¿¡æ¯

4. éœ€è¦ä½¿ç”¨ \<form:errors path="email"\>\</form:errors> æ ‡ç­¾æ¥æ˜¾ç¤ºé”™è¯¯æ¶ˆæ¯, è¿™ä¸ªæ ‡ç­¾ï¼Œ éœ€è¦å†™åœ¨\<form:form\> æ ‡ç­¾å†…ç”Ÿæ•ˆ.

5. é”™è¯¯æ¶ˆæ¯çš„å›½é™…åŒ–æ–‡ä»¶ i18n.properties , ä¸­æ–‡éœ€è¦æ˜¯ Unicode ç¼–ç ï¼Œä½¿ç”¨å·¥å…·è½¬ç .æ ¼å¼: éªŒè¯è§„åˆ™.è¡¨å• modelAttribute å€¼.å±æ€§å=æ¶ˆæ¯ä¿¡æ¯

```properties
 NotEmpty.monster.name=\u540D\u5B57\u4E0D\u80FD\u4E3A\u7A7A
 typeMismatch.monster.age=\u7C7B\u578B\u4E0D\u5339\u914D
```

 

6. æ³¨è§£@NotNull å’Œ @NotEmpty çš„åŒºåˆ«è¯´æ˜, NotNullåªæ ¡éªŒénull, è€Œä¸æ ¡éªŒæ˜¯å¦ä¸ºç©ºä¸², NotEmptyæ ¡éªŒénullä¹Ÿéç©º, åªä½œç”¨åœ¨string, collection, map, arrayä¸Š ,NotNullæ‰€æœ‰éƒ½å¯ä»¥ç”¨
7.SpingMVC éªŒè¯æ—¶ï¼Œä¼šæ ¹æ®ä¸åŒçš„éªŒè¯é”™è¯¯, è¿”å›å¯¹åº”çš„ä¿¡æ¯

- æ³¨è§£çš„ç»“åˆä½¿ç”¨

  - @NotNull + @Range
    é˜²æ­¢ä¸ºç©ºæ—¶æäº¤æˆåŠŸ,åªæœ‰@Range, ç©ºçš„ä¼šæäº¤è¿‡å»

  ```java
  public class Monster {
    @Range(min = 1)
    private Integer id;
    @Email
    @NotEmpty
    private String email;
    @Range(min = 1, max = 100)
    @NotNull
    private Integer age;
    // ä¸èƒ½ä¸ºç©º,Asserts that the annotated string,
    // collection, map or array is not {@code null} or empty
    @NotEmpty
    private String name;
    @DateTimeFormat(pattern = "yyyy-MM-dd")
    @NotNull
    private Date birthday;
    @NumberFormat(pattern = "###,###.##")
    @NotNull
    private Double salary;
  }
  ```

  

- æ•°æ®ç±»å‹è½¬æ¢æ ¡éªŒæ ¸å¿ƒç±»-DataBinder

  - å›¾ä¾‹ Spring MVC é€šè¿‡åå°„æœºåˆ¶å¯¹ç›®æ ‡æ–¹æ³•è¿›è¡Œè§£æï¼Œå°†è¯·æ±‚æ¶ˆæ¯ç»‘å®šåˆ°å¤„ç†æ–¹æ³•çš„å…¥å‚ä¸­ã€‚ æ•°æ®ç»‘å®šçš„æ ¸å¿ƒéƒ¨ä»¶æ˜¯ DataBinderï¼Œè¿è¡Œæœºåˆ¶å¦‚ä¸‹

![databinder](./../img/md-img/databinder.png)



- å–æ¶ˆæŸä¸ªå±æ€§çš„ç»‘å®š

	- åœ¨é»˜è®¤æƒ…å†µä¸‹ï¼Œè¡¨å•æäº¤çš„æ•°æ®éƒ½ä¼šå’Œ pojo ç±»å‹çš„ javabean å±æ€§ç»‘å®šï¼Œå¦‚æœåœ¨å¼€å‘ä¸­ï¼Œå¸Œæœ›å–æ¶ˆæŸä¸ªå±æ€§çš„ç»‘å®šï¼Œä¹Ÿå°±æ˜¯è¯´ï¼Œä¸å¸Œæœ›æ¥æ”¶åˆ°æŸä¸ªè¡¨å•å¯¹åº”çš„å±æ€§çš„å€¼ï¼Œåˆ™å¯ä»¥é€šè¿‡ @InitBinder æ³¨è§£å–æ¶ˆç»‘å®š.

-  1.ç¼–å†™ä¸€ä¸ªæ–¹æ³•, ä½¿ç”¨@InitBinder æ ‡è¯†çš„è¯¥æ–¹æ³•ï¼Œå¯ä»¥å¯¹ WebDataBinder å¯¹è±¡è¿›è¡Œåˆå§‹ åŒ–ã€‚WebDataBinder æ˜¯ DataBinder çš„å­ç±»ï¼Œç”¨äºå®Œæˆç”±è¡¨å•å­—æ®µåˆ° JavaBean å±æ€§çš„ç»‘å®š
2. @InitBinder æ–¹æ³•ä¸èƒ½æœ‰è¿”å›å€¼ï¼Œå®ƒå¿…é¡»å£°æ˜ä¸º voidã€‚ 
3. @InitBinder æ–¹æ³•çš„å‚æ•°é€šå¸¸æ˜¯æ˜¯ WebDataBinder

```java
// å–æ¶ˆç»‘å®šmonsterçš„nameæäº¤è¡¨å•çš„å€¼ç»™monster.nameå±æ€§
// 1. setDisallowedFields() æ˜¯å¯å˜å½¢å‚ï¼Œå¯ä»¥æŒ‡å®šå¤šä¸ªå­—æ®µ
// 2. å½“å°†ä¸€ä¸ªå­—æ®µ/å±æ€§ï¼Œè®¾ç½®ä¸º disallowed,å°±ä¸åœ¨æ¥æ”¶è¡¨å•æäº¤çš„å€¼
// 3. é‚£ä¹ˆè¿™ä¸ªå­—æ®µ/å±æ€§çš„å€¼ï¼Œå°±æ˜¯è¯¥å¯¹è±¡é»˜è®¤çš„å€¼ (å…·ä½“çœ‹ç¨‹åºå‘˜å®šä¹‰æ—¶æŒ‡å®š)
// 4. ä¸€èˆ¬æ¥è¯´ï¼Œå¦‚æœä¸æ¥æ”¶è¡¨å•å­—æ®µæäº¤æ•°æ®ï¼Œåˆ™è¯¥å¯¹è±¡å­—æ®µçš„éªŒè¯ä¹Ÿå°±æ²¡æœ‰æ„ä¹‰äº†
//  ,è¦æ³¨é‡Šæ‰ï¼Œæ¯”å¦‚ æ³¨é‡Š //@NotEmpty //@NotEmpty,ä¸æ³¨é‡Šæ‰å°±ä¼šåœ¨é‚£çæ ¡éªŒ, ä¸ç»‘å®šä¼ æ¥nullå€¼åœ¨è¿˜é‚£é‡Œæ‹¦æˆª
// private String name;
@InitBinder
public void initBinder(WebDataBinder webDataBinder) {
  webDataBinder.setDisallowedFields("name", "age");
}
```



### å¤„ç†ä¸­æ–‡ä¹±ç 

- å®šä¹‰

	- å½“è¡¨å•æäº¤æ•°æ®ä¸ºä¸­æ–‡æ—¶ï¼Œä¼šå‡ºç°ä¹±ç 

- å¤„ç†

  - æ–¹å¼1:è‡ªå®šä¹‰ä¸­æ–‡ä¹±ç è¿‡æ»¤å™¨

```java
// å®šä¹‰è¿‡æ»¤å™¨,å®ç°javax.servlet.Filteræ¥å£
public class CharacterEncodingFilter implements Filter {
  @Override
  public void doFilter(ServletRequest request, ServletResponse response, FilterChain chain) throws IOException, ServletException {
    request.setCharacterEncoding("utf8");
    response.setCharacterEncoding("utf8");
    // ä¸€å®šè¦æ”¾è¡Œ
    chain.doFilter(request, response);
  }
}
```

```xml
<!--web.xml, è¿™ä¸ªè¿‡æ»¤å™¨é…ç½®æœ€å‰é¢-->
<!--ä¸­æ–‡ä¹±ç è¿‡æ»¤å™¨-->
<filter>
  <filter-name>characterEncodingFilter</filter-name>
  <filter-class>com.xxx.web.filter.CharacterEncodingFilter</filter-class>
</filter>
<filter-mapping>
  <filter-name>characterEncodingFilter</filter-name>
  <url-pattern>/*</url-pattern>
</filter-mapping>
```



- æ–¹å¼2:ä½¿ç”¨springmvcæä¾›å­—ç¬¦ç¼–ç è¿‡æ»¤å™¨

  ```xml
  <!--springmvcæä¾›çš„å­—ç¬¦ç¼–ç è¿‡æ»¤å™¨-->
  <filter>
    <filter-name>characterEncodingFilter</filter-name>
    <filter-class>org.springframework.web.filter.CharacterEncodingFilter</filter-class>
    <init-param>
      <param-name>encoding</param-name>
      <param-value>utf8</param-value>
    </init-param>
  </filter>
  <filter-mapping>
    <filter-name>characterEncodingFilter</filter-name>
    <url-pattern>/*</url-pattern>
  </filter-mapping>
  ```

  

  jsonå¤„ç†å’ŒHttpMessageConverter

- @RespnoseBodyæ³¨è§£/è¿”å›jsonæ•°æ®

  - å¿…é¡»å¼•å…¥jacksonä¾èµ–
  jackson-databind:2.13.4.2

  - éœ€æ±‚:è¿”å›jsonæ•°æ®

```java
// æŒ‡å®šè¿”å›çš„æ•°æ®æ ¼å¼ json ,é è¿™ä¸ª@ResponseBody
@RequestMapping(value = "/json/dog")
@ResponseBody
public Dog getJson() {
  // å¦‚ä½•ä¸è¿”å›ä¸€ä¸ªè§†å›¾, è€Œè¿”å›ä¸€ä¸ªjsonæ•°æ® HttpMessageConvert
  Dog dog = new Dog("å¤§é»„", "åŒ—äº¬");
  return dog;
}
```



- æ³¨æ„äº‹é¡¹


1.ç›®æ ‡æ–¹æ³•æ­£å¸¸è¿”å› JSON éœ€è¦çš„æ•°æ®, å¯ä»¥æ˜¯ä¸€ä¸ªå¯¹è±¡, ä¹Ÿå¯ä»¥æ˜¯ä¸€ä¸ªé›†åˆ
2.@ResponseBody å¯ä»¥ç›´æ¥å†™åœ¨ controller ä¸Šï¼Œè¿™æ ·å¯¹æ‰€æœ‰æ–¹æ³•ç”Ÿæ•ˆ
3.@ResponseBody + @Controller = @RestController 

- @RequestBodyæ³¨è§£/æ¥æ”¶jsonæ•°æ®


1.æ¥æ”¶å®¢æˆ·ç«¯å‘é€ json å­—ç¬¦ä¸²æ•°æ®ï¼Œ
2.ä½¿ç”¨ SpringMVC çš„ @RequestBody å°†å®¢æˆ·ç«¯æäº¤çš„ json æ•°æ®ï¼Œå°è£…æˆ JavaBean å¯¹è±¡
3.å†æŠŠè¿™ä¸ª javabean ä»¥ json å¯¹è±¡å½¢å¼è¿”å›
4.ä¸€å®šè¦æŒ‡å®šè¯·æ±‚å¤´ ,content-typeä¸ºjson, å‘ŠçŸ¥æœåŠ¡ç«¯,å‘è¿‡æ¥çš„ä¸œè¥¿æ˜¯jsonå­—ç¬¦ä¸², ç„¶ååç«¯æ‰çŸ¥é“æ€ä¹ˆå»å¤„ç†è¿™ä¸ªjson-->è½¬æ¢æˆå¯¹è±¡

- å‰ç«¯

  ```javascript
  function sendJsonData() {
    $("#btn").click(function () {
      let username = $("input[name='username']").val()
      let password = $("input[name='password']").val()
      let user = {username, password}; // es6,å¯¹è±¡ç®€å†™
      let jsonUser = JSON.stringify(user)
      console.log(jsonUser)
      $.post({
        url: '<%=request.getContextPath()%>/json/user/',
        // æŒ‡å®šè¯·æ±‚ç±»å‹ä¸ºjson
        contentType: 'application/json;utf8',
        data: jsonUser,
        // æŒ‡å®šè¿”å›ç±»å‹ä¸ºjson
        dataType: 'json',
        success: (data) => {
          console.log(data)
          $("h3").remove()
          let $h3 = $("<h3></h3>");
          $h3.text(JSON.stringify(data))
          $h3.insertAfter($("#btn"))
        }
      })
    });
  }
  ```

  

- åç«¯

```java
@RequestMapping("/json/user/")
@ResponseBody
public User receiveJson(@RequestBody User user) {
  System.out.println("user = " + user);
  return user;
}
```



- HttpMessageConverter\<T\>

  - SpringMVC å¤„ç† JSON-åº•å±‚å®ç°æ˜¯ä¾é  HttpMessageConverter<T>æ¥è¿›è¡Œè½¬æ¢çš„

    - è¯·æ±‚æŠ¥æ–‡--->HttpInputMessage----->HttpMessageConverter-->-SpringMVC
    å“åº”æŠ¥æ–‡<---HttpOutputMessage<---HttpMessageConverter<---SpringMVC

    -  ä½¿ç”¨ HttpMessageConverter\<T\> å°†è¯·æ±‚ä¿¡æ¯è½¬åŒ–å¹¶ç»‘å®šåˆ°å¤„ç†æ–¹æ³•çš„å…¥å‚ä¸­, æˆ–å°†å“åº”ç»“æœè½¬ä¸ºå¯¹åº”ç±»å‹çš„å“åº”ä¿¡æ¯ï¼ŒSpring æä¾›äº†ä¸¤ç§é€”å¾„

    	- æ–¹æ³•1:ä½¿ç”¨ @RequestBody / @ResponseBody å¯¹ç›®æ ‡æ–¹æ³•è¿›è¡Œæ ‡æ³¨

    	- æ–¹æ³•2:ä½¿ç”¨ HttpEntity\<T> / ResponseEntity\<T> ä½œä¸ºç›®æ ‡æ–¹æ³•çš„å…¥å‚æˆ–è¿”å›å€¼

    - 1.å½“ æ§ åˆ¶ å™¨ å¤„ ç† æ–¹ æ³• ä½¿ ç”¨ åˆ° @RequestBody/@ResponseBody æˆ– HttpEntity\<T>/ResponseEntity\<T> æ—¶, 
    2.Spring é¦–å…ˆæ ¹æ®è¯·æ±‚å¤´æˆ–å“åº”å¤´çš„ Accept å±æ€§é€‰æ‹© åŒ¹é…çš„ HttpMessageConverter, 
    3.è¿›è€Œæ ¹æ®å‚æ•°ç±»å‹æˆ–æ³›å‹ç±»å‹çš„è¿‡æ»¤å¾—åˆ°åŒ¹é…çš„ HttpMessageConverter, 
    4.è‹¥æ‰¾ä¸åˆ°å¯ç”¨çš„ HttpMessageConverter å°†æŠ¥é”™: 415 Unsupported Media Type
    5.å®¢æˆ·ç«¯çè®¾ç½®Acceptè¯·æ±‚å¤´, ä¼šæŠ¥HTTPçŠ¶æ€ 406 - ä¸å¯æ¥æ”¶

    - debugæºç 

    	- 1.AbstractJackson2HttpMessageConverter#readJavaType,æ ¹æ®content-typeæ¥è·å–objectMapper, ç„¶åè·å–ç›®æ ‡æ–¹æ³•çš„å‚æ•°ç±»å‹, ç„¶åç”¨jacksonæ¥ååºåˆ—åŒ–å¾—åˆ°ç›®æ ‡æ–¹æ³•å‚æ•°, åå°„è°ƒç”¨
    2.è·å–åå°„è°ƒç”¨ç»“æœwriteInternalæ ¹æ®content-Typeæ¥åŒ¹objectMapper
    ,ç„¶ååå°„ç»“æœ, åºåˆ—åŒ–æˆjsonå­—ç¬¦ä¸²

- debugByAI

  - åœ¨ Spring MVC ä¸­ï¼Œå†…å®¹ç±»å‹ï¼ˆå¦‚ JSON æˆ– HTMLï¼‰çš„åˆ¤æ–­å’Œè½¬æ¢å™¨é€‰æ‹©æ˜¯é€šè¿‡ Content-Type è¯·æ±‚å¤´ï¼ˆè¯·æ±‚ä½“ç±»å‹ï¼‰å’Œ Accept å“åº”å¤´ï¼ˆå“åº”ç±»å‹ï¼‰å®Œæˆçš„
  - è¯·æ±‚æ•°æ®ç±»å‹çš„åˆ¤æ–­ï¼ˆContent-Typeï¼‰
    å½“å®¢æˆ·ç«¯å‘é€è¯·æ±‚æ—¶ï¼ŒContent-Type è¯·æ±‚å¤´å†³å®šäº†è¯·æ±‚ä½“çš„æ•°æ®æ ¼å¼ï¼ˆå¦‚ application/jsonï¼‰ã€‚Spring MVC ä¼šæ ¹æ®è¯¥å¤´é€‰æ‹©å¯¹åº”çš„ HttpMessageConverter æ¥å¤„ç†è¯·æ±‚ä½“ï¼ˆå¦‚ @RequestBodyï¼‰ã€‚

  - è°ƒè¯•ä½ç½®ï¼š
    DispatcherServlet#doDispatch
    å…¥å£ç‚¹ï¼Œå¤„ç†è¯·æ±‚åˆ†å‘ï¼Œè°ƒç”¨ HandlerAdapterã€‚

RequestMappingHandlerAdapter#invokeHandlerMethod
è¿›å…¥å…·ä½“çš„å¤„ç†å™¨æ–¹æ³•æ‰§è¡Œæµç¨‹ã€‚

RequestResponseBodyMethodProcessor#resolveArgument
å¤„ç† @RequestBody å‚æ•°è§£æï¼Œéå†æ‰€æœ‰ HttpMessageConverterï¼Œæ‰¾åˆ°æ”¯æŒå½“å‰ Content-Type çš„è½¬æ¢å™¨ã€‚

AbstractMessageConverterMethodArgumentResolver#readWithMessageConverters
æ ¸å¿ƒæ–¹æ³•ï¼šéå†æ‰€æœ‰ HttpMessageConverterï¼Œæ£€æŸ¥æ˜¯å¦æ”¯æŒå½“å‰ Content-Typeã€‚

```java
for (HttpMessageConverter<?> converter : this.messageConverters) {
  if (converter.canRead(targetType, contentType)) {
    // ä½¿ç”¨è¯¥è½¬æ¢å™¨è¯»å–è¯·æ±‚ä½“
  }
}
```
2. å“åº”æ•°æ®ç±»å‹çš„åˆ¤æ–­ï¼ˆAcceptï¼‰

å½“æœåŠ¡ç«¯è¿”å›å“åº”æ—¶ï¼ŒAccept è¯·æ±‚å¤´å†³å®šäº†å®¢æˆ·ç«¯æœŸæœ›çš„å“åº”æ ¼å¼ï¼ˆå¦‚ text/html æˆ– application/jsonï¼‰ã€‚Spring MVC ä¼šæ ¹æ®è¯¥å¤´é€‰æ‹©å¯¹åº”çš„è½¬æ¢å™¨æˆ–è§†å›¾è§£æå™¨ã€‚

è°ƒè¯•ä½ç½®ï¼š

RequestMappingHandlerAdapter#invokeHandlerMethod
è¿›å…¥è¿”å›å€¼å¤„ç†æµç¨‹ã€‚

HandlerMethodReturnValueHandler#handleReturnValue
å¤„ç† @ResponseBody æˆ–è§†å›¾è§£æã€‚

ContentNegotiationManager#resolveMediaTypes
æ ¹æ® Accept å¤´è§£æå®¢æˆ·ç«¯æ”¯æŒçš„åª’ä½“ç±»å‹åˆ—è¡¨ï¼ˆå¦‚ [text/html, application/json]ï¼‰ã€‚

AbstractMessageConverterMethodProcessor#writeWithMessageConverters
æ ¸å¿ƒæ–¹æ³•ï¼šéå†æ‰€æœ‰ HttpMessageConverterï¼Œæ‰¾åˆ°æ”¯æŒ Accept å¤´çš„è½¬æ¢å™¨ã€‚

```java
for (HttpMessageConverter<?> converter : this.messageConverters) {
  if (converter.canWrite(targetType, selectedMediaType)) {
    // ä½¿ç”¨è¯¥è½¬æ¢å™¨å†™å…¥å“åº”
  }
}
```
3. å…³é”®ç±»å’Œæ–¹æ³•

HttpMessageConverter æ¥å£

æ‰€æœ‰è½¬æ¢å™¨çš„åŸºç±»ï¼Œå®ç°ç±»åŒ…æ‹¬ï¼š

MappingJackson2HttpMessageConverterï¼ˆå¤„ç† JSONï¼‰

StringHttpMessageConverterï¼ˆå¤„ç†æ–‡æœ¬ï¼‰

Jaxb2RootElementHttpMessageConverterï¼ˆå¤„ç† XMLï¼‰

è‡ªå®šä¹‰çš„ HTML è½¬æ¢å™¨ï¼ˆå¦‚ Thymeleaf æˆ– FreeMarker è§†å›¾è§£æå™¨ï¼‰ã€‚

ContentNegotiationManager(å†…å®¹åå•†)
è´Ÿè´£è§£æå®¢æˆ·ç«¯è¯·æ±‚çš„ Accept å¤´å’Œ Content-Typeã€‚

4. è°ƒè¯•æ­¥éª¤

è®¾ç½®æ–­ç‚¹ï¼š

è¯·æ±‚ä½“è§£æï¼šAbstractMessageConverterMethodArgumentResolver#readWithMessageConverters

å“åº”ä½“ç”Ÿæˆï¼šAbstractMessageConverterMethodProcessor#writeWithMessageConverters

å†…å®¹åå•†ï¼šContentNegotiationManager#resolveMediaTypes

å‘é€è¯·æ±‚ï¼š

è¯·æ±‚å¤´åŒ…å« Content-Type: application/jsonï¼šè§‚å¯Ÿ JSON è½¬æ¢å™¨ï¼ˆå¦‚ MappingJackson2HttpMessageConverterï¼‰è¢«è°ƒç”¨ã€‚

è¯·æ±‚å¤´åŒ…å« Accept: text/htmlï¼šè§‚å¯Ÿè§†å›¾è§£æå™¨ï¼ˆå¦‚ ThymeleafViewResolverï¼‰è¢«è°ƒç”¨ã€‚

è§‚å¯Ÿæµç¨‹ï¼š

æ£€æŸ¥ contentType å‚æ•°çš„å€¼ï¼ˆå¦‚ MediaType.APPLICATION_JSONï¼‰ã€‚

æ£€æŸ¥ messageConverters åˆ—è¡¨ï¼Œç¡®è®¤æ˜¯å¦åŒ…å«æ‰€éœ€çš„è½¬æ¢å™¨ã€‚

6. å¸¸è§é—®é¢˜

è½¬æ¢å™¨æœªæ³¨å†Œï¼šæ£€æŸ¥æ˜¯å¦å¼•å…¥äº†ç›¸å…³ä¾èµ–ï¼ˆå¦‚ Jackson æˆ– Thymeleafï¼‰ã€‚

Accept å¤´æœªç”Ÿæ•ˆï¼šç¡®ä¿æœªå¼ºåˆ¶æŒ‡å®š produces å±æ€§ï¼ˆå¦‚ @GetMapping(produces = "application/json")ï¼‰ã€‚

å†…å®¹åå•†ç­–ç•¥ï¼šé»˜è®¤åŸºäº Accept å¤´ï¼Œä½†å¯èƒ½é…ç½®ä¸ºè·¯å¾„åç¼€ï¼ˆå¦‚ /user.json æˆ– /user.htmlï¼‰ã€‚

### æ–‡ä»¶ä¸‹è½½ResponseEntity\<T\>

- åœ¨ SpringMVC ä¸­ï¼Œé€šè¿‡è¿”å› ResponseEntity\<T>çš„ç±»å‹ï¼Œå¯ä»¥å®ç°æ–‡ä»¶ä¸‹è½½çš„åŠŸèƒ½

```java
@RequestMapping("/downFile")
public ResponseEntity<byte[]> downFile(HttpSession session) throws Exception {
  // 1.å…ˆè·å–åˆ°inputStreamæµ
  InputStream in = session.getServletContext().getResourceAsStream("/img/a.jpeg");
  // 2.å¼€è¾Ÿä¸€ä¸ªå­˜æ”¾æ–‡ä»¶çš„byteæ•°ç»„, byteæ•°ç»„æ”¯æŒäºŒè¿›åˆ¶æ•°æ®
  byte[] bytes = new byte[in.available()];
  // 3.å°†åŠ è½½æ–‡ä»¶è¯»å…¥byte[]ä¸­
  in.read(bytes);
  // 4.åˆ›å»ºè¿”å›çš„çŠ¶æ€: HttpStatus
  HttpStatus status = HttpStatus.OK;
  // 5.åˆ›å»ºheards
  HttpHeaders headers = new HttpHeaders();
  // 6.æŒ‡å®šè¿”å›çš„æ•°æ®,å®¢æˆ·ç«¯åº”è¯¥ä»¥é™„ä»¶çš„å½¢å¼å¤„ç†(ä¸‹è½½æ–‡ä»¶)
  headers.add("Content-Disposition", "attachment;filename=2.jpeg");
  // 7.æ„å»ºResponseEntity
  ResponseEntity<byte[]> responseEntity = new ResponseEntity<>(bytes, headers, status);
  return responseEntity;
}

content-type æŒ‡ç¤ºå“åº”å†…å®¹çš„æ ¼å¼ 
content-disposition æŒ‡ç¤ºå¦‚ä½•å¤„ç†å“åº”å†…å®¹,inline:ç›´æ¥åœ¨é¡µé¢æ˜¾ç¤º
attchment:ä»¥é™„ä»¶å½¢å¼ä¸‹è½½
```



### æ–‡ä»¶ä¸Šä¼ MultipartResolver

1. Spring MVC ä¸ºæ–‡ä»¶ä¸Šä¼ æä¾›äº†ç›´æ¥çš„æ”¯æŒï¼Œè¿™ç§æ”¯æŒæ˜¯é€šè¿‡å³æ’å³ç”¨çš„ MultipartResolver å® ç° çš„ ã€‚ Spring ç”¨ Jakarta Commons FileUpload æŠ€ æœ¯ å® ç° äº† ä¸€ ä¸ª MultipartResolver å®ç°ç±»:CommonsMultipartResovler

2. Spring MVC ä¸Šä¸‹æ–‡ä¸­é»˜è®¤æ²¡æœ‰è£…é… MultipartResovlerï¼Œå› æ­¤é»˜è®¤æƒ…å†µä¸‹ä¸èƒ½å¤„ç†æ–‡ä»¶çš„ ä¸Šä¼ å·¥ä½œï¼Œå¦‚æœæƒ³ä½¿ç”¨ Spring çš„æ–‡ä»¶ä¸Šä¼ åŠŸèƒ½ï¼Œéœ€ç°åœ¨ä¸Šä¸‹æ–‡ä¸­é…ç½® MultipartResolver

- ä½¿ç”¨

	- å¼•å…¥ä¾èµ– 

		- commons-io:2.2
commons-fileupload:1.3.1

	- é…ç½®mvc.xmlä¸­MultipartResovle


```xml
<!--é…ç½®æ–‡ä»¶ä¸Šä¼ éœ€è¦çš„bean, idçš„åå­—å¿…é¡»æ˜¯ä¸‹é¢è¿™ä¸ª,å¦åˆ™ä¼šå¤±è´¥-->
  <bean id="multipartResolver" class="org.springframework.web.multipart.commons.CommonsMultipartResolver"/>
```



- ä¸Šä¼ 

  - å‰ç«¯


```html
<form action="fileUpload" method="post" enctype="multipart/form-data">
  æ–‡ä»¶ä»‹ç»:<input type="text" name="introduce"> <br>
  é€‰æ‹©æ–‡ä»¶:<input type="file" name="file"><br>
  <input type="submit" value="ä¸Šä¼ æ–‡ä»¶"/>
</form>
```

- åç«¯

  ```java
  @RequestMapping("/fileUpload")
  public String fileUpload(@RequestParam("file") MultipartFile multipartFile,
                           HttpServletRequest request,String introduce) throws IOException {
    // è¿˜å¯ä»¥å¯ä»¥æ¥æ”¶å…¶ä»–å‚æ•°
    System.out.println("æ–‡ä»¶ä»‹ç»introduce = " + introduce);
    // æ”¶åˆ°æäº¤çš„æ–‡ä»¶å
    String originalFilename = multipartFile.getOriginalFilename();
    System.out.println("æ–‡ä»¶å: " + originalFilename);
    // ä¿å­˜ä¸Šä¼ çš„æ–‡ä»¶, å…¨è·¯å¾„åŒ…æ‹¬æ–‡ä»¶åå­—
    String savePath = request.getServletContext().getRealPath("/img/" + originalFilename);
    File saveFile = new File(savePath);
    // è½¬å­˜åˆ°saveToFile
    multipartFile.transferTo(saveFile);
    return "success";
  }
  ```

  transferToæ–¹æ³•åŸç†: å¦‚æœæ–‡ä»¶å­˜åœ¨,åˆ™åˆ é™¤é‡å†™, è¿˜æ˜¯ä»tomcatçš„tempç›®å½•ä¸­å‰ªè´´åˆ°æˆ‘ä»¬ç›®æ ‡è·¯å¾„ä¸­

### æ‹¦æˆªå™¨

- å®šä¹‰


1. Spring MVC ä¹Ÿå¯ä»¥ä½¿ç”¨æ‹¦æˆªå™¨å¯¹è¯·æ±‚è¿›è¡Œæ‹¦æˆªå¤„ç†ï¼Œç”¨æˆ·å¯ä»¥è‡ªå®šä¹‰æ‹¦æˆªå™¨æ¥å®ç°ç‰¹å®š çš„åŠŸèƒ½.
2. è‡ªå®šä¹‰çš„æ‹¦æˆªå™¨å¿…é¡»å®ç° HandlerInterceptor æ¥å£

- è‡ªå®šä¹‰æ‹¦æˆªå™¨çš„ä¸‰ä¸ªæ–¹æ³•

	-  preHandle()

		- è¿™ä¸ªæ–¹æ³•åœ¨ä¸šåŠ¡å¤„ç†å™¨å¤„ç†è¯·æ±‚ä¹‹å‰è¢«è°ƒç”¨ï¼Œåœ¨è¯¥æ–¹æ³•ä¸­å¯¹ç”¨æˆ·è¯·æ±‚
request è¿›è¡Œå¤„ç†ã€‚

	- postHandle()

		- è¿™ä¸ªæ–¹æ³•åœ¨ç›®æ ‡æ–¹æ³•å¤„ç†å®Œè¯·æ±‚åæ‰§è¡Œ

	-  afterCompletion()

		- åœ¨DispatcherServletçš„render(ä¹Ÿå°±æ˜¯æ¸²æŸ“å®Œæˆ,å·²ç»è°ƒç”¨äº†è½¬å‘æ–¹æ³•å)æ‰§è¡Œå: è¿™ä¸ªæ–¹æ³•åœ¨å®Œå…¨å¤„ç†å®Œè¯·æ±‚åè¢«è°ƒç”¨ï¼Œå¯ä»¥åœ¨è¯¥æ–¹æ³•ä¸­è¿›è¡Œä¸€äº›èµ„æº æ¸…ç†çš„æ“ä½œã€‚

	- è‡ªå®šä¹‰æ‹¦æˆªå™¨æ‰§è¡Œæµç¨‹è¯´æ˜

1. å¦‚æœ preHandle æ–¹æ³• è¿”å› false, åˆ™ä¸å†æ‰§è¡Œç›®æ ‡æ–¹æ³•, å¯ä»¥åœ¨æ­¤æŒ‡å®šè¿”å›é¡µé¢

2. postHandle åœ¨ç›®æ ‡æ–¹æ³•è¢«æ‰§è¡Œåæ‰§è¡Œ. å¯ä»¥åœ¨æ–¹æ³•ä¸­è®¿é—®åˆ°ç›®æ ‡æ–¹æ³•è¿”å›çš„ ModelAndView å¯¹è±¡
3. è‹¥ preHandle è¿”å› true, åˆ™ afterCompletion æ–¹æ³• åœ¨æ¸²æŸ“è§†å›¾ä¹‹åè¢«æ‰§è¡Œ.
4. è‹¥ preHandle è¿”å› false, åˆ™ afterCompletion æ–¹æ³•ä¸ä¼šè¢«è°ƒç”¨
5. åœ¨é…ç½®æ‹¦æˆªå™¨æ—¶ï¼Œå¯ä»¥æŒ‡å®šè¯¥æ‹¦æˆªå™¨å¯¹å“ªäº›è¯·æ±‚ç”Ÿæ•ˆï¼Œå“ªäº›è¯·æ±‚ä¸ç”Ÿæ•ˆ

- å®ä¾‹

  - é…ç½®mvc.xml

```xml
<!--é…ç½®è‡ªå®šä¹‰æ‹¦æˆªå™¨-->
<!--é…ç½®æ–¹å¼1, æ‹¦æˆªæ‰€æœ‰è¯·æ±‚-->
<mvc:interceptors>
  <!--å¼•ç”¨@Componentæ³¨è§£æ‰«æçš„è‡ªå®šä¹‰æ‹¦æˆªå™¨bean-->
  <ref bean="myInterceptor01"/>
</mvc:interceptors>

<!--é…ç½®è‡ªå®šä¹‰æ‹¦æˆªå™¨-->
<!--é…ç½®æ–¹å¼2-->
<mvc:interceptors>
  <mvc:interceptor>
    <!--å¯¹æŒ‡å®šè·¯å¾„è¿›è¡Œæ‹¦æˆª-->
    <mvc:mapping path="/hi"/>
    <!--å¼•ç”¨@Componentæ³¨è§£æ‰«æçš„è‡ªå®šä¹‰æ‹¦æˆªå™¨bean-->
    <ref bean="myInterceptor01"/>
  </mvc:interceptor>
</mvc:interceptors>

<!--é…ç½®æ–¹å¼3-->
<mvc:interceptors>
  <mvc:interceptor>
    <!--å¯¹æŒ‡å®šè·¯å¾„è¿›è¡Œæ‹¦æˆª-ä½¿ç”¨é€šé…ç¬¦åŒ¹é…-->
    <mvc:mapping path="/h*"/> //æ‹¦æˆªæ‰€æœ‰hå¼€å¤´çš„
    <!--å¼•ç”¨@Componentæ³¨è§£æ‰«æçš„è‡ªå®šä¹‰æ‹¦æˆªå™¨bean-->
    <ref bean="myInterceptor01"/>
  </mvc:interceptor>
</mvc:interceptors>

<!--é…ç½®æ–¹å¼4-->
<mvc:interceptors>
  <mvc:interceptor>
    <!--å¯¹æŒ‡å®šè·¯å¾„è¿›è¡Œæ‹¦æˆª-ä½¿ç”¨é€šé…ç¬¦åŒ¹é…-->
    <mvc:mapping path="/h*"/>
    <!--æ’é™¤æŒ‡å®šè·¯å¾„-->
    <mvc:exclude-mapping path="/hi"/>
    <!--å¼•ç”¨@Componentæ³¨è§£æ‰«æçš„è‡ªå®šä¹‰æ‹¦æˆªå™¨bean-->
    <ref bean="myInterceptor01"/>
  </mvc:interceptor>
</mvc:interceptors>
```



- è‡ªå®šä¹‰æ‹¦æˆªå™¨ç±»

```java
// è¦æ³¨å…¥åˆ°springmvcå®¹å™¨ä¸­,è¿˜è¦åœ¨mvc.xmlä¸­é…ç½®æ‹¦æˆªå™¨
@Component
public class MyInterceptor01 implements HandlerInterceptor {
  @Override
  public boolean preHandle(HttpServletRequest request, HttpServletResponse response, Object handler) throws Exception {
    // è¿”å›false,ç›®æ ‡æ–¹æ³•å°†ä¸å†æ‰§è¡Œ, è¢«æ‹¦æˆªä½äº†
    // å¯ä»¥æ ¹æ®ä¸šåŠ¡è·³è½¬åˆ°æŒ‡å®šçš„é¡µé¢
    System.out.println("MyInterceptor01.preHandle");
    return true;
  }

  @Override
  public void postHandle(HttpServletRequest request, HttpServletResponse response, Object handler, ModelAndView modelAndView) throws Exception {
    // è¯¥æ–¹æ³•å¯ä»¥è·å–åˆ°ç›®æ ‡æ–¹æ³•çš„ModelAndView
    System.out.println("MyInterceptor01.postHandle");
  }

  @Override
  public void afterCompletion(HttpServletRequest request, HttpServletResponse response, Object handler, Exception ex) throws Exception {
    // åœ¨è§†å›¾æ¸²æŸ“ä¹‹åæ‰§è¡Œ,è¿™é‡Œå¯ä»¥è¿›è¡Œèµ„æºæ¸…ç†å·¥ä½œ
    System.out.println("MyInterceptor01.afterCompletion");
  }
}
```



- ç»†èŠ‚

  - 1ã€é»˜è®¤é…ç½®æ˜¯éƒ½æ‰€æœ‰çš„ç›®æ ‡æ–¹æ³•éƒ½è¿›è¡Œæ‹¦æˆª, ä¹Ÿå¯ä»¥æŒ‡å®šæ‹¦æˆªç›®æ ‡æ–¹æ³•, æ¯”å¦‚åªæ˜¯æ‹¦æˆª hi

  - 2ã€mvc:mapping æ”¯æŒé€šé…ç¬¦, åŒæ—¶æŒ‡å®šä¸å¯¹å“ªäº›ç›®æ ‡æ–¹æ³•è¿›è¡Œæ‹¦æˆª

  - 3ã€æ‹¦æˆªå™¨éœ€è¦é…ç½®æ‰ç”Ÿæ•ˆï¼Œä¸é…ç½®æ˜¯ä¸ç”Ÿæ•ˆçš„.

  - 4ã€å¦‚æœ preHandler() æ–¹æ³•è¿”å›äº† false, å°±ä¸ä¼šæ‰§è¡Œç›®æ ‡æ–¹æ³•(å‰ææ˜¯ä½ çš„ç›®æ ‡æ–¹æ³•è¢«æ‹¦æˆª äº†), å¯ä»¥åœ¨è¿™é‡Œæ ¹æ®ä¸šåŠ¡éœ€è¦æŒ‡å®šè·³è½¬é¡µé¢.
    - åº”ç”¨å®ä¾‹

```java
// æ ¹æ®urlæ‹¦æˆª/hi
if (request.getRequestURI().contains("hi")) {
  System.out.println("æ‹¦æˆªä½hiäº†");
  return false;
}
return true;

String keyword = request.getParameter("keyword");
if (keyword != null && keyword.contains("ç—…æ¯’")) {
  request.getRequestDispatcher("/WEB-INF/pages/warning.jsp").forward(request, response);
  return false;
}
```



- å¤šä¸ªæ‹¦æˆªå™¨

  - æ‰§è¡Œé¡ºåºæŒ‰ç…§é…ç½®é¡ºåºæ‰§è¡Œ

```xml
<mvc:interceptors>
  <mvc:interceptor>
    <!--å¯¹æŒ‡å®šè·¯å¾„è¿›è¡Œæ‹¦æˆª-ä½¿ç”¨é€šé…ç¬¦åŒ¹é…-->
    <mvc:mapping path="/*"/>
    <!--å¼•ç”¨@Componentæ³¨è§£æ‰«æçš„è‡ªå®šä¹‰æ‹¦æˆªå™¨bean-->
    <ref bean="myInterceptor01"/>
  </mvc:interceptor>
  <mvc:interceptor>
    /*åŒ¹é…æ‰€æœ‰è¯·æ±‚
    <mvc:mapping path="/*"/>
    <ref bean="myInterceptor02"/>
  </mvc:interceptor>
</mvc:interceptors>
```

æ‰§è¡Œé¡ºåº, myInterceptor01 > myInterceptor02

- æ³¨æ„äº‹é¡¹


1. å¦‚æœç¬¬ 1 ä¸ªæ‹¦æˆªå™¨çš„ preHandle() è¿”å› false , åé¢éƒ½ä¸åœ¨æ‰§è¡Œ

2. å¦‚æœç¬¬ 2 ä¸ªæ‹¦æˆªå™¨çš„ preHandle() è¿”å› false , å°±ç›´æ¥æ‰§è¡Œç¬¬ 1 ä¸ªæ‹¦æˆªå™¨çš„ afterCompletion()æ–¹æ³•, å¦‚æœæ‹¦æˆªå™¨æ›´å¤šï¼Œè§„åˆ™ç±»ä¼¼
3. è¯´æ˜: å‰é¢è¯´çš„è§„åˆ™ï¼Œéƒ½æ˜¯ç›®æ ‡æ–¹æ³•è¢«æ‹¦æˆªçš„å‰æ

### å¼‚å¸¸å¤„ç†

- å®šä¹‰


1. SpringMVCé€šè¿‡HandlerExceptionResolver å¤„ç†ç¨‹åºçš„å¼‚å¸¸ï¼ŒåŒ…æ‹¬Handleræ˜ å°„ã€æ•°æ® ç»‘å®šä»¥åŠç›®æ ‡æ–¹æ³•æ‰§è¡Œæ—¶å‘ç”Ÿçš„å¼‚å¸¸ã€‚

2. ä¸»è¦å¤„ç† Handler ä¸­ç”¨ @ExceptionHandler æ³¨è§£å®šä¹‰çš„æ–¹æ³•ã€‚

3. ExceptionHandlerMethodResolver å†… éƒ¨ è‹¥ æ‰¾ ä¸ åˆ° @ExceptionHandler æ³¨ è§£ çš„ è¯ ï¼Œ ä¼š æ‰¾
@ControllerAdvice ç±»çš„@ExceptionHandler æ³¨è§£æ–¹æ³•, è¿™æ ·å°±ç›¸å½“äºä¸€ä¸ªå…¨å±€å¼‚å¸¸å¤„ç†å™¨

- å±€éƒ¨å¼‚å¸¸

  - å±€éƒ¨å¼‚å¸¸å°±æ˜¯ç›´æ¥åœ¨è¿™ä¸ª Handlerç±»ä¸­ç¼–å†™æ–¹æ³•,å¸¦æœ‰ExceptionHandleræ³¨è§£


  ```java
  // å±€éƒ¨å¼‚å¸¸,å¤„ç†æœ¬ç±»å‘ç”Ÿçš„å¼‚å¸¸
  @ExceptionHandler({ArithmeticException.class, NullPointerException.class})
  public String localException(Exception e, HttpServletRequest request) {
    System.out.println("å¼‚å¸¸ä¿¡æ¯:" + e.getMessage());
    request.setAttribute("reason", e.getMessage());
    return "exception_msg";
  }
  ```

  

- å…¨å±€å¼‚å¸¸

  ```java
  // ExceptionHandlerMethodResolver å†…éƒ¨è‹¥æ‰¾ä¸åˆ° @ExceptionHandler æ³¨è§£çš„è¯ï¼Œä¼šæ‰¾ @ControllerAdvice ç±»çš„@ExceptionHandler æ³¨è§£æ–¹æ³•, è¿™æ ·å°±ç›¸å½“äºä¸€ä¸ªå…¨å±€å¼‚å¸¸å¤„ç†å™¨
  // è¯¥æ³¨è§£è¡¨ç¤ºä¸€ä¸ªå…¨å±€å¼‚å¸¸å¤„ç†ç±»
  @ControllerAdvice
  public class MyGlobalException {
  
    // å…¨å±€å¼‚å¸¸ä¸ç®¡é‚£ä¸ªhandleræŠ›å‡ºå¼‚å¸¸éƒ½å¯ä»¥æ•è·
    @ExceptionHandler({NumberFormatException.class, ClassNotFoundException.class})
    public String globalException(Exception e, HttpServletRequest request) {
      System.out.println("å…¨å±€å¼‚å¸¸æ•è·åˆ°äº†");
      request.setAttribute("reason",e.getMessage());
      return "exception_msg";
    }
  }
  ```

  

- è‡ªå®šä¹‰å¼‚å¸¸

	- é€šè¿‡@ResponseStatus æ³¨è§£, å¯ä»¥è‡ªå®šä¹‰å¼‚å¸¸çš„è¯´æ˜

	- @ResponseStatus(reason = "å¹´é¾„éœ€è¦åœ¨1-100ä¹‹é—´",value = HttpStatus.BAD_REQUEST)
public class AgeException extends RuntimeException{}

	- debug

		- org.springframework.web.method.annotation.ExceptionHandlerMethodResolver#resolveMethodByExceptionTypeè¿™é‡ŒæŸ¥çœ‹è·å–çš„å¼‚å¸¸å¤„ç†æ–¹æ³•

- ç»Ÿä¸€å¼‚å¸¸å¤„ç†

  å¦‚æœå¸Œæœ›å¯¹æ‰€æœ‰å¼‚å¸¸è¿›è¡Œç»Ÿä¸€å¤„ç†ï¼Œå¯ä»¥ä½¿ç”¨ SimpleMappingExceptionResolver

  å®ƒå°†å¼‚å¸¸ç±»åæ˜ å°„ä¸ºè§†å›¾åï¼Œå³å‘ç”Ÿå¼‚å¸¸æ—¶ä½¿ç”¨å¯¹åº”çš„è§†å›¾æŠ¥å‘Šå¼‚å¸¸

  éœ€è¦åœ¨ ioc å®¹å™¨ä¸­é…ç½®

  - ä½¿ç”¨

  ```xml
  <!--é…ç½®ç»Ÿä¸€å¤„ç†å¼‚å¸¸-->
  <bean class="org.springframework.web.servlet.handler.SimpleMappingExceptionResolver">
    <property name="exceptionMappings">
      <props>
        <!--ArrayIndexOutOfBoundsExceptionå¼‚å¸¸å¯¹åº”
        /WEB-INF/pages/arrException.jspé¡µé¢,å› ä¸ºé…ç½®äº†è§†å›¾è§£æå™¨
        -->
        <prop key="java.lang.ArrayIndexOutOfBoundsException">arrException</prop>
      </props>
    </property>
  </bean>
  ```

  - å¯¹æœªçŸ¥å¼‚å¸¸è¿›è¡Œç»Ÿä¸€å¤„ç†

    - ä¸Šé¢çš„æ·»åŠ è¿™ä¸€è¡Œ

  ```xml
  <prop key="java.lang.Exception">allException</prop>
  ```

  

- å¼‚å¸¸å¤„ç†çš„ä¼˜å…ˆçº§

	- å±€éƒ¨å¼‚å¸¸ > å…¨å±€å¼‚å¸¸ > SimpleMappingExceptionResolver > tomcaté»˜è®¤é¡µé¢ 

### æ€»ç»“æ‰§è¡Œæµç¨‹+debug

- å¤„ç†å™¨æ˜ å°„å™¨, æ‹¿åˆ°æ‰§è¡Œé“¾

	- å…¶ä¸­æœ‰ç›®æ ‡hanlder,æ‹¦æˆªå™¨é“¾(é›†åˆ)
è¿™æ ·æ˜¯ä¸ºäº†åœ¨handlerå‰åæ‰§è¡Œæ‹¦æˆªå™¨

	- é€šè¿‡handlerå»è·å–é€‚é…å™¨, è·å–åˆ°è¿”å›çš„æ¨¡å‹å’Œè§†å›¾

- è§£æè§†å›¾

	- å°±æ˜¯æ ¹æ®è§†å›¾åç§°, æ¥è·å–è½¬å‘çš„urlè·¯å¾„

- æ¸²æŸ“

	- å°±æ˜¯æŠŠmodelmapä¸­æ•°æ®æ”¾å…¥åˆ°requeståŸŸä¸­

## mybatis

æ–‡æ¡£å¾ˆå¥½,æ˜¯ä¸­æ–‡çš„

https://mybatis.org/mybatis-3/zh_CN/index.html

### å®šä¹‰

- ä¼ ç»Ÿæ–¹å¼çš„ç‰¹ç‚¹

	- 1.æ‰‹åŠ¨è·å–è¿æ¥, ä¸ä¸€å®šæ ‡å‡†,æ¯ä¸ªäººæœ‰ä¸åŒçš„å†™æ³•
2.sqlå†™åœ¨daoå±‚,ç¡¬ç¼–ç ,ä¸åˆ©äºè§£è€¦,åˆ†æ•£ä¸åˆ©äºç»Ÿä¸€ç®¡ç†
3.éOOPçš„æ–¹å¼æ“ä½œæ•°æ®åº“

- mybatis

	-  MyBatis æ˜¯ä¸€ä¸ªæŒä¹…å±‚æ¡†æ¶, æŒä¹…å±‚æ¡†æ¶è¿˜æœ‰hibernate

	-  å‰èº«æ˜¯ ibatis, åœ¨ ibatis3.x æ—¶ï¼Œæ›´åä¸º MyBatis

	- MyBatis åœ¨ java å’Œ sql ä¹‹é—´æä¾›æ›´çµæ´»çš„æ˜ å°„æ–¹æ¡ˆ

	- mybatis å¯ä»¥å°†å¯¹æ•°æ®è¡¨çš„æ“ä½œ(sql,æ–¹æ³•)ç­‰ç­‰ç›´æ¥å‰¥ç¦»ï¼Œå†™åˆ° xml é…ç½®æ–‡ä»¶ï¼Œå®ç°å’Œ java ä»£ç çš„è§£è€¦

	- MyBatiså¯ä»¥é…ç½®ç¼“å­˜

	- mybatisä¸èƒ½å»ºåº“,å»ºè¡¨çš„æ“ä½œè¿˜æ˜¯è‡ªå·±å®Œæˆ

### quickstart

- æµç¨‹

- å»ºè¡¨

```mysql
CREATE TABLE `monster` (
  `id` int NOT NULL AUTO_INCREMENT,
  `name` varchar(64) COLLATE utf8mb4_general_ci NOT NULL DEFAULT '',
  `skill` varchar(64) COLLATE utf8mb4_general_ci NOT NULL DEFAULT '',
  `age` tinyint unsigned NOT NULL,
  `birthday` datetime NOT NULL DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
  `email` varchar(64) COLLATE utf8mb4_general_ci NOT NULL DEFAULT '',
  `gender` tinyint NOT NULL COMMENT 'æ€§åˆ« 0å¥³, 1ç”·',
  `salary` decimal(12,2) NOT NULL,
  PRIMARY KEY (`id`)
) ENGINE=InnoDB AUTO_INCREMENT=329 DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_general_ci
```



- å¼•å…¥ä¾èµ–

	- mysql-connector-j:8.4.0
mybatis:3.5.7
junit-jupiter:5.9.3
lombok:1.8.28

- é…ç½®mybatis-config.xmlæ–‡ä»¶

  ```xml
  <?xml version="1.0" encoding="UTF-8" ?>
  <!DOCTYPE configuration
          PUBLIC "-//mybatis.org//DTD Config 3.0//EN"
          "https://mybatis.org/dtd/mybatis-3-config.dtd">
  <configuration>
    <environments default="development">
      <environment id="development">
        <transactionManager type="JDBC"/>
        <dataSource type="POOLED">
          <property name="driver" value="com.mysql.cj.jdbc.Driver"/>
          <property name="url" value="jdbc:mysql://localhost:3306/spring?useSSL=true&amp;useUnicode=true&amp;characterEncoding=utf8&amp;rewriteBatchedStatements=true"/>
          <property name="username" value="root"/>
          <property name="password" value="root"/>
        </dataSource>
      </environment>
    </environments>
    <mappers>
      <mapper resource="mapper/MonsterMapper.xml"/>
    </mappers>
  </configuration>
  ```


- åˆ›å»ºå®ä½“ç±»

```java
@Data
// å…ˆä¿æŒå±æ€§åå’Œè¡¨å­—æ®µåä¿æŒä¸€è‡´
public class Monster {
  private Integer id;
  private String name;
  private String skill;
  private Integer age;
  private Timestamp birthday;
  private String email;
  private Integer gender;
  private Double salary;
}
```




- MonsterMapperæ¥å£

```java
// mapperæ¥å£ç”¨æ¥å£°æ˜å®ä½“ç±»çš„curdæ–¹æ³•
// è¿™äº›æ–¹æ³•çš„å®ç°,å¯¹åº”äºxmlæ–‡ä»¶ä¸­sql
public interface MonsterMapper {
  int addMonster(Monster monster);
}
```




- åœ¨MonsterMapper.xmlå†™insert,sqlè¯­å¥
```xml
<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper
        PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "https://mybatis.org/dtd/mybatis-3-mapper.dtd">
<!--è¯¥å‘½åç©ºé—´å…³è”MonsterMapperæ¥å£-->
<mapper namespace="mapper.MonsterMapper">
    <!--æŒ‡å®šæ¥å£ä¸­å£°æ˜çš„æ–¹æ³•-->
    <insert id="addMonster" parameterType="entity.Monster">
        insert into spring.monster(name, skill, age, birthday, email, gender, salary)
        VALUES (#{name}, #{skill}, #{age}, #{birthday}, #{email}, #{gender}, #{salary})
    </insert>
</mapper>
```




- åœ¨mybatis-config.xmlä¸­æŒ‡å®šmapper.xmlçš„ä½ç½®

  ```xml
  <mapper resource="mapper/MonsterMapper.xml"/>
  ```

  

- ç¼–å†™è·å–mybatisçš„SqlSessionå·¥å…·ç±»

```java
public class MyBatisUtil {
  private static SqlSessionFactory sqlSessionFactory;
  static {
    try {
      // è·å–é…ç½®æ–‡ä»¶
      String resource = "mybatis-config.xml";
      // mybatisæä¾›çš„åŠ è½½æ–‡ä»¶å·¥å…·, é»˜è®¤åœ¨resourcesç›®å½•ä¸­è·å–,å®é™…åœ¨åº”è¿è¡Œåçš„ç±»è·¯å¾„
      InputStream in = Resources.getResourceAsStream(resource);
      // åˆå§‹åŒ–sqlSessionFactory
      sqlSessionFactory = new SqlSessionFactoryBuilder().build(in);
    } catch (IOException e) {
      throw new RuntimeException(e);
    }
  }
  // ç¼–å†™æ–¹æ³•è·å–SqlSession
  public static SqlSession getSqlSession() {
    return sqlSessionFactory.openSession();
  }
}
```




- æµ‹è¯•

```java
@Test
void addMonster() {
  // æ‹¿åˆ°sqlSession
  SqlSession sqlSession = MyBatisUtil.getSqlSession();
  // mybatisæ ¹æ®åŠ¨æ€ä»£ç†ç”ŸæˆMonsterMapperæ¥å£çš„å®ç°å¯¹è±¡
  MonsterMapper monsterMapper = sqlSession.getMapper(MonsterMapper.class);
  // jdk.proxy2.$Proxy8
  System.out.println(monsterMapper.getClass());
  Monster monster = new Monster(null, "èœ˜è››ç²¾Pro", "åä¸", 200, null, "spider@gmil.com", 0, 10000.00);
  monsterMapper.addMonster(monster);
  // æ³¨æ„è¦commit
  sqlSession.commit();
  // å…³é—­ä¼šè¯-->å°†è¿æ¥æ”¾å…¥åˆ°è¿æ¥æ± ä¸­,å¤ç”¨
  sqlSession.close();
}
```




- æ³¨æ„ç‚¹

  - è®©mavenæŠŠxmlæ–‡ä»¶ä¸­æ‰“åŒ…åˆ°è¿è¡Œç›®å½•ä¸‹

  ```xml
  <build>
    <resources>
      <resource>
        <directory>src/main/java</directory>
        <includes>
          <include>**/*.xml</include>
        </includes>
      </resource>
    </resources>
  </build>
  ```

  

- insetè¯­å¥è·å–è‡ªå¢é•¿çš„ä¸»é”®id

  ```xml
  <insert id="addMonster" parameterType="entity.Monster" useGeneratedKeys="true" keyProperty="id">
  ```

  

- åˆ é™¤

  - int delete(Integer id);


  ```xml
  <delete id="delete" parameterType="integer">
    delete from monster where id = #{id}
  </delete>
  ```

  

- ä¿®æ”¹

  - int update(Monster monster);


  ```xml
  <update id="update" parameterType="entity.Monster">
    update monster set age = #{age}, email = #{email}, salary=#{salary} where id= #{id}
  </update>
  ```

  

- æŸ¥è¯¢

  - List\<Monster\> selectList();

  ``` xml
  <select id="selectList" resultType="entity.Monster">
    select id, name, skill, age, birthday, email, gender, salary from monster
  </select>
  ```

-  resultType:æ³¨æ„ï¼Œå¦‚æœè¿”å›çš„æ˜¯é›†åˆï¼Œé‚£åº”è¯¥è®¾ç½®ä¸ºé›†åˆåŒ…å«çš„ç±»å‹ï¼Œè€Œä¸æ˜¯é›†åˆæœ¬èº«çš„ç±»å‹ã€‚ 

- é…ç½®å‡å, å†™ç±»åå°±ä¸ç”¨å†™å…¨åäº†

  - ç±»å‹åˆ«åå¯ä¸º Java ç±»å‹è®¾ç½®ä¸€ä¸ªç¼©å†™åå­—ã€‚ å®ƒä»…ç”¨äº XML é…ç½®ï¼Œæ„åœ¨é™ä½å†—ä½™çš„å…¨é™å®šç±»åä¹¦å†™

```xml
// æ³¨æ„é…ç½®é¡ºåº
<typeAliases>
  <typeAlias type="entity.Monster" alias="Monster"/>
</typeAliases>
```




- ideaæç¤º

  - æŒ‡å®šæ•°æ®åº“çš„æ–¹è¨€,SQL Dialects

  - é…ç½®æ’ä»¶ 

  	- MyBatisCodeHelperPro(ç›´æ¥ä¸Šä»˜è´¹ç‰ˆ)

### æŸ¥çœ‹mybatis sqlæ‰§è¡Œæ—¥å¿—

```xml
<settings>
  <setting name="logImpl" value="STDOUT_LOGGING"/>
</settings>
```



### mybatisåŸç†

- mybatisæ¡†æ¶ç¤ºæ„

	- configurationé…ç½®xml, æˆ–è€…æ³¨è§£

	- SqlSessionFactory, æ ¹æ®é…ç½®æ–‡ä»¶åˆ›å»ºå·¥å‚
ä½œç”¨: åˆ›å»ºSqlSession

	- SqlSession: ç›¸å½“äºä¸€ä¸ªconnection,
ä½œç”¨: æ“ä½œDBçš„CRUD

	- Executor(æ‰§è¡Œå™¨):æ˜¯ä¸€ä¸ªæ¥å£(åŸºæœ¬æ‰§è¡Œå™¨, ç¼“å­˜æ‰§è¡Œå™¨)
ä½œç”¨: SqlSessionå†…éƒ¨æ˜¯é€šè¿‡æ‰§è¡Œå™¨å®Œæˆæ•°æ®åº“çš„æ“ä½œ

	- mappend statement
ä½œç”¨: å¯¹æ•°æ®åº“çš„æ“ä½œè¿›è¡Œå°è£…(æ¯”å¦‚sqlè¯­å¥,è¾“å…¥å‚æ•°,è¾“å‡ºç»“æœ)

	- ç»™mapperæ¥å£ç”Ÿæˆä»£ç†å¯¹è±¡(æ ¸å¿ƒ)

		- ä¸æ˜¯å¢å¼ºæ–¹æ³•, è€Œæ˜¯å®ç°æ–¹æ³•

- è®¾è®¡

  - configurationè¯»å–é…ç½®æ–‡ä»¶
    ä¸»è¦å·¥ä½œå°±æ˜¯å°±å†™xmlæ–‡ä»¶, å°è£…å¯¹è±¡
    mybatis.xml è·å–connection
    mapper.xmlè·å–MapperBean

    - MapperBeançš„å±æ€§
    interfaceName; // æ¥å£å
     List\<Function\> functionList// mapperä¸­sqlæ–¹æ³•
    - ç»†åˆ†ä¸»é¢˜ 1
    	

    ```java
    // è®°å½•å¯¹åº”mapper.xmlçš„æ–¹æ³•ä¿¡æ¯
    public class Function {
      private String sqlType; // sql type, insert update delete select
      private String funcName; // æ–¹æ³•å
      private String sql; // sqlè¯­å¥
      private Object resultType;// è¿”å›ç±»å‹
      private String parameterType; // å‚æ•°ç±»å‹
    }
    ```

  - Executor

  	- æä¾›queryæŸ¥è¯¢æ–¹æ³•,åº•å±‚ä½¿ç”¨åŸç”ŸjdbcæŸ¥è¯¢

  - SqlSession

    - æŒæœ‰å±æ€§, Executorå’ŒConfiguration

    - å®ç°äº†getMapperæ–¹æ³•
      æ ¹æ®æ¥å£ç”ŸæˆåŠ¨æ€ä»£ç†
      - æ ¸å¿ƒæ–¹æ³•

  ```java
  @SuppressWarnings("unchecked")
  public <T> T getMapper0(Class<T> clazz) {
  // ä»xxxMapper.xmlæ–‡ä»¶ä¸­è¯»å–sqlè¯­å¥,å’Œç»‘å®šæ¥å£å’Œæ¥å£æ–¹æ³•ä¿¡æ¯
  MapperBean mapperBean = configuration.readMapper(clazz.getSimpleName() + ".xml");
  return (T) Proxy.newProxyInstance(clazz.getClassLoader(), new Class[]{clazz},
    (proxy, method, args) -> {
        // åªè°ƒç”¨mapperä¸­å£°æ˜çš„æ–¹æ³•,ç»§æ‰¿objectæ–¹æ³•ä¸ä»£ç†,æ¯”å¦‚toString
        if (method.getDeclaringClass().getName().equals(mapperBean.getInterfaceName())) {
            List<Function> functionList = mapperBean.getFunctionList();
            if (functionList != null && !functionList.isEmpty()) {
                for (Function function : functionList) {
                    // æ ¹æ®ä¸åŒçš„sqlç±»å‹æ¥è°ƒç”¨åº•å±‚jdbcæ–¹æ³•å»æ‰§è¡Œ,è¿™é‡Œç›¸å½“äºå®ç°äº†æ–¹æ³•
                    // è€Œä¸æ˜¯å¢å¼ºæ–¹æ³•
                    if ("select".equals(function.getSqlType())) {
                        return selectOne(function.getSql(), args[0]);
                    }
                }
            }
        } // ç»™toString()ä¸€ä¸ªè¿”å›å€¼
        return proxy.getClass().toString();
    });
  }
  ```

  

### MybatisåŸç”ŸAPI, è¿˜æ˜¯è¯»å–mapper.xml

- SqlSessionçš„åŸç”Ÿæ–¹æ³•

  - è¿è¡Œæ—¶ç±»å‹DefaultSqlSession

  - è¿˜æ˜¯è¯»å–çš„xxxMapper.xmlä¸­sqlè¯­å¥æ¥å®Œæˆcurdæ“ä½œçš„

  - CRUD

    - å¢åŠ 

  ```java
  Monster monster = new Monster(null, "ç™½é¾™é©¬", "éª‘è¡Œ", 100, Timestamp.valueOf("2002-1-1 12:00:00"), "dragonhourse@gmail.com", 1, 5000.0);
  int rows = sqlSession.insert("mapper.MonsterMapper.addMonster", monster);
  Assertions.assertTrue(rows > 0);
  ```

  - åˆ é™¤

  ```java
  int rows = sqlSession.delete("mapper.MonsterMapper.delete", 341);
  Assertions.assertTrue(rows > 0);
  ```

  - ä¿®æ”¹

  ```java
  Monster monster = new Monster(343, "ç™½é¾™é©¬", "å˜æˆé¾™é£èµ·æ¥", 100, Timestamp.valueOf("2002-1-1 12:00:00"), "dragonhourse@gmail.com", 1, 5000.0);
  int rows = sqlSession.update("mapper.MonsterMapper.update", monster);
  Assertions.assertTrue(rows > 0);
  ```

  - æŸ¥è¯¢

  ```java
  List<Monster> monsters = sqlSession.selectList("mapper.MonsterMapper.selectList");
  ```

  

### æ³¨è§£çš„æ–¹å¼

- Mapperæ¥å£

```java
// ä½¿ç”¨æ³¨è§£çš„æ–¹å¼æ¥é…ç½®æ¥å£æ–¹æ³•
public interface MonsterAnnotationMapper {
  @Insert("insert into spring.monster(name, skill, age, email, gender, salary) " +
          " VALUES (#{name}, #{skill}, #{age}, #{email}, #{gender}, #{salary}) ")
  int addMonster(Monster monster);

  @Delete("delete from monster where id = #{id}")
  int delete(Integer id);

  @Update("update monster set age = #{age}, email = #{email}, salary=#{salary} where id= #{id} ")
  int update(Monster monster);

  @Select("select id, name, skill, age, birthday, email, gender, salary from monster ")
  List<Monster> selectList();

  @Select("select id, name, skill, age, birthday, email, gender, salary from monster where id = #{id}")
  Monster selectById(Integer id);
} 
```



- ä½¿ç”¨æ³¨è§£æ–¹å¼,æ·»åŠ æ—¶, å¦‚æœè¦è¿”å›è‡ªå¢é•¿ id å€¼, å¯ä»¥ä½¿ç”¨@Option æ³¨è§£ , ç»„åˆä½¿ç”¨

```java
@Insert("insert into spring.monster(name, skill, age, email, gender, salary) " +
        " VALUES (#{name}, #{skill}, #{age}, #{email}, #{gender}, #{salary}) ")
// å¦‚æœå±æ€§å€¼å’Œè¡¨å­—æ®µåä¸€æ ·å¯ä»¥çœç•¥keyColumn
@Options(useGeneratedKeys = true, keyProperty = "id", keyColumn = "id")
int addMonster(Monster monster);
```



- mybatis-config.xmlé…ç½®æ³¨è§£æ¥å£

```xml
<mapper class="mapper.MonsterAnnotationMapper"/>
```

- æµ‹è¯•
- æ³¨è§£æ–¹å¼é…ç½®çš„æ¥å£è¿è¡Œç±»å‹è¿˜æ˜¯jdk.proxy2.$Proxy14ä»£ç†å¯¹è±¡

```java
// è·å–æ³¨è§£Mapperå¯¹è±¡
annoMapper = sqlSession.getMapper(MonsterAnnotationMapper.class);
```



### xmlé…ç½®æ–‡ä»¶

- å±æ€§ï¼ˆpropertiesï¼‰

  - è¿™äº›å±æ€§å¯ä»¥åœ¨å¤–éƒ¨è¿›è¡Œé…ç½®ï¼Œå¹¶å¯ä»¥è¿›è¡ŒåŠ¨æ€æ›¿æ¢

  ```java
  <properties resource="jdbc.properties"/>
  ```

  

- é…ç½®å±æ€§,å°±å¯ä»¥å¼•ç”¨é…ç½®æ–‡ä»¶jdbc.propertiesä¸­å±æ€§äº†

```xml
<dataSource type="POOLED">
<property name="driver" value="${jdbc.driver}"/>
<property name="url" value="${jdbc.url}"/>
<property name="username" value="${jdbc.user}"/>
<property name="password" value="${jdbc.password}"/>
</dataSource>
```



- settings

  - æ—¥å¿—

  ```xml
  <setting name="logImpl" value="STDOUT_LOGGING"/>
  ```

  - ç¼“å­˜

- typeAliases

  - åˆ«å

    - é€ä¸ªå¼•ç”¨

    ```xml
    <typeAlias type="entity.Monster" alias="Monster"/>
    ```

    - æ•´ä¸ªåŒ…ä¸‹æ‰€æœ‰ç±»çš„ç”¨åˆ«å

    ```xml
    <package name="entity"/>
    ```

- typeHandlers

	- MyBatis åœ¨è®¾ç½®é¢„å¤„ç†è¯­å¥ï¼ˆPreparedStatementï¼‰ä¸­çš„å‚æ•°æˆ–ä»ç»“æœé›†ä¸­å–å‡ºä¸€ä¸ªå€¼æ—¶ï¼Œ éƒ½ä¼šç”¨ç±»å‹å¤„ç†å™¨å°†è·å–åˆ°çš„å€¼ä»¥åˆé€‚çš„æ–¹å¼è½¬æ¢æˆ Java ç±»å‹

- mappers

  - æˆ‘ä»¬éœ€è¦å‘Šè¯‰ MyBatis åˆ°å“ªé‡Œå»æ‰¾åˆ°è¿™äº›SQLè¯­å¥


  ```xml
  - <!-- å°†åŒ…å†…çš„æ˜ å°„å™¨æ¥å£å…¨éƒ¨æ³¨å†Œä¸ºæ˜ å°„å™¨ -->
  <mappers>
    <package name="org.mybatis.builder"/>
  </mappers>
  
  - <!-- ä½¿ç”¨ç›¸å¯¹äºç±»è·¯å¾„çš„èµ„æºå¼•ç”¨ -->
  <mappers>
    <mapper resource="org/mybatis/builder/AuthorMapper.xml"/>
  </mappers>
  
  - <!-- ä½¿ç”¨æ˜ å°„å™¨æ¥å£å®ç°ç±»çš„å®Œå…¨é™å®šç±»å,æ³¨è§£æ–¹å¼ä½¿ç”¨è¿™ä¸ª -->
  <mappers>
    <mapper class="org.mybatis.builder.AuthorMapper"/>
  </mappers>
  ```

  

### XML æ˜ å°„å™¨(Mapper.xmlæ–‡ä»¶)

- é¡¶çº§å…ƒç´ 

  - cache

  	- è¯¥å‘½åç©ºé—´çš„ç¼“å­˜é…ç½®

  - cache-ref 

  	- å¼•ç”¨å…¶å®ƒå‘½åç©ºé—´çš„ç¼“å­˜é…ç½®ã€‚

  - resultMap

    -  æè¿°å¦‚ä½•ä»æ•°æ®åº“ç»“æœé›†ä¸­åŠ è½½å¯¹è±¡ï¼Œæ˜¯æœ€å¤æ‚ä¹Ÿæ˜¯æœ€å¼ºå¤§çš„å…ƒç´ 

    -  å½“å¯¹è±¡å±æ€§å’Œè¡¨çš„å­—æ®µæ²¡æœ‰åŒ¹é…,å°±éœ€è¦ä½¿ç”¨ç»“æœé›†æ˜ å°„,ä¹Ÿå¯ä»¥ä½¿ç”¨åˆ«å,ä½†æ˜¯å¤ç”¨æ€§ä½

  ```xml
  <resultMap id="userResultMap" type="User">
    <id property="user_id" column="user_id"/>
    <result property="username" column="user_name"/>
    <result property="usereamil" column="user_email"/>
  </resultMap>
  
  <select id="findAllUser" resultMap="userResultMap" >
      select * from user
  </select>
  ```

  

å¦‚æœæ˜¯ MyBatis-Pluså¤„ç†å°±æ¯”è¾ƒç®€å•å¯ä»¥ä½¿ç”¨@TableFieldæ¥è§£å†³

å®ä½“å­—æ®µåå’Œè¡¨å­—æ®µåä¸ä¸€è‡´çš„é—®é¢˜ï¼Œè¿˜å¯ä»¥ä½¿ç”¨@TableName æ¥è§£å†³å®ä½“ç±»åå’Œè¡¨åä¸ä¸€è‡´çš„é—®é¢˜

	- sql
	
		- å¯è¢«å…¶å®ƒè¯­å¥å¼•ç”¨çš„å¯é‡ç”¨è¯­å¥å—
	
	- insert
	
	- delete
	
	- update
	
	- select

- éé¡¶çº§å…ƒç´ 

  - parameterType
    å‚æ•°ç±»å‹

    - 1. ä¼ å…¥ç®€å•ç±»å‹ï¼Œæ¯”å¦‚æŒ‰ç…§ id æŸ¥ Monster

      - ä¸€ä¸ªæŸ¥è¯¢æ¡ä»¶

    ```xml
    <select id="findByName" resultType="entity.Monster" parameterType="string">
      select * from monster where name like concat('%',#{name},'%')
    </select>
    ```

    

    - 2. ä¼ å…¥ POJO ç±»å‹ï¼ŒæŸ¥è¯¢æ—¶éœ€è¦æœ‰å¤šä¸ªç­›é€‰æ¡ä»¶


  ```xml
  <select id="selectByNameOrId" resultType="Monster" parameterType="Monster">
    select * from monster where (id = #{id}) or (name like concat('%',#{name},'%'))
  </select>
  ```

  

3.ä¼ å…¥mapç±»å‹

```java
// mapè®¾ç½®k-vè¦åŒ¹é…
map.put("id", 320);
map.put("salary", 400);
```

```xml
<select id="findByIdAndSalaryMap" resultType="entity.Monster" parameterType="map">
  select * from monster where id > #{id} and salary > #{salary}
</select>
```

 resultType

è¿”å›mapç±»å‹


```java
List<Map<String,Object>> findByIdAndSalaryMapAndReturnMap(Map map);
```
```xml
<select id="findByIdAndSalaryMapAndReturnMap" resultType="java.util.Map" parameterType="map">
  select * from monster where id > #{id} and salary > #{salary}
</select>
```




### åŠ¨æ€SQL

- å®šä¹‰

	- ä½¿ç”¨ JDBC æˆ–å…¶å®ƒç±»ä¼¼çš„æ¡†æ¶ï¼Œæ ¹æ®ä¸åŒæ¡ä»¶æ‹¼æ¥ SQL è¯­å¥éå¸¸éº»çƒ¦ï¼Œ
ä¾‹å¦‚æ‹¼æ¥æ—¶è¦ç¡®ä¿ä¸èƒ½å¿˜è®°æ·»åŠ å¿…è¦çš„ç©ºæ ¼ï¼Œè¿˜è¦æ³¨æ„å»æ‰åˆ—è¡¨æœ€åä¸€ä¸ªåˆ—åçš„é€—å·ç­‰, è€ŒåŠ¨æ€sqlå¯ä»¥è§£å†³è¿™ä¸ªé—®é¢˜

- åŠ¨æ€sqlæ ‡ç­¾

  - æ³¨æ„@Param("age")æ³¨è§£ç”¨æ¥è§£å†³æ¥å£å½¢å‚åä¸sqlä¸­#{age} æˆ–test="age>0"ä¸ä¸€è‡´çš„é—®é¢˜

    ```java
    List<Monster> selectByAge(@Param("age") Integer age123x);
    ```

    

  - 1. if [åˆ¤æ–­]

    - è¯·æŸ¥è¯¢ age å¤§äº 0 çš„ï¼Œ age ä¸å¤§äº 0, åˆ™è¾“å‡ºæ‰€æœ‰

    ```xml
    select * from monster where 1 = 1
    <if test="age >= 0">
      and age > #{age}
    </if>
    ```

    

  - 2. where [æ‹¼æ¥ where å­å¥]

    - whereåº•å±‚ä¼šè‡ªåŠ¨å»æ‰å¤šä½™çš„andè¯­å¥,è¦é…åˆifæ ‡ç­¾ä½¿ç”¨

    - å¦‚æœæ²¡æœ‰ä¸€ä¸ªæ¡ä»¶æ»¡è¶³, åˆ™whereä¹Ÿä¼šè¢«å»æ‰

    - æŸ¥è¯¢ id å¤§äº 20 çš„ï¼Œå¹¶ä¸”åå­—æ˜¯ "èœ˜è››ç²¾Pro" çš„æ‰€æœ‰å¦–æ€ª, æ³¨æ„ï¼Œå¦‚æœåå­—ä¸ºç©ºï¼Œ
      æˆ–è€…è¾“å…¥çš„ id å°äº 0, åˆ™ä¸æ‹¼æ¥ sql è¯­å¥

    ```xml
    select * from monster
    <where>
      <if test="id != null and id >= 0">
        and id > #{id}
      </if>
      <if test="name != null and name != ''">
        and name like concat('%',#{name},'%')
      </if>
    </where>
    ```

  - 3. choose/when/otherwise [ç±»ä¼¼ java çš„ switch è¯­å¥, æ³¨æ„æ˜¯å•åˆ†æ”¯]

    - æœ‰æ—¶å€™ï¼Œæˆ‘ä»¬ä¸æƒ³ä½¿ç”¨æ‰€æœ‰çš„æ¡ä»¶ï¼Œè€Œåªæ˜¯æƒ³ä»å¤šä¸ªæ¡ä»¶ä¸­é€‰æ‹©ä¸€ä¸ªä½¿ç”¨

    - å¦‚æœç»™çš„ name ä¸ä¸ºç©ºï¼Œå°±æŒ‰åå­—æŸ¥è¯¢å¦–æ€ªï¼Œå¦‚æœæŒ‡å®šçš„ id>0ï¼Œå°±æŒ‰ id æ¥æŸ¥è¯¢å¦–
      æ€ªï¼Œ è¦æ±‚ä½¿ç”¨ choose/when/otherwise æ ‡ç­¾å®ç°, ä¼ å…¥å‚æ•°è¦æ±‚ä½¿ç”¨ Map

    ```xml
    select * from monster
    <choose>
      <when test="name !=null and name != ''">
        where name like concat('%',#{name},'%')
      </when>
      <when test="id != null">
        where id =  #{id}
      </when>
      <otherwise>
        where salary > 100
      </otherwise>
    </choose>
    ```

    

  - 4. foreach [ç±»ä¼¼ in ], æ‰¹é‡æ’å…¥ç”¨çš„åˆ°

    - é›†åˆè¦åˆ¤æ–­ç©º, in (ç©ºçš„)mysqlæŠ¥é”™

    - å¦‚æœids.size()æŠ¥é”™, æ·»åŠ vmå‚æ•°
    --add-opens java.base/java.util=ALL-UNNAMED --add-opens java.base/java.lang.reflect=ALL-UNNAMED --add-opens java.base/java.text=ALL-UNNAMED

    - æŸ¥è¯¢å¤šä¸ªid

      ```xml
      <select id="selectByIds" parameterType="list" resultType="Monster">
        select * from monster
        <if test="ids != null and ids.size() != 0">
          <where>
            id in
            <foreach collection="ids" item="id" open="(" close=")" separator=",">
              #{id}
            </foreach>
          </where>
        </if>
      </select>
      ```

      

  - 5. trim [æ›¿æ¢å…³é”®å­—/å®šåˆ¶å…ƒç´ çš„åŠŸèƒ½]

    - trim å¯ä»¥æ›¿æ¢ä¸€äº›å…³é”®å­—.è¦æ±‚:æŒ‰åå­—æŸ¥è¯¢å¦–æ€ªï¼Œå¦‚æœ sql è¯­å¥æœ‰ and | or |zangxinå°±æ›¿æ¢æˆwhere
    åªèƒ½æ›¿æ¢ä¸€ä¸ª, æ¯”å¦‚: zangxin zangxin name like concat('%',#{name}, '%')æ›¿æ¢æˆangxin name like concat('%',#{name}, '%'), è¿˜æ˜¯ä¼šæŠ¥è¯­æ³•é”™è¯¯

    ```xml
    <select id="selectByNameTrim" parameterType="map" resultType="Monster">
      select * from monster
      <trim prefix="where" prefixOverrides="and|or|zangxin">
        <if test="name != null and name != ''">
          zangxin name like concat('%',#{name}, '%')
        </if>
        <if test="age != null">
          and age > #{age}
        </if>
      </trim>
    </select>
    ```

    

  - 6. set set å…ƒç´ ä¼šåŠ¨æ€åœ°åœ¨è¡Œé¦–æ’å…¥ SET å…³é”®å­—ï¼Œå¹¶ä¼šåˆ æ‰é¢å¤–çš„é€—å·,setè‡³å°‘æœ‰ä¸€ä¸ªå­—æ®µæ»¡è¶³æ¡ä»¶,å¦åˆ™å°±ä¼š:  update monster where id = ? é”™è¯¯

  ```xml
  <update id="updateBySet" parameterType="Monster">
    update monster
    <set>
      <if test="name != null and name != ''">
        name = #{name},
      </if>
      <if test="age !=null ">
        age = #{age},
      </if>
      <if test="email != null and email != ''">
        email = #{email},
      </if>
      <if test="salary != null">
        salary = #{salary},
      </if>
      <if test="skill != null and skill != ''">
        skill = #{skill}
      </if>
    </set>
    where id = #{id}
  </update>
  ```

  

###  resultMapç»“æœé›†æ˜ å°„

- ä¸€å¯¹ä¸€(ç›¸å½“äºåˆ†è¡¨)äººå’Œèº«ä»½è¯çš„å…³ç³»æè¿°

  - çº§è”æŸ¥è¯¢

    - æ–¹å¼ä¸€:å¤šè¡¨è”æŸ¥

  ```xml
  <resultMap id="PersonIdCardResultMap" type="Person">
    <!-- idæ ‡ç­¾çš„ç»“æœå¯ä»¥å¸®åŠ©æé«˜æ•´ä½“æ€§èƒ½, é€šå¸¸æŒ‡å®šä¸»é”®-->
    <id property="id" column="id"/>
    <result property="name" column="name"/>
    <!--çº§è”å±æ€§:Personå¯¹è±¡çš„IdCardå±æ€§ä¹Ÿæ˜¯ä¸€ä¸ªå¯¹è±¡-->
    <association property="idCard" javaType="IdCard">
      <result property="id" column="card_id"/>
      <result property="card_sn" column="card_sn"/>
    </association>
  </resultMap>
  ```

  ```xml
  <select id="getPersonById" parameterType="integer" resultMap="PersonIdCardResultMap">
    <!--     è·å–Personå¯¹è±¡å…³è”å±æ€§IdCardå¯¹è±¡å±æ€§,å¤šè¡¨æŸ¥è¯¢-->
    select p.id, p.card_id, p.NAME, id.id, id.card_sn
    from Person p inner join idcard id on id.id = p.card_id
    where p.id = #{id}
  </select>
  ```

  æ–¹å¼äºŒ:ä¸¤æ¬¡å•è¡¨æŸ¥è¯¢


```xml
<!--æ ¸å¿ƒæ€æƒ³:å°†å¤šè¡¨æŸ¥è¯¢,åˆ†è§£æˆå•è¡¨æ“ä½œ, æ˜“äºç»´æŠ¤, è¿˜èƒ½å¤ç”¨å†™çš„å•è¡¨æŸ¥è¯¢sql-->
<resultMap id="PersonIdCardResultMap2" type="Person">
  <id property="id" column="id"/>
  <result property="name" column="NAME"/>
  <!--card_idæ˜¯ç¬¬ä¸€æ¬¡å•è¡¨æŸ¥è¯¢è·å–çš„ç»“æœé›†,å†æ¬¡ä½œä¸ºç¬¬äºŒæ¬¡æŸ¥è¯¢çš„å…¥å‚-->
  <association property="idCard" column="card_id" select="resultmap_.mapper.IdCardMapper.getById"/>
</resultMap>
<!--çº§è”æ–¹å¼äºŒ-->
<select id="getPersonById2" parameterType="integer" resultMap="PersonIdCardResultMap2">
  select * from person where id = #{id}
</select>
```


æ³¨è§£æ–¹å¼çº§è”

ä¸¤æ¬¡å•è¡¨

 idCardMapper:


```java
@Select("select * from idcard where id = #{id}")
IdCard getById(Integer id);
```
PersonMapper:

```java
@Select("select * from person where id = #{id}")
@Results({
  @Result(id = true,property = "id",column = "id"),
  @Result(property = "name",column = "name"),
  @Result(property = "idCard", column = "card_id",
          one = @One(select ="resultmap_.mapper.IdCardAnnotationMapper.getById"))
})
Person getPersonById(Integer id);
```
- ä¸€å¯¹å¤š

  - åŒå‘çš„ä¸€å¯¹å¤š

    - æ¯”å¦‚é€šè¿‡ User å¯ä»¥æŸ¥è¯¢åˆ°å¯¹åº”çš„ Pet, åè¿‡ æ¥ï¼Œé€šè¿‡ Pet ä¹Ÿå¯ä»¥çº§è”æŸ¥è¯¢åˆ°å¯¹åº”çš„ User ä¿¡æ¯.

    - ä¸€ä¸ªç”¨æˆ·å¯ä»¥å…»å¤šä¸ªå® ç‰©

      ```java
      @Data
      public class User {
        private Integer user_id;
        private String username;
        // ä¸€ä¸ªuserå¯ä»¥å…»å¤šä¸ªå® ç‰©
        private List<Pet> petList;
      }
      
      @Data
      public class Pet {
        private Integer id;
        private String nickname;
        private Integer userId;
        private User user;
      }
      ```

      

    - ç”¨æˆ·æŸ¥è¯¢å® ç‰©2æ¬¡å•è¡¨æ“ä½œçš„æŸ¥è¯¢

      - UserMappper

      ```xml
      <resultMap id="UserResultMap" type="User">
        <id property="user_id" column="user_id"/>
        <result property="username" column="user_name"/>
        <!--propertyå¯¹åº”Userçš„listå­—æ®µ,
      columnè¡¨ç¤ºç”¨ç»“æœé›†çš„idå­—æ®µä½œä¸ºç¬¬äºŒæ¬¡æŸ¥è¡¨sqlçš„å…¥å‚
      ofTypeè¡¨ç¤ºé›†åˆå…ƒç´ çš„ç±»å‹
      collectionè¡¨ç¤ºè¿™ä¸ªå±æ€§æ˜¯ä¸€ä¸ªé›†åˆ-->
        <collection property="petList" column="user_id" ofType="Pet"
                    select="resultmap_one2multi.mapper.PetMapper.getByUserId"/>
      </resultMap>
      ```

      ```xml
      <select id="getById" resultMap="UserResultMap" parameterType="integer">
        select * from user where user_id = #{id}
      </select>
      ```

      

PetMapper


```xml
<select id="getByUserId" parameterType="integer" resultType="Pet">
  select id, nickname, user_id as userId from pet where user_id = #{id}
</select>
```


ä»å® ç‰©æŸ¥è¯¢ä¸»äºº,å® ç‰©å¯¹è±¡æŒæœ‰ç”¨æˆ·å¯¹åƒ

æ³¨æ„toString()æ–¹æ³•å¯¼è‡´æ— é™é€’å½’è°ƒç”¨

```xml
<resultMap id="PetResultMap" type="Pet">
  <id column="id" property="id"/>
  <result property="nickname" column="nickname"/>
  <result property="userId" column="userId"/>
  <association property="user" javaType="User" column="userId"
               select="resultmap_one2multi.mapper.UserMapper.getById"/>
</resultMap>
```
```xml
<select id="getByUserId" parameterType="integer" resultMap="PetResultMap">
  select id, nickname, user_id as userId from pet where user_id = #{id}
</select>
```



æ³¨è§£æ–¹å¼


```java
// PetMapper
@Select("select id, nickname, user_id as userId from pet where user_id = #{userId}")
List<Pet> getByUserId2(Integer userId);
```


```java
// UserMapper
@Select("select user_id, user_name from user where user_id = #{id}")
@Results({
        @Result(id = true,property = "user_id",column = "user_id"),
        @Result(property = "username",column = "user_name"),
        @Result(property = "petList", column = "user_id",
                many = @Many(select = "resultmap_one2multi.mapper.PetMapper.getByUserId2"))
})
User getById2(Integer id);
```
æ³¨æ„,@Resultsæ³¨è§£å¯ä»¥æŒ‡å®šid, ç”¨æ¥å¤ç”¨

### ç¼“å­˜

- ä¸€çº§ç¼“å­˜/æœ¬åœ°ç¼“å­˜(local cache)

  - é»˜è®¤æƒ…å†µä¸‹ï¼Œåªå¯ç”¨äº†æœ¬åœ°çš„ä¼šè¯ç¼“å­˜ï¼Œå®ƒä»…ä»…å¯¹ä¸€ä¸ªä¼šè¯ä¸­çš„æ•°æ®è¿›è¡Œç¼“å­˜, ä¼šè¯å…³é—­,å°±ä¼šæ¶ˆå¤±

  - åŒä¸€ä¸ªSqlSessionå¯¹è±¡è°ƒç”¨äº†ç›¸åŒselectè¯­å¥,ä¼šç›´æ¥ä»ç¼“å­˜ä¸­è·å–, è€Œä¸æ˜¯å†å»æŸ¥è¯¢æ•°æ®åº“

  - å¼€å¯æ—¥å¿—æŸ¥çœ‹, å› ä¸ºé»˜è®¤å¼€å¯ä¸€çº§ç¼“å­˜, æ‰€ä»¥å†æ¬¡æŸ¥è¯¢monsterMapper.getById(3)æ—¶,ä¸ä¼šå†æ¬¡sqlè¯·æ±‚,è€Œæ˜¯ä»ç¼“å­˜ä¸­è·å–

  - debug

  	- 1.sqlSessionæŒæœ‰executor, excutoræŒæœ‰,localCacheå¯¹è±¡(é‡Œé¢ä¸€ä¸ªhashmap),æ¯æ¬¡æŸ¥è¯¢å‰å…ˆå»ä»ç¼“å­˜ä¸­è·å–, å¦‚æœç¼“å­˜ä¸­æ²¡æœ‰çš„è¯å°±å»æŸ¥æ•°æ®åº“:æ–¹æ³•queryFromDatabase
  2.æŸ¥ä¹‹å‰æŠŠå…ˆæ”¾å…¥ä¸€ä¸ªç©ºå¯¹è±¡åˆ°localCacheä¸­,
  æŸ¥è¯¢åˆ°ç»“æœå, å…ˆæ‰§è¡Œfinallyæ“ä½œæ¸…é™¤keyå¯¹åº”çš„ç¼“å­˜, ç„¶ååœ¨æŠŠæŸ¥è¯¢çš„ç»“æœæ”¾å…¥localCaheä¸­,
  æ³¨æ„: ä¸ç®¡æœ‰æ²¡æœ‰æŸ¥è¯¢åˆ°ç»“æœ, éƒ½ä¼šæ¸…é™¤ç¼“å­˜

  - ä¸€çº§ç¼“å­˜å¤±æ•ˆé—®é¢˜åŸå› 

    - å…³é—­äº†sqlSession

    ```java
    // æŸ¥è¯¢å‰é‡å¯ä¼šè¯
    sqlSession.close();
    Monster monster3 = MyBatisUtil.getSqlSession().getMapper(MonsterMapper.class).getById(300);
    ```

    - æ‰§è¡Œäº† sqlSession.clearCache(),
      åº•å±‚æ˜¯è°ƒç”¨hashmapçš„clear()æ–¹æ³•

    ```java
    // æŸ¥è¯¢å‰æ¸…é™¤ç¼“å­˜
    sqlSession.clearCache();
    Monster monster3 = monsterMapper.getById(300);
    ```

    - æ‰§è¡Œäº†ä¿®æ”¹æ“ä½œ

    	- excutoråœ¨æ‰§è¡Œupdateæ–¹æ³•æ—¶ä¼šè°ƒç”¨clearLocalCacheæ–¹æ³•æ¸…ç©ºmap

- äºŒçº§ç¼“å­˜/å…¨å±€ç¼“å­˜/Cache

  - å®šä¹‰

  	- äºŒçº§ç¼“å­˜çš„ä½œç”¨åŸŸæ˜¯å…¨å±€èŒƒå›´, é’ˆå¯¹ä¸åŒçš„ä¼šè¯éƒ½æœ‰æ•ˆ, æŸ¥è¯¢æ—¶å…ˆæŸ¥äºŒçº§ç¼“å­˜, å¦‚æœæ²¡æœ‰æŸ¥ä¸€çº§ç¼“å­˜,å¦‚æœæ²¡æœ‰å†æŸ¥è¯¢æ•°æ®åº“

  - å¼€å¯äºŒçº§ç¼“å­˜

    - é»˜è®¤æ˜¯å¼€å¯äº†,å¯ä»¥ä¸ç”¨å†™, ä¸ºfalseæ˜¯å…³é—­äºŒçº§ç¼“å­˜

      ```xml
      <setting name="cacheEnabled" value="true"/>
      ```

    - åœ¨mapper.xmlä¸­é…ç½®cacheæ ‡ç­¾

      å«ä¹‰: åˆ›å»ºäº† FIFO çš„ç­–ç•¥ï¼Œæ¯éš” 30 ç§’åˆ·æ–°ä¸€æ¬¡ï¼Œæœ€å¤šå­˜æ”¾ 360 ä¸ªå¯¹è±¡è€Œä¸”è¿”å›çš„å¯¹è±¡è¢«è®¤ä¸ºæ˜¯åªè¯»çš„ã€‚

      ```xml
      <!--é…ç½®äºŒçº§ç¼“å­˜-->
      <cache eviction="FIFO" flushInterval="60000" size="512" readOnly="true"/>
      ```

      

    - äºŒçº§ç¼“å­˜çš„å‚æ•°

      - evictionç¼“å­˜çš„å›æ”¶ç­–ç•¥

      	-  LRU â€“ æœ€è¿‘æœ€å°‘ä½¿ç”¨çš„:ç§»é™¤æœ€é•¿æ—¶é—´ä¸è¢«ä½¿ç”¨çš„å¯¹è±¡ï¼Œå®ƒæ˜¯é»˜è®¤

      	-  FIFO â€“ å…ˆè¿›å…ˆå‡º:æŒ‰å¯¹è±¡è¿›å…¥ç¼“å­˜çš„é¡ºåºæ¥ç§»é™¤å®ƒä»¬

      	- SOFT â€“ è½¯å¼•ç”¨:ç§»é™¤åŸºäºåƒåœ¾å›æ”¶å™¨çŠ¶æ€å’Œè½¯å¼•ç”¨è§„åˆ™çš„å¯¹è±¡ã€‚

      	-  WEAK â€“ å¼±å¼•ç”¨:æ›´ç§¯æåœ°ç§»é™¤åŸºäºåƒåœ¾æ”¶é›†å™¨çŠ¶æ€å’Œå¼±å¼•ç”¨è§„åˆ™çš„å¯¹è±¡

      - flushInterval:æ—¶é—´é—´éš”ï¼Œå•ä½æ˜¯æ¯«ç§’ï¼Œ

      - size: å¼•ç”¨æ•°ç›®ï¼Œå†…å­˜å¤§å°±å¤šé…ç½®ç‚¹ï¼Œè¦è®°ä½ä½ ç¼“å­˜çš„å¯¹è±¡æ•°ç›®å’Œä½ è¿è¡Œç¯å¢ƒçš„å¯ç”¨å†…å­˜ èµ„æºæ•°ç›®ã€‚é»˜è®¤å€¼æ˜¯ 1024

      - readOnly: true,åªè¯»,å¯ä»¥æé«˜æ•ˆç‡

  - å…³é—­äºŒçº§ç¼“å­˜

    - å…¨å±€å…³é—­,ç›¸å½“äºæ€»å¼€å…³

      ```xml
      <setting name="cacheEnabled" value="false"/>
      ```

      

    - å•ä¸ªmapper.xmlå…³é—­

    	- åœ¨mapper.xmlä¸­ä¸å»é…ç½®\<cache/>æ ‡ç­¾

    - å•ä¸ªæ–¹æ³•å…³é—­äºŒçº§ç¼“å­˜


    ```xml
    <select id="getById" resultType="Monster" useCache="false">,è¿™ä¸ªé»˜è®¤æ˜¯true,å³ä½¿ç”¨äºŒçº§ç¼“å­˜
    ```

    

  -  mybatis åˆ·æ–°äºŒçº§ç¼“å­˜çš„è®¾ç½®

    ```xml
    <select id="getById" resultType="Monster" flushCache="true">
    ```

    - insertã€updateã€delete æ“ä½œæ•°æ®åéœ€è¦åˆ·æ–°ç¼“å­˜ï¼Œå¦‚æœä¸æ‰§è¡Œåˆ·æ–°ç¼“å­˜ä¼šå‡ºç°è„è¯»

    - é»˜è®¤ä¸º trueï¼Œé»˜è®¤æƒ…å†µä¸‹ä¸º true å³åˆ·æ–°ç¼“å­˜ï¼Œä¸€èˆ¬ä¸ç”¨ä¿®æ”¹ã€‚

  - äºŒçº§ç¼“å­˜å¤±æ•ˆ

  	- æ‰§è¡Œæ›´æ–°æ“ä½œæ—¶ä¼šæ‰§è¡Œtcm(TransactionalCacheManager)çš„clear(cache)æ–¹æ³•,æ¸…ç©ºhashmap

  - debug

  	- å¦‚æœå¼€å¯äº†äºŒçº§ç¼“å­˜, åœ¨è°ƒç”¨CachingExecutoræ—¶, Cachedå¯¹è±¡å°±ä¸ä¼šä¸ºnull, ç¬¬ä¸€æ¬¡å»æ•°æ®åº“ä¸­æŸ¥, ç„¶åæŠŠç»“æœæ”¾å…¥åˆ°äºŒçº§ç¼“å­˜ä¸­, ä»¥åå†æ¬¡æŸ¥è¯¢çš„æ—¶å€™, é¦–å…ˆèµ°äºŒçº§ç¼“å­˜

- ç¼“å­˜æ‰§è¡Œé¡ºåº

	- äºŒçº§ç¼“å­˜-->ä¸€çº§ç¼“å­˜-->æ•°æ®åº“

	- sqlSessionæ‰§è¡Œcloseæ–¹æ³•æ—¶ä¼šæŠŠä¸€çº§ç¼“å­˜æ”¾å…¥äºŒçº§ç¼“å­˜

	- ä¸ä¼šå‡ºç°ä¸€çº§ç¼“å­˜å’ŒäºŒçº§ç¼“å­˜ä¸­æœ‰åŒä¸€ä¸ªæ•°æ®ã€‚
å› ä¸ºäºŒçº§ç¼“å­˜(æ•°æ®)æ˜¯åœ¨ä¸€çº§ç¼“å­˜å…³é—­ä¹‹åæ‰æœ‰çš„

- EhCache,ç¬¬ä¸‰æ–¹ç¼“å­˜,
  æ›¿ä»£mybatisè‡ªå¸¦çš„äºŒçº§ç¼“å­˜

  - ä½¿ç”¨

    - å¼•å…¥ä¾èµ–

    ```xml
    <!--ehcacheç›¸å…³ä¾èµ–-->
    <dependency>
      <groupId>net.sf.ehcache</groupId>
      <artifactId>ehcache-core</artifactId>
      <version>2.6.11</version>
    </dependency>
    <dependency>
      <groupId>org.slf4j</groupId>
      <artifactId>slf4j-api</artifactId>
      <version>1.7.25</version>
    </dependency>
    <!--mybatisæ•´åˆehcache-->
    <dependency>
      <groupId>org.mybatis.caches</groupId>
      <artifactId>mybatis-ehcache</artifactId>
      <version>1.2.1</version>
    </dependency>
    ```

    -  mybatis-config.xml ä»ç„¶æ‰“å¼€äºŒçº§ç¼“å­˜

      ```xml
      <setting name="cacheEnabled" value="true"/>
      ```

    - ehcache.xmlé…ç½®æ–‡ä»¶

    - åœ¨mapper.xmlä¸­å¯åŠ¨ehcache

    ```xml
    <!-- å¯åŠ¨ ehcache ç¼“å­˜ -->
    <cache type="org.mybatis.caches.ehcache.EhcacheCache"/>
    ```

    

  - mybatisç¼“å­˜å’Œehcacheç¼“å­˜çš„å…³ç³»

  	-  MyBatis æä¾›äº†ä¸€ä¸ªæ¥å£ Cache org.apache.ibatis.cache.Cache 

  	- åªè¦å®ç°äº†è¯¥ Cache æ¥å£ï¼Œå°±å¯ä»¥ä½œä¸ºäºŒçº§ç¼“å­˜äº§å“å’Œ MyBatis æ•´åˆä½¿ç”¨,Ehcache å°± æ˜¯å®ç°äº†è¯¥æ¥å£

  	- MyBatis é»˜è®¤æƒ…å†µ(å³ä¸€çº§ç¼“å­˜)æ˜¯ä½¿ç”¨çš„ PerpetualCache ç±»å®ç° Cache æ¥å£çš„,æ˜¯æ ¸å¿ƒç±»

### mybatsié€†å‘å·¥ç¨‹

- ä»‹ç»,mybatis-generatorèƒ½å¸®æˆ‘ä»¬ç”Ÿæˆmapper.xmlçš„curdçš„sql,mapperæ¥å£, Furnå®ä½“ç±»

- æ–‡æ¡£https://mybatis.org/generator/quickstart.html

- ä½¿ç”¨æ­¥éª¤

  - å»ºè¡¨

  - å¼•å…¥mybatis-generatorä¾èµ–

  ```xml
  <!--mybatis generator-->
  <dependency>
    <groupId>org.mybatis.generator</groupId>
    <artifactId>mybatis-generator-core</artifactId>
    <version>1.4.0</version>
  </dependency>
  ```

  - é…ç½®
    mybatis-generator.xml

  ```xml
  <?xml version="1.0" encoding="UTF-8"?> <!DOCTYPE generatorConfiguration
  PUBLIC "-//mybatis.org//DTD MyBatis Generator Configuration 1.0//EN"
  "http://mybatis.org/dtd/mybatis-generator-config_1_0.dtd">
  <generatorConfiguration>
    <context id="DB2Tables" targetRuntime="MyBatis3">
      <!-- ç”Ÿæˆæ²¡æœ‰æ³¨é‡Šçš„ bean-->
      <commentGenerator>
        <property name="suppressAllComments" value="true"/>
      </commentGenerator>
      <!-- é…ç½®æ•°æ®åº“è¿æ¥ä¿¡æ¯-->
      <jdbcConnection driverClass="com.mysql.cj.jdbc.Driver"
                      connectionURL="jdbc:mysql://localhost:3306/furn_ssm?characterEncoding=utf8"
                      userId="root"
                      password="root">
      </jdbcConnection>
      <javaTypeResolver>
        <property name="forceBigDecimals" value="false"/>
      </javaTypeResolver>
      <!-- æŒ‡å®š javaBean ç”Ÿæˆçš„ä½ç½®-->
      <javaModelGenerator targetPackage="org.xxx.furn.bean"
                          targetProject="ä½¿ç”¨ç»å¯¹è·¯å¾„/furn_ssm/src/main/java">
        <property name="enableSubPackages" value="true"/>
        <property name="trimStrings" value="true"/>
      </javaModelGenerator>
      <!-- æŒ‡å®š sql æ˜ å°„æ–‡ä»¶ç”Ÿæˆçš„ä½ç½®-->
      <sqlMapGenerator targetPackage="mapper" targetProject="ä½¿ç”¨ç»å¯¹è·¯å¾„/furn_ssm/src/main/resources">
        <property name="enableSubPackages" value="true"/>
      </sqlMapGenerator>
      <!-- æŒ‡å®š dao æ¥å£ç”Ÿæˆçš„ä½ç½®, ä¹Ÿå°±æ˜¯ mapper æ¥å£-->
      <javaClientGenerator type="XMLMAPPER" targetPackage="org.xxx.furn.dao"
                           targetProject="ä½¿ç”¨ç»å¯¹è·¯å¾„/furn_ssm/src/main/java">
        <property name="enableSubPackages" value="true"/>
      </javaClientGenerator>
      <!-- æŒ‡å®šè¦é€†å‘ç”Ÿæˆçš„è¡¨å’Œç”Ÿæˆç­–ç•¥-->
  
      <table tableName="furn" domainObjectName="Furn"></table>
  
    </context>
  </generatorConfiguration>
  ```

  

  - javaä»£ç ç”Ÿæˆ

    ```java
    @Test
    void test01() throws Exception {
      List<String> warnings = new ArrayList<String>();
      boolean overwrite = true;
      // æŒ‡å®šé…ç½®æ–‡ä»¶
      InputStream in = this.getClass().getResourceAsStream("mybatis-generator.xml");
      ConfigurationParser cp = new ConfigurationParser(warnings);
      Configuration config = cp.parseConfiguration(in);
      DefaultShellCallback callback = new DefaultShellCallback(overwrite);
      MyBatisGenerator myBatisGenerator = new MyBatisGenerator(config, callback, warnings);
      myBatisGenerator.generate(null);
      System.out.println(warnings);
      System.out.println("é€†å‘ç”Ÿæˆ OK");
    }
    ```

    

  - æ³¨æ„äº‹é¡¹

  	- åœ¨é…ç½®æ–‡ä»¶ä¸­,é…ç½®æ•°æ®æº,é…ç½®è¡¨å,å®ä½“ç±»å

  	- ç”Ÿæˆçš„åŒ…å,é¡¹ç›®è·¯å¾„ç­‰,ç›´æ¥é…ç½®æˆç»å¯¹è·¯å¾„,å…å¾—äº§ç”Ÿä¸å¿…è¦çš„éº»çƒ¦

  - ç”Ÿæˆçš„å¸¸ç”¨çš„æ–¹æ³•

  	- Selective

  		- å¤šä¸ªæ¡ä»¶,åŠ¨æ€sqlæ‹¼æ¥

  	- PrimaryKey

  		- æ ¹æ®ä¸»é”®

  	- FurnExample

  		- åº”è¯¥æ˜¯ä¸ç”¨sqlå†™æ¡ä»¶ğŸ˜…
  ç”¨oopæ–¹å¼å†™sql

### mybatisåˆ†é¡µæ’ä»¶

- æœ‰ä¸­æ–‡æ–‡æ¡£, åœ¨githubä¸Š

- å¼•å…¥ä¾èµ–

  ```xml
  <!--mybatisåˆ†é¡µæ’ä»¶-->
  <dependency>
    <groupId>com.github.pagehelper</groupId>
    <artifactId>pagehelper</artifactId>
    <version> 5.3.2</version>
  </dependency>
  ```

  

- é…ç½®æ’ä»¶

  - mybatis-config.xml

  ```xml
  <!--åˆ†é¡µæ’ä»¶-->
  <plugins>
    <plugin interceptor="com.github.pagehelper.PageInterceptor">
      <!--æ–¹è¨€è®¾ç½®ä¸ºmysql-->
      <property name="helperDialect" value="mysql"/>
      <!--å¯¹æŸ¥è¯¢å‚æ•°è¿›è¡Œåˆç†åŒ–-->
      <property name="reasonable" value="true"/>
    </plugin>
  </plugins>
  ```

- å¼€å§‹åˆ†é¡µ

  - æ–¹å¼ä¸€

    - service

    ```java
    @Override
    public Page<Furn> getPageByName(Integer pageNum, Integer pageSize, String name) {
      // å¼€å¯åˆ†é¡µ
      PageHelper.startPage(pageNum, pageSize);
      FurnExample furnExample = new FurnExample();
      furnExample.createCriteria().andNameLike("%" + name + "%");
      // public class Page<E> extends ArrayList<E> implements Closeable, ç»§æ‰¿List,æ‰€ä»¥å¯ä»¥è½¬æ¢
      // å®é™…ä¸Š furnList.getClass() = class com.github.pagehelper.Page
      Page<Furn> furnList = (Page<Furn>)furnMapper.selectByExample(furnExample);
      return furnList;
    }
    ```

    

    - controller

    ```java
    @GetMapping("/getPageByName")
    private Result getPageByName(
      @RequestParam(value = "pageNum", defaultValue = "1") Integer pageNum,
      @RequestParam(value = "pageSize", defaultValue = "3") Integer pageSize,
      String name) {
      LOGGER.info("getPageByNameå…¥å‚: {},{},{}", pageNum, pageSize, name);
      Result result = new Result();
      Page<Furn> page = furnService.getPageByName(pageNum, pageSize, name);
      List<Furn> furnList = page.getResult();
      int pages = page.getPages();
      long totalRows = page.getTotal();
      result.put("furnList", furnList);
      result.put("totalPages", pages);
      result.put("totalRows", totalRows);
      result.put("pageNum", pageNum);
      result.put("pageSize", pageSize);
      result.ok();
      return result;
    }
    ```

    

  - æ–¹å¼äºŒ

    - service

    ```java
    @Override
    public PageInfo<Furn> getPageByName2(Integer pageNum, Integer pageSize, String name) {
      // å¼€å¯åˆ†é¡µ
      PageHelper.startPage(pageNum, pageSize);
      FurnExample furnExample = new FurnExample();
      furnExample.createCriteria().andNameLike("%" + name + "%");
      List<Furn> furnList = furnMapper.selectByExample(furnExample);
      PageInfo<Furn> pageInfo = new PageInfo<>(furnList, pageSize);
      return pageInfo;
    }
    ```

    

    - controller

    ```java
    @GetMapping("/getPageByName2")
    public Result getPageByName2(
      @RequestParam(value = "pageNum", defaultValue = "1") Integer pageNum,
      @RequestParam(value = "pageSize", defaultValue = "3") Integer pageSize,
      @RequestParam(value = "name", defaultValue = "") String name) {
      LOGGER.info("getPageByName2å…¥å‚: {},{},{}", pageNum, pageSize, name);
      Result result = new Result();
      PageInfo<Furn> page = furnService.getPageByName2(pageNum, pageSize, name);
      result.ok("page", page);
      return result;
    }
    ```

    

### MybatisPlus

## SSM+Vueå‰åç«¯åˆ†ç¦»é¡¹ç›®

### åç«¯

- æ­å»ºç¯å¢ƒ

	- æ­å»ºåç«¯webå·¥ç¨‹ç¯å¢ƒ

		- å¼•å…¥ç›¸å…³mavenä¾èµ–

			- spring,springmvc, mybatis

			- jsonè§£æ

			- å•å…ƒæµ‹è¯•, lombok

			- mysqlæ•°æ®åº“,æ•°æ®åº“è¿æ¥æ± 

			- æ—¥å¿—

			- mybatisåˆ†é¡µæ’ä»¶

			- mavenæ‰“waråŒ…æ’ä»¶

	- web.xml

		- é…ç½®å¯åŠ¨springå®¹å™¨

		- é…ç½®ContextLoaderListenerç›‘å¬å™¨

		- é…ç½®å‰ç«¯æ§åˆ¶å™¨, æŒ‡å®šspringmvc.xmlé…ç½®æ–‡ä»¶

		- æŒ‡å®šå­—ç¬¦é›†è¿‡æ»¤å™¨

		- æŒ‡å®šéšè—æ–¹æ³•è¿‡æ»¤å™¨, RESTé£æ ¼ç¼–ç¨‹éœ€è¦

	- mvc.xml

		- springmvcæ‰«æControlleråŒ…, é…ç½®é»˜è®¤è§†å›¾è§£æå™¨, é…ç½®æ³¨è§£é©±åŠ¨, é…ç½®é»˜è®¤Servletå¤„ç†å™¨

	- spring.xml

		- æ‰«åŒ…: dao,service

		- æ•°æ®æº

		- mybatisçš„sqlSessionFactory

		- mybatisæ‰«ædaoæ¥å£

		- äº‹åŠ¡ç®¡ç†å™¨

		- äº‹åŠ¡æ–¹æ³•åˆ‡é¢

	- mybatis.xml

		- å¼€å¯æ—¥å¿—

		- ç»™å®ä½“ç±»é…ç½®åˆ«å

		- åˆ†é¡µæ’ä»¶

- å»ºè¡¨

- ä½¿ç”¨ MyBatis Generator é€†å‘å·¥ç¨‹ç”Ÿæˆ bean mapper æ¥å£å’Œ mapper.xml

- å†™controller å¢åˆ æ”¹æŸ¥æ–¹æ³•

- åˆ†é¡µæ’ä»¶

  ```java
  PageHelper.startPage(pageNum, pageSize);
  FurnExample furnExample = new FurnExample();
  furnExample.createCriteria().andNameLike("%" + name + "%");
  List<Furn> furnList = furnMapper.selectByExample(furnExample);
  System.out.println("furnList.getClass() = " + furnList.getClass());
  // å®é™…ä¸Šæ˜¯ä¸€ä¸ªfurnList.getClass() = class com.github.pagehelper.Page å¯¹è±¡
  PageInfo<Furn> pageInfo = new PageInfo<>(furnList, pageSize);
  ```

  

- åç«¯è¡¨å•æ•°æ®æ ¡éªŒ

  - åç«¯æ•°æ®æ ¡éªŒçš„å¿…è¦æ€§

  	- äººå®¶ç»•è¿‡å‰ç«¯,ç”¨postman/httpClientä¹‹ç±»çš„å·¥å…·ç›´æ¥è¯·æ±‚

  - å¼•å…¥JSR303æ•°æ®æ ¡éªŒ, å¼•å…¥ï¼Œå¼•å…¥ hibernate-validator.jar 

  ```xml
  <dependency> 
    <groupId>org.hibernate</groupId> 
    <artifactId>hibernate-validator</artifactId> 
    <version>6.1.0.Final</version>
  </dependency>
  ```

  

  - ä½¿ç”¨

    - å®ä½“ç±»æ·»åŠ æ³¨è§£æ ¡éªŒè§„åˆ™å’Œé”™è¯¯æ¶ˆæ¯

  ```java
  @Data
  public class Furn {
    private Integer id;
    @NotEmpty(message = "å•†å“åä¸èƒ½ä¸ºç©º")
    private String name;
    @NotEmpty(message = "ä¾›åº”å•†åä¸èƒ½ä¸ºç©º")
    private String maker;
  
    @Range(min = 0,max = 9999999, message = "èŒƒå›´ä¸º0-9999999")
    @NotNull(message = "è¯·è¾“å…¥æ•°å­—")
    private BigDecimal price;
  
    @NotNull(message = "è¯·è¾“å…¥æ•°å­—")
    @Range(min = 0,max = 9999999,message = "èŒƒå›´ä¸º0-9999999")
    private Integer sales;
    @NotNull(message = "è¯·è¾“å…¥æ•°å­—")
    @Range(min = 0,max = 9999999,message = "èŒƒå›´ä¸º0-9999999")
    private Integer stock;
    @NotEmpty
    private String imgPath = "assets/images/product-image/1.jpeg";
  }
  ```

  

  - controlleræ ¡éªŒ

    - æ ¹æ®é”™è¯¯å†³å®šè¿”å›å€¼

  ```java
  @PostMapping
  public Result save(@Valid @RequestBody Furn furn, Errors errors) {
    Result result = new Result();
    // æ ¡éªŒ
    Map<String, Object> map = new HashMap<>();
    if (errors.hasFieldErrors()) {
      List<FieldError> fieldErrors = errors.getFieldErrors();
      for (FieldError fieldError : fieldErrors) {
        map.put(fieldError.getField(), fieldError.getDefaultMessage());
      }
    }
    // è¯´æ˜æ ¡éªŒé€šè¿‡
    if (map.isEmpty()) {
      boolean save = furnService.save(furn);
      if (save) {
        result.ok();
      } else {
        result.fail("æ·»åŠ å¤±è´¥");
      }
    } else {
      // æ ¡éªŒå¤±è´¥æ—¶æŠŠé”™è¯¯ä¿¡æ¯å°è£…åˆ°resultä¸­
      result.fail();
      result.put("errorMsg", map);
    }
    return result;
  }
  ```

  

### å‰ç«¯

- æ­å»ºå‰ç«¯vue3å·¥ç¨‹, ä½¿ç”¨vue-cli

- ä½¿ç”¨elementPlusæ­å»ºä¸€ä¸ªå¢åˆ æ”¹æŸ¥é¡µé¢

- è§£å†³è·¨åŸŸé—®é¢˜

	- å‰ç«¯é…ç½®ä»£ç†

- ä¿®æ”¹/æ–°å¢/åˆ é™¤å, éœ€è¦è°ƒç”¨listæ–¹æ³•åˆ·æ–°é¡µé¢

- å¼‚æ­¥çš„å‘

  - ä¿®æ”¹åå­˜åœ¨çš„é—®é¢˜é¡µé¢ä¸åˆ·æ–°

    - æŠŠlistå†™åœ¨thenä¸­, è€Œä¸è¦å†™åœ¨å’Œaxios.get/postæ–¹æ³•åŒä¸€çº§åˆ«ä¸Š

  ```javascript
  if (this.delId && this.delId > 0) {
    request.delete('/api/furn?id=' + this.delId).then(res => {
      if (res.data.code == 1) {
        // å¿…é¡»å†™åœ¨thenåé¢, å¦åˆ™å¼‚æ­¥ä¼šå¯¼è‡´é¡µé¢ä¸åˆ·æ–°
        // åˆ·æ–°æ•°æ®
        this.getPageByName(this.pageNum)
        console.log("åˆ é™¤:", res.data)
        this.$message({
          type: "success",
          message: 'åˆ é™¤æˆåŠŸ',
        })
      }
    });
  ```

  

  - æ ¡éªŒè§„åˆ™å¤±æ•ˆ

  	- æŠŠè¿™ä¸ªthis.formData = {}å†™åœ¨æ ¡éªŒçš„åŒçº§åˆ«ä¸Š, 

  		- å¯¼è‡´æ ¡éªŒå¤±æ•ˆ, å› ä¸ºæ¸…ç©ºäº†æ•°æ®
  åº”è¯¥å…ˆæ ¡éªŒå®Œ, æäº¤æ•°æ®åå†æ¸…ç©º

- å‰ç«¯axiosé…ç½®è¯·æ±‚æ‹¦æˆªå™¨, å“åº”æ‹¦æˆªå™¨

- å‰ç«¯åˆ†é¡µ

	- elemet-åˆ†é¡µæ§ä»¶

- å‰ç«¯æ•°æ®æ ¡éªŒ

	- æœ‰äº›å¤æ‚, å†™æ ¡éªŒè§„åˆ™, æ”¹å®Œåæ¸…ç©ºæ•°æ®, æ ¡éªŒæˆåŠŸå æäº¤

### æ€»ç»“

- ä½¿ç”¨çš„æŠ€æœ¯

	- å‰ç«¯vue3+elementPlus
Axiosè¯·æ±‚æ•°æ®

	- åç«¯SSM
mybatisGenerator, mybatis pageHelper

å¢™ä¸ŠèŠ¦è‹‡ï¼Œå¤´é‡è„šè½»æ ¹åº•æµ…ï¼Œ

å±±é—´ç«¹ç¬‹ï¼Œå˜´å°–çš®åšè…¹ä¸­ç©ºã€‚

## æ—¥å¿—

### logback

- ä¾èµ–

  ```xml
  <dependency>
    <groupId>ch.qos.logback</groupId>
    <artifactId>logback-classic</artifactId>
    <version>1.2.10</version>
  </dependency>
  ```

  

- ä½¿ç”¨åŸºäºslf4jç”¨æ³•ï¼Œè·å–å¹¶ä½¿ç”¨Logger

  ```java
  public class Sample {
    private static final Logger LOGGER = LoggerFactory.getLogger(Sample.class);
    public static void main(String[] args){
      LOGGER.info("A Message From LOGGERï¼š{}", "Hello World");
    }
  }
  ```

  

- é…ç½®æ–‡ä»¶(logback.xml)

```xml
<configuration>
  <!-- æ§åˆ¶å°è¾“å‡º -->
  <appender name="CONSOLE" class="ch.qos.logback.core.ConsoleAppender">
    <encoder>
      <pattern>%d{HH:mm:ss.SSS} [%thread] %-5level %logger{36} - %msg%n</pattern>
    </encoder>
  </appender>

  <!-- è®¾ç½®Spring MVCç›¸å…³åŒ…çš„æ—¥å¿—çº§åˆ« -->
  <logger name="org.springframework" level="INFO" />
  <!-- å¦‚æœæ›´ç²¾ç¡®ï¼Œå¯ä»¥æŒ‡å®šå­åŒ… -->
  <logger name="org.springframework.web" level="INFO" />

  <!-- æ ¹æ—¥å¿—çº§åˆ« -->
  <root level="INFO">
    <appender-ref ref="CONSOLE" />
  </root>
</configuration>
```



