---
layout:     post
title:      "微服务项目练习1"
subtitle:   ""
date:       2025-03-26 08:48:27
author:     "zangxin"
header-img: "img/post-bg-2015.jpg"
catalog: true
tags:
---

# 微服务项目练习

通用性产品发布解决方案

java springcloud微服务项目练习笔记

这是一个什么项目?

类似商城: 有后台后台界面和前台界面, 可以上架商品, 分类商品, sku,spu等等

## 设计



## 环境

```sh
docker compose -f jiaju_mall_v2_docker_compose.yaml up -d
```

使用docker环境, docker compose-file

```yaml
name: jiaju_mall_v2
services:
  mysql:
    container_name: mysql
    image: mysql
    ports:
      - "3306:3306"
    environment:
      - MYSQL_ROOT_PASSWORD=root
    volumes:
      - /Users/qingsongcai/devtools/docker_mount/jiaju_mall_v2/mysql-data:/var/lib/mysql
      - /Users/qingsongcai/devtools/docker_mount/jiaju_mall_v2/myconf:/etc/mysql/conf.d
    restart: always
    networks: 
      - jiaju_mall_v2_net

networks:
  jiaju_mall_v2_net:

```

前端也使用快速脚手架renren-fast-vue

**使用renren-fast 脚手架*** https://gitee.com/renrenio/renren-fast

把配置文件中数据库改成自己的mysql数据库

启动后台项目和前台项目, 依赖版本, 详见代码

解决跨域问题, 在前端vue配置文件设置代理

代理的域名填后端tomcat的启动地址

解决跨域问题-后端

```java
@Configuration
public class CorsConfig implements WebMvcConfigurer {

   @Override
   public void addCorsMappings(CorsRegistry registry) {
       registry.addMapping("/**")
           .allowedOrigins("*")
           .allowCredentials(true)
           .allowedMethods("GET", "POST", "PUT", "DELETE", "OPTIONS")
           .maxAge(3600);
   }
}
```



代码生成器

## 编码

使用技术, springboot, vue2, mybatisplus

### 商品模块

#### 1.创建家居分类表**,**并完成对家居分类增删改查功能

1. 需求**:** 创建商品分类表**(**支持层级**)** 表字段设计id和parent_id, 一般要使用自连接

   ```sql
   -- 商品模块库
   create database jiaju_commodity;
   use jiaju_commodity;
   -- 分类表
   CREATE TABLE `commodity_category`
   (
       `id`        BIGINT    NOT NULL AUTO_INCREMENT COMMENT 'id',
       `name`      CHAR(50)  NOT NULL COMMENT '名称',
       `parent_id` BIGINT    NOT NULL COMMENT '父分类 id',
       `cat_level` INT       NOT NULL COMMENT '层级',
       `is_show`   TINYINT   NOT NULL COMMENT '0 不显示，1 显示]',
       `sort`      INT       NOT NULL COMMENT '排序',
       `icon`      CHAR(255) NOT NULL COMMENT '图标',
       `pro_unit`  CHAR(50)  NOT NULL COMMENT '统计单位',
       `pro_count` INT       NOT NULL COMMENT '商品数量',
       PRIMARY KEY (`id`)
   ) CHARSET = utf8mb4 COMMENT ='商品分类表';
   -- 添加测试数据
   # 测试数据
   # 第1组 家用电器
   INSERT INTO `commodity_category`(`id`, `name`, `parent_id`, `cat_level`, `is_show`, `sort`, `icon`, `pro_unit`, `pro_count`)
   VALUES (1, '家用电器', 0, 1, 1, 0, '', '', 0);
   INSERT INTO `commodity_category`(`id`, `name`, `parent_id`, `cat_level`, `is_show`, `sort`, `icon`, `pro_unit`, `pro_count`)
   VALUES (21, '大 家 电', 1, 2, 1, 0, '', '', 0);
   INSERT INTO `commodity_category`(`id`, `name`, `parent_id`, `cat_level`, `is_show`, `sort`, `icon`, `pro_unit`, `pro_count`)
   VALUES (22, '厨卫大电', 1, 2, 1, 0, '', '', 0);
   INSERT INTO `commodity_category`(`id`, `name`, `parent_id`, `cat_level`, `is_show`, `sort`, `icon`, `pro_unit`, `pro_count`)
   VALUES (201, '燃气灶', 22, 3, 1, 0, '', '', 0),
          (202, '油烟机', 22, 3, 1, 0, '', '', 0);
   INSERT INTO `commodity_category`(`id`, `name`, `parent_id`, `cat_level`, `is_show`, `sort`, `icon`, `pro_unit`, `pro_count`)
   VALUES (301, '平板电视', 21, 3, 1, 0, '', '', 0);
   # 第2组 家居家装
   INSERT INTO `commodity_category`(`id`, `name`, `parent_id`, `cat_level`, `is_show`, `sort`, `icon`, `pro_unit`, `pro_count`)
   VALUES (2, '家居家装', 0, 1, 1, 0, '', '', 0);
   INSERT INTO `commodity_category`(`id`, `name`, `parent_id`, `cat_level`, `is_show`, `sort`, `icon`, `pro_unit`, `pro_count`)
   VALUES (41, '家纺', 2, 2, 1, 0, '', '', 0);
   INSERT INTO `commodity_category`(`id`, `name`, `parent_id`, `cat_level`, `is_show`, `sort`, `icon`, `pro_unit`, `pro_count`)
   VALUES (601, '桌布/罩件', 41, 3, 1, 0, '', '', 0);
   INSERT INTO `commodity_category`(`id`, `name`, `parent_id`, `cat_level`, `is_show`, `sort`, `icon`, `pro_unit`, `pro_count`)
   VALUES (602, '地毯地垫', 41, 3, 1, 0, '', '', 0);
   INSERT INTO `commodity_category`(`id`, `name`, `parent_id`, `cat_level`, `is_show`, `sort`, `icon`, `pro_unit`, `pro_count`)
   VALUES (42, '灯具', 2, 2, 1, 0, '', '', 0);
   INSERT INTO `commodity_category`(`id`, `name`, `parent_id`, `cat_level`, `is_show`, `sort`, `icon`, `pro_unit`, `pro_count`)
   VALUES (651, '台灯', 42, 3, 1, 0, '', '', 0);
   INSERT INTO `commodity_category`(`id`, `name`, `parent_id`, `cat_level`, `is_show`, `sort`, `icon`, `pro_unit`, `pro_count`)
   VALUES (652, '节能灯', 42, 3, 1, 0, '', '', 0);
   
   select *from commodity_category;
   ```

2. .需求**:** 使用 **renren-generator** 生成商品分类的 **crud** 代码

   使用人人generator代码生成器

   特点: 根据表生成简单的mapper/dao, service controller等等

3.  需求**:** 整合 **hspliving-commodity+MyBatis-Plus ,** 并完成对商品分类 的增删改查接口测试

    1.展示层级分类图, 而不是表格信息, 方便查看

<img src="../img/md-img/2025-03-26-project-01/01.png" align="left" alt="截屏2025-03-26 08.57.50" style="zoom: 67%;" />



接口 :http://localhost:9090/commodity/category/list/tree

要在parentchild里显示child节点

数据格式:

```json
{
    "msg": "success",
    "code": 0,
    "categoryTree": [
  		{
        "id": 22,
        "name": "厨卫大电",
        "parentId": 1,
        "catLevel": 2,
        "isShow": 1,
        "sort": 0,
        "icon": "",
        "proUnit": "",
        "proCount": 99
        "childCategories": [
            "category": {
              "id": 202,
              "name": "油烟机",
              "parentId": 22,
              "catLevel": 3,
              "isShow": 1,
              "sort": 0,
              "icon": "",
              "proUnit": "",
              "proCount": 0
            },
      ]
    },
	]
}
```

实现核心代码

```java
    @Override
    public PageUtils queryPage(Map<String, Object> params) {
        IPage<CategoryEntity> page = this.page(
                new Query<CategoryEntity>().getPage(params),
                new QueryWrapper<CategoryEntity>()
        );
        return new PageUtils(page);
    }

    @Override
    public List<CategoryEntity> ListTree() {
        // 先取出所有数据,再组装成map: id -> 分类对象
        LinkedList<CategoryEntity> categoryList = new LinkedList<>(baseMapper.selectList(null));
        Map<Long, CategoryEntity> map = categoryList.stream().collect(Collectors.toMap(CategoryEntity::getId, e -> e));
        ListTree(map, 1);
        List<CategoryEntity> list = map.values().stream()
                .filter(e -> e.getCatLevel().equals(1)).collect(Collectors.toList());
        return list;
    }

    /**
     * 按深度层级遍历, 组装子分类到父分类的childCategories属性中
     *
     * @param map      所有分类信息map: id -- 分类对象
     * @param catLevel 初始分类等级, 值为1时, 组装全部分类层级
     */
    private void ListTree(Map<Long, CategoryEntity> map, Integer catLevel) {
        List<CategoryEntity> levelCategories = map.values().stream()
                .filter(e -> e.getCatLevel().equals(catLevel))
                // 根据排序字段排序
                .sorted(Comparator.comparingInt(CategoryEntity::getSort))
                .collect(Collectors.toList());
        if (!CollectionUtils.isEmpty(levelCategories)) {
            // 分类深度递归遍历, 1->2->3
            for (CategoryEntity levelCategory : levelCategories) {
                // 如果有父分类,则加入到父分类中
                CategoryEntity parent = map.get(levelCategory.getParentId());
                if (parent != null) {
                    if (parent.getChildCategories() == null) {
                        parent.setChildCategories(new ArrayList<>());
                    }
                    parent.getChildCategories().add(levelCategory);
                }
            }
            ListTree(map, catLevel + 1);
        }
    } 
```

注意点: 在实体类增加不存在于数据库的字段, 使用mybatisPlus的注解 

```java
@TableName(value = "commodity_category",excludeProperty = {"childCategories"})
或者
@TableField(exist = false)
private List<CategoryEntity> childCategories;
```

2.删除分类

需求:  **只有没有子分类的才可以** **Delete,**

  逻辑删除,mybatisplus的https://baomidou.com/guides/logic-delete/

```java
/**
* 0 不显示，1 显示
*/
@TableLogic(value = "1", delval = "0")
private Integer isShow;
```

接口: http://localhost:9090/commodity/category/delete

```json
[652,651]
```

```json
{
    "msg": "success",
    "code": 0
}
```

3.新增

<img src="../img/md-img/2025-03-26-project-01/截屏2025-03-27 08.58.37.png" alt="截屏2025-03-27 08.58.37" style="zoom:33%;" />

**需求:只有** **1,2** **级菜单可以** **新增,**

```json
{
  "id": null,
  "name": "新分类",
  "parentId": 709,
  "catLevel": 3,
  "isShow": 1,
  "sort": 0,
  "icon": "",
  "proUnit": "",
  "proCount": 0
}
```



<img src="../img/md-img/截屏2025-03-27 08.48.05.png" alt="截屏2025-03-27 08.48.05" style="zoom: 33%;" />

4.修改分类



需求: 修改分类需要调用回显接口, 然后保存

回显<img src="../img/md-img/2025-03-26-project-01/截屏2025-03-27 08.57.18.png" alt="截屏2025-03-27 08.57.18" style="zoom:33%;" />

http://localhost:9090/commodity/category/info/713

保存修改

http://localhost:9090/commodity/category/update

```json
{
  "id": 713,
  "name": "下112新",
  "icon": "下1",
  "proUnit": "下1"
}
```

5.批量删除

前端支持即可

```javascript
batchDel() {
  // this.$refs.tree 引用<el-tree>
  // 半选就是某个分类的子分类, 只选择了部分，没有全选
  let checkedNodes = this.$refs.tree.getCheckedNodes(false,false)
  let delIds =[]
  let delName = []
  for (let i = 0; i < checkedNodes.length; i++) {
    let category = checkedNodes[i]
    delIds.push(category.id)
    delName.push(category.name)
  }
  // 判断空
  if (delIds.length === 0) {
    return;
  }
  this.$confirm(`是否要删除[${delName}]`, '提示', {
    confirmButtonText: '确定',
    cancelButtonText: '取消',
    type: 'warning'
  }).then(() => {
    this.$http.post('http://localhost:9090/commodity/category/delete', delIds).then(({data}) => {
      if (data && data.code === 0) {
        this.$message({
          message: '操作成功',
          type: 'success',
          duration: 1500
        })
        console.log("批量删除成功: ", data)
        // 刷新数据
        this.getTreeData()
      }
    })
  });
  console.log("checkedNodes", checkedNodes)
},
```

#### 2.创建商品品牌表**,**并完成对商品品牌表增删改查功能

表 commodity_brand

```sql
CREATE TABLE `commodity_brand`
(
    id           BIGINT NOT NULL AUTO_INCREMENT COMMENT 'id',
    `name`       CHAR(50) COMMENT '品牌名',
    logo         VARCHAR(1200) COMMENT 'logo',
    description  LONGTEXT COMMENT '说明',
    isShow       TINYINT COMMENT '显示',
    first_letter CHAR(1) COMMENT '检索首字母',
    sort         INT COMMENT '排序',
    primary key (id)
) CHARSET = utf8mb4 COMMENT ='商品品牌表';
```

1.CRUD API 代码生成器生成

```apl
http://localhost:9090/commodity/category/delete
http://localhost:9090/commodity/category/info/{id}
http://localhost:9090/commodity/category/list
http://localhost:9090/commodity/category/delete
```

2.控制是否显示品牌 (isShow字段)

Switch开关控件

<img src="../img/md-img/2025-03-26-project-01/截屏2025-03-27 12.25.38.png" alt="截屏2025-03-27 12.25.38" style="zoom: 33%;" />

```html
<el-table-column
  prop="isShow"
  header-align="center"
  align="center"
  label="显示">
  <template slot-scope="scope">
    <el-switch
      v-model="scope.row.isShow"
      @change="switchIsShow(scope.row)"
      :active-value="1"
      :inactive-value="0"
      active-color="#13ce66"
      inactive-color="#ff4949">
    </el-switch>
  </template>
</el-table-column>
```

#### 3.图片上传-使用aliyun-oss

1.上传方式分析

普通上传方式: 用户数据需先上传到应用服务器，之后再上传到OSS

<img src="../img/md-img/2025-03-26-project-01/截屏2025-03-27 14.35.57.png" alt="截屏2025-03-27 14.35.57" style="zoom: 33%;" align="left" />

缺点: 速度慢, 应用服务器压力大,应用服务器成本高

阿里云对象存储**-**服务端签名后直传

<img src="../img/md-img/2025-03-26-project-01/截屏2025-03-27 14.38.57.png" alt="截屏2025-03-27 14.38.57" style="zoom:33%;" align="left" />

**Web**端向服务端请求签名，然后直接上传，不会对服务端产生压力，而且安全可靠。但服务端无法实时了解用户上传了多少文件，上传了什么文件。如果想实时了解用户 上传了什么文件，可以采用服务端签名直传并设置**上传回调**

2.在aliyun创建oss bucket创建ram授权用户,获取OSS_ACCESS_KEY_ID和OSS_ACCESS_KEY_SECRET

使用ossClient访问

aliyun文档 : https://help.aliyun.com/zh/oss/developer-reference/getting-started

集成springCloudalibaba-oss

https://github.com/alibaba/spring-cloud-alibaba/wiki/OSS

需求:上传图片到oss, 使用对象存储**-**服务端签名后直传

<img src="../img/md-img/2025-03-26-project-01/截屏2025-03-27 19.56.22.png" alt="截屏2025-03-27 19.56.22" style="zoom:33%;" />

<img src="../img/md-img/2025-03-26-project-01/截屏2025-03-27 19.58.23.png" alt="截屏2025-03-27 19.58.23" style="zoom:33%;" />

注意点:  aliyunOSS上配置跨域访问, 配置公共读取权限, 否则不能显示



#### 4.重构模块-引入服务发现

现在模块有, mall.common(aliyun存储服务),mall.commodity(商品子模块),mall.admin(后台管理模块)

以及vue管理台前端模块



<img src="../img/md-img/2025-03-26-project-01/截屏2025-03-27 20.28.13.png" alt="截屏2025-03-27 20.28.13" style="zoom:33%;" />

现在对这些服务进行统一 管理, 引入nacos服务注册和发现中心

<img src="../img/md-img/2025-03-26-project-01/截屏2025-03-27 20.28.56.png" alt="截屏2025-03-27 20.28.56" style="zoom:50%;" />



